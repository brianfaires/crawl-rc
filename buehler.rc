## Config at start of file

################################### Begin lua/core/config.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
--[[
BRC Configuration - All user-configurable settings
Author: buehler
Dependencies: core/constants.lua
--]]

-- Initialize
BRC = BRC or {}
BRC.Config = {}

BRC.Config.emojis = true -- Use emojis in alerts and announcements

-- after-shaft.lua
BRC.Config.stop_on_stairs_after_shaft = true -- Stop explore on stairs after shaft, until back to original level

-- announce-hp-mp.lua: Announce HP/MP changes
BRC.Config.dmg_flash_threshold = 0.20 -- Flash screen when losing this % of max HP
BRC.Config.dmg_fm_threshold = 0.30 -- Force more for losing this % of max HP
BRC.Config.announce = {
  hp_loss_limit = 1, -- Announce when HP loss >= this
  hp_gain_limit = 4, -- Announce when HP gain >= this
  mp_loss_limit = 1, -- Announce when MP loss >= this
  mp_gain_limit = 2, -- Announce when MP gain >= this
  hp_first = true, -- Show HP first in the message
  same_line = true, -- Show HP/MP on the same line
  always_both = true, -- If showing one, show both
  very_low_hp = 0.10, -- At this % of max HP, show all HP changes and mute % HP alerts
} -- BRC.Config.announce (do not remove this comment)

-- An alternative announce setup: Displays meters after every turn. Uncomment the following block to try it.
--[[
BRC.Config.announce = {
  hp_loss_limit = 0,
  hp_gain_limit = 0,
  mp_loss_limit = 0,
  mp_gain_limit = 0,
  hp_first = true,
  same_line = true,
  always_both = true
} -- BRC.Config.announce (do not remove this comment)
--]]

-- color-inscribe.lua
BRC.Config.colorize_inscriptions = true -- Add color to any inscription on pickup (e.g. resistance, stat changes, etc)

-- drop-inferior.lua
BRC.Config.drop_inferior = true -- Mark items for drop when a strictly better item is picked up
BRC.Config.msg_on_inscribe = true -- Show a message when an item is marked for drop

-- exclude-dropped.lua: Disables auto-pickup for whatever you drop
BRC.Config.exclude_dropped = true -- Exclude items from future autopickup when dropped
BRC.Config.ignore_stashed_weapon_scrolls = true -- Don't exclude enchant/brand scrolls if holding an enchantable weapon

-- fm-disable.lua: Disable built-in force_mores that can't be easily removed
BRC.Config.fm_disable = true -- Skip the 'more' prompt for all messages configured in fm-disable.lua

-- alert-monsters.lua: Dynamically set force mores based on hp/xl/willpower/resistance/etc
BRC.Config.fm_on_uniques = true -- Stop on all Uniques & Pan lords
BRC.Config.pack_monster_turns = 15 -- # turns to wait before repeating an alert for a pack of monsters. 0 to disable
BRC.Config.disable_alert_monsters_in_zigs = true -- Disable dynamic force_mores in Ziggurats
BRC.Config.debug_alert_monsters = false -- Get a message when alerts toggle off/on

-- fully-recover.lua: Keep resting until these statuses are gone.
-- Special cases exist for "slowed" and "corroded". If you include them, use those exact strings only.
BRC.Config.rest_off_statuses = {
  "berserk", "confused", "corroded", "marked", "short of breath",
  "slowed", "sluggish", "tree%-form", "vulnerable", "weakened",
} -- BRC.Config.rest_off_statuses (do not remove this comment)

-- inscribe-stats.lua: Inscribe stats on pickup and adjust each turn
BRC.Config.inscribe_weapons = true
BRC.Config.inscribe_armour = true
BRC.Config.inscribe_dps_type = "plain" -- How to calc dmg for weapon inscriptions (See BRC.DMG_TYPE in constants.lua)

-- misc-alerts.lua
BRC.Config.alert_low_hp_threshold = 0.35 -- % max HP to alert; 0 to disable
BRC.Config.alert_remove_faith = true -- Reminder to remove amulet at max piety
BRC.Config.alert_spell_level_changes = true -- Alert when you gain additional spell levels
BRC.Config.save_with_msg = true -- Shift-S to save and leave yourself a message

-- remind-id.lua: Before finding scroll of ID, stop travel when increasing largest stack size, starting at:
BRC.Config.stop_on_scrolls_count = 2 -- Stop on a stack of this many un-ID'd scrolls
BRC.Config.stop_on_pots_count = 3 -- Stop on a stack of this many un-ID'd potions

-- runrest-features.lua: Runrest features
BRC.Config.ignore_altars = true -- when you have a god already
BRC.Config.ignore_portal_exits = true -- don't stop explore on portal exits
BRC.Config.stop_on_hell_stairs = true -- stop explore on hell stairs
BRC.Config.stop_on_pan_gates = true -- stop explore on pan gates
BRC.Config.temple_macros = true -- auto-search altars; run to exit after worship
BRC.Config.gauntlet_macros = true -- auto-search with filters

-- safe-consumables.lua
BRC.Config.safe_consumables = true -- Maintain !r and !q on all consumables without a built-in prompt

-- safe-stairs.lua: Detect/warn for accidental stair usage
BRC.Config.warn_v5 = true -- Prompt before entering Vaults:5
BRC.Config.warn_stairs_threshold = 5 -- Warn if taking stairs back within # turns; 0 to disable

-- startup.lua: Startup features
BRC.Config.show_skills_on_startup = true
BRC.Config.auto_set_skill_targets = {
  { "Stealth", 2.0 }, -- First, focus stealth to 2.0
  { "Fighting", 2.0 }, -- If already have stealth, focus fighting to 2.0
} -- auto_set_skill_targets (do not remove this comment)

-- weapon-slots.lua: Always use a/b/w slots for weapons
BRC.Config.do_auto_weapon_slots_abw = true -- Auto-move weapons to a/b/w slots

--[[
  Pickup/Alert system
  This does not affect other autopickup settings; just the BRC Pickup/Alert system
  Choose which items are auto-picked up, alerted, and when force-more is applied.
--]]
BRC.Config.pickup = {
  armour = true,
  weapons = true,
  staves = true,
} -- BRC.Config.pickup (do not remove this comment)

-- Which alerts are enabled
BRC.Config.alert = {
  system_enabled = true, -- If false, no alerts are generated
  armour = true,
  weapons = true,
  orbs = true,
  staff_resists = true,
  talismans = true,

  -- Only alert a plain talisman if its min_skill <= Shapeshifting + talisman_lvl_diff
  talisman_lvl_diff = you.class() == "Shapeshifter" and 27 or 6, -- 27 for Shapeshifter, 6 for everyone else

  -- Each non-useless item is alerted once.
  one_time = {
    "wand of digging", "buckler", "kite shield", "tower shield",
    "crystal plate armour", "gold dragon scales", "pearl dragon scales", "storm dragon scales", "shadow dragon scales",
    "quick blade", "demon blade", "eudemon blade", "double sword", "triple sword",
    "broad axe", "executioner's axe", "demon whip", "eveningstar", "giant spiked club", "sacred scourge",
    "lajatang", "bardiche", "demon trident", "trishula", "hand cannon", "triple crossbow",

  }, -- BRC.Config.alert.one_time (do not remove this comment)

  -- Only do one-time alerts if your skill >= this value, in weap_school/armour/shield
  OTA_require_skill = { weapon = 3, armour = 2.5, shield = 0 },
} -- BRC.Config.alert (do not remove this comment)

-- Which alerts generate a force_more
BRC.Config.fm_alert = {
  early_weap = false, -- Good weapons found early
  upgrade_weap = false, -- Better DPS / weapon_score
  weap_ego = false, -- New or diff egos
  body_armour = false,
  shields = true,
  aux_armour = false,
  armour_ego = true, -- New or diff egos
  high_score_weap = false, -- Highest damage found
  high_score_armour = true, -- Highest AC found
  one_time_alerts = true,
  artefact = false, -- Any artefact
  trained_artefacts = true, -- Only for artefacts where you have corresponding skill > 0
  orbs = false,
  talismans = you.class() == "Shapeshifter", -- True for shapeshifter, false for everyone else
  staff_resists = false,
} -- BRC.Config.fm_alert (do not remove this comment)

-- Debugging
BRC.Config.debug_notes_on_char_dump = true
BRC.Config.show_debug_messages = true

---- Heuristics for tuning the pickup/alert system. Advanced behavior customization.
BRC.Tuning = {}

--[[
  BRC.Tuning.armour: Magic numbers for the armour pickup/alert system.
  For armour with different encumbrance, alert when ratio of gain/loss (AC|EV) is > value
  Lower values mean more alerts. gain/diff/same/lose refers to egos.
  min_gain/max_loss check against the AC or EV delta when ego changes; skip alerts if delta outside limits
  ignore_small: separate from AC/EV ratios, if absolute AC+EV loss is <= this, alert any gain/diff ego
--]]
BRC.Tuning.armour = {
  lighter = {
    gain_ego = 0.6,
    diff_ego = 0.8,
    same_ego = 1.2,
    lost_ego = 2.0,
    min_gain = 3.0,
    max_loss = 4.0,
    ignore_small = 3.5,
  },
  heavier = {
    gain_ego = 0.4,
    diff_ego = 0.5,
    same_ego = 0.7,
    lost_ego = 2.0,
    min_gain = 3.0,
    max_loss = 8.0,
    ignore_small = 5,
  },
  encumb_penalty_weight = 0.7, -- Penalizes heavier armour when training spellcasting/ranged. 0 to disable
  early_xl = 6, -- Alert all usable runed body armour if XL <= `early_xl`
} -- BRC.Tuning.armour (do not remove this comment)

--[[
  BRC.Tuning.weap: Magic numbers for the weapon pickup/alert system. Two common types of values:
    1. Cutoffs for pickup/alert weapons (when DPS ratio exceeds a value)
    2. Cutoffs for when alerts are active (XL, skill_level)
  Pickup/alert system will try to upgrade ANY weapon in your inventory.
  "DPS ratio" is (new_weapon_score / inventory_weapon_score). Score considers DPS, brand, and accuracy.
--]]
BRC.Tuning.weap = {}
BRC.Tuning.weap.pickup = {
  add_ego = 1.0, -- Pickup weapon that gains a brand if DPS ratio > `add_ego`
  same_type_melee = 1.2, -- Pickup melee weap of same school if DPS ratio > `same_type_melee`
  same_type_ranged = 1.1, -- Pickup ranged weap if DPS ratio > `same_type_ranged`
  accuracy_weight = 0.25, -- Treat +1 Accuracy as +`accuracy_weight` DPS
} -- BRC.Tuning.weap.pickup (do not remove this comment)

BRC.Tuning.weap.alert = {
  -- Alerts for weapons not requiring an extra hand
  pure_dps = 1.0, -- Alert if DPS ratio > `pure_dps`
  gain_ego = 0.8, -- Gaining ego; Alert if DPS ratio > `gain_ego`
  new_ego = 0.8, -- Get ego not in inventory; Alert if DPS ratio > `new_ego`
  low_skill_penalty_damping = 8, -- Increase to penalize low-trained schools. Penalty = (skill+damp) / (top_skill+damp)

  -- Alerts for 2-handed weapons, when carrying 1-handed
  add_hand = {
    ignore_sh_lvl = 4.0, -- Treat offhand as empty if shield_skill < `ignore_sh_lvl`
    add_ego_lose_sh = 0.8, -- Alert 1h -> 2h (using shield) if DPS ratio > `add_ego_lose_sh`
    not_using = 1.0, --  Alert 1h -> 2h (not using 2nd hand) if DPS ratio > `not_using`
  },

  -- Alerts for good early weapons of all types
  early = {
    xl = 7, -- Alert early weapons if XL <= `xl`
    skill = { factor = 1.5, offset = 2.0 }, -- Skip weapons with skill diff > XL * factor + offset
    branded_min_plus = 4, -- Alert branded weapons with plus >= `branded_min_plus`
  },

  -- Alerts for particularly strong ranged weapons
  early_ranged = {
    xl = 14, -- Alert strong ranged weapons if XL <= `xl`
    min_plus = 7, -- Alert ranged weapons with plus >= `min_plus`
    branded_min_plus = 4, -- Alert branded ranged weapons with plus >= `branded_min_plus`
    max_shields = 8.0, -- Alert 2h ranged, despite shield, if shield_skill <= `max_shields`
  }, -- BRC.Tuning.weap.alert.early_ranged (do not remove this comment)
} -- BRC.Tuning.weap.alert (do not remove this comment)

---- BRC.BrandBonus: Tune the impact of brands on DPS calculations
-- This applies to weapon inscriptions, and item comparisons in the pickup-alert system.
-- Uses "terse" ego names, e.g. "spect" instead of "spectralizing"
BRC.BrandBonus = {
  chaos = { factor = 1.15, offset = 2.0 }, -- Approximate weighted average
  distort = { factor = 1.0, offset = 6.0 },
  drain = { factor = 1.25, offset = 2.0 },
  elec = { factor = 1.0, offset = 4.5 }, -- technically 3.5 on avg; fudged up for AC pen
  flame = { factor = 1.25, offset = 0 },
  freeze = { factor = 1.25, offset = 0 },
  heavy = { factor = 1.8, offset = 0 }, -- Speed is accounted for elsewhere
  pain = { factor = 1.0, offset = you.skill("Necromancy") / 2 },
  spect = { factor = 1.7, offset = 0 }, -- Fudged down for increased incoming damage
  venom = { factor = 1.0, offset = 5.0 }, -- estimated 5 dmg per poisoning

  subtle = { -- Completely made up values in attempt to compare weapons fairly
    antimagic = { factor = 1.1, offset = 0 },
    holy = { factor = 1.15, offset = 0 },
    penet = { factor = 1.3, offset = 0 },
    protect = { factor = 1.15, offset = 0 },
    reap = { factor = 1.3, offset = 0 },
    vamp = { factor = 1.2, offset = 0 },
  }, -- BRC.BrandBonus.subtle (do not remove this comment)
} -- BRC.BrandBonus (do not remove this comment)

---- Cosmetic settings
BRC.AlertColor = {
  weapon = {
    desc = "magenta",
    item = "yellow",
    stats = "lightgrey",
  },
  body_arm = {
    desc = "lightblue",
    item = "lightcyan",
    stats = "lightgrey",
  },
  aux_arm = { desc = "lightblue", item = "yellow" },
  orb = { desc = "green", item = "lightgreen" },
  talisman = { desc = "green", item = "lightgreen" },
  misc = { desc = "brown", item = "white" },
} -- BRC.AlertColor (do not remove this comment)

BRC.LogColor = {
  error = "lightred",
  warning = "yellow",
  info = "lightgrey",
  debug = "lightblue",
}

BRC.Emoji = {}
if BRC.Config.emojis then
  BRC.Emoji.RARE_ITEM = "ðŸ’Ž"
  BRC.Emoji.ORB = "ðŸ”®"
  BRC.Emoji.TALISMAN = "ðŸ§¬"

  BRC.Emoji.WEAPON = "âš”ï¸"
  BRC.Emoji.RANGED = "ðŸ¹"
  BRC.Emoji.POLEARM = "ðŸ”±"
  BRC.Emoji.TWO_HAND = "âœ‹ðŸ¤š"
  BRC.Emoji.CAUTION = "âš ï¸"

  BRC.Emoji.STAFF_RESISTANCE = "ðŸ”¥"

  BRC.Emoji.ACCURACY = "ðŸŽ¯"
  BRC.Emoji.STRONGER = "ðŸ’ª"
  BRC.Emoji.STRONGEST = "ðŸ’ªðŸ’ª"
  BRC.Emoji.EGO = "âœ¨"
  BRC.Emoji.LIGHTER = "â¬"
  BRC.Emoji.HEAVIER = "â«"
  BRC.Emoji.ARTEFACT = "ðŸ’ "

  BRC.Emoji.REMIND_ID = "ðŸŽ"
  BRC.Emoji.EXCLAMATION = "â—"
  BRC.Emoji.EXCLAMATION_2 = "â€¼ï¸"

  BRC.Emoji.HP_METER = { FULL = "â¤ï¸", PART = "â¤ï¸â€ðŸ©¹", EMPTY = "ðŸ¤" }
  BRC.Emoji.MP_METER = { FULL = "ðŸŸ¦", PART = "ðŸ”¹", EMPTY = "âž–" }

  BRC.Emoji.SUCCESS = "âœ…"
else
  BRC.Emoji.REMIND_ID = "<magenta>?</magenta>"
  BRC.Emoji.EXCLAMATION = "<magenta>!</magenta>"
  BRC.Emoji.EXCLAMATION_2 = "<lightmagenta>!!</lightmagenta>"

  BRC.Emoji.HP_METER = {
    BORDER = "<white>|</white>",
    FULL = "<green>+</green>",
    PART = "<lightgrey>+</lightgrey>",
    EMPTY = "<darkgrey>-</darkgrey>",
  } -- BRC.Emoji.HP_METER (do not remove this comment)

  BRC.Emoji.MP_METER = {
    BORDER = "<white>|</white>",
    FULL = "<lightblue>+</lightblue>",
    PART = "<lightgrey>+</lightgrey>",
    EMPTY = "<darkgrey>-</darkgrey>",
  } -- BRC.Emoji.MP_METER (do not remove this comment)
end

}
############################### End lua/core/config.lua ###############################
##########################################################################################

## (Resuming init.txt) ##

####### Main options #######
easy_confirm = all
show_more = false
small_more = true
mouse_input = false
default_manual_training = true
autofight_caught = true
rest_wait_both = true
rest_wait_ancestor = true

autofight_stop = 40
hp_warning = 20
item_stack_summary_minimum = 8
fail_severity_to_confirm = 4

sort_menus = true:equipped,art,ego,basename,identified,qualname,>qty
drop_filter += useless_item, forbidden
fire_order = silver javelin, javelin, silver boomerang, boomerang, curare-tipped dart, poisoned dart, dart, stone


####### Explore options #######
explore_delay = -1
travel_delay = -1
rest_delay = -1
view_delay = 100
show_travel_trail = true

explore_stop = altars,branches,portals,runed_doors,greedy_pickup_smart
explore_stop_pickup_ignore += scroll, potion, misc, wand, stone, dart, boomerang, javelin


### Mostly normal RC options ###

################################### Begin rc/autoinscribe.rc ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
# See safe-consumables.lua for consumable inscriptions

ai := autoinscribe

# General
ai += of fire resistance:rF+
ai += of cold resistance:rC+
ai += of poison resistance:rPois
ai += of preservation:rCorr
ai += of invulnerability:rInv
ai += of magic regeneration:MRegen+
ai += of positive energy:rN+
ai += of regeneration:Regen+
ai += of resistance:rRes
ai += of willpower:Will+

# Armour
ai += fire dragon scale:rF++, rC-
ai += gold dragon scale:rC+, rF+, rPois
ai += ice dragon scale:rC++, rF-
ai += pearl dragon scale:rN+
ai += storm dragon scale:rElec
ai += swamp dragon scale:rPois
ai += quicksilver dragon scale:Will+
ai += shadow dragon scale:Stlth+
ai += (?<!moon) troll leather:Regen+


# Amulets
ai += amulet of faith:Faith, !P

# Rings
ai += ring of fire:rF+, rC-
ai += ring of flight:+Fly
ai += ring of ice:rC+, rF-
ai += ring of magical power:MP+9
ai += ring of protection from cold:rC+
ai += ring of protection from fire:rF+
ai += ring of resist corrosion:rCorr
ai += ring of see invisible:sInv
ai += ring of wizardry:Wiz+

# Staves
ai += staff of air:rElec
ai += staff of cold:rC+
ai += staff of death:rN+
ai += staff of fire:rF+
ai += staff of poison:rPois

############################### End rc/autoinscribe.rc ###############################
##########################################################################################

################################### Begin rc/autopickup.rc ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
####### Autopickup exceptions #######
ae := autopickup_exceptions
ae ^= <potions? of attraction, <potions? of lignification, <potions? of mutation
ae ^= <scrolls? of immolation, <scrolls? of poison
ae ^= <missile, <misc
ae ^= >staff of.*, >useless_item

############################### End rc/autopickup.rc ###############################
##########################################################################################

################################### Begin rc/display.rc ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
## Mutes are at end of file, so they override the rest

stat_colour = 3:red, 7:lightred

hp_colour = 100:green, 99:lightgrey, 75:yellow, 50:lightred, 25:red
mp_colour = 100:green, 99:lightgrey, 75:yellow, 50:lightred, 25:red

tile_font_crt_family  = Lucida Console
tile_font_stat_family = Lucida Console
tile_font_msg_family  = Lucida Console
tile_font_lbl_family  = Lucida Console


####### Menu Colors #######
# Set Alias & clear defaults
menu := menu_colour
menu =

# Variables
$boring := darkgrey
$emergency := lightcyan
$heal := green
$normal := lightgrey
$rare := yellow
$useful := lightblue
$warning := red


# First, highlight uselessness
menu += $boring:(melded|useless_item)
menu += $warning:forbidden

# Overrides: pickup menu (Affects Cntl-F)
#   (why don't these work when they come after inventory overrides?)
menu += pickup:lightmagenta:artefact.*jewellery
menu += pickup:lightgreen:artefact.*weapon
menu += pickup:lightcyan:artefact.*armour
menu += pickup:yellow:artefact
menu += pickup:magenta:jewellery
menu += pickup:lightblue:(ego|(unidentified.*(glowing|runed|shiny|embroidered)))
menu += pickup:magenta:(wand|curare|disjunction|throwing net)
menu += pickup:$normal:(missile|weapon|armour)
menu += brown:spellbook

# Overrides: inventory menu
menu += inventory:lightgreen:.*equipped.*(weapon|armour|jewellery)
menu += inventory:$boring:inert
menu += inventory:lightmagenta:artefact.*amulet
menu += inventory:magenta:amulet
menu += inventory:white:artefact
menu += inventory:lightgrey:ego
menu += inventory:$boring:(weapon|armour)
menu += inventory:$normal:jewellery

# Overrides: use_item menu
menu += use_item:lightgreen:.*equipped.*(weapon|armour|jewellery)
menu += use_item:lightmagenta:artefact.*amulet
menu += use_item:magenta:amulet
menu += use_item:white:artefact
menu += use_item:lightgrey:ego
menu += use_item:$boring:(weapon|armour)
menu += use_item:$normal:jewellery

## General settings; used where not explicitly set above

# Artefact / Ego / Vanilla (For equipment)
menu += $emergency:artefact
menu += $useful:ego
menu += $normal:(weapon|armour|jewellery)

# Decks
menu += $emergency:deck of escape
menu += $useful:deck of summoning
menu += $warning:deck of destruction

# Misc
menu += blue:(talisman|bauble)
menu += lightmagenta:evoker

# Missiles
menu += $emergency:(curare|disjunction|throwing net)
menu += $normal:missile

# Potions
menu += $emergency:potions? of (cancellation|haste|resistance)
menu += $heal:potions? of (ambrosia|curing|heal wounds|magic)
menu += $rare:potions? of experience
menu += $useful:potions? of (brilliance|enlightenment|invisibility|might)
menu += $warning:potions? of (attraction|berserk|lignification|mutation)

# Scrolls
menu += $normal:scrolls? of (amnesia|enchant|identify)
menu += $emergency:scrolls? of (blinking|butterflies|fear|fog|teleportation|summoning)
menu += $rare:scrolls? of (acquirement|brand)
menu += $useful:scrolls? of (revelation)
menu += $warning:scrolls? of (immolation|noise|poison|silence|torment|vulnerability)

# Wands
menu += $emergency:wand of digging
menu += $normal:wand of (flame|paralysis|charming|mindburst|polymorph)
menu += $useful:wand of (acid|iceblast|light|quicksilver|roots|warping)

# Weapons
menu += brown:staff of


######## Message coloring ########
# black, blue, green, cyan, red, magenta, brown, lightgrey,
# darkgrey, lightblue, lightgreen, lightcyan, lightred,
# lightmagenta, yellow, white

# Standard colours to be used for message highlighting
$danger   := lightred
$item_dmg := red
$warning  := yellow
$boring   := darkgrey
$negative := brown
$good     := lightblue
$positive := green
$verypositive := lightgreen
$awesome := lightmagenta
$interface := cyan
$takesaction := blue
$godaction := magenta
$mp := lightcyan

# Set Alias & clear defaults
msc := message_colour
msc =

msc += $mp:You feel your power returning
msc += $mp:Done waiting

msc += $danger:roused to righteous anger
msc += $danger:is roused by the hymn
msc += $danger:A magical barricade bars your way
msc += $danger:is repulsed
msc += $danger:seems less drained
msc += $danger:preventing you from leaping
msc += $danger:shrugs off the wave
msc += $danger:Your unholy channel expires
msc += $danger:Being near the torpor snail leaves you feeling lethargic
msc += $danger:The amulet engulfs you in a massive magical discharge
msc ^= $danger:Your.*appears confused
msc ^= $danger:You open a gate to Pandemonium
msc += $danger:Some icy apparitions appear
msc += $danger:You feel less empathic
msc ^= $danger:Qazlal is no longer ready to protect you from an element
msc ^= $danger:Your divine halo fades away
msc ^= $danger:Your divine shield disappears
msc ^= $danger:The orb of electricity explodes
msc ^= $danger:Your divine shield fades away
msc += $danger:visions of slaying
msc += $danger:You.*no longer.*bleed smoke
msc += $danger:Your shadow no longer tangibly mimics your actions
msc += $danger:You are even more entangled
msc += $danger:You have drawn Pain
msc += $danger:Your magical shield disappears
msc += $danger:creates some ice likenesses
msc += $danger:soul is no longer ripe for the taking
msc += $danger:You are no longer magically infusing your attacks
msc += $danger:The ambient light returns to normal
msc += $danger:An iron grate slams shut
msc += $danger:begins to accept
msc += $danger:begins to recite a word of recall
msc += $danger:begins to radiate toxic energy
msc += $danger:The shadow imp is revulsed by your support of nature
msc += $danger:Careful! You are starting to lose your buoyancy
msc ^= $danger:plants?.*suddenly grows? acid sacs
msc ^= $danger:Your.*is devoured by a tear in reality
msc += $danger:Your body is bloodless
msc += $danger:Your unliving flesh cannot be transformed in this way
msc += $danger:You can't disarm
msc += $danger:You feel strangely static
msc += $danger:A powerful magic interferes with your control of the blink
msc += $danger:burns.*terribly
msc += $danger:You are no longer teleporting projectiles to their destination
msc += $danger:Water floods your area
msc += $danger:You feel the presence of a powerless spirit
msc += $danger:You feel less (resistant|protected)
msc += $danger:You hear a crashing sound
msc += $danger:The tree smolders and burns
msc += $danger:You are contaminated with residual magics
msc += $danger:is duplicated
msc += $danger:You sense a malign presence
msc += $danger:The deck only has
msc += $danger:blocks your orb of destruction
msc += $danger:There are no remains here to animate
msc += $danger:Your ring of flames gutters out
msc += $danger:The elephant guardians awaken
msc += $danger:slides away
msc += $danger:moves from beneath you
msc += $danger:A powerful magic prevents control of your teleportation
msc += $danger:There's only.*cards? left!
msc += $danger:A huge vortex of air appears
msc += $danger:you're silenced
msc += $danger:Your hands slow down
msc += $danger:Your shroud falls apart
msc += $danger:Not with that terrain in the way
msc += $danger:Your teleport is interrupted
msc += $danger:Your.*revert to.*normal proportions
msc += $danger:Its appearance distorts for a moment
msc += $danger:A shaft opens up in the floor
msc += $danger:You are held in a net
msc += $danger:(The|Your).*falls away!
msc += $danger:The orbs collide in a blinding explosion
msc += $danger:You feel the power of the Abyss delaying your translocation
msc += $danger:Mara shimmers
msc += $danger:Your.*is blown up
msc += $danger:seems to grow more fierce
msc += $danger:attacks!
msc += $danger:You sense the presence of something unfriendly
msc += $danger:Your.*falls into the water
msc += $danger:Something unseen opens the huge gate
msc += $danger:changes into something you cannot see
msc += $danger:The rod doesn't have enough magic points
msc += $danger:The power of the Abyss keeps you in your place
msc += $danger:Your.*is destroyed
msc += $danger:You feel your control is inadequate
msc += $danger:A great vortex of raging winds appears
msc += $danger:You blow up your
msc += $danger:The sixfirhy seems to be charged up
msc += $danger:You feel your power drain away
msc += $danger:You cannot cast spells when silenced
msc += $danger:You feel hot and cold all over
msc += $danger:You don't have the energy to cast that spell
msc += $danger:and don't expect to remain undetected
msc += $danger:but the box appears empty
msc += $danger:your gold pieces vanish
msc += $danger:Your.*dies
msc += $danger:You cannot teleport right now
msc += $danger:You feel your power drawn to a protective spirit
msc += $danger:your magic stops regenerating
msc += $danger:Some monsters swap places
msc += $danger:You turn into a spiny porcupine
msc += $danger:Your limbs have turned to stone
msc += $danger:Your skin feels tender
msc += $danger:You turn into a fleshy mushroom
msc += $danger:The sound of falling rocks suddenly begins to subside
msc += $danger:The walls and floor vibrate strangely for a moment
msc += $danger:Your.*(armour|shield) melts away
msc += $danger:drains you
msc += $danger:feel drained
msc += $danger:strangely unstable
msc += $danger:curare-tipped.*hits you
msc += $danger:Space warps.* around you
msc += $danger:Space bends around you
msc += $danger:Space bends sharply around you!
msc += $danger:sense of stasis
msc += $danger:clumsily bash
msc += $danger:goes berserk
msc += $danger:Forgetting.* will destroy the book
msc += $danger:The blast of calcifying dust hits you
msc += $danger:You are engulfed in calcifying dust
msc += $danger:^It .* you
msc += $danger:[^f]Something.*you[^r]
msc += $danger:grabs you[^r]
msc += $danger:you convulse
msc += $danger:is unaffected
msc += $danger:blinks into view
msc += $danger:seems to speed up
msc += $danger:You feel yourself slow down
msc += $danger:The alarm trap emits a blaring wail
msc += $danger:The mark upon you grows brighter.
msc += $danger:flickers (and vanishes|out of sight)
msc += $danger:Terrible wounds (open|spread)
msc += $danger:The acid burns
msc += $danger:The.*is recalled
msc += $danger:The.*blows on a signal horn!
msc += $danger:You miscast
msc += $danger:zaps a wand
msc += $danger:You are no longer berserk
msc += $danger:You suddenly lose the ability to move
msc += $danger:Your.*glows black for a moment
msc += $danger:You are caught in a web
msc += $danger:You are knocked back by the lance of force
msc += $danger:You are knocked back by the blast of cold
msc += $danger:You are knocked back by the great wave of water
msc += $danger:You feel very sick
msc += $danger:Your.*falls away
msc += $danger:splits in two
msc += $danger:assumes the form|sacrifices itself
msc += $danger:Necromantic energies
msc += $danger:You feel an extremely numb sensation
msc += $danger:You feel jittery
msc += $danger:You are caught in (a|the) (net|web)
msc += $danger:You become entangled in (a|the) (net|web)
msc += $danger:You fall asleep
msc += $danger:The forest starts to sway and rumble
msc += $danger:Vines fly forth from the trees!
msc += $danger:Roots grasp at your
msc += $danger:Roots rise up from beneath you and drag you back to the ground
msc += $danger:The.*picks up a wand
msc += $danger:You struggle against (a|the) (net|web)
msc += $danger:You struggle to escape the net
msc += $danger:The.*engulfs you in water
msc += $danger:Your magical defenses are stripped away
msc += $danger:appears out of thin air
msc += $danger:You feel less protected from missiles
msc += $danger:The power of Zot is invoked against
msc += $danger:you fail to dodge
msc += $danger:Death has come for you
msc += $danger:Your body is wracked with pain
msc += $danger:You sense an overwhelmingly malignant aura
msc += $danger:Space twists in upon itself
msc += $danger:Strange energies course through your body
msc += $danger:You feel haunted
msc += $danger:Your.*suddenly stops moving
msc += $danger:You feel incredibly sick
msc += $danger:You don't have enough magic
msc += $danger:You haven't enough magic at the moment
msc += $danger:You (fall|are sucked) into a shaft
msc += $danger:seems to grow stronger
msc += $danger:Dowan seems to find hidden reserves of power
msc += $danger:You struggle to resist
msc += $danger:You barely resist
msc += $danger:You turn into an animated tree
msc += $danger:Your roots penetrate the ground
msc += $danger:is no longer charmed
msc += $danger:You try to slip out of the net
msc += $danger:You become entangled in the net
msc += $danger:You feel a build-up of mutagenic energy
msc += $danger:You cannot pacify this monster
msc += $danger:You feel a (horrible|terrible) chill
msc += $danger:You are burned terribly
msc += $danger:moth of wrath (goads|infuriates) the
msc += $danger:you trip and fall back down the stairs
msc += $danger:the glow from your corona prevents you from becoming completely invisible
msc += $danger:A red film seems to cover your vision as you go berserk
msc += $danger:Your limbs are stiffening
msc += $danger:You have turned to stone
msc += $danger:Draining that being is not a good idea
msc += $danger:You feel.*ill
msc += $danger:Something feeds on your intellect
msc += $danger:The barbed spikes become lodged in your body
msc += $danger:You feel your translocation being delayed
msc += $danger:You fail to use your ability
msc += $danger:Oh no! You have blundered into a Zot trap
msc += $danger:Wisps of shadow swirl around
msc += $danger:The.*grows two more
msc += $danger:There is a sealed passage
msc += $danger:doors? slams? shut
msc += $danger:A basket of spiders falls from above
msc += $danger:is bolstered by the flame
msc ^= $danger:Mennas' surroundings become eerily quiet
msc += $danger:attempts to bespell you
msc += $danger:You feel horribly lethargic
msc += $danger:firmly anchored in space
msc += $danger:You stop (a|de)scending the stairs
msc += $danger:You tear a large gash into the net
msc += $danger:reflects
msc += $danger:The walls disappear
msc += $danger:You cannot afford.*fee
msc += $danger:This weapon is already enchanted
msc += $danger:You feel.*sluggish
msc += $danger:You no longer adapt resistances upon receiving elemental damage
msc += $danger:The storm surrounding you is now too weak to repel missiles
msc += $danger:You feel extremely strange
msc += $danger:You feel rather ponderous
msc += $danger:That seemed strangely inert
msc += $danger:You can't unwield your weapon to draw a new one
msc += $danger:the volcano erupts with a roar
msc += $danger:Your guardian golem overheats
msc += $danger:burn any scroll you tried to read
msc += $danger:You are blown backwards
msc += $danger:It is caustic
msc += $danger:Not only inedible but also greatly harmful
msc += $danger:evokes.*(amulet|ring)
msc += $danger:take too long for a potion to reach your roots
msc += $danger:There was something very wrong with that liquid
msc += $danger:You cannot move
msc += $danger:stands defiantly in death's doorway
msc += $danger:twongs alarmingly
msc += $danger:You( suddenly)? feel( more| all small and)? vulnerable
msc += $danger:The poison in your body grows stronger
msc += $danger:You are being crushed by all of your possessions
msc += $danger:You are carrying too much
msc += $danger:You draw Wild Magic
msc += $danger:You draw the Helix
msc += $danger:This potion can/'t work under stasis
msc += $danger:Your icy (armour|shield) evaporates
msc += $danger:You struggle to detach yourself from the web
msc += $danger:You are more confused
msc += $danger:You are confused
msc += $danger:breaks free
msc += $danger:You.*re too confused
msc += $danger:Your skin stops crawling
msc += $danger:Your attempt to break free
msc += $danger:Your resistance to elements expires
msc += $danger:You are blasted by holy energy
msc += $danger:You feel uncertain
msc += $danger:You are firmly grounded in the material plane once more
msc += $danger:The writing blurs in front of your eyes
msc += $danger:You cannot cast spells while unable to breathe
msc += $danger:You feel your rage building
msc += $danger:You feel a little less
msc += $danger:This card doesn't seem to belong here
msc += $danger:You flicker back
msc += $danger:something.*blocking the
msc += $danger:You slice into (a|the) (net|web)
msc += $danger:It doesn't seem very happy
msc += $danger:You have been turned into a pig
msc += $danger:comes? into view
msc += $danger:You feel quite a bit less full
msc += $danger:Your unstable footing causes you to fumble your attack
msc += $danger:You are being weighed down by all of your possessions
msc += $danger:flinch away in fear
msc += $danger:is completely unfazed by your meager offer of peace
msc += $danger:deflects the
msc += $danger:The blink frog basks in the distortional energy
msc += $danger:appears unharmed
msc ^= $danger:You and your allies can no longer gain power from killing the unholy and evil
msc += $danger:You have lost your religion
msc += $danger:Your shroud unravels
msc += $danger:Your attacks are no longer magically infused
msc += $danger:You feel your attacks grow feeble
msc += $danger:Magical energy is drained from your
msc += $danger:A chorus of chattering voices calls out to you
msc += $danger:You can no longer
msc += $danger:The.*shudders
msc ^= $danger:Your unholy and evil allies forsake you
msc += $danger:Your transformation has ended
msc += $danger:Nothing appears to have answered your call
msc += $danger:The grasping roots prevent you from becoming airborne
msc += $danger:You kill your
msc += $danger:You feel less regenerative
msc += $danger:Lernaean hydra knocks down a tree
msc += $danger:You are caught in an explosion of electrical discharges
msc += $danger:bends your attack away
msc += $danger:Your song has ended
msc += $danger:goes into a battle-frenzy
msc += $danger:Your aura of abjuration expires
msc += $danger:Your.*is blown up
msc += $danger:There's only one card left
msc += $danger:You deal a card
msc += $danger:darts out from under the net
msc += $danger:You wield the.*\'s
msc += $danger:dips into the water
msc += $danger:You destroy your
msc += $danger:You're too exhausted to jump
msc += $danger:Your battlesphere expends the last of its energy and dissipates
msc += $danger:You feel your bond with your battlesphere wane
msc += $danger:Your battlesphere wavers and loses cohesion
msc += $danger:You lose concentration completely
msc += $danger:go into a battle-frenzy
msc += $danger:You can't jump while in water
msc += $danger:staircase.*moves
msc += $danger:You wield
msc += $danger:is filled with.*inner flame
msc += $danger:You feel guilty
msc += $danger:You feel extremely guilty
msc += $danger:picks up.*throwing net
msc += $danger:You feel less protected from physical attacks
msc ^= $danger:Your.*falters for a moment
msc += $danger:Mutagenic energy flows through the plutonium sword
msc += $danger:Your.*is incinerated
msc ^= $danger:begins absorbing vital energies
msc += $danger:Blessed fire suddenly surrounds you
msc ^= $danger:Your.*is poisoned
msc ^= $danger:Your.*looks even sicker
msc ^= $danger:Your.*is no longer beserk
msc += $danger:You swing wildly
msc += $danger:You lose your focus
msc += $danger:You feel threatened and lose the ability
msc ^= $danger:Your.*looks rather confused

# Item Destruction, gaining bad mutations, or losing good ones, penance, and gong
msc += $item_dmg:Your teeth shrink to normal size
msc += $item_dmg:Your.*scales disappear
msc += $item_dmg:You feel a strong urge to yell
msc += $item_dmg:Your wild genetic ride slows down
msc += $item_dmg:The barb on your tail disappears
msc += $item_dmg:Your wings shrivel and weaken
msc += $item_dmg:You feel very strange
msc += $item_dmg:You feel conductive
msc += $item_dmg:A chill runs up and down your throat
msc += $item_dmg:You feel forlorn
msc += $item_dmg:Your skin no longer functions as natural camouflage
msc += $item_dmg:Your natural healing is weakened
msc += $item_dmg:Your rate of healing slows
msc += $item_dmg:Your talons dull and shrink into feet
msc += $item_dmg:You feel genetically unstable
msc += $item_dmg:The horns on your head shrink a bit
msc += $item_dmg:You feel an ache in your throat
msc += $item_dmg:You feel yourself wasting away
msc += $item_dmg:You feel angry
msc += $item_dmg:You feel a little pissed off
msc += $item_dmg:Your hooves look more like feet
msc += $item_dmg:A piece of fruit is consumed
msc += $item_dmg:pieces of fruit are consumed
msc += $item_dmg:You feel slightly disoriented
msc += $item_dmg:Your system partially rejects artificial healing
msc += $item_dmg:You feel even more weirdly uncertain
msc += $item_dmg:You feel weirdly uncertain
msc += $item_dmg:The drain falls to bits
msc += $item_dmg:acid corrodes
msc ^= $item_dmg:freezes? and shatters?
msc += $item_dmg:covered with spores
msc += $item_dmg:rots? away
msc += $item_dmg:It has a very clean taste
msc += $item_dmg:You feel your flesh rotting away
msc += $item_dmg:You are engulfed in dark miasma
msc += $item_dmg:You feel very guilty
msc += $item_dmg:That really hurt
msc += $item_dmg:You fall into the water
msc += $item_dmg:PTOANNNG
msc += $item_dmg:PANG
msc += $item_dmg:GONNNNG
msc += $item_dmg:BOUMMMMG
msc += $item_dmg:SHROANNG
msc += $item_dmg:BONNNG
msc += $item_dmg:You will pay for your transgression. mortal
msc += $item_dmg:You hear a distant slurping noise
msc ^= $item_dmg:picks up.*(potions?|scrolls?|wand)
msc += $item_dmg:drinks a potion
msc += $item_dmg:You hear a zap
msc += $item_dmg:reads a scroll
msc += $item_dmg:Mutagenic energies flood into your body
msc += $item_dmg:your body twists? and deforms?
msc += $item_dmg:You really shouldn't be using
msc += $item_dmg:You die.
msc += $item_dmg:You are engulfed in mutagenic fog
msc += $item_dmg:You feel the urge to shout
msc += $item_dmg:Your vision blurs
msc += $item_dmg:You feel frail
msc += $item_dmg:the book crumbles to dust
msc += $item_dmg:Your thinking seems confused
msc += $item_dmg:You are heavily infused with residual magics
msc += $item_dmg:Your vision seems duller
msc += $item_dmg:You feel less energetic


msc += $warning:You yowl
msc += $warning:You scream at
msc += $warning:is no longer distracted by gold
msc += $warning:boulder beetle smashes into something
msc += $warning:grate falls apart
msc += $warning:Your passage of Golubria closes with a snap
msc += $warning:is no longer weakened
msc += $warning:Something blocks
msc += $warning:Your aim is not that steady anymore
msc += $warning:You feel strangely alone
msc += $warning:You feel the tide rushing in
msc += $warning:Failed to move towards target
msc += $warning:Your protection from physical attacks is fading
msc ^= $warning:The Screaming Sword
msc += $warning:A large net falls onto you
msc += $warning:You stop recalling your allies
msc += $warning:You feel a little guilty
msc += $warning:snaps.*out of.*fear
msc += $warning:Your stasis keeps you stable
msc += $warning:You retract your mandibles
msc += $warning:The boots cling to your feet
msc ^= $warning:Your ring of flames is guttering out
msc += $warning:reforms as a
msc += $warning:You draw the first five cards.*and discard the rest
msc += $warning:You have damaged your brain
msc += $warning:A thin mist springs up around you
msc += $warning:The mangrove smolders and burns
msc += $warning:You feel your anger subside
msc += $warning:You feel nervous for a moment
msc += $warning:Your.*is burned terribly
msc += $warning:Your.*is frozen
msc += $warning:There is nothing there. so you fail to move
msc += $warning:You enter the passage of Golubria
msc += $warning:You start to feel a little slower
msc += $warning:drowns your?
msc += $warning:puts on a
msc += $warning:Faint laughter comes from somewhere
msc += $warning:shroud bends your.*attack away
msc += $warning:shadowy figures dance through the air in front of you
msc += $warning:This room is filled with shadowy figures
msc += $warning:You feel spirits watching over you
msc += $warning:You feel a genetic drift
msc += $warning:You return to the normal time flow
msc += $warning:reappears nearby
msc += $warning:I'll put it outside for you
msc += $warning:A pair of horns grows on your head
msc += $warning:is held in a (net|web)
msc += $warning:Smoke pours forth from your.*of chaos
msc += $warning:You cannot go berserk while under stasis
msc += $warning:You feel less woody
msc += $warning:is no longer paralysed
msc += $warning:The antennae on your head shrink away
msc += $warning:You feel less stealthy
msc += $warning:falls into the lava
msc ^= $warning:Your spellspark servitor disappears
msc += $warning:The shock serpent's electric aura discharges
msc += $warning:The air sparks with electricity
msc += $warning:You sense an evil presence
msc += $warning:Jory draws you further into his thrall
msc += $warning:grabs your
msc += $warning:You shudder from the earth-shattering force
msc += $warning:Smoke pours from your
msc += $warning:curses noisily
msc += $warning:is no longer blind
msc += $warning:Lightning arcs down from a storm cloud
msc += $warning:You feel strangely numb
msc += $warning:You feel less sure on your feet
msc += $warning:The air around you crackles with electrical energy
msc += $warning:The vortex of raging winds lifts you up
msc += $warning:creates a blast of rain
msc += $warning:shimmers and seems to become two
msc += $warning:Your ball lightning explodes
msc += $warning:There is a sudden explosion of flames
msc += $warning:You feel extremely nervous for a moment
msc += $warning:The orb fizzles
msc += $warning:A film of ice covers the
msc += $warning:That ambrosia tasted strange
msc += $warning:orb of destruction hits.*wall
msc += $warning:Something tries to affect you
msc += $warning:You block its attack
msc += $warning:A large net falls down
msc += $warning:You have made a black mistake
msc += $warning:You are stuck in your current form
msc += $warning:You feel like a pig
msc += $warning:Your hearing returns
msc += $warning:You feel less in control of your magic
msc += $warning:You feel your magical power running wild
msc += $warning:are frozen
msc += $warning:Something hits you but does no damage
msc += $warning:You turn into a bat
msc += $warning:A demon appears
msc += $warning:twists and deforms
msc += $warning:There is a sudden blast of acid
msc += $warning:Die. mortal
msc += $warning:You choke on the stench
msc += $warning:Your summoned allies are left behind
msc += $warning:You feel that your aim is more steady
msc += $warning:There's a creature in the
msc += $warning:They are\:
msc += $warning:A card falls out of the deck
msc += $warning:(dart|javelin|large rock|stone|boomerang) disappears in a puff of smoke
msc += $warning:You can't close doors while held in a net
msc += $warning:A slime creature suddenly
msc += $warning:You feel closer to the material plane
msc += $warning:leaps out from its hiding place
msc += $warning:You stop removing your armour
msc += $warning:You smell decay
msc += $warning:You feel a malignant aura surround you
msc += $warning:briefly surrounded by a scintillating aura of random colours
msc += $warning:looks stronger
msc += $warning:You have difficulty breathing
msc += $warning:The heat melts your.*(armour|shield)
msc += $warning:You are engulfed in a cloud of spores
msc += $warning:You feel less perceptive
msc += $warning:A profound silence engulfs you
msc += $warning:An unnatural silence engulfs you
msc ^= $warning:Hurry and find it before the entrance collapses
msc += $warning:Your memory of.*unravels
msc += $warning:You speak a Word of immense power
msc += $warning:seems to move somewhat quicker
msc += $warning:steals.*your
msc += $warning:A tentacle flies out from the starspawn's body
msc += $warning:The explosive bolt releases an explosion
msc += $warning:There is a Zot trap here
msc += $warning:You enter a teleport trap
msc += $warning:You need to enable at least one skill for training
msc += $warning:You (resume|stop) training
msc += $warning:You feel slightly jumpy
msc += $warning:You are splashed with acid
msc += $warning:ticking.*clock
msc += $warning:dying ticks
msc += $warning:distant snort
msc += $warning:odd grinding sound
msc += $warning:creaking of ancient gears
msc += $warning:floor suddenly vibrates
msc += $warning:a sudden draft
msc += $warning:coins.*counted
msc += $warning:tolling.*bell
msc += $warning:fails to return
msc += $warning:Something appears in a flash of light
msc += $warning:you turn into a fiery being
msc += $warning:no longer ripe
msc += $warning:The wave splashes down
msc += $warning:The spell fizzles
msc += $warning:The crackling of melting ice is subsiding rapidly
msc += $warning:seems to gain new vigour
msc += $warning:You feel strangely stable
msc += $warning:(asks|barks|bellows|boasts|brags|breathes|buzzes|cackles|calls|caws|chants|cheers)
msc += $warning:(chilling moan|complains|cries|croak|curses loudly|embarks|explains|Floosh|gibbers|giggles)
msc += $warning:(grits|groans|growls|grumbles|grunts|gurgles|hisses|jeers|keens|laughs|launches|makes a sound)
msc += $warning:(mewls|moans|mumbles|murmurs|mutters|pleads|prattles|preaches|queries|recites|roars|says)
msc += $warning:(scowls|screams|screeches|shout|shriek|sighs|sings|snarls|sneers|snorts|threatens|trumpets)
msc += $warning:(utters an oath|wail|wails|whimpers|whisper|yells)
msc += $warning:you roar
msc += $warning:imitates the bagpipes
msc += $warning:looks more energetic
msc += $warning:suddenly curses
msc += $warning:Dowan breathes
msc += $warning:Dowan shakes his head
msc += $warning:You hear strange voices
msc += $warning:You hear
msc += $warning:You drop
msc += $warning:You hear an irritating high-pitched whine
msc += $warning:You hear snatches of song
msc += $warning:seems more stable
msc += $warning:opens the (door|gate|large door)
msc += $warning:dissolves into sparkling lights
msc += $warning:[^un]wields
msc += $warning:There is a portal leading out of here
msc += $warning:Natasha's spirit plunges in to the ground
msc += $warning:Natasha's spirit rises from its lifeless body
msc += $warning:wears
msc += $warning:You are.*contaminated
msc += $warning:blinks
msc += $warning:You are starting to lose your buoyancy
msc += $warning:You float gracefully downwards
msc += $warning:Your surroundings suddenly seem different
msc += $warning:It (begins to drip with poison|bursts into flame|glows with a cold blue light|softly glows with a divine radiance|stops glowing)
msc += $warning:Your.*drips with poison
msc += $warning:You sense an unholy aura
msc += $warning:It is covered in frost
msc += $warning:The shock serpent begins to gather electrical charge
msc += $warning:moves out of view
msc += $warning:basks in the mutagenic energy
msc += $warning:Several doors burst open
msc += $warning:Flickering shadows surround you
msc += $warning:You.*one of the.*heads off
msc += $warning:slime creatures merge
msc += $warning:roars a battle-cry
msc += $warning:The.*is healed
msc += $warning:You stumble backwards
msc += $warning:Are you sure you want to stumble around while confused
msc += $warning:it creaks loudly
msc += $warning:The.*explodes
msc += $warning:You are caught in (a fiery explosion|an explosion of ice and frost)
msc += $warning:stops burning
msc += $warning:(The |.*)is healed
msc += $warning:You feel less studious
msc += $warning:(corpses?|macabre mass) merges with
msc += $warning:You start to feel a little uncertain
msc += $warning:corpses? begins to drag
msc += $warning:corpses meld into an agglomeration of writhing flesh
msc += $warning:beckons forth a restless soul
msc += $warning:Something reaches out for you
msc += $warning:Something tries to feed on your intellect
msc += $warning:You feel a brief urge to hack something to bits
msc += $warning:Pain shudders through your
msc += $warning:The.*passes through your shield
msc += $warning:draws strength from your injuries
msc += $warning:The.*pierces through
msc += $warning:The forest fire spreads
msc += $warning:The tree burns like a torch
msc += $warning:magical defenses are stripped away
msc += $warning:You blink
msc += $warning:You teleport
msc += $warning:You step into.*shadow
msc += $warning:Grasping roots rise from the ground around the
msc += $warning:The winds start to flow at the.*will
msc += $warning:The .*(are|is) blown away
msc += $warning:goes into a frenzy at the smell of blood
msc += $warning:Something picks up
msc += $warning:You smell burning wood
msc += $warning:stumbles backwards
msc += $warning:looks slightly unstable
msc += $warning:slips into darkness
msc += $warning:The air around.*erupts in flames
msc += $warning:hops backward while attacking
msc += $warning:violent explosion of flames
msc += $warning:turns its malign attention towards you
msc += $warning:Splash!
msc += $warning:Harold gasps with his last breath
msc += $warning:You see a puff of smoke
msc += $warning:pour from your
msc += $warning:Tentacles burst out of the water
msc += $warning:calls forth a grand avatar
msc += $warning:focuses on the pain
msc += $warning:suddenly seems more agile
msc += $warning:regenerates before your eyes
msc += $warning:You feel corrupt for a moment
msc += $warning:Send 'em back where they came from
msc += $warning:The net rips apart
msc += $warning:Your surroundings seem slightly different
msc += $warning:You are under the weather
msc += $warning:You are standing in the rain
msc += $warning:The rain has left you waist-deep in water
msc += $warning:We do not forgive those who trespass against us
msc += $warning:A.*appears from out of thin air
msc += $warning:looks more healthy
msc += $warning:A mysterious force pulls you upwards
msc += $warning:punctures the fabric of the universe
msc += $warning:degenerates into a cloud
msc += $warning:wounds heal themselves
msc += $warning:is no longer moving slowly
msc += $warning:is completely healed
msc += $warning:You heal
msc += $warning:It is briefly surrounded by a scintillating aura of random colours
msc += $warning:Partly explored
msc += $warning:There is a shaft here
msc += $warning:You feel that this wand is rather unreliable
msc += $warning:You feel less protected
msc += $warning:You hear a crashing sound
msc += $warning:shatters
msc += $warning:apparitions take form around you
msc += $warning:You feel your magic capacity is already quite full
msc += $warning:pulls away from the web
msc += $warning:withdraws into its
msc += $warning:is no longer petrified
msc += $warning:You remove
msc += $warning:Your.*dissolves into shadows
msc += $warning:Your.*stops moving altogether
msc += $warning:hides itself under the floor
msc += $warning:puts on a burst of speed
msc += $warning:decay slows
msc += $warning:Your.*is caught in
msc += $warning:Thorny briars emerge from the ground!
msc += $warning:You flicker for a moment
msc += $warning:There is a.*altar.*here
msc += $warning:You kneel at the altar
msc += $warning:You feel a strong urge to attack something
msc += $warning:You cannot move away from
msc += $warning:The pull of.*song draws you forwards
msc += $warning:Shadowy forms rise from the deep
msc += $warning:You feel as though you will be slow longer
msc += $warning:disappears!
msc += $warning:Your.*is no longer moving quickly
msc += $warning:You feel your magic capacity decrease
msc += $warning:drains the heat from the surrounding environment
msc += $warning:pounces on you
msc += $warning:A tentacle rises from the water
msc += $warning:comes (down|up) the stairs
msc += $warning:You catch a bit of a chill
msc += $warning:A ballistomycete grows in the wake of the spore
msc += $warning:A fungus suddenly grows
msc += $warning:A toadstool grows
msc += $warning:then quickly surges around you
msc += $warning:There is a sudden explosion of frost
msc += $warning:That was not very filling
msc += $warning:You failed to disarm the trap
msc += $warning:is covered with a thin layer of ice
msc += $warning:draws out.*weapon's spirit
msc += $warning:You are pushed out
msc ^= $warning:Your.*seems to slow down
msc += $warning:thirsts for the lives of mortals
msc += $warning:emits a brilliant flash of light
msc += $warning:is firebranded into
msc += $warning:is no longer bleeding
msc += $warning:The dungeon rumbles around Jorgrun!
msc += $warning:evaporates and reforms as
msc += $warning:You turn into a venomous arachnid creature
msc += $warning:infuriates you
msc += $warning:Your extra speed is starting to run out
msc += $warning:Your skin is crawling a little less now
msc += $warning:You stumble into the trap
msc += $warning:Your transformation is almost over
msc += $warning:You feel magic leave you
msc += $warning:You feel magic returning to you
msc += $warning:Your (horns|talons) disappear
msc += $warning:Tentacles burst from the starspawn
msc += $warning:you must find a gate leading back
msc += $warning:You fall off the wall
msc += $warning:Blech - you need (greens|meat)
msc += $warning:A starcursed mass splits
msc += $warning:You draw the Sage
msc += $warning:You feel a wave of frost pass over you
msc += $warning:The creatures around you are filled with an inner flame
msc += $warning:is filled with an inner flame
msc += $warning:You feel less healthy
msc += $warning:summons a great blast of wind
msc += $warning:Your attack snaps.*out of its fear
msc += $warning:You feel blessed for a moment
msc += $warning:You draw a card
msc += $warning:Walls emerge from the floor
msc += $warning:You feel like more of a target
msc += $warning:is knocked back by the flood of elemental water
msc += $warning:blown away by the wind
msc += $warning:is surrounded by Orcish apparitions
msc += $warning:The.*reappears nearby
msc += $warning:The deck of cards disappears
msc += $warning:The.*looks more experienced
msc += $warning:There is a rocky tunnel leading out of this place here
msc += $warning:Your icy (armour|shield) starts to melt
msc += $warning:Your legs become a tail
msc += $warning:You feel the effects of Trog's Hand fading
msc += $warning:You slam the door shut with a bang
msc += $warning:magical effects unravel
msc += $warning:You awkwardly throw
msc += $warning:You erupt
msc += $warning:The flames covering.*go out
msc += $warning:bleats in terror
msc += $warning:seems to regain.*courage
msc += $warning:You have a feeling of ineptitude
msc += $warning:falls through a shaft
msc += $warning:You cannot throw anything while held in a net
msc += $warning:furiously retaliates
msc += $warning:The blast of chaos engulfs your?
msc += $warning:You are engulfed in seething chaos
msc += $warning:Your song is almost over
msc += $warning:is in the way
msc += $warning:You are too berserk
msc += $warning:The tentacle pulls you backwards
msc += $warning:starcursed mass shudders and
msc += $warning:The kraken squirts a massive cloud of ink
msc += $warning:Wisps of shadow whirl around
msc += $warning:You are too injured to fight recklessly
msc += $warning:shakes off its lethargy
msc += $warning:I don't know how to get there
msc += $warning:Your.*warbles
msc += $warning:chimes melodiously
msc += $warning:erupts into laughter
msc += $warning:makes a deep moaning sound
msc += $warning:raves incoherently
msc += $warning:speaks gibberish
msc += $warning:belts out
msc += $warning:yelps
msc += $warning:goes tick-tock
msc += $warning:gives off a wolf whistle
msc ^= $warning:[e] your.* of resist
msc += $warning:phases out as you
msc += $warning:momentarily phases out
msc += $warning:cracks jokes
msc += $warning:Your orb of destruction dissipates
msc += $warning:regales you with its life story
msc += $warning:parrots the noises around you
msc += $warning:lets out a mournful sigh
msc += $warning:tootles away
msc += $warning:makes a horrible noise
msc += $warning:burps loudly
msc += $warning:You are caught in a violent explosion
msc += $warning:pulses with an eldritch light
msc += $warning:the glow from your magical contamination prevents you from becoming completely invisible
msc += $warning:appears from out of your range of vision
msc += $warning:You stop putting on your armour
msc += $warning:We have you now
msc += $warning:You do not belong in this place
msc += $warning:There is a sudden explosion of magical energy
msc += $warning:Something forms from out of thin air
msc += $warning:You sense a hostile presence
msc += $warning:Trespassers are not welcome here
msc += $warning:You feel a terrible foreboding
msc += $warning:You will not leave this place
msc += $warning:wrenching scream
msc += $warning:before it is too late
msc += $warning:picks up
msc += $warning:Nothing appears to happen
msc += $warning:The dead are
msc += $warning:The boulder beetle hits a closed door
msc += $warning:begin to drag.*along the ground
msc += $warning:merge to form a (large abomination|macabre mass|small abomination)
msc += $warning:Two macabre masses merge
msc += $warning:falls through the shaft
msc += $warning:There is a crawl-hole back to the Lair here
msc += $warning:There is a hole to the Spider Nest here
msc += $warning:You create a pond
msc += $warning:Mennas becomes audible again
msc += $warning:That was extremely unsatisfying
msc += $warning:The wind howls around you
msc += $warning:You are feeling less magically infused
msc += $warning:Something invisible bursts forth from the water
msc += $warning:Something.*misses
msc += $warning:There is a cloud of mutagenic fog here
msc += $warning:howls
msc += $warning:You part the fleshy orifice with a squelch
msc += $warning:The orb of energy explodes
msc += $warning:The air shimmers briefly around you
msc += $warning:You are much too full right now
msc += $warning:turns to fight
msc += $warning:You feel transcendent for a moment
msc += $warning:You're too terrified to move while being watched
msc += $warning:The weapon returns to the
msc += $warning:The queen bee calls on the killer bee to defend her
msc += $warning:You turn into a bat
msc += $warning:Your.*looks incredibly listless
msc += $warning:The mass is resisting your pull
msc += $warning:escapes
msc += $warning:The silence causes your song to end
msc += $warning:You feel (slightly|somewhat) less full
msc += $warning:The light of Elyvilon fails to reach
msc += $warning:The light of Elyvilon almost touches upon
msc += $warning:[^r]pulls free of the water
msc += $warning:Your piety has decreased
msc += $warning:struggles to resist
msc += $warning:You are outlined in light
msc += $warning:Your.*is outlined in light
msc += $warning:You feel momentarily disoriented
msc += $warning:You are now empty
msc += $warning:(prevent|prevents) you from hitting
msc += $warning:The water nymph flows with the water
msc += $warning:summons a
msc += $warning:cannot make way for you
msc += $warning:The horns on your head shrink away
msc += $warning:Your shroud begins to fray at the edges
msc += $warning:You'd need three hands to do that
msc += $warning:Your.*disappears
msc += $warning:That's too.*for you
msc += $warning:The dungeon trembles and rubble falls from the walls
msc += $warning:Finesse? Hah! Time to rip out guts
msc += $warning:You fail to extend your transformation any further
msc += $warning:This spell does not affect your current form
msc += $warning:You can't wield anything in your present form
msc += $warning:Your.*revert to their normal proportions
msc += $warning:Suddenly Natasha's spirit rises from her lifeless body
msc += $warning:Your.*shudders
# Demonspawn gaining a mutation they already have
msc += $warning:Your mutations feel more permanent
msc += $warning:Roots rise up from beneath.*and drag it to the ground
msc ^= $warning:You feel a sudden chill
msc += $warning:You feel hot for a moment
msc += $warning:stop glowing
msc += $warning:The water foams
msc += $warning:The satyr's allies are stirred to greatness
msc += $warning:Mushrooms sprout up around you
msc += $warning:seems less confused
msc += $warning:You could not reach far enough
msc ^= $warning:The golden flame engulfs you
msc += $warning:You shudder
msc += $warning:The giant firefly flashes a warning beacon
msc += $warning:vibrate crazily for a second
msc += $warning:Harold falls down. and clutches his wounds
msc += $warning:You finish recalling your allies
msc += $warning:Your.*wears
msc += $warning:Something (bites|hits) your?
msc += $warning:You feel more confident with your borrowed prowess
msc += $warning:Your hands get new energy
msc += $warning:You squeal for attention
msc ^= $warning:changes into
msc += $warning:The crackle of the magical portal is almost imperceptible now
msc += $warning:blocks (the|you)
msc += $warning:You start to feel a little faster
msc += $warning:You meow for attention
msc += $warning:The lightning arc arcs out of your line of sight
msc += $warning:The lightning arc suddenly appears
msc += $warning:The bush is engulfed in roaring flames
msc += $warning:A yell rips itself from your throat
msc += $warning:Purgy wonders. \"What am I doing in here\?\"
msc += $warning:You create some ball lightning
msc += $warning:dances into the air
msc += $warning:appears
msc += $warning:Your divine protection wanes
msc += $warning:The sheep \"Baaaas\" balefully
msc += $warning:is blown backwards by the freezing wind


msc += $boring:Okay\, then\.
msc += $boring:Your tentacles glow momentarily
msc += $boring:You feel a little dazed
msc += $boring:You feel mildly nauseous
msc += $boring:looks momentarily confused
msc += $boring:Motes of dust swirl before your eyes
msc ^= $boring:You squeeze the fleshy orifice shut
msc += $boring:Gastronok glows a brilliant shade of cerise
msc += $boring:fingertips start to glow
msc += $boring:eyes start to glow
msc += $boring:You smell tea
msc += $boring:Your ghoul eats
msc += $boring:seems to dim momentarily
msc += $boring:The net is caught on your fulminant prism
msc += $boring:The shadows disperse without effect
msc += $boring:You feel woody for a moment
msc += $boring:Your vision is briefly tinged with green
msc ^= $boring:Sigmund is suddenly surrounded by pale red light
msc += $boring:has a weird expression for a moment
msc += $boring:You feel roots moving beneath the ground
msc += $boring:This spell is already in effect
msc ^= $boring:You displace your
msc ^= $boring:whispers something so quietly that you cannot hear
msc ^= $boring:for a moment.*blends into the shadows
msc ^= $boring:picks up a beetle and eats it
msc += $boring:Everything looks hazy for a moment
msc += $boring:There is a strange surge of energy around
msc += $boring:orc priest shimmers for a moment
msc += $boring:orc priest's eyes start to glow
msc += $boring:The weapon returns to your
msc += $boring:Your bandages flutter
msc += $boring:The water in the fountain briefly bubbles
msc += $boring:The bush looks momentarily different
msc += $boring:Dowan's feet meld with the ground. briefly
msc += $boring:briefly looks nauseous
msc += $boring:twitches
msc += $boring:Jessica looks very angry
msc += $boring:You fall off the door
msc += $boring:as though insubstantial
msc += $boring:The Killer Klown sprays water
msc += $boring:The Killer Klown honks
msc += $boring:wriggles its tentacles
msc += $boring:You reach down and part the fleshy orifice
msc += $boring:orb spider pulsates with a strange energy
msc += $boring:orb spider begins to weave its threads into a brightly glowing ball
msc += $boring:Your eyebrows briefly feel incredibly bushy
msc += $boring:briefly appears rusty
msc += $boring:Your.*stops glowing
msc += $boring:Your.*briefly vibrates
msc += $boring:You feel gritty
msc += $boring:You briefly become tangled in your
msc += $boring:Your eyebrows wriggle
msc += $boring:You detect nothing
msc += $boring:Your.*shimmers for a moment
msc += $boring:Your.*eyes start to glow
msc += $boring:Your.*spins!
msc += $boring:grins madly
msc += $boring:You lose your grip on
msc += $boring:The water engulfing you falls away
msc += $boring:The disc glows for a moment
msc += $boring:Your.*briefly glows
msc += $boring:You feel numb
msc += $boring:The chaos spawn grows dozens of eye stalks in order to get a better look at you
msc += $boring:Jory stares carefully at you
msc += $boring:seems to be having trouble coordinating.*its legs
msc += $boring:Your.*flashes
msc += $boring:You create a blast of thin mist
msc ^= $boring:then vanish
msc += $boring:avoids triggering.*trap
msc += $boring:Terence looks scornfully at you
msc += $boring:Sigmund looks at you with fury
msc += $boring:holds.*ground
msc += $boring:The door collapses
msc += $boring:You smell baking bread
msc += $boring:The lightning arc grounds out
msc += $boring:Fannar glares icily
msc ^= $boring:A poisoned needle shoots out and hits your shield
msc += $boring:ghost twirls its
msc += $boring:You attack empty space
msc += $boring:Eustachio twirls his moustache
msc += $boring:is briefly tinged with black
msc += $boring:The dust glows
msc += $boring:Crazy Yiuf scratches his head thoughtfully
msc += $boring:Crazy Yiuf counts something out on his finger
msc += $boring:The crystal guardian glitters
msc += $boring:The wizard's fingertips start to glow
msc += $boring:You are already empty-
msc ^= $boring:the.*shaped block of ice
msc ^= $boring:briefly gains? a (green|red|yellow) sheen
msc += $boring:The great wave of water passes through the water elemental
msc += $boring:shimmers and vanishes
msc += $boring:You do an impromptu tapdance
msc += $boring:You feel uncomfortable
msc ^= $boring:The shadow imp breathes mist at you
msc += $boring:That snozzcumber tasted truly putrid
msc += $boring:The reaper draws a finger across its throat
msc += $boring:Your.*seems to dim momentarily
msc += $boring:Your.*is briefly tinged with black
msc += $boring:Your.*shivers with cold
msc += $boring:A malignant aura surrounds your
msc += $boring:Your.*twitches violently
msc += $boring:The world appears momentarily distorted
msc += $boring:The iron imp grinds its teeth
msc += $boring:unwise to walk into this
msc += $boring:The tree breaks and falls down
msc += $boring:Nessos tries to tell you a complicated story about hydras
msc += $boring:You feel blessed for a moment
msc += $boring:The boulder beetle hits.*wall
msc += $boring:A root reaches out and grasps at passing movement
msc += $boring:Tangled roots snake along the ground
msc += $boring:You smell coffee
msc += $boring:The white imp grinds its teeth
msc += $boring:Your.*imp grins impishly at you
msc += $boring:Your hooves feel warm
msc += $boring:Your.*jumps up and down with excitement
msc += $boring:Strange appendages sprout from
msc += $boring:Suppurating sores blossom under
msc += $boring:That beef jerky was jerk
msc += $boring:A dozen eyes blink open in the
msc += $boring:You part the fleshy orifice
msc += $boring:There is an open fleshy orifice here
msc += $boring:Your hair momentarily turns into snakes
msc += $boring:The crimson imp grinds its teeth
msc ^= $boring:The crimson imp spits at you
msc += $boring:then rights herself and shakes her weapon
msc += $boring:You smell burning hair
msc += $boring:Your nose twitches suddenly
msc += $boring:You are wearing that object
msc += $boring:You can't wield jewellery
msc += $boring:There is an abandoned shop here
msc += $boring:You don't have any such object
msc += $boring:Mennas is caught in a moment of prayer
msc += $boring:You spin around
msc += $boring:Aizul coils and then uncoils
msc += $boring:The tide is released from Ilsuiw's call
msc += $boring:Polyphemus seems to be sizing you up for his next meal
msc += $boring:You can't read that
msc += $boring:You can't drink that
msc += $boring:Your.*falls into the water
msc += $boring:A large abomination twists grotesquely
msc += $boring:collapse into pulpy
msc ^= $boring:You reach to attack
msc += $boring:avoids the shaft
msc += $boring:Your bones ache
msc += $boring:Thank you for shopping
msc += $boring:Your ears itch
msc += $boring:Prince Ribbit hops awkwardly around
msc += $boring:You pass into a different region of Pandemonium
msc += $boring:You smell brimstone
msc += $boring:Something frightening happens
msc += $boring:Multicoloured lights dance before your eyes
msc += $boring:Some snowflakes condense on Fannar
msc += $boring:shape twists and changes as it dies
msc += $boring:No such ability
msc += $boring:The plume of ash settles
msc += $boring:You feel uncomfortably hot
msc += $boring:You can't wield that with a shield
msc ^= $boring:The blast of magma explodes
msc += $boring:Crazy Yiuf glowers
msc += $boring:Crazy Yiuf flaps his cloak
msc += $boring:Crazy Yiuf waves his quarterstaff at you
msc += $boring:You feel lost and a long
msc += $boring:The world around you seems to dim momentarily
msc += $boring:tears through a web
msc += $boring:Pikel waves his whip at you
msc += $boring:Wisps of condensation drift from your
msc += $boring:A chill runs through your body
msc += $boring:Frost covers your body
msc += $boring:numb with cold
msc += $boring:That.*was very bland
msc += $boring:That lemon was rather sour
msc += $boring:You call on the dead to rise
msc += $boring:You can't wear that
msc += $boring:vibrates crazily for a second
msc ^= $boring:The crimson imp breathes (mist|steam) at you
msc += $boring:showing sharp teeth
msc += $boring:Branches wave dangerously above you
msc += $boring:A root lunges up near you
msc += $boring:Maurice looks sneaky
msc += $boring:Suddenly you are surrounded with a pale green light
msc += $boring:really hit the spot
msc += $boring:Grum bares his teeth
msc += $boring:Grum sniffs the air and quickly glances around
msc += $boring:The shadow imp grinds its teeth
msc += $boring:looks to the heavens
msc += $boring:beckons to you
msc += $boring:Your.*struggles to escape
msc += $boring:Your.*struggles against
msc += $boring:Your.*struggles to get unstuck from
msc += $boring:fades away
msc += $boring:You feel electric
msc += $boring:sharp shower of sparks
msc += $boring:pulsates ominously
msc += $boring:You feel earthy
msc += $boring:Sparks of electricity dance between your
msc += $boring:Edmund gestures with his flail
msc += $boring:You feel very uncomfortable
msc += $boring:Xtahua glares at you
msc += $boring:You pass through the gate
msc += $boring:The starspawn's tentacles wither and die
msc += $boring:Trunks creak and shift
msc += $boring:unmelds from your body
msc += $boring:The air around.*crackles with energy
msc += $boring:Something.*the (bush|plant)
msc += $boring:There's nothing there!
msc += $boring:You briefly turn translucent
msc += $boring:unborn seems to be listening
msc += $boring:You can only put on jewellery
msc += $boring:There isn't anything here
msc += $boring:The air around you briefly surges with heat
msc += $boring:Your skin glows momentarily
msc += $boring:You draw two cards from the deck
msc += $boring:You shuffle the cards back into the deck
msc += $boring:The drowned soul returns to the deep
msc += $boring:Your.*stays? behind
msc += $boring:You prostrate yourself
msc += $boring:You shiver with cold
msc += $boring:glows? .* for a moment
msc += $boring:Waves of light ripple over
msc += $boring:Your skin tingles
msc += $boring:looks braver
msc += $boring:You enjoyed that
msc += $boring:Your brain hurts
msc += $boring:becomes somewhat translucent
msc += $boring:generates a fountain of clear water
msc += $boring:You cannot attack while caught
msc += $boring:You cannot throw anything while caught
msc += $boring:grinds (her|his) teeth
msc += $boring:bristles in rage as it notices you
msc += $boring:You feel forgetful for a moment
msc += $boring:The briar patch crumbles away
msc += $boring:You feel momentarily lethargic
msc += $boring:but nothing happens
msc += $boring:Wisps of smoke drift from your
msc += $boring:You smell salt
msc += $boring:tries to hide in the shadows
msc += $boring:stops crackling
msc ^= $boring:Your.*is no longer covered in acid
msc += $boring:You momentarily stiffen
msc += $boring:waves its rhizomes
msc += $boring:The flesh is too rotten for a proper zombie
msc += $boring:You smell (smoke|something weird)
msc += $boring:The floor shifts beneath you alarmingly
msc += $boring:The reaper smiles without lips
msc += $boring:great wave of water passes through
msc += $boring:crushes a nearby insect and laughs
msc += $boring:Welcome back to the Dungeon
msc += $boring:You are blasted with air
msc ^= $boring:There is a collapsed entrance here
msc += $boring:You can't see any susceptible monsters within range! (Use Z to cast anyway.)
msc += $boring:You can't go (down|up) here
msc += $boring:Your hair stands on end
msc += $boring:Wisps of vapour drift from your
msc += $boring:The Killer Klown smiles at you
msc += $boring:the (bush|fungus|plant)
msc += $boring:You are momentarily dazzled by a (brilliant|flash of) light
msc ^= $boring:(flickers out of sight|flickers and vanishes|slips into darkness) for a moment
msc += $boring:The golden flame engulfs your?
msc += $boring:The shaft crumbles and collapses
msc += $boring:An air elemental (forms|merges) itself (from|into) the air
msc += $boring:A corpse collapses into a pulpy mess
msc += $boring:You start (resting|waiting)
msc += $boring:Unknown command
msc += $boring:but (do no|doesn't do any|does no) damage
msc += $boring:miss
msc += $boring:Wisps of poison gas drift from your
msc += $boring:You walk carefully through
msc += $boring:grow from
msc += $boring:withers and dies
msc += $boring:There is nothing on the other side of the stone arch
msc += $boring:misses you
msc += $boring:You block
msc += $boring:You are waved at by a branch
msc += $boring:The trees move their gnarly branches around
msc += $boring:Heat runs through your body
msc += $boring:Lukewarm flames ripple over your body
msc += $boring:stops (dripping with poison|flaming)
msc += $boring:Press.*to see all runes
msc += $boring:There is a.*(door|gate)
msc += $boring:(antennae|eye-stalks|whiskers)
msc += $boring:You feel troubled
msc += $boring:You feel a wave of unholy energy pass over you
msc += $boring:grins evilly
msc += $boring:A huge blade swings just past you
msc += $boring:(The|Something).*disappears
msc += $boring:The.*glitters chillingly
msc += $boring:You feel a strange surge of energy
msc += $boring:There are no unholy or evil weapons here to destroy
msc += $boring:close doors on yourself
msc += $boring:Your.*falls off the wall
msc += $boring:stops rolling
msc += $boring:(gazes forward|pauses|quivers|skips|sputters|stops to sniff|summons a swarm of flies)
msc += $boring:turns its.*gaze
msc += $boring:Your summoned ally is left behind
msc += $boring:That felt strangely unrewarding
msc += $boring:The air around you crackles with energy
msc += $boring:(drops|unwields)
msc += $boring:The battlesphere dissipates
msc += $boring:(The|Your?).*(passes|pick your way) through a web
msc += $boring:passes through a web
msc += $boring:You feel extremely cold
msc += $boring:You feel terrible
msc += $boring:You sense a malignant aura
msc += $boring:You (hold|stand) your ground
msc += $boring:Your.*(holds|stands) its ground
msc += $boring:The.*eats the
msc += $boring:The winds cease moving at the.*will
msc += $boring:The ground creaks as gnarled roots bulge its surface
msc += $boring:rages
msc += $boring:Your acid blob dissolves into a puddle of slime
msc += $boring:You feel a wrenching sensation
msc += $boring:The.*falls off the wall
msc += $boring:The.*jiggles
msc += $boring:The.*looks excited
msc += $boring:Pikel cracks his whip
msc += $boring:slime creature splits
msc += $boring:stops glowing
msc += $boring:splashes around in the water
msc += $boring:tentacles slide back into the water
msc += $boring:(You|reach down and) (close|open) the.*(door|gate)
msc += $boring:You (climb|fly) (down|up)wards
msc += $boring:You go (down|up)
msc += $boring:You fly (down|up) through the gate
msc += $boring:You must enter the number of times for the command to repeat
msc += $boring:Use Z to cast anyway
msc += $boring:There are no items here
msc += $boring:it crumbles to dust
msc += $boring:The hatch slams shut behind you
msc += $boring:There is an empty arch of ancient stone here
msc += $boring:The world spins around you as you enter the gateway
msc += $boring:This spell is.*dangerous to cast
msc += $boring:There is a web.*here
msc += $boring:You pick your way through the web
msc += $boring:You hold your ground
msc += $boring:The floor vibrates
msc += $boring:Sand pours from your
msc += $boring:Strange energies run through your body
msc += $boring:evades a web
msc += $boring:The.*goes (down|up) the
msc += $boring:jumps into the shaft
msc += $boring:Why would you want to do that
msc += $boring:you're not good enough to have a special ability
msc += $boring:holds its.*at the ready
msc += $boring:There is a.*fountain.*here
msc += $boring:Little bolts of electricity crackle over the disc
msc += $boring:tries to grin evilly
msc += $boring:The corpses? collapses? into a pulpy mess
msc += $boring:There is an empty arch of ancient stone
msc += $boring:The runic seals? fades? away
msc += $boring:looks hungrier
msc += $boring:Something drops
msc += $boring:tears the web
msc += $boring:lashes its tail
msc += $boring:smirks and points a slender finger
msc += $boring:The orb of destruction dissipates
msc += $boring:Your (claws|elbows|hands|wings) glow momentarily
msc += $boring:Weird images run through your mind
msc += $boring:safely over a trap
msc += $boring:avoid triggering a
msc += $boring:A net swings high above you
msc += $boring:Natasha extends her claws
msc += $boring:The shadow imp breathes steam at you
msc += $boring:You can't see any susceptible monsters within range
msc += $boring:You are momentarily dazzled by a brilliant light
msc += $boring:You feel momentarily weightless
msc += $boring:You feel uncomfortably cold
msc += $boring:Your fire elemental sizzles in the rain
msc += $boring:Nessos pounds the earth with his hooves
msc += $boring:Frost spreads across the the floor
msc += $boring:You sense an ancient evil watching you
msc += $boring:Your.*(looks|smiles) at you
msc += $boring:You experience a momentary feeling of inescapable doom
msc += $boring:assumes a wrestling stance
msc += $boring:feints to the
msc += $boring:Purgy looks around nervously
msc += $boring:You smell pepper
msc += $boring:You feel faint for a moment
msc += $boring:takes off
msc += $boring:There is a rock-blocked tunnel here
msc += $boring:falls off the
msc += $boring:The bat flutters around in erratic circles
msc += $boring:You swing at nothing
msc += $boring:electric golem crackles and sizzles
msc += $boring:ghost ripples
msc += $boring:Maud (frowns|looks upset)
msc += $boring:There is an ice choked empty arch of ancient stone here
msc += $boring:Sparks fly from your
msc += $boring:crimson imp breathes smoke at you
msc += $boring:Distant voices call out to you
msc += $boring:You are showered with tiny particles of grit
msc += $boring:The scroll reassembles itself in your
msc += $boring:You feel uncomfortably hot
msc += $boring:Nergalle blows her nose
msc += $boring:You release your grip on
msc += $boring:Nergalle looks more energetic
msc += $boring:stampedes away
msc += $boring:fails to trigger a.*trap
msc += $boring:You feel a numb sensation
msc += $boring:You smell sulphur
msc += $boring:There's nothing to (close|open) nearby
msc += $boring:Your.*stumbles backwards
msc += $boring:ghost takes a fighting stance
msc += $boring:You shiver with fear
msc += $boring:Your.*falls like a stone
msc += $boring:You feel a surge of energy from the ground
msc += $boring:You release your grip on
msc += $boring:Your head hurts
msc += $boring:The lightning grounds out
msc += $boring:Your.*feel warm
msc += $boring:This isn't a weapon
msc += $boring:You feel as though nothing has changed
msc += $boring:Blork the orc's eyes start to glow
msc += $boring:Blork the orc shakes
msc += $boring:You smell wet wool
msc += $boring:You create a blast of rain
msc += $boring:There is a rose-covered archway here
msc += $boring:becomes larger for a moment
msc += $boring:falls out of your pack
msc += $boring:leaps into the air
msc += $boring:body glows momentarily
msc += $boring:shimmers violently
msc += $boring:makes a popping sound
msc += $boring:your.*spectral.*

# Enemies taking damage
msc += $good:You (beat|bite|bludgeon|burn|carve|chop|claw|constrict|crush|cut|devastate|dice|drain|electrocute|eviscerate)
msc += $good:You (flatten|fracture|freeze|grab|hammer|headbutt|hit|impale|kick|mangle|maul|open|peck|perforate|pierce|pound)
msc += $good:You (pulverise|pummel|punch|puncture|punish|scratch|sears|shatter|shave|shred|skewer|slash|slice|smack|sock)
msc += $good:You (spit|squash|squeeze|stick|strike|tail-slap|tentacle-slap|thrash|thump|touch|trample|whack|knocked back)
msc += $good:(attacks|bites|burns|carves|chops|claws|constricts|crushes|cuts|drains|draws|electrocutes|engulfs) [^y]
msc += $good:(eviscerates|freezes|gores|grabs|headbutts|hits|hits|kicks|mauls|melts|opens|pecks|perforates) [^y]
msc += $good:(poisons|pulverises|pummels|punches|punctures|sears|shocks|shreds|skewers|slashes|slices|smacks) [^y]
msc += $good:(spits|squashes|sticks|stings|strikes|tail-slaps|tentacle-slaps|touches|tramples|trunk-slaps) [^y]
msc += $good:You smite
msc ^= $good:Your fire elemental burns
msc += $good:is flooded with distortional energies
msc += $good:You draw life from
msc += $good:is struck by the twisting air
msc += $good:burns!
msc += $good:Asterion shares his spectral weapon's damage
msc += $good:is struck by lightning
msc += $good:A guardian golem appears
msc += $good:is covered in liquid flames
msc += $good:is engulfed in
msc += $good:Your.*tramples the
msc += $good:The orb of electricity engulfs the
msc += $good:The (.*hellfire|blast of flame|blast of lightning|blast of magma|explosion) engulfs [^y]
msc += $good:The (explosion of.*fragments|explosion of spores|fiery explosion|fireball|ghostly fireball) engulfs [^y]
msc += $good:The (great blast of fire|plume of ash|stinking cloud) engulfs [^y]
msc += $good:is smitten
msc += $good:struck by your spines
msc += $good:There is a sudden explosion of sparks
msc += $good:is drained
msc += $good:You drain (her|his|its) (magic|power)
msc += $good:You drain the
msc += $good:Something (bites|hits)
msc += $good:is blasted
msc += $good:is burned by your radiant heat
msc += $good:The boulder beetle smashes into the
msc += $good:The golden flame engulfs
msc += $good:The eldritch tentacle writhes
msc ^= $good:The.*pierces through the
msc += $good:Space (bends|warps horribly) around
msc += $good:(convulses|writhes in agony)
msc += $good:is splashed with acid
msc += $good:You feel life coursing into your body
msc += $good:is struck by lightning
msc += $good:is burned by acid
msc += $good:seems to burn from within
msc += $good:Space warps around
msc ^= $good:statue shatters

# Non-damage combat messages
msc += $positive:You pounce on
msc += $positive:but is stunned by your will
msc += $positive:by your wave of power
msc += $positive:is stunned by your will and fails to attack
msc += $positive:The sticky flame splashes onto
msc ^= $positive:Your orcs go into a battle-frenzy
msc += $positive:falters in the face of your power
msc += $positive:in retribution by your aura
msc += $positive:Your slowness suddenly goes away
msc += $positive:is no longer regenerating
msc += $positive:You repair your equipment
msc += $positive:You extend your infusion
msc += $positive:You draw (the Helm|Dowsing)
msc += $positive:You shrug off the repeated paralysis
msc ^= $positive:You begin infusing your attacks with magical energy
msc += $positive:It gets dark
msc += $positive:is outlined in light
msc += $positive:moth of wrath (goads|infuriates) your
msc += $positive:Some water evaporates in the bright sunlight
msc += $positive:You become one with your weapon
msc += $positive:Your bond becomes stronger
msc += $positive:A magical shield forms in front of you
msc += $positive:Your attacks no longer feel as feeble
msc += $positive:You feel odd
msc += $positive:The shadowy forms in the deep grow still as others approach
msc += $positive:You renew your portal
msc += $positive:You begin teleporting projectiles to their destination
msc += $positive:is no longer invulnerable
msc += $positive:blocks its attack
msc += $positive:sizzles in the rain
msc += $positive:gets badly buffeted
msc += $positive:Your legs become a tail as you enter the water
msc += $positive:You feel a sudden desire to slay dragons
msc += $positive:You feel weakened for a moment
msc += $positive:Your stone body feels more resilient
msc += $positive:You swoop lightly up into the air
msc += $positive:You feel very comfortable in the air
msc += $positive:The air around you leaps into flame
msc += $positive:is knocked back by the great wave of water
msc += $positive:Your.*wounds heal themselves
msc += $positive:is recalled
msc += $positive:You renew your shroud
msc += $positive:One of your tentacles grows a vicious spike
msc += $positive:A mana viper appears with a sibilant hiss
msc += $positive:melts!
msc += $positive:You extend your mandibles
msc ^= $positive:Your?.*appears? unharmed
msc += $positive:You finish merging with the rock
msc += $positive:You gain the combat prowess of a mighty hero
msc += $positive:shroud falls apart
msc += $positive:Your.*glows blue
msc += $positive:your mind becomes perfectly clear
msc += $positive:You create a blast of noxious fumes!
msc += $positive:Roots rise up to grasp you
msc += $positive:is no longer moving quickly
msc += $positive:You create a snake
msc += $positive:apparition takes form in the air
msc += $positive:The rubble rises up and takes form
msc += $positive:You begin to abjure the creatures around you
msc += $positive:You extend your aura of abjuration
msc += $positive:A divine shield forms around you
msc += $positive:Your attacks no longer feel as feeble
msc += $positive:Your shroud bends.*attack away
msc += $positive:illusion disappears in a puff of smoke
msc += $positive:A beastly little devil appears in a puff
msc += $positive:Your.*is no longer encased in ice
msc += $positive:You deflect
msc += $positive:The lightning arcs
msc += $positive:is knocked back by the lance of force
msc += $positive:is dazzled
msc += $positive:is doused terribly
msc += $positive:You summon a servant imbued with your destructive magic
msc += $positive:You are suffused with power
msc += $positive:The sheep.*panic
msc += $positive:The sheep turns to a blind rush
msc += $positive:Smoke pours from your nose
msc += $positive:The trap is out of ammunition
msc += $positive:You dart out from under the net
msc += $positive:The manticore spikes snap loose
msc += $positive:Your jumping spider.*pounces on the
msc += $positive:You are unaffected
msc += $positive:no longer looks unusually strong
msc += $positive:The area is filled with flickering shadows
msc += $positive:flinches away
msc += $positive:The.*is (deflected|repelled)
msc += $positive:Your.*is no longer paralysed.
msc += $positive:Your.*seems less confused
msc += $positive:You feel less contaminated with magical energies
msc += $positive:Your.*breaks free
msc += $positive:You feel momentarily confused
msc += $positive:That potion was really gluggy
msc += $positive:You( easily| partially)? resist
msc += $positive:Your skin crawls
msc += $positive:You draw out your weapon's spirit
msc += $positive:You catch the
msc += $positive:fails to defend (herself|himself|itself)
msc += $positive:falters for a moment
msc += $positive:You feel invigorated
msc += $positive:flops around on dry land
msc += $positive:You escape
msc += $positive:glows a violent red
msc += $positive:You emit a cloud
msc += $positive:icy envelope dissipates
msc ^= $positive:appears confused
msc += $positive:looks drowsy
msc += $positive:is caught in a (net|web)
msc += $positive:struggles to get unstuck from the (net|web)
msc += $positive:loses its grip on you
msc += $positive:looks rather.*confused
msc ^= $positive:The sentinel's mark upon you fades away
msc += $positive:The lost soul (fades away|flickers out)
msc += $positive:You turn into a creature of crystalline ice
msc ^= $positive:The.*dark mirror aura disappears
msc += $positive:is no longer berserk
msc += $positive:You wake up
msc += $positive:The grasping roots settle back into the ground
msc += $positive:The forest abruptly stops moving
msc += $positive:You feel more buoyant
msc += $positive:You fly up into the air
msc += $positive:You gasp with relief as air once again reaches your lungs
msc += $positive:A film of ice covers your body
msc += $positive:Your.*has recharged
msc += $positive:you pull free of the water engulfing you
msc += $positive:You feel a surge of unholy energy
msc += $positive:your?.*stops? burning
msc += $positive:begins to rapidly decay
msc += $positive:Your possessions no longer seem quite so burdensome
msc += $positive:You feel in control
msc += $positive:You feel odd for a moment
msc += $positive:suddenly stops moving
msc += $positive:is poisoned
msc += $positive:looks even sicker
msc += $positive:A film of ice covers your body
msc += $positive:is stunned!
msc += $positive:is flash-frozen
msc += $positive:seems to slow down
msc += $positive:is moving more slowly
msc += $positive:stops moving altogether
msc += $positive:Your skin hardens
msc += $positive:Your new body merges with your .* armour
msc += $positive:gives you a mild electric shock
msc += $positive:Eating
msc += $positive:the sound returns
msc += $positive:Your icy armour thickens
msc += $positive:The naga ritualist's toxic aura wanes
msc += $positive:Your.*pulls away from the web
msc += $positive:You become transparent for a moment
msc += $positive:is charmed
msc += $positive:Your skin feels harder
msc += $positive:Shadowy shapes form in the air around you
msc += $positive:is burned terribly
msc += $positive:[^y].*is frozen
msc += $positive:You furiously retaliate
msc += $positive:The scroll dissolves into smoke
msc ^= $positive:Your.*reflects
msc ^= $positive:You reflect
msc += $positive:is no longer unusually agile
msc += $positive:struggles to blink free from constriction
msc += $positive:You pull the items towards yourself
msc += $positive:the former slaves? thanks? you
msc += $positive:Something gets caught in the net
msc += $positive:the hog turns into a human
msc += $positive:the hogs revert to their human forms
msc += $positive:You feel the strange sensation of being on two planes at once
msc += $positive:A flood of magical energy pours into your mind
msc += $positive:You feel the material plane grow further away
msc += $positive:You momentarily phase out as.*passes through you
msc += $positive:You feel less exhausted
msc ^= $positive:Your.*(resist[^a]|resists|unaffected)
msc += $positive:The flame cauterises the wound
msc += $positive:the.*last head off
msc += $positive:You carefully extract the manticore spikes from your body
msc += $positive:You melt the
msc += $positive:has finally been put to rest
msc += $positive:begins to bleed from.*wounds
msc += $positive:Your.*draws strength from
msc += $positive:You feel yourself moving faster
msc += $positive:looks sick
msc += $positive:Your feet morph into talons
msc += $positive:You grow a pair of large bovine horns
msc += $positive:You extend your transformation
msc += $positive:Your.*turns? into razor-sharp scythe blades?
msc += $positive:You conjure a globe of magical energy
msc += $positive:You imbue your battlesphere with additional charge
msc += $positive:You feel resistant
msc += $positive:You are no longer poisoned
msc += $positive:looks frightened
msc += $positive:The.*is outlined in light
msc += $positive:You feel quick
msc += $positive:You no longer feel sluggish
msc += $positive:You feel odd for a moment
msc += $positive:returns to your pack
msc += $positive:Space distorts slightly along a thin shroud covering your body
msc += $positive:You are covered in a thin layer of ice
msc += $positive:You feel (clumsy|dopey|weak) for a moment
msc += $positive:stops singing
msc += $positive:and things crawl out
msc += $positive:You feel more catlike
msc += $positive:A crackling disc of dense vapour forms in the air
msc += $positive:icy armour evaporates
msc += $positive:Your.*looks invigorated
msc += $positive:repels the curse
msc += $positive:Yoink! You pull the item towards yourself
msc += $positive:The disc of vapour around you crackles
msc += $positive:turns into a zombie
msc += $positive:You summon
msc += $positive:hydra's last head off
msc += $positive:You feel a.*surge of power
msc += $positive:magic leaks into the air
msc += $positive:You focus on the pain
msc += $positive:Your.*darts out from under the net
msc += $positive:struggles to escape constriction
msc += $positive:submits to your will
msc += $positive:You channel some magical energy
msc += $positive:is caught in the net
msc += $positive:struggles (against|to escape) the net
msc += $positive:Your magic seems less tainted
msc += $positive:You shudder from the blast and a jelly pops out
msc += $positive:looks weaker
msc += $positive:falls into the water
msc += $positive:You fade into the shadows
msc += $positive:life force is offered up
msc += $positive:is calmed by your holy aura
msc ^= $positive:You fade into invisibility
msc ^= $positive:grand avatar fades into the ether
msc ^= $positive:Your attacks are magically infused
msc ^= $positive:You feel protected from missiles
msc ^= $positive:Your.*is no longer moving slowly
msc ^= $positive:You are no longer (entranced|glowing)
msc ^= $positive:You feel as if something is helping you
msc += $positive:appears in a shower of sparks
msc += $positive:Malign forces permeate your being
msc += $positive:A glowing mist starts to gather
msc ^= $positive:begin to glow red
msc ^= $positive:begin to glow brighter

#msc += $verypositive:
msc ^= $verypositive:The.*zombie.*rots away
msc += $verypositive:You feel buoyant
msc ^= $verypositive:You feel very safe from missiles
msc ^= $verypositive:You are no longer firmly anchored in space
msc += $verypositive:Magical energy flows into your mind!
msc ^= $verypositive:The terrible wounds on your body vanish
msc += $verypositive:Your.*rumbles
msc += $verypositive:You feel life flooding into your body
msc += $verypositive:You feel purified
msc += $verypositive:You feel more resilient
msc += $verypositive:You get a glimpse of the first card
msc += $verypositive:You turn into a swirling mass of dark shadows
msc += $verypositive:You feel nimbler
msc += $verypositive:the tentacle is hauled back through the portal
msc += $verypositive:You feel more in control of your magic
msc += $verypositive:releases its grip on you
msc += $verypositive:You feel magically charged
msc += $verypositive:You turn to flesh and can move again
msc += $verypositive:Your magma supply has returned
msc += $verypositive:You (blow up|destroy|kill)
msc += $verypositive:is blown up
msc += $verypositive:dies
msc += $verypositive:is destroyed
msc += $verypositive:is killed
msc += $verypositive:is incinerated
msc += $verypositive:is devoured by a tear in reality
msc += $verypositive:turns neutral
msc += $verypositive:The spatial vortex dissipates
msc += $verypositive:Your magical contamination has.*faded
msc += $verypositive:drowns
msc += $verypositive:The.*falls from the air
msc += $verypositive:The.*simulacrum vapourises
msc += $verypositive:more experienced
msc ^= $verypositive:rots away and dies
msc ^= $verypositive:You.*and break free
msc += $verypositive:The web tears apart
msc += $verypositive:You disentangle yourself
msc += $verypositive:Saving game
msc += $verypositive:You finish memorising
msc += $verypositive:You may choose your destination
msc += $verypositive:You feel yourself speed up
msc += $verypositive:You feel stealthy
msc += $verypositive:Your skill with magical items lets you calculate the power of this device
msc += $verypositive:You can move again
msc += $verypositive:The fungal colony is destroyed
msc ^= $verypositive:The starcursed mass shudders and is absorbed by its neighbour
msc ^= $verypositive:The starcursed mass shudders and withdraws
msc += $verypositive:You are no longer firmly anchored in space
msc += $verypositive:Magic courses through your body
msc += $verypositive:You have disarmed the trap
msc += $verypositive:You are healed
msc += $verypositive:Pain shudders through your arm
msc += $verypositive:You slip out of the net
msc += $verypositive:You break free from the net
msc += $verypositive:Your life force is being protected
msc += $verypositive:It is a scroll of recharging
msc += $verypositive:is converted
msc += $verypositive:It is a scroll of enchant
msc += $verypositive:That put a bit of spring back into your step
msc += $verypositive:You feel vaguely more buoyant than before
msc += $verypositive:You feel (better|faster|mighty|much better|protected|refreshed)
msc += $verypositive:You feel.* mighty all of a sudden
msc += $verypositive:You feel.*agile all of a sudden
msc += $verypositive:You feel aware of your surroundings
msc += $verypositive:You detect (creatures|items)
msc += $verypositive:You feel the corruption within you wane
msc += $verypositive:You feel perceptive
msc ^= $verypositive:You feel less confused
msc += $verypositive:You feel a little better
msc += $verypositive:You feel studious about
msc += $verypositive:You feel telepathic
msc += $verypositive:You feel your magic capacity increase
msc += $verypositive:You feel the abyssal rune guiding you out of this place
msc += $verypositive:You feel fantastic
msc += $verypositive:Found.*altar
msc += $verypositive:Found a one-way gate to the infinite horrors of the Abyss
msc += $verypositive:Found a glowing drain
msc += $verypositive:Found a gate leading back out of here
msc += $verypositive:Found a hole to the Spider Nest
msc += $verypositive:Found a frozen archway
msc += $verypositive:Found an ice covered gate leading
msc += $verypositive:Found a dark tunnel
msc += $verypositive:Found a labyrinth entrance
msc += $verypositive:Found a flagged portal
msc += $verypositive:Found an exit through the horrors of the Abyss
msc += $verypositive:Found a gateway leading out of the Abyss
msc += $verypositive:Found a gateway leading deeper into the Abyss
msc += $verypositive:Found a gate leading out of Pandemonium
msc += $verypositive:Found a gate leading to another region
msc += $verypositive:Found a gate to the Vaults
msc += $verypositive:Found a gateway
msc += $verypositive:Found a rocky tunnel leading out of this place
msc += $verypositive:Found a portal to a secret trove of treasure
msc += $verypositive:Found a magical portal
msc += $verypositive:Found a flickering gateway to a bazaar
msc += $verypositive:Found a one-way gate leading to the halls of Pandemonium
msc += $verypositive:Found a portal leading out of here
msc += $verypositive:Found.*staircase
msc += $verypositive:Found.*(Accessories|Antiques|Boutique|Distillery|Elixirs|Emporium|shop|Smithy|store)
msc += $verypositive:You feel your magical essence form a protective shroud around your flesh
msc += $verypositive:You feel your.*returning
msc += $verypositive:It is a scroll of brand weapon
msc ^= $verypositive:Your.*seems to speed up
msc += $verypositive:An interdimensional caravan has stopped on this level and set up a bazaar
msc += $verypositive:Your demonic ancestry asserts itself
msc += $verypositive:You feel (agile|clever|stronger)
msc += $verypositive:You feel more protected from negative energy

# Positive mutation - or losing bad ones
msc += $awesome:You feel more resistant
msc += $awesome:Your fur grows into a thick mane
msc += $awesome:Your magic regains its normal vibrancy
msc += $awesome:Your thick fur grows shaggy and warm
msc += $awesome:You feel more sure on your
msc += $awesome:You feel breathless
msc += $awesome:Your genes go into a fast flux
msc += $awesome:A poisonous barb forms on the end of your tail
msc += $awesome:Your wings grow larger and stronger
msc += $awesome:You feel more spiritual
msc ^= $awesome:You feel immune to rotting
msc += $awesome:Your system.*accepts artificial healing
msc += $awesome:You feel completely energised by your suffering
msc += $awesome:An ominous black mark forms on your body
msc += $awesome:You feel a strange anaesthesia
msc += $awesome:You feel saturated with power
msc += $awesome:You feel power rushing into your body
msc += $awesome:Your blood runs red-hot
msc += $awesome:Your feet have mutated into hooves
msc += $awesome:You feel power flowing into your body
msc ^= $awesome:You feel more in touch with the powers of death
msc += $awesome:Your urge to yell lessens
msc += $awesome:One of your lower tentacles grows a sharp spike
msc += $awesome:You regain control of your magic
msc += $awesome:The horns on your head grow some more
msc += $awesome:You feel less concerned about heat
msc += $awesome:You smell fire and brimstone
msc += $awesome:You begin to radiate miasma
msc += $awesome:You feel genetically stable
msc ^= $awesome:You feel a.*healthier
msc += $awesome:You feel your life force and your magical essence meld
msc ^= $awesome:You feel your magical essence form a protective shroud around your flesh
msc += $awesome:You feel your magic shroud grow more resilient
msc += $awesome:Your body becomes stretchy
msc += $awesome:Your skin becomes partially translucent
msc += $awesome:You feel less concerned
msc += $awesome:You are surrounded by darkness
msc += $awesome:Your skin functions as natural camouflage
msc += $awesome:You begin to emit a foul stench of rot and decay
msc ^= $awesome:You feel energised by your suffering
msc ^= $awesome:You feel even more energised by your suffering
msc += $awesome:Your teeth lengthen and sharpen
msc += $awesome:Your natural healing is strengthened
msc += $awesome:You begin to regenerate
msc += $awesome:You begin to radiate repulsive energy
msc += $awesome:Your repulsive radiation grows stronger
msc += $awesome:Your body's shape seems more normal
msc += $awesome:You feel the presence of a demonic guardian
msc += $awesome:Your guardian grows in power
msc += $awesome:Your scales feel tougher
msc += $awesome:Your teeth are very long and razor-sharp
msc += $awesome:You feel negative
msc += $awesome:You begin to heal more quickly
msc += $awesome:You feel healthy
msc += $awesome:You feel a little more calm
msc += $awesome:You feel nature experimenting on you
msc += $awesome:You feel a strange attunement to the structure of the dungeons
msc += $awesome:Your mouth lengthens and hardens into a beak
msc += $awesome:Fur sprouts all over your body
msc += $awesome:Your attunement to dungeon structure grows
msc += $awesome:You slip into the darkness of the dungeon
msc += $awesome:You slip further into the darkness
msc += $awesome:Your thoughts seem clearer
msc += $awesome:A wave of death washes over you
msc += $awesome:The wave of death grows in power
msc += $awesome:Sharp spines emerge from
msc += $awesome:Your vision sharpens
msc += $awesome:Your urge to shout disappears
msc ^= $awesome:scales grow over part of your
msc ^= $awesome:scales spread over more of your
msc += $awesome:scales cover you.*completely
msc += $awesome:You are partially covered in thin metallic scales
msc ^= $awesome:Something appears at your feet
msc ^= $awesome:Something appears before you
msc ^= $awesome:Your urge to shout disappears
msc += $awesome:Your metabolism slows
msc += $awesome:Your bones become.*less dense
msc += $awesome:You feel (more robust|robust|very robust)
msc += $awesome:You feel more energetic
msc += $awesome:You feel (health|insulated|stable|clean)
msc += $awesome:Your (fingernails|toenails) (lengthen|sharpen)
msc += $awesome:Your hands twist into claws
msc += $awesome:Your feet stretch into talons
msc += $awesome:Your feet thicken and deform
msc ^= $awesome:A pair of antennae grows on your head
msc ^= $awesome:The antennae on your head grow some more
msc ^= $awesome:There is a nasty taste in your mouth for a moment
msc += $awesome:Large bone plates (cover|grow|spread)
msc += $awesome:Your throat feels
msc += $awesome:Your teeth grow very long and razor-sharp
msc ^= $awesome:You feel less vulnerable
msc ^= $awesome:You no longer feel vulnerable
msc ^= $awesome:You feel a little less angry

# Other rare and awesome stuff
msc += $awesome:word of recall is interrupted
msc ^= $awesome:is protecting you
msc ^= $awesome:You are shrouded in an aura of darkness
msc += $awesome:You are surrounded by a storm
msc += $awesome:You sense an aura of extreme power
msc += $awesome:Your.*shines brightly
msc ^= $awesome:The Shining One will now bless your weapon at an altar
msc ^= $awesome:You and your allies can gain power from killing the unholy and evil
msc ^= $awesome:A divine halo surrounds you
msc += $awesome:There is a labyrinth entrance here
msc += $awesome:You adapt resistances upon receiving elemental damage
msc += $awesome:The storm surrounding you grows powerful enough to repel missiles
msc += $awesome:There is a magical portal here
msc ^= $awesome:There is a gateway to a ziggurat here
msc ^= $awesome:Fruit sprouts up around you
msc ^= $awesome:A sheep catches fire
msc += $awesome:plants?.*grows? in the rain
msc += $awesome:You are restored by drawing out deep reserves of power within
msc ^= $awesome:There is a gate to the Realm of Zot here
msc += $awesome:A monocle briefly appears
msc += $awesome:You feel an empty sense of dread
msc += $awesome:That felt like a moral victory
msc += $awesome:A shaft materialises beneath you
msc += $awesome:You draw Experience
msc += $awesome:You draw the Mercenary
msc += $awesome:Your body is suffused with negative energy
msc ^= $awesome:Qazlal will now grant you protection from an element of your choosing
msc ^= $awesome:Kikubaaqudgha will now enhance your necromancy at an altar
msc += $awesome:You rejoin the land of the living
msc += $awesome:The sixfirhy explodes in a shower of sparks
msc += $awesome:With a swish of your cloak
msc += $awesome:Some fountains start gushing blood
msc += $awesome:A genie takes form and thunders\: \"Choose your reward
msc += $awesome:You turn into a fearsome dragon
msc += $awesome:You turn into a living statue of rough stone
msc += $awesome:You manage to scramble free
msc += $awesome:Your.*(rod|wand).*glows for a moment
msc += $awesome:You sense traps nearby
msc += $awesome:You now sometimes bleed smoke when heavily injured by enemies
msc += $awesome:Your shadow now sometimes tangibly mimics your actions
msc += $awesome:You sense items nearby
msc += $awesome:Suddenly you stand beside yourself
msc += $awesome:You feel somewhat nimbler
msc += $awesome:A mystic portal forms
msc += $awesome:You may select the general direction of your translocation
msc += $awesome:It is briefly surrounded by shifting shadows
msc += $awesome:The deck has exactly five cards
msc += $awesome:You are no longer firmly anchored in space
msc += $awesome:There is a gate to the Realm of Zot here
msc += $awesome:A terribly searing pain shoots up your
msc += $awesome:Your strength has recovered
msc += $awesome:A flood of memories washes over you
msc ^= $awesome:Vehumet offers you knowledge of
msc ^= $awesome:With a loud hiss the gate opens wide
msc += $awesome:You have collected all the runes
msc += $awesome:a hidden mimic gets squished
msc += $awesome:Now go and win
msc += $awesome:You feel knowledgeable
msc += $awesome:The arc blade crackles to life
msc ^= $awesome:There is a gate leading out of Pandemonium here
msc += $awesome:You feel powerful
msc ^= $awesome:You can now
msc += $awesome:joins your ranks
msc += $awesome:Your magic begins regenerating once more
msc += $awesome:Your.*is now the
msc += $awesome:There is a glowing drain
msc ^= $awesome:There is a gateway leading out of the Abyss here
msc += $awesome:There is a sand-covered staircase here
msc += $awesome:Your.*crackles with electricity
msc ^= $awesome:This is a scroll of acquirement
msc += $awesome:You pick up the.*rune
msc += $awesome:You now have.*rune
msc += $awesome:Your.*skill increases
msc += $awesome:You have reached level
msc += $awesome:Your experience leads to an increase in your attributes
msc ^= $awesome:There is a frozen archway here
msc ^= $awesome:There is a dark tunnel here
msc ^= $awesome:There is a flagged portal here
msc ^= $awesome:There is a portal to a secret trove of treasure here
msc ^= $awesome:There is a flickering gateway to a bazaar here
msc ^= $awesome:There is an entrance to.*on this level
msc += $awesome:3 runes! That's enough to enter the realm of Zot
msc += $awesome:The lock glows eerily
msc += $awesome:Heavy smoke blows from the lock
msc += $awesome:You have escaped!
msc += $awesome:rune into the lock
msc += $awesome:With a loud hiss the gate opens wide
msc += $awesome:You sensed
msc += $awesome:You are wearing\:
msc += $awesome:With a loud hiss the gate opens wide
msc += $awesome:The shadows inhabiting this place fade forever
msc += $awesome:You have identified the last
msc += $awesome:You feel a craving for the dungeon's cuisine
msc ^= $awesome:Lugonu will now corrupt your weapon
msc ^= $awesome:You now have enough gold to petition Gozag for potion effects
msc ^= $awesome:You now have enough gold to fund merchants seeking to open stores in the dungeon

# Weapon brands/enchantment
msc ^= $awesome:A searing pain shoots up your
msc += $awesome:You hear the crackle of electricity
msc += $awesome:You see sparks fly
msc += $awesome:Your hands tingle
msc += $awesome:Your claws tingle
msc += $awesome:You feel a dreadful hunger
msc ^= $awesome:Your.*glows (green|purple|red|.*yellow)
msc += $awesome:briefly pass through it before

# You or an ally takes damage
#msc += $negative:
msc += $negative:you trip and fall down the stairs
msc += $negative:You are engulfed in blessed fire
msc += $negative:The fountain mimic splashes you
msc += $negative:Your body is twisted very painfully
msc += $negative:crushes you
msc ^= $negative:drains your
msc += $negative:Your body is distorted in a weirdly horrible way
msc += $negative:starcursed mass engulfs you
msc ^= $negative:Your.*is struck by the twisting air
msc += $negative:You are constricted
msc ^= $negative:Your.*is blasted
msc += $negative:Electricity courses through your body
msc ^= $negative:Your.*is struck by lightning
msc += $negative:You are struck by lightning
msc += $negative:silver sears your?
msc += $negative:You draw magical energy from your own body
msc += $negative:Rocks fall onto you out of nowhere
msc += $negative:You are engulfed in raging winds
msc ^= $negative:Your.*convulses
msc += $negative:You are struck by the briar patch's thorns
msc += $negative:You feel like your blood is boiling
msc += $negative:The magical storm engulfs you
msc += $negative:Your body is flooded with distortional energies
msc += $negative:You are caught in a strong localised spatial distortion
msc ^= $negative:The Shining One blasts you with cleansing flame
msc += $negative:You are struck by lightning
msc += $negative:You are caught in an extremely strong localised spatial distortion
msc += $negative:You are blasted with searing flames
msc += $negative:Your.*suffers a backlash
msc ^= $negative:Your.*is smitten
msc += $negative:You are blasted with fire
msc ^= $negative:Your.*is engulfed in
msc ^= $negative:A huge blade swings out and slices into your?
msc += $negative:Flames sear your flesh
msc += $negative:A wave of violent energy washes through your body
msc += $negative:You are caught in a localised spatial distortion
msc += $negative:The acid blast engulfs you
msc ^= $negative:Heat is drained from your body
msc += $negative:Energy rips through your body
msc += $negative:You feel you are being watched by something
msc += $negative:Unholy energy fills the air
msc += $negative:You are caught in a localised field of spatial distortion
msc += $negative:The ghost moth stares at you
msc += $negative:Your ice beast melts
msc ^= $negative:burns you
msc += $negative:Your.*burn
msc += $negative:draws from the surrounding life force
msc += $negative:The boulder beetle smashes into you
msc += $negative:You feel very cold
msc ^= $negative:The.*pierces through (you|your)
msc ^= $negative:The walls? burns? you
msc ^= $negative:Your.*is blown up
msc += $negative:The throwing net hits your
msc += $negative:Your body is suffused with distortional energy
msc += $negative:constricts your?
msc += $negative:(bites|burns|claws|freezes|gores|gores|headbutts|hits|kicks|pecks|pecks|poisons|punches) your?
msc += $negative:(shocks|skewers|slaps|smites|stings|tail-slaps|tentacle-slaps|touches|tramples|trunk-slaps) your?
# Thanks killer klowns
msc += $negative:(defenestrates|elbows|flogs|headlocks|pinches|pokes|pounds|prods|squeezes|strangle-hugs|teases|tickles|trip-wires|wrestles) your?
msc += $negative:Your.*burned by acid
msc += $negative:Your?.*is struck by the.*spines
msc += $negative:Your.*spectral.* shares its damage
msc += $negative:The.*begins to radiate
msc += $negative:The.*toxic radiance grows
msc += $negative:Your.*loses its grip
msc += $negative:The water swirls and strikes you
msc += $negative:Your.*is knocked back
msc += $negative:The shock serpent's electric aura discharges violently
msc += $negative:The lightning shocks
msc += $negative:The tentacled starspawn engulfs you
msc += $negative:The.*ugly thing engulfs you
msc ^= $negative:Your life force is offered up
msc ^= $negative:The (.*hellfire|blast of flame|blast of lightning|blast of magma|explosion) engulfs your?
msc ^= $negative:The (explosion of.*fragments|explosion of spores|fiery explosion|fireball|ghostly fireball) engulfs your?
msc ^= $negative:The (great blast of fire|plume of ash|stinking cloud) engulfs your?
msc += $negative:Pain shoots through your body
msc += $negative:Your.*is flash-frozen
msc += $negative:You writhe in agony
msc += $negative:you feel sick
msc += $negative:Something smites you
msc += $negative:The air twists around and.*strikes you
msc += $negative:You are hit by a branch
msc += $negative:You are caught in an explosion of flying shrapnel
msc += $negative:You are hit by flying rocks
msc ^= $negative:strikes at you from the darkness
msc += $negative:Your?.*burned terribly
msc += $negative:covered in liquid flames
msc += $negative:You are blasted with ice
msc += $negative:Your.*seems to slow down
msc += $negative:You are electrocuted
msc += $negative:and unravels at your touch
msc += $negative:You are struck by the.*spines
msc += $negative:The water rises up and strikes you
msc += $negative:The torrent of lightning arcs to you
msc += $negative:A root smacks your
msc += $negative:The eye of draining stares at you
msc += $negative:The orb of electricity engulfs you
msc += $negative:The barbed spikes dig painfully into your body as you move
msc += $negative:You are engulfed in (a cloud of scalding steam|flames|freezing|freezing vapours)
msc += $negative:You are engulfed in (ghostly flame|negative energy|noxious fumes|poison gas|roaring flames)
msc += $negative:A root smacks you from below
msc += $negative:Ka-crash
msc += $negative:You are frozen
msc ^= $negative:draws life force from you
msc += $negative:You have a terrible headache
msc += $negative:Your damage is reflected back at you
msc += $negative:Your body is twisted painfully
msc += $negative:Your scythe-like blades burn
msc += $negative:Your.*is splashed with acid
msc += $negative:Your.*is constricted
msc += $negative:The freed slave is burned by acid
msc += $negative:Something.*your
msc += $negative:snaps closed at you
msc += $negative:headbutts you!
msc += $negative:engulfs your
msc += $negative:You are blasted with magical energy
msc += $negative:The large rock crashes through you
msc += $negative:You are blasted!
msc += $negative:The great icy blast engulfs you
msc += $negative:is hit by a branch
msc += $negative:The wandering mushroom releases spores at your?

#monster resists
msc += $danger:completely resists
msc += $warning:resists

# For the text that describes ranged attacks and spells
msc += $takesaction:chants a haunting song
msc += $takesaction:You release an incredible blast of power in all directions
msc += $takesaction:calls upon its god to speed up
msc += $takesaction:You create a blast
msc += $takesaction:The ophan calls forth blessed flames
msc += $takesaction:You exhale
msc += $takesaction:You enter the passage of Golubria
msc += $takesaction:You conjure a prism of explosive energy
msc += $takesaction:A raging storm of fire appears
msc += $takesaction:Sojobo summons a great blast of wind
msc += $takesaction:A fierce wind blows from the fan
msc ^= $takesaction:Rupert roars wildly at you
msc += $takesaction:A fierce wind blows
msc += $takesaction:The wizard shimmers violently
msc += $takesaction:releases spores
msc += $takesaction:The giant eyeball stares at you
msc += $takesaction:You begin recalling your allies
msc += $takesaction:You begin to radiate toxic energy
msc += $takesaction:The wretched star glows turbulently
msc += $takesaction:You begin to meditate on the wall
msc += $takesaction:You dig through the rock wall
msc += $takesaction:You ignite the poison in your surroundings
msc += $takesaction:You attempt to give life to the dead
msc ^= $takesaction:hurls a stone arrow
msc += $takesaction:weaves a glowing orb of energy
msc += $takesaction:spins a strand of pure energy
msc += $takesaction:Aizul coils himself and waves his upper body at you
msc ^= $takesaction:The royal jelly spits out
msc ^= $takesaction:calls upon Beogh to heal
msc ^= $takesaction:prays to Beogh
msc ^= $takesaction:calls down the wrath of
msc ^= $takesaction:invokes the aid of Beogh
msc += $takesaction:utters an invocation to Beogh
msc += $takesaction:shining eye gazes
msc += $takesaction:orb of fire glows
msc += $takesaction:orb of fire emits
msc += $takesaction:utters an invocation to its god
msc += $takesaction:offers its life energy for powerful magic
msc += $takesaction:utters a dark prayer and points at you
msc += $takesaction:waves its arms in wide circles
msc += $takesaction:is infused with unholy energy
msc += $takesaction:shambling mangrove reaches out with a gnarled limb
msc += $takesaction:You jump-attack
msc += $takesaction:The injured rakshasa weaves a defensive illusion
msc += $takesaction:Mara seems to draw the.*out of itself
msc += $takesaction:Mara shimmers
msc += $takesaction:Your battlesphere fires
msc += $takesaction:curse skull calls on the powers of darkness
msc += $takesaction:curse skull rattles its jaw
msc += $takesaction:Your shadow mimicks your spell
msc += $takesaction:calls down the wrath of its god upon you
msc += $takesaction:invokes the aid of its god against you
msc += $takesaction:rakshasa weaves an illusion
msc += $takesaction:coils itself and waves its upper body at you
msc += $takesaction:casts a spell
msc += $takesaction:You breathe a
msc ^= $takesaction:You draw life from your surroundings
msc += $takesaction:You step out of the flow of time
msc += $takesaction:You can feel time thicken for a moment
msc += $takesaction:The flow of time bends around you
msc += $takesaction:You start singing a song of slaying
msc += $takesaction:The disc erupts in an explosion of electricity!
msc += $takesaction:and something leaps out
msc += $takesaction:You assume a fearsome visage
msc ^= $takesaction:Asterion utters an invocation to Makhleb
msc ^= $takesaction:Asterion conjures a destructive force in the name of Makhleb
msc ^= $takesaction:wizard howls an incantation
msc ^= $takesaction:draws from the surrounding life force
msc ^= $takesaction:Gastronok chants a spell
msc ^= $takesaction:(breathes|spits).*at
msc += $takesaction:You conjure a mighty blast of ice
msc += $takesaction:conjures a mighty blast of ice
msc ^= $takesaction:Your spellspark servitor (casts|conjures|launches)
msc += $takesaction:You reach into the bag
msc += $takesaction:You gaze into the crystal ball
msc += $takesaction:Your jumping spider leaps
msc ^= $takesaction:ice dragon breathes frost
msc ^= $takesaction:points at you and mumbles some strange words
msc += $takesaction:(fires|shoots|throws) [^n]
msc += $takesaction:You (fire|shoot|throw)
msc += $takesaction:(conjures|fires|gestures|plays a|radiates)
msc ^= $takesaction:mumbles some strange (prayers|words)
msc ^= $takesaction:spriggan berserker (invokes|prays to|utters an invocation to) Trog
msc ^= $takesaction:calls down the wrath of the Shining One
msc += $takesaction:casts a spell.*floats close
msc += $takesaction:offers itself to Yredelemnul
msc ^= $takesaction:launches metal splinters at you
msc += $takesaction:(Angry insects surge|Agitated ravens fly) out from beneath the
msc ^= $takesaction:begins absorbing vital energies
msc ^= $takesaction:calls forth a grand avatar
msc ^= $takesaction:exhales a fierce blast of wind
msc ^= $takesaction:curls into a ball and starts rolling
msc ^= $takesaction:You open the lid
msc ^= $takesaction:jumps down from its now dead mount
msc ^= $takesaction:swoops through the air toward you
msc ^= $takesaction:jumping spider pounces on
msc ^= $takesaction:jumping spider leaps
msc += $takesaction:manticore flicks its tail
msc += $takesaction:You begin to abjure the creatures around you
msc ^= $takesaction:The golden eye blinks at you
msc ^= $takesaction:activates a sealing rune
msc ^= $takesaction:offers up its power
msc += $takesaction:You warp the flow of time around you
msc += $takesaction:summons
msc += $takesaction:great orb of eyes gazes at
msc += $takesaction:You radiate an aura of cold

msc ^= $godaction:Dithmenos does not appreciate your starting fires
msc += $godaction:Beogh throws an implement of electrocution at you
msc += $godaction:Beogh throws implements of electrocution at you
msc += $godaction:Beogh sends forth an army of orcs
msc += $godaction:you feel ready to understand
msc += $godaction:You feel a surge of divine interest
msc += $godaction:(Ashenzari|Beogh|Cheibriados|Dithmenos|Elyvilon|Fedhas|Gozag|Igni Ipthes|Jiyva|Kikubaaqudgha|Lugonu)
msc += $godaction:(Makhleb|Nemelex Xobeh|Okawaru|Qazlal|Sif Muna|The Shining One|Trog|Vehumet|Xom|Yredelemnul|Zin[^g])
msc ^= $godaction:(Ashenzari|Beogh|Cheibriados|Dithmenos|Elyvilon|Fedhas|Gozag|Igni Ipthes|Jiyva|Kikubaaqudgha|Lugonu) says
msc ^= $godaction:(Makhleb|Nemelex Xobeh|Okawaru|Qazlal|Sif Muna|The Shining One|Trog|Vehumet|Xom|Yredelemnul|Zin[^g]) says
msc ^= $godaction:Your divine halo returns
msc += $godaction:is distracted by the nearby gold
msc += $godaction:soul is now ripe for the taking
msc += $godaction:sets up shop in the Dungeon
msc ^= $godaction:You redirect
msc ^= $godaction:You feel protected from physical attacks
msc ^= $godaction:You feel protected from cold
msc ^= $godaction:You feel protected from fire
msc ^= $godaction:You feel protected from electricity
msc += $godaction:resistances upon receiving elemental damage
msc += $godaction:A storm cloud blasts the area with cutting wind
msc += $godaction:A blizzard blasts the area with ice
msc += $godaction:Magma suddenly erupts from the ground
msc ^= $godaction:Xom calls
msc += $godaction:The storm around you weakens
msc += $godaction:The ground shakes violently
msc += $godaction:The storm around you strengthens
msc += $godaction:due to Igni's heat
msc += $godaction:A mighty gale blasts forth
msc += $godaction:A fiery fortress appears around you!
msc += $godaction:is consumed in a column of flame
msc += $godaction:The toadstool can now pick up its mycelia and move
msc += $godaction:Slime for the Slime God
msc ^= $godaction:Cheibriados rebukes [^y]
msc ^= $godaction:You hear Xom
msc ^= $godaction:Go forth and redecorate
msc += $godaction:This is a.*sacrifice
msc ^= $godaction:Xom.*touches
msc ^= $godaction:You need some minor
msc ^= $godaction:Let me alter your
msc ^= $godaction:Xom complains about the scenery
msc ^= $godaction:Xom howls with laughter
msc ^= $godaction:This place needs a little more atmosphere
msc ^= $godaction:The area is suffused with divine lightning
msc ^= $godaction:Let's go for a ride
msc ^= $godaction:Xom momentarily opens a gate
msc ^= $godaction:Where it stops
msc ^= $godaction:\"First here. now there\.\"
msc ^= $godaction:\"Over there now!\"
msc ^= $godaction:Serve the toy. my child
msc ^= $godaction:Fight to survive. mortal
msc ^= $godaction:Xom opens a gate
msc ^= $godaction:Xom slaps you with
msc ^= $godaction:You hear crickets chirping
msc ^= $godaction:Get over here
msc ^= $godaction:Go forth and destroy
msc ^= $godaction:Xom laughs nastily
msc ^= $godaction:Everything around seems to assume a strange transparency
msc ^= $godaction:You feel watched
msc ^= $godaction:The walls suddenly lose part of their structure
msc ^= $godaction:You are now a BORING thing
msc ^= $godaction:Xom makes a sudden noise
msc ^= $godaction:Xom roars with laughter
msc ^= $godaction:You feel someone pinching you\. As you turn. you see no one
msc ^= $godaction:\"Try this\.\"
msc ^= $godaction:\"Whee!\"
msc ^= $godaction:\"Catch!\"
msc ^= $godaction:\"Here.\"
msc ^= $godaction:\"Boo!\"
msc ^= $godaction:\"Tag. you\'re it!\"
msc ^= $godaction:\"Boring in life. Boring in death\"
msc ^= $godaction:\"This might be better!\"
msc ^= $godaction:\"I like them better like this\.\"
msc ^= $godaction:\"Heh heh heh\.\.\.\"
msc ^= $godaction:\"Burn. baby. burn!\"
msc ^= $godaction:\"Time to have some fun!\"
msc ^= $godaction:\"Have a taste of chaos. mortal\.\"
msc ^= $godaction:\"See what I see. my child!\"
msc ^= $godaction:\"Just a minor improvement\.\.\.\"
msc ^= $godaction:\"Hum-dee-hum-dee-hum\.\.\.\"
msc ^= $godaction:\"There. this looks better\.\"
msc ^= $godaction:\"You have grown too confident for your meagre worth\.\"
msc ^= $godaction:\"Take this token of my esteem\.\"
msc ^= $godaction:\"Take this instrument of something!\"
msc ^= $godaction:\"See what I see. my child!\"
msc ^= $godaction:\"What!\? Thats's it\?!\"c
msc ^= $godaction:\"Serve the (mortal|toy). my (child|children)!\"
msc ^= $godaction:Let\'s see if it\'s strong enough to survive yet
--These don't seem to work, maybe a bug?
msc ^= $boring:disappears without a glow
msc ^= $boring:disappears without a sign
msc ^= $boring:glow with a rainbow of weird colours and disappear
msc ^= $boring:glows slightly and disappears
msc ^= $boring:is slowly consumed by flames
msc ^= $boring:slowly burns to ash
msc ^= $boring:slowly crumbles into the ground
msc ^= $boring:shimmers? and breaks? into pieces
msc ^= $boring:disappears into the void
msc ^= $boring:stares at you suspiciously for a moment
msc += $boring:trembles before you
msc += $boring:You feel mildly nauseous
msc += $boring:Multicoloured lights dance around

# Interface Messages - These shouldn't take any turns
msc += $interface:You cannot read scrolls
msc += $interface:You cannot drink potions
msc += $interface:too exhausted to
msc += $interface:There are no objects that can be picked up here
msc += $interface:Calm down first
msc += $interface:You enter a permanent teleport trap
msc += $interface:too cloudy to do that here
msc += $interface:A powerful magic interferes with the creation of the passage
msc += $interface:You cannot apport that
msc += $interface:The film of ice won't work on stone
msc += $interface:You see nothing there to enslave the soul of
msc += $interface:There isn't anything that you can close there
msc += $interface:Choose some type of armour to enchant
msc += $interface:You can't place the prism on a creature
msc += $interface:You are too depleted to cast spells recklessly
msc += $interface:It's stuck to you
msc += $interface:You're in a travel-excluded area
msc += $interface:You are unable to make a sound
msc += $interface:Choose an unidentified item
msc += $interface:There is nothing here that can be animated
msc += $interface:No.*are visible
msc += $interface:No evolvable flora in sight
msc += $interface:You must target a plant or fungus
msc += $interface:No target in range
msc += $interface:This is a.*deck
msc += $interface:No exploration algorithm can help you here
msc += $interface:You cannot walk through the dense trees
msc += $interface:This wall is too hard to dig through
msc += $interface:You can't dig through that
msc += $interface:You are already wielding that
msc ^= $interface:Something interferes with your magic
msc += $interface:You can only heal others!
msc += $interface:You are already wielding that
msc += $interface:You don't know.*spells?
msc += $interface:That is presently inert
msc += $interface:That isn't a deck
msc += $interface:Reset throwing quiver to default
msc += $interface:You can't memorise that many levels of magic yet
msc += $interface:You aren't wielding a weapon
msc += $interface:You'd need your.*free
msc += $interface:I'll put part of them outside for you
msc += $interface:You're in a travel-excluded area. stopping explore
msc += $interface:There is a passage of Golubria here
msc += $interface:you can't auto-travel out of here
msc += $interface:waypoint
msc += $interface:You aren't in the Abyss
msc += $interface:You haven't found any runes yet
msc += $interface:This weapon is holy and will not allow you to wield it
msc += $interface:Huh\?
msc += $interface:You can't drink
msc += $interface:You cannot cast that spell in your current form
msc ^= $interface:is stuck to you
msc += $interface:is melded into your body
msc ^= $interface:Your.*feels? slithery
msc += $interface:You can't wear anything in your present form
msc += $interface:You're too inexperienced to learn that spell
msc += $interface:You're already wearing two cursed rings
msc += $interface:You need a rune to enter this place
msc ^= $interface:There is an ice covered gate leading back out of here here
msc += $interface:The bosom of this dungeon contains the most powerful artefact
msc += $interface:Clearing travel trail
msc += $interface:Your pack is full
msc += $interface:You can't pick everything up
msc += $interface:Could not pick up an item
msc += $interface:You can't carry that many items
msc += $interface:You enter the Abyss
msc += $interface:You enter the halls of Pandemonium
msc += $interface:This wand has
msc += $interface:That is beyond the maximum range
msc += $interface:You can't (drink|read) that
msc += $interface:You cannot shoot.*while held in a net
msc += $interface:You're already here
msc += $interface:You can't do that
msc += $interface:Cleared annotation
msc += $interface:You have no means to grasp a wand firmly enough
msc += $interface:Choose a valid weapon
msc += $interface:No previous command
msc += $interface:You sense a monster
msc += $interface:Welcome
msc += $interface:There is a.*trap here
msc += $interface:There is a.*(entrance).*here
msc += $interface:That item cannot be evoked
msc += $interface:Please enjoy your stay
msc += $interface:You now have enough gold to buy
msc += $interface:Showing terrain only
msc += $interface:Returning to normal view
msc += $interface:Done exploring
msc += $interface:You pace your travel speed to your slowest ally
msc += $interface:The water rises up and takes form
msc += $interface:The winds coalesce and take form
msc += $interface:The.*answers the.*call
msc += $interface:You're too full
msc += $interface:Your memorisation is interrupted
msc += $interface:surroundings become eerily quiet
msc += $interface:You fall into the shallow water
msc += $interface:an escape hatch
msc += $interface:You stop dropping stuff
msc += $interface:melds into your body
msc += $interface:Clearing level map
msc += $interface:There's nothing close enough
msc += $interface:Autopickup is now
msc += $interface:Hurry and find it before the portal
msc += $interface:You slide downwards
msc += $interface:Can't find anything matching that
msc += $interface:No item to drop
msc += $interface:you feel a great hunger. Being not satiated
msc += $interface:You finish taking off
msc += $interface:appears from thin air
msc += $interface:You feel more attuned to
msc += $interface:(Attack!|Fall back!|Follow me!|Stop fighting!|Wait here!)
msc += $interface:You have finished your manual
msc += $interface:You have no appropriate body parts free
msc ^= $interface:You finish putting on
msc += $interface:isn't holding a weapon that can be rebranded
msc += $interface:You feel the dreadful sensation subside
msc += $interface:You feel an oppressive heat about you
msc += $interface:You travel at normal speed
msc += $interface:Your reserves of magic are already full
msc += $interface:There are no corpses nearby
msc += $interface:No target in view
msc += $interface:It (is|was) a (potion|scroll)
msc += $interface:Aborting
msc += $interface:Created macro
msc += $interface:Saving macro


# 3-k Message Channels
# --------------------

#Channels
#channel.plain =
channel.prompt = $interface
channel.god = $godaction
channel.duration = $warning
channel.danger = $danger
channel.warning = $danger
channel.recovery = $verypositive
channel.talk = mute
channel.talk_visual = $boring
channel.timed_portal = $warning
channel.intrinsic_gain = $awesome
#channel.mutation = --either danger/warning/awesome
channel.monster_spell = $takesaction
#channel.monster_enchant = --either danger/warning/boring/takesaction
channel.friend_spell = $takesaction
#channel.friend_enchant = --either danger/warning/boring/takesaction
channel.friend_action = $takesaction
channel.monster_damage = mute
#channel.banishment = --either positive or danger
channel.equipment = $interface
#channel.floor =
channel.multiturn = $boring
#channel.examine =
#channel.examine_filter =
#channel.diagnostics =
#channel.error =
#channel.tutorial =
channel.orb = $awesome
#channel.hell_effect = -either danger/warning/boring


#### MUTES Be careful with these! Last, so they override the rest
#msc ^= mute:plain:No target in view!
msc ^= mute:There is a.*door here

# Unnecessary
msc ^= mute:HP restored
msc ^= mute:Magic restored
msc ^= mute:A chill wind blows around you
msc ^= mute:The.*dissolves into shadows
msc ^= mute:The (bush|fungus|plant) is (engulfed|struck)
#msc ^= mute:Cast which spell
msc ^= mute:Use which ability
msc ^= mute:Evoke which item
#msc ^= mute:Confirm with
#msc ^= mute:You can\'t see any susceptible monsters within range
msc ^= mute:for a list of commands and other information
msc ^= mute:You swap places
msc ^= mute:Your.*spectral.*disappears


msc ^= mute:Moving in this stuff is going to be slow
msc ^= mute:You enter the shallow water
msc ^= mute:There is a.*(staircase).*here

msc ^= mute:is lightly (damaged|wounded)
msc ^= mute:is moderately (damaged|wounded)
msc ^= mute:is heavily (damaged|wounded)
msc ^= mute:is severely (damaged|wounded)
msc ^= mute:is almost (dead|destroyed)

msc ^= mute:Was it this warm in here before
msc ^= mute:The flames dance
msc ^= mute:Your shadow attacks
msc ^= mute:Marking area around
msc ^= mute:Placed new exclusion
msc ^= mute:Reduced exclusion size to a single square
msc ^= mute:Removed exclusion
msc ^= mute:You can access your shopping list by pressing
msc ^= mute:As you enter the labyrinth
msc ^= mute:previously moving walls settle noisily into place
msc ^= mute:The plant looks sick
msc ^= mute:Shift\-Dir \- straight line
msc ^= mute:Your foxfire dissipates
msc ^= mute:evades? a web
msc ^= mute:An electric hum fills the air
msc ^= mute:You pick up a book of
msc ^= mute:accepts your kill
msc ^= mute:Okawaru is honoured by your kill
msc ^= mute:you see here a.*corpse
msc ^= mute:you now have .* gold pieces

############################### End rc/display.rc ###############################
##########################################################################################

################################### Begin rc/fm-messages.rc ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
more := force_more_message
flash := flash_screen_message

# Remove annoying defaults
more -= You have reached level
more -= The lock glows eerily
more -= Heavy smoke blows from the lock
more -= The gate opens wide
more -= With a soft hiss the gate opens wide
more -= You pick up the .* gem and feel its .* weight
more -= You pick up the .* rune and feel its power
more -= welcomes you( back)?!

# Significant spells/effects ending
flash += You feel stable
more += is no longer charmed
more += You.*re starting to lose your buoyancy
# Death's Door
more += time is.*running out
more += life is in your own
# Death channel
more += unholy channel is weakening

# Monsters doing things
more += monster_warning:wielding.*of distortion
more += begins to recite a word of recall
more += There is.*feeling in your soul
more += wretched star pulses
more += Strange energies course through your body

flash += doors? slams? shut
flash += blows.*on a signal horn
flash += Deactivating autopickup
flash += Its appearance distorts for a moment
flash += The.*offers itself to Yredelemnul
flash += The forest starts to sway and rumble
flash += Your?.*suddenly stops? moving

# Crowd control
more += You.*(?<!( too|less)) confused
more += You .*(slow.*down|lose consciousness)
more += infuriates you
more += hits you .* distortion
more += Space .* around you
more += surroundings become eerily quiet
more += Your limbs are stiffening

flash += You .* (blown|knocked back|mesmerised|trampled|stumble backwards|encased)
flash += Your magical (effects|defenses) are (unraveling|stripped away)
flash += You stop (a|de)scending the stairs
flash += A sentinel's mark forms upon you
flash += The pull of.*song draws you forward
flash += engulfs you in water

# Clouds
more += danger:(calcify|mutagenic)
more += You.*re engulfed in.*miasma
flash += Miasma billows from the

# You Screwed Up
more += is no longer ready
more += You really shouldn't be using
more += You don't have enough magic to cast this spell
flash += Your body shudders with the violent release
flash += power of Zot

# Found something important
more += Found.*the Ecumenical Temple
more += Found.*(treasure|bazaar|ziggurat)
more += .*resides here
more += You have a vision of.*gates?
more += Press the corresponding letter to learn more about a god
flash += timed_portal:.*

# Translocations
more += danger:sense of stasis
more += Your surroundings.*(different|flicker)
more += You.*re suddenly pulled into a different region
flash += You blink
flash += danger:You feel strangely .*stable
flash += delayed

# Big damage
more += your body is wracked
more += The poison in your body grows stronger
more += You.*re lethally poisoned
more += danger:You convulse
more += You feel a (horrible|terrible) chill
more += Your.*terribly
more += You are.*terribly

# Hit by something
more += Terrible wounds open
more += The air around.*erupts in flames
more += The air twists around and violently strikes you in flight
more += You shudder from the earth-shattering force
more += You feel.*(?<!less)( haunted| rot| vulnerable)
flash += danger:corrodes you
flash += Your damage is reflected back at you
flash += ^(?!Your? ).*reflects

# FYI
more += seems mollified
more += You have finished your manual

# Unexpected monsters
more += appears in a (shower|flash)
more += appears out of thin air
more += You sense the presence of something unfriendly
more += Wisps of shadow swirl around

# Misc
more += hell effect:.*
more += god:wrath finds you
more += The walls disappear

# Ashenzari
more += god:Ashenzari invites you to partake
# Dithmenos
more += god:You are shrouded in an aura of darkness
more += god:You.*bleed smoke
more += god:Your shadow.*tangibly mimics your actions
# Fedhas
more += god:Fedhas invokes the elements against you
# Jivya
more += god:will now unseal the treasures of the Slime Pits
more += god:Jiyva alters your body
# Kikubaaqudgha
more += god:Kikubaaqudgha will grant you
# Lugonu
more += god:Lugonu will now corrupt your weapon
more += god:Lugonu sends minions to punish you
# Okawaru
more += god:Okawaru sends forces against you
# Qazlal
flash += god:resistances upon receiving elemental damage
flash += god:You are surrounded by a storm which can block enemy attacks
# The Shining One
more += god:Your divine shield starts to fade
more += god:Your divine shield fades away
# Trog
more += god:You feel the effects of Trog's Hand fading
more += god:You feel less resistant to hostile enchantments
# Xom
more += staircase.*moves
more += Some monsters swap places
# Yredelemnul
more += god:soul is no.* ripe for the taking
more += god:dark mirror aura disappears
# Zin
more += god:will now cure all your mutations

############################### End rc/fm-messages.rc ###############################
##########################################################################################

################################### Begin rc/macros.rc ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
bindkey = [~] CMD_LUA_CONSOLE

# Numpad keymaps
macros += K \{-1019} f
macros += K \{-1018} 3
macros += K \{-1016} \{9}
macros += K \{-1015} 2
macros += K \{-1012} 1
macros += K \{-1010} o
macros += K \{-1000} .
macros += K \{-247} 5
macros += K2 \{-1019} .

# Spellcasting macros
macros += M 1 za
macros += M 2 zb
macros += M 3 zc
macros += M 4 zd
macros += M 6 zf
macros += M 7 zg
macros += M 8 zh
macros += M 9 zi
macros += M 0 zj

# Confirm targeting with same keys as spellcasting
macros += K2 \{-1018} \{13}
macros += K2 \{-1015} \{13}
macros += K2 \{-1012} \{13}
macros += K2 1 \{13}
macros += K2 2 \{13}
macros += K2 3 \{13}
macros += K2 4 \{13}
macros += K2 6 \{13}
macros += K2 7 \{13}
macros += K2 8 \{13}
macros += K2 9 \{13}
macros += K2 0 \{13}

############################### End rc/macros.rc ###############################
##########################################################################################

################################### Begin rc/runrest.rc ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
# Aliases
stop := runrest_stop_message
ignore := runrest_ignore_message

# Ignore these stops
interrupt_travel -= sense_monster
interrupt_travel -= mimic
ignore ^= "sense a monster nearby"

# Monsters to ignore at a distance
runrest_ignore_monster += fire vortex:1

# Stop for consumables you want to use immediately
stop += potions? of experience
stop += scrolls? of acquirement

# Don't stop for noisy doors unless someone shouts back
stop -= it creaks loudly
stop -= flies open with a bang
stop += You hear

# Re-enable stops for all ally actions then ignore some
ignore -= friend_action:
ignore -= friend_spell:
ignore -= friend_enchant:
ignore ^= butterfly disappears
ignore ^= friend_action:(a|the) web
ignore ^= friend_action:(seems|blinks)
stop += friend_action:
stop += friend_spell:
stop += friend_enchant:
stop += appears from out of your range of vision
stop += hits your
stop += our.*is destroyed

# Expiring effects; Turn on transmutation|flight|swiftness ending and ignore the rest
ignore -= transformation is almost over\.
ignore -= transformation has ended\.
ignore -= revert to.*form\.
ignore -= You feel yourself come back to life
ignore ^= unholy channel is weakening
ignore ^= magical contamination.*faded
ignore ^= our foxfire dissipates
stop ^= unholy channel expires
stop ^= are starting to lose your buoyancy
stop ^= You feel.*sluggish
# Expiring effects for friends too
stop ^= no longer petrified
ignore ^= no longer.*(covered in acid|unusually strong)
ignore ^= looks more healthy

# Misc
stop -= You now have enough gold to
stop ^= timed_portal:.*
ignore ^= nearby plant withers and dies
ignore ^= disentangle yourself
ignore ^= You swap places.

# Summonings
ignore ^= our.*crimson imp blinks
ignore ^= our.*simulacrum vaporises
ignore ^= our.*returns to the shadows of the Dungeon
ignore ^= our.*skeleton crumbles into dust
ignore ^= our.*fades into mist
ignore ^= our.*looks more healthy
ignore ^= our.*is no longer (corroded|moving slowly)
ignore ^= our.*dissolves into a puddle of slime

# Ashenzari
stop += god:Ashenzari invites you to partake
# Ru
stop += god:Ru believes you are ready to make a new sacrifice
# Hepliaklqana
ignore ^= emerges from the mists of memory
# Wu Jian Council
ignore += heavenly storm settles
# Yredelemnul
ignore += offer up the Black Torch's flame
ignore += mindless puppets stay behind to rot

############################### End rc/runrest.rc ###############################
##########################################################################################

################################### Begin rc/slot-defaults.rc ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
####### Item Slots #########
# Rings to P/p for easy swapping
item_slot += ring of:Pp

# ignored: moonshine, noise
# unassigned slots: d, e, F
item_slot ^= scroll of acquirement:q
item_slot ^= scroll of amnesia:E
item_slot ^= scroll of blinking:B
item_slot ^= scroll of brand weapon:D
item_slot ^= scroll of butterflies:s
item_slot ^= scroll of enchant armour:u
item_slot ^= scroll of enchant weapon:W
item_slot ^= scroll of fear:f
item_slot ^= scroll of fog:F
item_slot ^= scroll of identify:i
item_slot ^= scroll of immolation:o
item_slot ^= scroll of revelation:j
item_slot ^= scroll of poison:y
item_slot ^= scroll of silence:S
item_slot ^= scroll of summoning:s
item_slot ^= scroll of teleportation:t
item_slot ^= scroll of torment:k
item_slot ^= scroll of vulnerability:v

item_slot ^= potion of ambrosia:A
item_slot ^= potion of attraction:n
item_slot ^= potion of berserk rage:z
item_slot ^= potion of brilliance:R
item_slot ^= potion of cancellation:C
item_slot ^= potion of curing:c
item_slot ^= potion of experience:x
item_slot ^= potion of enlightenment:g
item_slot ^= potion of haste:H
item_slot ^= potion of heal wounds:h
item_slot ^= potion of invisibility:I
item_slot ^= potion of lignification:l
item_slot ^= potion of magic:M
item_slot ^= potion of might:m
item_slot ^= potion of resistance:r
item_slot ^= potion of mutation:U

item_slot ^= condenser vane:V
item_slot ^= phial of floods:O
item_slot ^= phantom mirror:N
item_slot ^= box of beasts:X
item_slot ^= tin of tremorstones:T
item_slot ^= lightning rod:L

item_slot ^= wand of digging:K
item_slot ^= wand of flame:Q
item_slot ^= wand of mindburst:Y
item_slot ^= wand of acid:G
item_slot ^= wand of light:G
item_slot ^= wand of quicksilver:G
item_slot ^= wand of iceblast:Z
item_slot ^= wand of roots:Z
item_slot ^= wand of charming:J
item_slot ^= wand of paralysis:J



######## Spell Slots #########
spell_slot ^= Alistair's Intoxication:AITX
spell_slot ^= Alistairâ€™s Walking Alembic:AWKLMBSTEI
spell_slot ^= Anguish:ANGUISH
spell_slot ^= Animate Armour:ANMT
spell_slot ^= Animate Dead:ADNMT
spell_slot ^= Arcjolt:AJCOLT
spell_slot ^= Blink:BLNK
spell_slot ^= Borgnjor's Revivification:BRVF
spell_slot ^= Call Canine Familiar:CFN
spell_slot ^= Call Imp:ICMP
spell_slot ^= Cause Fear:CFSUR
spell_slot ^= Chain Lightning:LCHGNT
spell_slot ^= Cigotuvi's Dreadful Rot:CDRVT
spell_slot ^= Confusing Touch:CTF
spell_slot ^= Conjure Ball Lightning:BLCTN
spell_slot ^= Construct Spike Launcher:CSLPKNRAUE
spell_slot ^= Corpse Rot:CRPS
spell_slot ^= Dazzling Flash:DZFLSHNG
spell_slot ^= Death Channel:DCNL
spell_slot ^= Death's Door:DROTHEA
spell_slot ^= Detonation Catalyst:DCTNYTSAEO
spell_slot ^= Diamond Sawblades:DSWBLNIAO
spell_slot ^= Discord:DISCORD
spell_slot ^= Disjunction:DJNIS
spell_slot ^= Dispersal:DPLIS
spell_slot ^= Dragon's Call:DCRGN
spell_slot ^= Forge Monarch Bomb:FMBONRCHGEA
spell_slot ^= Forge Phalanx Beetle:FPBENXORG
spell_slot ^= Fortress Blast:FBRTSLA
spell_slot ^= Foxfire:FXOIRE
spell_slot ^= Fugue of the Fallen:FUGALNE
spell_slot ^= Fulsome Fusillade:FLSOMADE
spell_slot ^= Hoarfrost Cannonade:HCORFND
spell_slot ^= Ice Form:IFORM
spell_slot ^= Ignite Poison:IPOSN
spell_slot ^= Ignition:IGNTO
spell_slot ^= Infestation:INFESTAON
spell_slot ^= Irradiate:IRADTE
spell_slot ^= Iskenderun's Battlespehere:BSI
spell_slot ^= Iskenderun's Mystic Blast:IMB
spell_slot ^= Jinxbite:JNXBITE
spell_slot ^= Leda's Liquefaction:LQFND
spell_slot ^= Malign Gateway:MGWTN
spell_slot ^= Manifold Assault:MANFT
spell_slot ^= Martyr's Knell:MKNARTYEL
spell_slot ^= Maxwell's Capacitive Coupling:MCXW
spell_slot ^= Metabolic Englaciation:MENC
spell_slot ^= Monstrous Menagerie:MNGR
spell_slot ^= Nazjaâ€™s Percussive Tempering:NPTZJACUE
spell_slot ^= Olgreb's Toxic Radiance:TOR
spell_slot ^= Ozocubu's Armour:OAMR
spell_slot ^= Ozocubu's Refrigeration:ROZFG
spell_slot ^= Permafrost Eruption:PERUTFMAOSTIN
spell_slot ^= Platinum Paragon:PLTGNMAO
spell_slot ^= Polar Vortex:PVXT
spell_slot ^= Rending Blade:RBENDALG
spell_slot ^= Scorch:SCORH
spell_slot ^= Shatter:SHTR
spell_slot ^= Sigil of Binding:SBGILDNG
spell_slot ^= Silence:SICL
spell_slot ^= Spellspark Servitor:SVFR
spell_slot ^= Sphinx Sisters:SPHINXR
spell_slot ^= Starburst:SBUT
spell_slot ^= Static Discharge:DSCGT
spell_slot ^= Sublimation of Blood:SBLM
spell_slot ^= Summon Blazeheart Golem:SBGLZOM
spell_slot ^= Summon Cactus Giant:CGS
spell_slot ^= Summon Forest:FSRTM
spell_slot ^= Summon Horrible Things:HST
spell_slot ^= Summon Hydra:HYDRA
spell_slot ^= Summon Ice Beast:ISB
spell_slot ^= Summon Lightning Spire:SMLIRNG
spell_slot ^= Summon Mana Viper:MSV
spell_slot ^= Summon Seismosaurus Egg:EGSMIEOAU
spell_slot ^= Summon Small Mammal:SMLAUON
spell_slot ^= Swiftness:SWIFT
spell_slot ^= Volatile Blastmotes:VBOLMASTE
:if you.class() == "Summoner" then
  spell_slot ^= (summon|call):abcdefgh
:end

############################### End rc/slot-defaults.rc ###############################
##########################################################################################

## (Resuming init.txt) ##

### buehler.rc core files ###

################################### Begin lua/core/constants.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
--[[
BRC Constants - All constant definitions
Author: buehler
Dependencies: (none, but indirectly references core/constants.lua)
--]]

-- Initialize
BRC = BRC or {}

---- Items ----
BRC.ALL_MISC_ITEMS = {
  "box of beasts",
  "condenser vane",
  "figurine of a ziggurat",
  "Gell's gravitambourine",
  "horn of Geryon",
  "lightning rod",
  "phantom mirror",
  "phial of floods",
  "sack of spiders",
  "tin of tremorstones",
} -- BRC.ALL_MISC_ITEMS (do not remove this comment)

-- This is checked against the full text of the pickup message, so use patterns to match
BRC.ALL_MISSILES = {
  "poisoned dart",
  "atropa-tipped dart",
  "curare-tipped dart",
  "datura-tipped dart",
  "darts? of disjunction",
  "darts? of dispersal",
  " stone",
  "boomerang",
  "silver javelin",
  "javelin",
  "large rock",
  "throwing net",
} -- BRC.ALL_MISSILES (do not remove this comment)

-- Could be removed after https://github.com/crawl/crawl/issues/4606 is addressed
BRC.ALL_SPELLBOOKS = {
  "parchment of",
  "book of",
  "Necronomicon",
  "Grand Grimoire",
  "tome of obsoleteness",
  "Everburning Encyclopedia",
  "Ozocubu's Autobiography",
  "Maxwell's Memoranda",
  "Young Poisoner's Handbook",
  "Fen Folio",
  "Inescapable Atlas",
  "There-And-Back Book",
  "Great Wizards, Vol. II",
  "Great Wizards, Vol. VII",
  "Trismegistus Codex",
  "the Unrestrained Analects",
  "Compendium of Siegecraft",
  "Codex of Conductivity",
  "Handbook of Applied Construction",
  "Treatise on Traps",
  "My Sojourn through Swampland",
  "Akashic Record",
  -- Include prefixes for randart books
  "Almanac",
  "Anthology",
  "Atlas",
  "Book",
  "Catalogue",
  "Codex",
  "Compendium",
  "Compilation",
  "Cyclopedia",
  "Directory",
  "Elucidation",
  "Encyclopedia",
  "Folio",
  "Grimoire",
  "Handbook",
  "Incunable",
  "Incunabulum",
  "Octavo",
  "Omnibus",
  "Papyrus",
  "Parchment",
  "Precepts",
  "Quarto",
  "Secrets",
  "Spellbook",
  "Tome",
  "Vellum",
  "Volume",
} -- BRC.ALL_SPELLBOOKS (do not remove this comment)

---- Races ----
BRC.ALL_UNDEAD_RACES = {
  "Demonspawn",
  "Mummy",
  "Poltergeist",
  "Revenant",
} -- BRC.ALL_UNDEAD_RACES (do not remove this comment)

BRC.ALL_NONLIVING_RACES = {
  "Djinni",
  "Gargoyle",
} -- BRC.ALL_NONLIVING_RACES (do not remove this comment)

BRC.ALL_POIS_RES_RACES = {
  "Djinni",
  "Gargoyle",
  "Mummy",
  "Naga",
  "Poltergeist",
  "Revenant",
} -- BRC.ALL_POIS_RES_RACES (do not remove this comment)

BRC.ALL_LITTLE_RACES = {
  "Spriggan",
} -- BRC.ALL_LITTLE_RACES (do not remove this comment)

BRC.ALL_SMALL_RACES = {
  "Kobold",
} -- BRC.ALL_SMALL_RACES (do not remove this comment)

BRC.ALL_LARGE_RACES = {
  "Armataur",
  "Naga",
  "Oni",
  "Troll",
} -- BRC.ALL_LARGE_RACES (do not remove this comment)

---- Skills ----
BRC.ALL_STAFF_SCHOOLS = {
  air = "Air Magic",
  alchemy = "Alchemy",
  cold = "Ice Magic",
  death = "Necromancy",
  earth = "Earth Magic",
  fire = "Fire Magic",
  conjuration = "Conjurations",
} -- BRC.ALL_STAFF_SCHOOLS (do not remove this comment)

BRC.ALL_TRAINING_SKILLS = {
  "Air Magic",
  "Alchemy",
  "Armour",
  "Axes",
  "Conjurations",
  "Dodging",
  "Earth Magic",
  "Evocations",
  "Fighting",
  "Fire Magic",
  "Forgecraft",
  "Hexes",
  "Ice Magic",
  "Invocations",
  "Long Blades",
  "Maces & Flails",
  "Necromancy",
  "Polearms",
  "Ranged Weapons",
  "Shapeshifting",
  "Shields",
  "Short Blades",
  "Spellcasting",
  "Staves",
  "Stealth",
  "Summonings",
  "Translocations",
  "Unarmed Combat",
  "Throwing",
} -- BRC.ALL_TRAINING_SKILLS (do not remove this comment)

BRC.ALL_WEAP_SCHOOLS = {
  "axes",
  "maces & flails",
  "polearms",
  "long blades",
  "short blades",
  "staves",
  "unarmed combat",
  "ranged weapons",
} -- BRC.ALL_WEAP_SCHOOLS (do not remove this comment)

---- Branches ----
BRC.ALL_PORTAL_NAMES = {
  "Bailey",
  "Bazaar",
  "Desolation",
  "Gauntlet",
  "Ice Cave",
  "Necropolis",
  "Ossuary",
  "Sewer",
  "Trove",
  "Volcano",
  "Wizlab",
  "Zig",
} -- BRC.ALL_PORTAL_NAMES (do not remove this comment)

BRC.ALL_HELL_BRANCHES = {
  "Coc",
  "Dis",
  "Geh",
  "Hell",
  "Tar",
} -- BRC.ALL_HELL_BRANCHES (do not remove this comment)

---- Egos ----
BRC.PLAIN_DMG_EGOS = { -- Cause extra damage without a damage type
  "distortion",
  "heavy",
  "spectralizing",
} -- BRC.PLAIN_DMG_EGOS (do not remove this comment)

BRC.ALL_RISKY_EGOS = {
  "chaos",
  "distortion",
  "harm",
  "heavy",
  "infusion",
  "ponderous",
} -- BRC.ALL_RISKY_EGOS (do not remove this comment)

---- Other ----
BRC.KEYS = {
  LF = string.char(10),
  CR = string.char(13),
} -- BRC.KEYS (do not remove this comment)

BRC.MUTATIONS = {
  antennae = "antennae",
  augmentation = "augmentation",
  beak = "beak",
  claws = "claws",
  deformed = "deformed body",
  demonic_touch = "demonic touch",
  hooves = "hooves",
  horns = "horns",
  missing_hand = "missing a hand",
  pseudopods = "pseudopods",
  sharp_scales = "sharp scales",
  sturdy_frame = "sturdy frame",
  talons = "talons",
} -- BRC.MUTATIONS (do not remove this comment)

BRC.SIZE_PENALTY = {
  LITTLE = -2,
  SMALL = -1,
  NORMAL = 0,
  LARGE = 1,
  GIANT = 2,
} -- BRC.SIZE_PENALTY (do not remove this comment)

-- Would prefer to use integer values, but they don't work in all menus
BRC.COLORS = {
  blue = "blue",
  green = "green",
  cyan = "cyan",
  red = "red",
  magenta = "magenta",
  brown = "brown",
  lightgrey = "lightgrey",
  darkgrey = "darkgrey",
  lightblue = "lightblue",
  lightgreen = "lightgreen",
  lightcyan = "lightcyan",
  lightred = "lightred",
  lightmagenta = "lightmagenta",
  yellow = "yellow",
  white = "white",
  black = "black",
} -- BRC.COLORS (do not remove this comment)

BRC.DMG_TYPE = {
  unbranded = 1, -- No brand
  plain = 2, -- Include brand dmg with no associated damage type
  branded = 3, -- Include full brand dmg
  scoring = 4, -- Include boosts for non-damaging brands
} -- BRC.DMG_TYPE (do not remove this comment)

}
############################### End lua/core/constants.lua ###############################
##########################################################################################

################################### Begin lua/core/data.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
--[[
BRC.data - Persistent data management module
Manages persistent data across games and saves
Author: buehler
Dependencies: (none)
--]]

-- Initialize
BRC = BRC or {}
BRC.data = {}

-- Local constants
local BRC_PREFIX = "brc_data_"
local TYPES = {
  string = "string",
  number = "number",
  boolean = "boolean",
  list = "list",
  dict = "dict",
  table = "table",
  unknown = "unknown",
}

-- Values to detect when character is changed
local GAME_CHANGE_MONITORS = {
  buehler_rc_version = BRC.VERSION,
  buehler_name = you.name(),
  buehler_race = you.race(), -- using 'race' without a prefix breaks RC parser
  buehler_class = you.class(), -- using 'class' without a prefix breaks RC parser
} -- GAME_CHANGE_MONITORS (do not remove this comment)

-- Persistent variables - BRC.data defines these in init(), to come after all other persistent data

-- Private variables
local _persistent_var_names = {}
local _persistent_table_names = {}

-- Private functions (defined globally to allow access from chk_lua_save)
function BRC.data._brc_type_of(value)
  local t = type(value)
  if t == "table" then
    if #value > 0 then
      return TYPES.list
    else
      return TYPES.dict
    end
  elseif t == "string" then
    return TYPES.string
  elseif t == "number" then
    return TYPES.number
  elseif t == "boolean" then
    return TYPES.boolean
  else
    return TYPES.unknown
  end
end

function BRC.data._brc_val2str(value, indent_count)
  if not value then return "nil" end
  indent_count = indent_count or 1
  local indent = string.rep("  ", indent_count)
  local list_separator = ",\n" .. indent

  local type = BRC.data._brc_type_of(value)
  if type == TYPES.string then
    return string.format('"%s"', value:gsub('"', ""))
  elseif type == TYPES.number then
    return tostring(value)
  elseif type == TYPES.boolean then
    return tostring(value)
  elseif type == TYPES.list then
    local tokens = {}
    for _, v in ipairs(value) do
      tokens[#tokens + 1] = BRC.data._brc_val2str(v, indent_count + 1)
    end
    if #tokens == 0 then return "{}" end
    return string.format("{\n%s%s\n}", indent, table.concat(tokens, list_separator))
  elseif type == TYPES.dict then
    local tokens = {}
    for k, v in pairs(value) do
      tokens[#tokens + 1] = string.format('["%s"] = %s', k, BRC.data._brc_val2str(v, indent_count + 1))
    end
    if #tokens == 0 then return "{}" end
    return string.format("{\n%s%s\n}", indent, table.concat(tokens, list_separator))
  else
    local str = tostring(value) or "nil"
    BRC.log.error(string.format("Unknown data type for value (%s): %s", str, type))
    return "nil"
  end
end

-- Public API

--[[
BRC.data.persist() Creates a persistent global variable or table, initialized to the default value if it doesn't exist.
The variable/list/dict is automatically persisted across saves.
Returns the current value.
Usage: variable_name = BRC.data.persist("variable_name", default_value)
--]]
function BRC.data.persist(name, default_value)
  if _G[name] == nil then _G[name] = default_value end

  table.insert(chk_lua_save, function()
    local var_type = BRC.data._brc_type_of(_G[name])
    if var_type == TYPES.unknown then return "" end
    return string.format("%s = %s%s", name, BRC.data._brc_val2str(_G[name]), BRC.KEYS.LF)
  end)

  local var_type = BRC.data._brc_type_of(_G[name])
  if var_type == TYPES.list or var_type == TYPES.dict then
    _persistent_table_names[#_persistent_table_names + 1] = name
  else
    _persistent_var_names[#_persistent_var_names + 1] = name
  end

  return _G[name]
end

function BRC.data.serialize()
  local tokens = { "\n---PERSISTENT TABLES---\n" }
  for _, name in ipairs(_persistent_table_names) do
    tokens[#tokens + 1] = string.format("%s = %s\n\n", name, BRC.data._brc_val2str(_G[name]))
  end

  tokens[#tokens + 1] = "\n---PERSISTENT VARIABLES---\n"
  for _, name in ipairs(_persistent_var_names) do
    tokens[#tokens + 1] = string.format("%s = %s\n", name, BRC.data._brc_val2str(_G[name]))
  end

  return table.concat(tokens)
end

function BRC.data.erase()
  if _persistent_var_names then
    for _, name in ipairs(_persistent_var_names) do
      _G[name] = nil
    end
  end

  if _persistent_table_names then
    for _, name in ipairs(_persistent_table_names) do
      _G[name] = nil
    end
  end

  _persistent_var_names = {}
  _persistent_table_names = {}
end

--[[
BRC.data.verify_reinit() Verifies data reinitialization and game state consistency
This should be called after all features have run init() to declare their data
--]]
function BRC.data.verify_reinit()
  local failed_reinit = false
  if you.turns() > 0 then
    for k, v in pairs(GAME_CHANGE_MONITORS) do
      local prev = _G[BRC_PREFIX .. k]
      if prev ~= v then
        failed_reinit = true
        local msg = string.format("Unexpected change to %s: %s -> %s", k, prev, v)
        BRC.mpr.lightred(msg)
      end
    end

    if not _G[BRC_PREFIX .. "successful_reload"] then
      failed_reinit = true
      BRC.log.error(string.format("Failed to load persistent data for buehler.rc v%s!", BRC.VERSION))
      BRC.mpr.darkgrey("Try restarting, or set BRC.DEBUG_MESSAGES=True for more info.")
    end

    if failed_reinit and BRC.mpr.yesno("Deactivate buehler.rc?", BRC.COLORS.yellow) then return false end
  end

  for k, v in pairs(GAME_CHANGE_MONITORS) do
    local var_name = BRC_PREFIX .. k
    _G[var_name] = BRC.data.persist(var_name, v)
  end
  _G[BRC_PREFIX .. "successful_reload"] = true

  return true
end

function BRC.data.init()
  for k, v in pairs(GAME_CHANGE_MONITORS) do
    BRC.data.persist(BRC_PREFIX .. k, v)
  end

  -- brc_data_successful_reload comes last, defaults to false. If true, confirms all data reloaded.
  BRC.data.persist(BRC_PREFIX .. "successful_reload", false)
  return BRC.data.verify_reinit()
end

}
############################### End lua/core/data.lua ###############################
##########################################################################################

################################### Begin lua/core/util.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
--[[
BRC Utility Functions - All utility functions organized into logical tables
Author: buehler
Dependencies: (none)
--]]

-- Initialize
BRC = BRC or {}
BRC.log = {}
BRC.text = {}
BRC.mpr = {}
BRC.get = {}
BRC.is = {}
BRC.you = {}
BRC.set = {}
BRC.util = {}
BRC.dump = {}

-- Local variables
local _mpr_queue = {}

-- Local constants
local CLEANUP_TEXT_CHARS = "([%^%$%(%)%%%.%[%]%*%+%-%?])"

-- Local functions
local function log_message(message, context, color)
  message = message or "Unknown message"
  color = color or BRC.LogColor.info
  local msg = string.format("[BRC] %s", message)
  if context then
    msg = string.format("%s (%s)", msg, context)
  end
  crawl.mpr(string.format("<%s>%s</%s>", color, msg, color))
  crawl.flush_prev_message()
end

local function serialize_chk_lua_save()
  local tokens = { "\n---CHK_LUA_SAVE---" }
  for _, func in ipairs(chk_lua_save) do
    tokens[#tokens + 1] = util.trim(func())
  end

  return table.concat(tokens, "\n")
end

local function serialize_inventory()
  local tokens = { "\n---INVENTORY---\n" }
  for inv in iter.invent_iterator:new(items.inventory()) do
    tokens[#tokens + 1] = string.format("%s: (%s) Qual: %s", inv.slot, inv.quantity, inv.name("qual"))
    local base = inv.name("base") or "N/A"
    local cls = inv.class(true) or "N/A"
    local st = inv.subtype() or "N/A"
    tokens[#tokens + 1] = string.format("  Base: %s Class: %s, Subtype: %s\n", base, cls, st)
  end

  return table.concat(tokens)
end

-- BRC.log - Logging methods
function BRC.log.error(message, context)
  log_message(message, context, BRC.LogColor.error)
end

function BRC.log.warning(message, context)
  log_message(message, context, BRC.LogColor.warning)
end

function BRC.log.info(message, context)
  log_message(message, context, BRC.LogColor.info)
end

function BRC.log.debug(message, context)
  if not BRC.Config.show_debug_messages then return end
  log_message(message, context, BRC.LogColor.debug)
end

---- BRC.text - Utility functions ----

-- Remove tags from text, and optionally escape special characters
function BRC.text.clean_text(text, escape_chars)
  -- Fast path: if no tags, just handle newlines and escaping
  if not text:find("<", 1, true) then
    local one_line = text:gsub("\n", "")
    if escape_chars then return one_line:gsub(CLEANUP_TEXT_CHARS, "%%%1") end
    return one_line
  end

  local tokens = {}
  local pos = 1
  local len = #text

  while pos <= len do
    local tag_start = text:find("<", pos, true)
    if not tag_start then
      -- No more tags, append remaining text
      tokens[#tokens + 1] = text:sub(pos)
      break
    end

    -- Append text before tag
    if tag_start > pos then tokens[#tokens + 1] = text:sub(pos, tag_start - 1) end

    -- Find end of tag
    local tag_end = text:find(">", tag_start, true)
    if not tag_end then
      -- Malformed tag, append remaining text
      tokens[#tokens + 1] = text:sub(pos)
      break
    end

    pos = tag_end + 1
  end

  -- Join all parts and remove newlines
  local cleaned = table.concat(tokens):gsub("\n", "")

  -- Handle escaping if needed
  if escape_chars then return cleaned:gsub(CLEANUP_TEXT_CHARS, "%%%1") end

  return cleaned
end

-- Wrap text in a color tag, Usage: BRC.text.blue("Hello"), or BRC.text["red"]("Hello")
for k, v in pairs(BRC.COLORS) do
  BRC.text[k] = function(text)
    return string.format("<%s>%s</%s>", v, text, v)
  end
end

function BRC.text.color(color, text)
  return color and BRC.text[color](text) or text
end

--- BRC.mpr - Wrappers around crawl.mpr ---
-- Create a wrapper for each color. Usage: BRC.mpr.lightgreen("Hello"), or BRC.mpr["red"]("Hello")
for k, v in pairs(BRC.COLORS) do
  BRC.mpr[k] = function(text, channel)
    crawl.mpr(BRC.text.color(v, text), channel)
    crawl.flush_prev_message()
  end
end

function BRC.mpr.color(text, color, channel)
  return BRC.mpr[color](text, channel)
end

-- Message and stop travel/activity
function BRC.mpr.stop(text, color, channel)
  BRC.mpr.color(text, color, channel)
  you.stop_activity()
end

-- Message and a more prompt
function BRC.mpr.more(text, color, channel)
  BRC.mpr.color(text, color, channel)
  you.stop_activity()
  crawl.more()
  crawl.redraw_screen()
end

-- Conditionally display a more prompt
function BRC.mpr.optmore(show_more, text, color, channel)
  if show_more then
    BRC.mpr.more(text, color, channel)
  else
    BRC.mpr.color(text, color, channel)
  end
end

-- Queue a message, to dispay at start of next turn
function BRC.mpr.que(text, color, channel)
  for _, msg in ipairs(_mpr_queue) do
    if msg.text == text and msg.channel == channel then return end
  end
  _mpr_queue[#_mpr_queue + 1] = { text = BRC.text.color(color, text), channel = channel, show_more = false }
end

-- Queue msg w/ conditional force-more prompt
function BRC.mpr.que_optmore(show_more, text, color, channel)
  for _, msg in ipairs(_mpr_queue) do
    if msg.text == text and msg.channel == channel and msg.show_more == show_more then return end
  end
  _mpr_queue[#_mpr_queue + 1] = { text = BRC.text.color(color, text), channel = channel, show_more = show_more }
end

-- Display and consume the message queue
function BRC.mpr.consume_queue()
  local do_more = false
  for _, msg in ipairs(_mpr_queue) do
    crawl.mpr(msg.text, msg.channel)
    crawl.flush_prev_message()
    if msg.show_more then do_more = true end
  end

  if do_more then
    you.stop_activity()
    crawl.redraw_screen()
    crawl.more()
    crawl.redraw_screen()
  end

  _mpr_queue = {}
end

-- Get a yes/no response
function BRC.mpr.yesno(text, color, capital_only)
  local msg = string.format("%s (%s)", text, capital_only and "Y/N" or "y/n")
  local MAX_TRIES = 10

  for i = 1, MAX_TRIES do
    crawl.formatted_mpr(BRC.text.color(color, msg), "prompt")
    local res = crawl.getch()
    if string.char(res) == "Y" or string.char(res) == "y" and not capital_only then return true end
    if string.char(res) == "N" or string.char(res) == "n" and not capital_only then return false end
    if i == 1 and capital_only then msg = "[CAPS ONLY] " .. msg end
  end

  BRC.mpr.lightmagenta("Feels like a no.")
  return false
end

---- BRC.get - Functions to get non-boolean data ----

function BRC.get.command_key(cmd)
  local key = crawl.get_command(cmd)
  if not key then return nil end
  return key:sub(-1) -- get_command returns things like "Uppercase S"; we just want 'S'
end

--[[
BRC.get.equipped_aux() - Returns 2 values:
  1. A list of equipped items of the type
  2. the num_slots (ie maximum size the list can ever be). This is usually a list of length 1, with num_slots==1.
  Poltergeists will get all worn aux armours and num_slots=6.
The length of the list <= num_slots.
--]]
function BRC.get.equipped_aux(aux_type)
  local all_aux = {}
  local num_slots = you.race() == "Poltergeist" and 6 or 1
  for i = 1, num_slots do
    local it = items.equipped_at(aux_type, i)
    all_aux[#all_aux + 1] = it
  end
  return all_aux, num_slots
end

function BRC.get.mut(mutation, include_all)
  return you.get_base_mutation_level(mutation, true, include_all, include_all)
end

function BRC.get.skill(skill)
  if not skill:find(",", 1, true) then return you.skill(skill) end

  local skills = crawl.split(skill, ",")
  local sum = 0
  local count = 0
  for _, s in ipairs(skills) do
    sum = sum + you.skill(s)
    count = count + 1
  end
  return sum / count
end

function BRC.get.skill_with(it)
  if BRC.is.magic_staff(it) then return math.max(BRC.get.skill(BRC.get.staff_school(it)), BRC.get.skill("Staves")) end
  if it.is_weapon then return BRC.get.skill(it.weap_skill) end
  if BRC.is.body_armour(it) then return BRC.get.skill("Armour") end
  if BRC.is.shield(it) then return BRC.get.skill("Shields") end
  if BRC.is.talisman(it) then return BRC.get.skill("Shapeshifting") end

  return 1 -- Fallback to 1
end

function BRC.get.staff_school(it)
  for k, v in pairs(BRC.ALL_STAFF_SCHOOLS) do
    if it.subtype() == k then return v end
  end
end

function BRC.get.talisman_min_level(it)
  -- Parse the item description
  local tokens = crawl.split(it.description, "\n")
  for _, v in ipairs(tokens) do
    if v:sub(1, 4) == "Min " then
      local start_pos = v:find("%d", 4)
      if start_pos then
        local end_pos = v:find("[^%d]", start_pos)
        return tonumber(v:sub(start_pos, end_pos - 1))
      end
    end
  end

  return 0 -- Fallback to 0, to surface any errors. Applies to Protean Talisman.
end

---- BRC.is - Boolean type checks of items ----

function BRC.is.amulet(it)
  return it and it.name("base") == "amulet"
end

function BRC.is.armour(it, include_orbs)
  -- exclude orbs by default
  if not it or it.class(true) ~= "armour" then return false end
  if not include_orbs and BRC.is.orb(it) then return false end
  return true
end

function BRC.is.aux_armour(it)
  return BRC.is.armour(it) and not (BRC.is.body_armour(it) or BRC.is.shield(it))
end

function BRC.is.body_armour(it)
  return it and it.subtype() == "body"
end

function BRC.is.jewellery(it)
  return it and it.class(true) == "jewellery"
end

function BRC.is.magic_staff(it)
  return it and it.class and it.class(true) == "magical staff"
end

function BRC.is.ring(it)
  return it and it.name("base") == "ring"
end

function BRC.is.scarf(it)
  return it and it.class(true) == "armour" and it.subtype() == "scarf"
end

function BRC.is.shield(it)
  return it and it.is_shield()
end

function BRC.is.talisman(it)
  if not it then return false end
  local c = it.class(true)
  return c and (c == "talisman" or c == "bauble")
end

function BRC.is.orb(it)
  return it and it.class(true) == "armour" and it.subtype() == "offhand" and not it.is_shield()
end

function BRC.is.polearm(it)
  return it and it.weap_skill:find("Polearms", 1, true)
end

---- BRC.you - Boolean attributes of the character ----

function BRC.you.free_offhand()
  if BRC.get.mut(BRC.MUTATIONS.missing_hand, true) > 0 then return true end
  return not items.equipped_at("offhand")
end

function BRC.you.have_shield()
  return BRC.is.shield(items.equipped_at("offhand"))
end

function BRC.you.in_hell()
  return util.contains(BRC.ALL_HELL_BRANCHES, you.branch())
end

function BRC.you.by_slimy_wall()
  for x = -1, 1 do
    for y = -1, 1 do
      if view.feature_at(x, y) == "slimy_wall" then return true end
    end
  end
  return false
end

function BRC.you.miasma_immune()
  if util.contains(BRC.ALL_UNDEAD_RACES, you.race()) then return true end
  if util.contains(BRC.ALL_NONLIVING_RACES, you.race()) then return true end
  return false
end

function BRC.you.mutation_immune()
  return util.contains(BRC.ALL_UNDEAD_RACES, you.race())
end

function BRC.you.zero_stat()
  return you.strength() <= 0 or you.dexterity() <= 0 or you.intelligence() <= 0
end

---- BRC.set - Simple helper functions wrapping crawl.setopt() ----
function BRC.set.autopickup_exception(pattern, add_pattern)
  local op = add_pattern and "^=" or "-="
  crawl.setopt(string.format("autopickup_exceptions %s %s", op, pattern))
end

function BRC.set.explore_stop(pattern, add_pattern)
  local op = add_pattern and "+=" or "-="
  crawl.setopt(string.format("explore_stop %s %s", op, pattern))
end

function BRC.set.explore_stop_pickup_ignore(pattern, add_pattern)
  local op = add_pattern and "+=" or "-="
  crawl.setopt(string.format("explore_stop_pickup_ignore %s %s", op, pattern))
end

function BRC.set.flash_screen_message(pattern, add_pattern)
  local op = add_pattern and "+=" or "-="
  crawl.setopt(string.format("flash_screen_message %s %s", op, pattern))
end

function BRC.set.force_more(pattern, add_pattern)
  local op = add_pattern and "+=" or "-="
  crawl.setopt(string.format("force_more_message %s %s", op, pattern))
end

-- Sets a macro. Function must be global and not a member of a module.
function BRC.set.macro(key, function_name)
  BRC.log.debug(string.format(
    "Assigning macro: %s to %s",
    BRC.text.magenta(function_name.."()"),
    BRC.text.lightred("< '" .. key .. "' >")
  ))
  crawl.setopt(string.format("macros += M %s ===%s", key, function_name))
end

function BRC.set.message_mute(pattern, mute_pattern)
  local op = mute_pattern and "^=" or "-="
  crawl.setopt(string.format("message_colour %s mute:%s", op, pattern))
end

function BRC.set.runrest_ignore_message(pattern, add_pattern)
  local op = add_pattern and "+=" or "-="
  crawl.setopt(string.format("runrest_ignore_message %s %s", op, pattern))
end

--- BRC.dump - Debugging utils called from in-game lua interpreter ---

function BRC.dump.all(verbose, skip_mpr)
  local tokens = {}

  tokens[#tokens + 1] = BRC.data.serialize()
  if verbose then
    tokens[#tokens + 1] = serialize_inventory()
    tokens[#tokens + 1] = _weapon_cache.serialize()
    tokens[#tokens + 1] = serialize_chk_lua_save()
  end

  local text = table.concat(tokens, "\n")
  if not skip_mpr then
    BRC.mpr.white(text)
  end

  return text
end

function macro_brc_dump_character()
  if BRC.mpr.yesno("Add BRC debug info to character dump?", BRC.COLORS.lightcyan) then
    crawl.take_note(BRC.dump.all(true, true))
    BRC.mpr.lightgray("BRC debug info added to character dump.")
  else
    BRC.mpr.lightgray("Okay, then.")
  end
  BRC.util.do_cmd("CMD_CHARACTER_DUMP", "#") -- Includes the message w/ file path to console
end

--- BRC.util - Utility functions ----
-- BRC.util.do_cmd(): Tries via keypress first, fallback to crawl.do_commands()
-- crawl.do_commands() isn't always immediate; might wait for a keypress before doing the command
function BRC.util.do_cmd(cmd)
  local key = BRC.get.command_key(cmd)
  if key then
    crawl.sendkeys({key})
  else
    crawl.do_commands({cmd})
  end
end

--[[
The functions above are general purpose: They should apply to any crawl RC file.
The functions below contain design choices or logic that are somewhat specific to BRC.
Examples: Weapon DPS calculation, treating dragon scales as branded, or defining what a "risky ego" is.
--]]

-- Local functions; Often mirroring calculations that live in crawl.
-- Each mirrored function is commented with the last dcss version it was compared against.

local function format_dmg(dmg)
  -- Always return a string of length 4
  if dmg < 10 then return string.format("%.2f", dmg) end
  if dmg > 99.9 then return ">100" end
  return string.format("%.1f", dmg)
end

local function format_stat(abbr, val, is_worn)
  local stat_str = string.format("%.1f", val)
  if val < 0 then
    return string.format("%s%s", abbr, stat_str)
  elseif is_worn then
    return string.format("%s:%s", abbr, stat_str)
  else
    return string.format("%s+%s", abbr, stat_str)
  end
end

local function get_size_penalty()
  if util.contains(BRC.ALL_LITTLE_RACES, you.race()) then
    return BRC.SIZE_PENALTY.LITTLE
  elseif util.contains(BRC.ALL_SMALL_RACES, you.race()) then
    return BRC.SIZE_PENALTY.SMALL
  elseif util.contains(BRC.ALL_LARGE_RACES, you.race()) then
    return BRC.SIZE_PENALTY.LARGE
  end
  return BRC.SIZE_PENALTY.NORMAL
end

local function get_unadjusted_armour_pen(encumb)
  -- dcss v0.33.1
  local pen = encumb - 2 * BRC.get.mut(BRC.MUTATIONS.sturdy_frame, true)
  if pen > 0 then return pen end
  return 0
end

local function get_adjusted_armour_pen(encumb, str)
  -- dcss v0.33.1
  local base_pen = get_unadjusted_armour_pen(encumb)
  return 2 * base_pen * base_pen * (45 - you.skill("Armour")) / 45 / (5 * (str + 3))
end

local function get_adjusted_dodge_bonus(encumb, str, dex)
  -- dcss v0.33.1
  local size_factor = -2 * get_size_penalty()
  local dodge_bonus = 8 * (10 + you.skill("Dodging") * dex) / (20 - size_factor) / 10
  local armour_dodge_penalty = get_unadjusted_armour_pen(encumb) - 3
  if armour_dodge_penalty <= 0 then return dodge_bonus end

  if armour_dodge_penalty >= str then return dodge_bonus * str / (armour_dodge_penalty * 2) end
  return dodge_bonus - dodge_bonus * armour_dodge_penalty / (str * 2)
end

local function get_shield_penalty(sh)
  -- dcss v0.33.1
  return 2 * sh.encumbrance * sh.encumbrance * (27 - you.skill("Shields")) / 27 / (25 + 5 * you.strength())
end

local function get_branded_delay(delay, ego)
  if not ego then return delay end
  if ego == "speed" then
    return delay * 2 / 3
  elseif ego == "heavy" then
    return delay * 1.5
  end
  return delay
end

local function get_weap_min_delay(it)
  -- dcss v0.33.1
  -- This is an abbreviated version of the actual calculation.
  -- Skips brand and >=3 checks, which are covered in get_weap_delay()
  if it.artefact and it.name("qual"):find("woodcutter's axe", 1, true) then return it.delay end

  local min_delay = math.floor(it.delay / 2)
  if it.weap_skill == "Short Blades" then return 5 end
  if it.is_ranged then
    local basename = it.name("base")
    local is_2h_ranged = basename:find("crossbow", 1, true) or basename:find("arbalest", 1, true)
    if is_2h_ranged then return math.max(min_delay, 10) end
  end

  return math.min(min_delay, 7)
end

local function get_weap_delay(it)
  -- dcss v0.33.1
  local delay = it.delay - BRC.get.skill(it.weap_skill) / 2
  delay = math.max(delay, get_weap_min_delay(it))
  delay = get_branded_delay(delay, BRC.get.ego(it))
  delay = math.max(delay, 3)

  local sh = items.equipped_at("offhand")
  if BRC.is.shield(sh) then delay = delay + get_shield_penalty(sh) end

  if it.is_ranged then
    local worn = items.equipped_at("armour")
    if worn then
      local str = you.strength()

      local cur = items.equipped_at("weapon")
      if cur and cur ~= it and cur.artefact then
        if it.artefact and it.artprops["Str"] then str = str + it.artprops["Str"] end
        if cur.artefact and cur.artprops["Str"] then str = str - cur.artprops["Str"] end
      end

      delay = delay + get_adjusted_armour_pen(worn.encumbrance, str)
    end
  end

  return delay / 10
end

local function get_slay_bonuses()
  local sum = 0

  -- Slots can go as high as 18 afaict
  for i = 0, 20 do
    local it = items.equipped_at(i)
    if it then
      if BRC.is.ring(it) then
        if it.artefact then
          local name = it.name()
          local idx = name:find("Slay", 1, true)
          if idx then
            local slay = tonumber(name:sub(idx + 5, idx + 5))
            if slay == 1 then
              local next_digit = tonumber(name:sub(idx + 6, idx + 6))
              if next_digit then slay = 10 + next_digit end
            end

            if name:sub(idx + 4, idx + 4) == "+" then
              sum = sum + slay
            else
              sum = sum - slay
            end
          end
        elseif BRC.get.ego(it) == "Slay" then
          sum = sum + it.plus
        end
      elseif it.artefact and (BRC.is.armour(it, true) or BRC.is.amulet(it)) then
        local slay = it.artprops["Slay"]
        if slay then sum = sum + slay end
      end
    end
  end

  if you.race() == "Demonspawn" then
    sum = sum + 3 * BRC.get.mut(BRC.MUTATIONS.augmentation, true)
    sum = sum + BRC.get.mut(BRC.MUTATIONS.sharp_scales, true)
  end

  return sum
end

local function get_staff_bonus_dmg(it, dmg_type)
  -- dcss v0.33.1
  if dmg_type == BRC.DMG_TYPE.unbranded then return 0 end
  if dmg_type == BRC.DMG_TYPE.plain then
    local basename = it.name("base")
    if basename ~= "staff of earth" and basename ~= "staff of conjuration" then return 0 end
  end

  local spell_skill = BRC.get.skill(BRC.get.staff_school(it))
  local evo_skill = you.skill("Evocations")

  local chance = (2 * evo_skill + spell_skill) / 30
  if chance > 1 then chance = 1 end
  -- 0.75 is an acceptable approximation; most commonly 63/80
  -- Varies by staff type in sometimes complex ways
  local avg_dmg = 3 / 4 * (evo_skill / 2 + spell_skill)
  return avg_dmg * chance
end

-- Formatting for stat inscriptions & alerts
function BRC.get.armour_info(it)
  if not BRC.is.armour(it) then return "", "" end

  -- Compare against last slot if poltergeist
  local slot_num = you.race() == "Poltergeist" and 6 or 1
  local cur = items.equipped_at(it.equip_type, slot_num)
  local is_worn = it.equipped or (it.ininventory and cur and cur.slot == it.slot)
  local cur_ac = 0
  local cur_sh = 0
  local cur_ev = 0
  if cur and not is_worn then
    -- Show deltas if not worn, else compare against 0
    if BRC.is.shield(cur) then
      cur_sh = BRC.get.shield_sh(cur)
      cur_ev = -get_shield_penalty(cur)
    else
      cur_ac = BRC.get.armour_ac(cur)
      cur_ev = BRC.get.armour_ev(cur)
    end
  end

  if BRC.is.shield(it) then
    local sh_str = format_stat("SH", BRC.get.shield_sh(it) - cur_sh, is_worn)
    local ev_str = format_stat("EV", -get_shield_penalty(it) - cur_ev, is_worn)
    return sh_str, ev_str
  else
    local ac_str = format_stat("AC", BRC.get.armour_ac(it) - cur_ac, is_worn)
    if not BRC.is.body_armour(it) then return ac_str end
    local ev_str = format_stat("EV", BRC.get.armour_ev(it) - cur_ev, is_worn)
    return ac_str, ev_str
  end
end

function BRC.get.weapon_info(it, dmg_type)
  if not it.is_weapon then return end
  dmg_type = dmg_type or BRC.DMG_TYPE[BRC.Config.inscribe_dps_type] or BRC.DMG_TYPE.plain
  local dmg = format_dmg(BRC.get.weap_damage(it, dmg_type))
  local delay = get_weap_delay(it)
  local delay_str = string.format("%.1f", delay)
  if delay < 1 then
    delay_str = string.format("%.2f", delay)
    delay_str = delay_str:sub(2, #delay_str)
  end

  local dps = format_dmg(dmg / delay)
  local acc = it.accuracy + (it.plus or 0)
  if acc >= 0 then acc = string.format("+%s", acc) end

  --TODO: This would be nice if it worked in all UIs
  --return string.format("DPS:<w>%s</w> (%s/%s), Acc<w>%s</w>", dps, dmg, delay_str, acc)
  return string.format("DPS: %s (%s/%s), Acc%s", dps, dmg, delay_str, acc)
end

-- Egos, with customized definition:
-- Excludes unusable egos. Includes: artefacts, and armours with innate egos (except steam dragon scales)
function BRC.get.ego(it, exclude_stat_only_egos)
  local ego = it.ego(true)
  if ego then
    if BRC.is.unusable_ego(ego) or (exclude_stat_only_egos and (ego == "speed" or ego == "heavy")) then
      return it.artefact and it.name() or nil
    end
    return ego
  end

  if BRC.is.body_armour(it) then
    local qualname = it.name("qual")
    if qualname:find("dragon scales", 1, true) and not qualname:find("steam", 1, true)
      or qualname:find("troll leather", 1, true) then
        return qualname
    end
  end

  return it.artefact and it.name() or nil
end

function BRC.get.hands(it)
  if you.race() ~= "Formicid" then return it.hands end
  local st = it.subtype()
  if st == "giant club" or st == "giant spiked club" then return 2 end
  return 1
end

function BRC.is.unusable_ego(ego)
  if ego == "holy" and util.contains(BRC.ALL_POIS_RES_RACES, you.race()) then return true end
  if ego == "rPois" and util.contains(BRC.ALL_POIS_RES_RACES, you.race()) then return true end
  return false
end

function BRC.is.risky_ego(ego_name)
  if not ego_name then return false end
  for _, v in ipairs(BRC.ALL_RISKY_EGOS) do
    if ego_name:find(v) then return true end
  end
  return false
end

-- Armour stats
function BRC.get.armour_ac(it)
  -- dcss v0.33.1
  local it_plus = it.plus or 0

  if it.artefact and it.is_identified then
    local art_ac = it.artprops["AC"]
    if art_ac then it_plus = it_plus + art_ac end
  end

  local ac = it.ac * (1 + you.skill("Armour") / 22) + it_plus
  if not BRC.is.body_armour(it) then return ac end

  local deformed = BRC.get.mut(BRC.MUTATIONS.deformed, true) > 0
  local pseudopods = BRC.get.mut(BRC.MUTATIONS.pseudopods, true) > 0
  if pseudopods or deformed then return ac * 6 / 10 end

  return ac
end

function BRC.get.armour_ev(it)
  -- dcss v0.33.1
  -- This function computes the armour-based component to standard EV (not paralysed, etc)
  -- Factors in stat changes from this armour and removing current one
  local str = you.strength()
  local dex = you.dexterity()
  local no_art_str = str
  local no_art_dex = dex
  local art_ev = 0

  -- Adjust str/dex/EV for artefact stat changes
  local worn = items.equipped_at("armour")
  if worn and worn.artefact then
    if worn.artprops["Str"] then str = str - worn.artprops["Str"] end
    if worn.artprops["Dex"] then dex = dex - worn.artprops["Dex"] end
    if worn.artprops["EV"] then art_ev = art_ev - worn.artprops["EV"] end
  end

  if it.artefact then
    if it.artprops["Str"] then str = str + it.artprops["Str"] end
    if it.artprops["Dex"] then dex = dex + it.artprops["Dex"] end
    if it.artprops["EV"] then art_ev = art_ev + it.artprops["EV"] end
  end

  if str <= 0 then str = 1 end

  local dodge_bonus = get_adjusted_dodge_bonus(it.encumbrance, str, dex)
  local naked_dodge_bonus = get_adjusted_dodge_bonus(0, no_art_str, no_art_dex)
  return (dodge_bonus - naked_dodge_bonus) + art_ev - get_adjusted_armour_pen(it.encumbrance, str)
end

function BRC.get.shield_sh(it)
  -- dcss v0.33.1
  local dex = you.dexterity()
  if it.artefact and it.is_identified then
    local art_dex = it.artprops["Dex"]
    if art_dex then dex = dex + art_dex end
  end

  local cur = items.equipped_at("offhand")
  if BRC.is.shield(cur) and cur.artefact and cur.slot ~= it.slot then
    local art_dex = cur.artprops["Dex"]
    if art_dex then dex = dex - art_dex end
  end

  local it_plus = it.plus or 0

  local base_sh = it.ac * 2
  local shield = base_sh * (50 + you.skill("Shields") * 5 / 2)
  shield = shield + 200 * it_plus
  shield = shield + 38 * (you.skill("Shields") + 3 + dex * (base_sh + 13) / 26)
  return shield / 200
end

-- Weapon stats
function BRC.get.weap_dps(it, dmg_type)
  if not dmg_type then dmg_type = BRC.DMG_TYPE.scoring end
  return BRC.get.weap_damage(it, dmg_type) / get_weap_delay(it)
end

function BRC.get.weap_damage(it, dmg_type)
  -- Returns an adjusted weapon damage = damage * speed
  -- Includes stat/slay changes between weapon and the one currently wielded
  -- Aux attacks not included
  if not dmg_type then dmg_type = BRC.DMG_TYPE.scoring end
  local it_plus = it.plus or 0
  -- Adjust str/dex/slay from artefacts
  local str = you.strength()
  local dex = you.dexterity()

  -- Adjust str/dex/EV for artefact stat changes
  if not it.equipped then
    local wielded = items.equipped_at("weapon")
    if wielded and wielded.artefact then
      if wielded.artprops["Str"] then str = str - wielded.artprops["Str"] end
      if wielded.artprops["Dex"] then dex = dex - wielded.artprops["Dex"] end
      if wielded.artprops["Slay"] then it_plus = it_plus - wielded.artprops["Slay"] end
    end

    if it.artefact and it.is_identified then
      if it.artprops["Str"] then str = str + it.artprops["Str"] end
      if it.artprops["Dex"] then dex = dex + it.artprops["Dex"] end
      if it.artprops["Slay"] then it_plus = it_plus + it.artprops["Slay"] end
    end
  end

  local stat = str
  if it.is_ranged or it.weap_skill:find("Blades", 1, true) then stat = dex end

  local stat_mod = 0.75 + 0.025 * stat
  local skill_mod = (1 + BRC.get.skill(it.weap_skill) / 25 / 2) * (1 + you.skill("Fighting") / 30 / 2)

  it_plus = it_plus + get_slay_bonuses()

  local pre_brand_dmg_no_plus = it.damage * stat_mod * skill_mod
  local pre_brand_dmg = pre_brand_dmg_no_plus + it_plus

  if BRC.is.magic_staff(it) then return (pre_brand_dmg + get_staff_bonus_dmg(it, dmg_type)) end

  if dmg_type == BRC.DMG_TYPE.plain then
    local ego = BRC.get.ego(it)
    if ego and util.contains(BRC.PLAIN_DMG_EGOS, ego) then
      local bonus = BRC.BrandBonus[ego] or BRC.BrandBonus.subtle[ego]
      return bonus.factor * pre_brand_dmg_no_plus + it_plus + bonus.offset
    end
  elseif dmg_type >= BRC.DMG_TYPE.branded then
    local ego = BRC.get.ego(it)
    if ego then
      local bonus = BRC.BrandBonus[ego]
      if not bonus and dmg_type == BRC.DMG_TYPE.scoring then bonus = BRC.BrandBonus.subtle[ego] end
      if bonus then return bonus.factor * pre_brand_dmg_no_plus + it_plus + bonus.offset end
    end
  end

  return pre_brand_dmg
end

function BRC.get.weap_score(it, no_brand_bonus)
  if it.dps and it.acc then
    -- Handle cached /  high-score tuples in _weapon_cache
    return it.dps + it.acc * BRC.Tuning.weap.pickup.accuracy_weight
  end
  local it_plus = it.plus or 0
  local dmg_type = no_brand_bonus and BRC.DMG_TYPE.unbranded or BRC.DMG_TYPE.scoring
  return BRC.get.weap_dps(it, dmg_type) + (it.accuracy + it_plus) * BRC.Tuning.weap.pickup.accuracy_weight
end

}
############################### End lua/core/util.lua ###############################
##########################################################################################

################################### Begin lua/core/brc.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
--[[
BRC (Buehler RC) Core Module
This module serves as the central coordinator for all feature modules
It automatically loads any global table that contains `BRC_FEATURE_NAME`
It then manages the feature's lifecycle and hook dispatching
Author: buehler
Dependencies: core/data.lua, core/util.lua
--]]

-- Initialize
BRC = BRC or {}
BRC.VERSION = "1.1.0"
BRC.active = false

-- Local constants
local HOOK_FUNCTIONS = {
  autopickup = "autopickup",
  init = "init",
  c_answer_prompt = "c_answer_prompt",
  c_assign_invletter = "c_assign_invletter",
  c_message = "c_message",
  ready = "ready",
}

-- Local variables
local _features = {}
local _hooks = {}
local prev_turn

-- Local functions
local function is_feature_module(maybe_feature_module)
  return maybe_feature_module and type(maybe_feature_module) == "table"
    and maybe_feature_module.BRC_FEATURE_NAME and type(maybe_feature_module.BRC_FEATURE_NAME) == "string"
end

local function ask_to_deactivate(feature_name)
  if BRC.mpr.yesno(string.format("Deactivate %s?", feature_name), BRC.COLORS.yellow) then
    BRC.unregister_feature(feature_name)
  else
    crawl.mpr("Okay, then.")
  end
end

-- Hook management
local function register_hooks(feature_name, feature_module)
  for _, hook_name in pairs(HOOK_FUNCTIONS) do
    if feature_module[hook_name] then
      if not _hooks[hook_name] then _hooks[hook_name] = {} end
      table.insert(_hooks[hook_name], {
        feature_name = feature_name,
        hook_name = hook_name,
        func = feature_module[hook_name],
      })
    end
  end
end

local function unregister_hooks(feature_name)
  for _, hook_list in pairs(_hooks) do
    for i = #hook_list, 1, -1 do
      if hook_list[i].feature_name == feature_name then
        BRC.log.error(string.format("Unregistered hook: %s.%s", hook_list[i].feature_name, hook_list[i].hook_name))
        table.remove(hook_list, i)
      end
    end
  end
end

local function call_all_hooks(hook_name, ...)
  if not _hooks[hook_name] then return end

  local last_return_value = nil
  local returning_feature = nil

  for i = #_hooks[hook_name], 1, -1 do
    local hook_info = _hooks[hook_name][i]
    local success, result = pcall(hook_info.func, ...)
    if not success then
      BRC.log.error(string.format("Failure in %s.%s", hook_info.feature_name, hook_name), result)
      ask_to_deactivate(hook_info.feature_name, hook_name)
    else
      if last_return_value and result and last_return_value ~= result then
        BRC.log.warning(string.format("Return value mismatch in hook %s:\n  (first) %s -> %s\n  (final) %s -> %s",
          hook_name, returning_feature, BRC.data.BRC.data._brc_val2str(last_return_value),
          hook_info.feature_name, BRC.data.BRC.data._brc_val2str(result))
        )
      end

      last_return_value = result
      returning_feature = hook_info.feature_name
    end
  end

  return last_return_value
end

local function register_all_features(parent_module)
  local loaded_count = 0

  -- Scan the namespace for feature modules and load them
  for name, value in pairs(parent_module) do
    if is_feature_module(value) then
      local feature_name = value.BRC_FEATURE_NAME
      local success = BRC.register_feature(feature_name, value)

      if success then
        loaded_count = loaded_count + 1
      else
        BRC.log.error(string.format('Failed to register feature: %s. Aborting bulk registration.', name))
        return loaded_count
      end
    end
  end

  return loaded_count
end

-- Public API
function BRC.init(parent_module)
  -- Default to scanning the global namespace for modules
  parent_module = parent_module or _G
  if type(parent_module) ~= "table" then
    BRC.log.warning("Invalid parent module (must be a table). Using global namespace instead.")
    parent_module = _G
  end

  -- Handle stale data (ie switching characters on a local instance)
  _features = {}
  _hooks = {}

  -- Load all features, then the data module last
  local loaded_count = register_all_features(parent_module)
  if loaded_count == 0 then
    BRC.mpr.lightred("No features loaded. BRC is inactive.")
    return false
  end
  BRC.log.debug(string.format("Loaded %d features.", loaded_count, parent_module))

  -- Init features
  BRC.log.debug(BRC.text.green("Initializing features..."))
  call_all_hooks(HOOK_FUNCTIONS.init)
  if not BRC.data.init() then
    BRC.log.error("Failed to initialize data module. BRC is inactive.")
    return false
  end

  -- Add the autopickup function
  add_autopickup_func(function(it, _) return BRC.autopickup(it) end)

  -- Register the char_dump macro
  if BRC.Config.debug_notes_on_char_dump then
    BRC.set.macro(BRC.get.command_key("CMD_CHARACTER_DUMP") or "#", "macro_brc_dump_character")
  end

  -- Success!
  local success_emoji = BRC.Config.emojis and BRC.Emoji.SUCCESS or ""
  local success_text = string.format("Successfully initialized BRC system v%s!", BRC.VERSION)
  BRC.mpr.lightgreen(string.format("\n%s %s %s", success_emoji, success_text, success_emoji))

  prev_turn = -1
  BRC.active = true
  BRC.ready()
  return true
end

function BRC.register_feature(feature_name, feature_module)
  if not feature_name or not feature_module then
    BRC.log.error("Invalid feature registration: missing name or module")
    return false
  end

  if _features[feature_name] then
    BRC.log.error(string.format("Feature '%s' is already registered", BRC.text.yellow(feature_name)))
    return false
  end

  _features[feature_name] = feature_module
  register_hooks(feature_name, feature_module)

  BRC.log.debug(string.format("Feature '%s' registered", BRC.text.lightcyan(feature_name)))
  return true
end

function BRC.unregister_feature(feature_name)
  if not _features[feature_name] then
    BRC.log.error(string.format("Feature '%s' is not registered", BRC.text.yellow(feature_name)))
    return false
  end

  unregister_hooks(feature_name)
  _features[feature_name] = nil

  BRC.log.debug(string.format("Feature '%s' unregistered", BRC.text.lightcyan(feature_name)))
  return true
end

-- Hook methods
function BRC.autopickup(it, _)
  if not BRC.active then return end
  return call_all_hooks(HOOK_FUNCTIONS.autopickup, it)
end

function BRC.ready()
  if not BRC.active then return end

  crawl.redraw_screen()
  if you.turns() == prev_turn then return end
  prev_turn = you.turns()

  call_all_hooks(HOOK_FUNCTIONS.ready)
  BRC.mpr.consume_queue()
end

function BRC.c_message(text, channel)
  if not BRC.active then return end
  call_all_hooks(HOOK_FUNCTIONS.c_message, text, channel)
end

function BRC.c_answer_prompt(prompt)
  if not BRC.active then return end
  if prompt == "Die?" then return false end
  return call_all_hooks(HOOK_FUNCTIONS.c_answer_prompt, prompt)
end

function BRC.c_assign_invletter(it)
  if not BRC.active then return end
  return call_all_hooks(HOOK_FUNCTIONS.c_assign_invletter, it)
end

}
############################### End lua/core/brc.lua ###############################
##########################################################################################

## (Resuming init.txt) ##

### Lua feature files ###

################################### Begin lua/features/after-shaft.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
--[[
Feature: after-shaft
Description: Automatically stops exploration on stairs after falling into a shaft
Author: buehler
Dependencies: core/config.lua, core/data.lua, core/constants.lua, core/util.lua
--]]

f_after_shaft = {}
f_after_shaft.BRC_FEATURE_NAME = "after-shaft"

-- Persistent variables
as_shaft_depth = BRC.data.persist("as_shaft_depth", 0)
as_shaft_branch = BRC.data.persist("as_shaft_branch", "NA")

-- Hook functions
function f_after_shaft.init()
  if not BRC.Config.stop_on_stairs_after_shaft then return end

  if you.turns() == 0 and you.class() == "Delver" then
    as_shaft_depth = 1
    as_shaft_branch = you.branch()
  end

  BRC.set.explore_stop("stairs", as_shaft_depth ~= 0)
end

function f_after_shaft.c_message(text, channel)
  if not BRC.Config.stop_on_stairs_after_shaft then return end
  if channel ~= "plain" or BRC.you.in_hell() then return end
  if as_shaft_depth ~= 0 and you.branch() == as_shaft_branch then return end

  local text_fall = "ou fall into a shaft"
  local text_sucked = "ou are sucked into a shaft"
  if text:find(text_fall, 1, true) or text:find(text_sucked, 1, true) then
    as_shaft_depth = you.depth()
    as_shaft_branch = you.branch()
    BRC.set.explore_stop("stairs", true)
  end
end

function f_after_shaft.ready()
  if not BRC.Config.stop_on_stairs_after_shaft then return end
  if you.depth() == as_shaft_depth and you.branch() == as_shaft_branch then
    BRC.set.explore_stop("stairs", false)
    as_shaft_depth = 0
    as_shaft_branch = "NA"
  end
end

}
############################### End lua/features/after-shaft.lua ###############################
##########################################################################################

################################### Begin lua/features/alert-monsters.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
--[[
Feature: alert-monsters
Description: Dynamic force_more configuration for monsters based on player HP, xl, willpower, resistances, etc.
    WARNINGS:
      - Never put a '}' on a line by itself. This breaks crawl's RC parser.
      - POSIX regex are required for this feature to use '|' in patterns.
Author: original by gammafunk, extended by buehler
Dependencies: core/config.lua, core/util.lua
--]]

f_alert_monsters = {}
f_alert_monsters.BRC_FEATURE_NAME = "alert-monsters"

-- Local constants / configuration
--[[
FM_PATTERNS configures all alerts. Each table within it creates one alert, using the following fields:
  - `name` is for debugging.
  - `pattern` is either a string or a table of monster names, that will file a force_more when they come into view.
  - `is_pack` (optional) indicates the alert is for a pack of monsters.
    Packs only fire once every few turns - as defined in BRC.Config.pack_monster_turns (default 15).
  - `flash_screen` (optional) indicates the alert should flash the screen instead of using force_more.
  - `cutoff` sets the point when the alert is active (usually how much HP you have)
  - `cond` defines HOW the character stats are compared against `cutoff` (HP/will/etc).
      Ex:
        `always` alerts are always on.
        `hp` alerts are active when you have < `cutoff` HP.
        `will` alerts are active when you have <= `cutoff` pips of willpower.
        `int` alerts are active when you have < `cutoff` Int.
        `xl` alerts are active when your XL is < `cutoff`.
        `elec` alerts are active when you have no rElec and < `cutoff` HP.
        `fire`, `cold`, etc are active < `cutoff` HP with no resistance. Pips of res reduce the cutoff to 50/33/20%
--]]
local FM_PATTERNS = {
  { name = "always_fm", cond = "always", cutoff = 0,
    pattern = {
      -- High damage/speed
      "juggernaut", "orbs? of fire", "orbs? of winter", "flayed ghost",
      --Summoning
      "shadow demon", "guardian serpent", "draconian stormcaller", "spriggan druid", "dryad",
      "worldbinder", "halazid warlock", "demonspawn corrupter",
      --Dangerous abilities
      "wyrmhole", "torpor snail", "water nymph", "shambling mangrove", "iron giant",
      "starflower", "merfolk aquamancer", "wretched star",
      --Dangerous clouds
      "catoblepas", "apocalypse crab",
    } },

  { name = "always_flash", cond = "always", cutoff = 0,
    flash_screen = true,
    pattern = {
      -- Noteworthy abilities
      "air elemental", "elemental wellspring", "ghost crab", "ironbound convoker",
      "vault guardian", "vault warden", "wendingo",
      -- Displacement
      "deep elf knight", "swamp worm",
      -- Summoning
      "deep elf elementalist",
    } },

  { name = "always_fm_pack", cond = "always", cutoff = 0,
    is_pack = true,
    pattern = { "boggart", "dream sheep", "floating eye", "shrike", } },

  -- Early game Dungeon problems for chars with low mhp. (adder defined below)
  { name = "30hp", cond = "hp", cutoff = 30,
    pattern = { "hound", "gnoll" } },

  -- Monsters dangerous until a certain point
  { name = "xl_7", cond = "xl", cutoff = 7,
    pattern = { "orc wizard" } },
  { name = "xl_12", cond = "xl", cutoff = 12,
    pattern = { "hydra", "bloated husk" } },

  -- Monsters that can hit for ~50% of hp from range with unbranded attacks
  { name = "40hp", cond = "hp", cutoff = 40,
    pattern = { "orc priest" } },
  { name = "50hp", cond = "hp", cutoff = 50,
    pattern = { "orc high priest", "manticore" } },
  { name = "60hp", cond = "hp", cutoff = 60,
    pattern = { "yaktaur(?! captain)", "cyclops", "centaur(?! warrior)" } },
  { name = "70hp_melai", cond = "hp", cutoff = 70,
    is_pack = true,
    pattern = "meliai" },
  { name = "80hp", cond = "hp", cutoff = 80,
    pattern = { "gargoyle" } },
  { name = "90hp", cond = "hp", cutoff = 90,
    pattern = { "deep elf archer", "tengu conjurer" } },
  { name = "110hp", cond = "hp", cutoff = 110,
    pattern = { "centaur warrior", "yaktaur captain", "hellion", "eye of devastation",
                "sun moth", "deep elf high priest", "deep troll earth mage",
                "stone giant", "cacodemon" } },
  { name = "120hp", cond = "hp", cutoff = 120,
    pattern = { "quicksilver (dragon|elemental)", "magenta draconian", "thorn hunter" } },
  { name = "160hp", cond = "hp", cutoff = 160,
    pattern = { "brimstone fiend", "deep elf sorcererhell sentinal", "war gargoyle",
                "draconian (knight|scorcher)" } },
  { name = "200hp", cond = "hp", cutoff = 200,
    pattern = { "(draconian|deep elf) annihilator", "iron (dragon|elemental)" } },

  -- Monsters that can crowd-control you without sufficient willpower
  -- Cutoff ~10% for most spells; lower for more significant spells like banish
  { name = "willpower2", cond = "will", cutoff = 2,
    pattern = { "basilisk", "naga ritualist", "vampire(?! (bat|mage|mosquito))", "sphinx marauder" } },
  { name = "willpower3", cond = "will", cutoff = 3,
    pattern = { "deep elf (demonologist|sorcerer|archer)", "occultist", "merfolk siren", "fenstrider witch",
                "cacodemon", "imperial myrmidon", "guardian sphinx", "nagaraja", "draconian shifter",
                "glowing orange brain", "orc sorcerer", "ogre mage", "satyr", "vault sentinel", "iron elemental",
                "death knight", "vampire knight" } },
  { name = "willpower3_great_orb_of_eyes", cond = "will", cutoff = 3,
    is_pack = true,
    pattern = "great orb of eyes" },
  { name = "willpower3_golden_eye", cond = "will", cutoff = 3,
    is_pack = true,
    pattern = "golden eye" },
  { name = "willpower4", cond = "will", cutoff = 4,
    pattern = { "merfolk avatar", "tainted leviathan", "nargun" } },

  -- Brain feed with low int
  { name = "brainfeed", cond = "int", cutoff = 6,
    pattern = { "glowing orange brain", "neqoxec" } },

  -- Alert if no resist and HP below cutoff
  { name = "pois_30", cond = "pois", cutoff = 30,
    pattern = { "adder" } },
  { name = "pois_80", cond = "pois", cutoff = 80,
    pattern = { "golden dragon", "green draconian", "swamp dragon" } },
  { name = "pois_120", cond = "pois", cutoff = 120,
    pattern = { "green death", "naga mage", "nagaraja", "fenstrider witch" } },
  { name = "pois_140", cond = "pois", cutoff = 140,
    pattern = { "tengu reaver" } },

  { name = "elec_40", cond = "elec", cutoff = 40, is_pack = true,
    pattern = "electric eel" },
  { name = "elec_80", cond = "elec", cutoff = 80,
    pattern = { "shock serpent", "raiju", "spark wasp" } },
  { name = "elec_120", cond = "elec", cutoff = 120,
    pattern = { "black draconian", "blizzard demon", "deep elf zephyrmancer", "storm dragon", "tengu conjurer" } },
  { name = "elec_140", cond = "elec", cutoff = 140,
    pattern = { "electric golem", "titan", "servants? of whisper", "spriggan air mage",
                "ball lightning", "tengu reaver" } },

  { name = "corr_60", cond = "corr", cutoff = 60,
    pattern = { "acid dragon" } },
  { name = "corr_140", cond = "corr", cutoff = 140,
    pattern = { "tengu reaver", "entropy weaver", "demonspawn corrupter", "moon troll" } },

  { name = "fire_60", cond = "fire", cutoff = 60,
    pattern = { "steam dragon", "lindwurm", "fire crab", "lava snake" } },
  { name = "fire_100", cond = "fire", cutoff = 100,
    pattern = { "efreet", "deep elf pyromancer", "smoke demon", "sun moth" } },
  { name = "fire_120", cond = "fire", cutoff = 120,
    pattern = { "orc sorcerer", "hell hound", "demonspawn blood saint", "red draconian", "ogre mage",
                "molten gargoyle", "hell knight" } },
  { name = "fire_140", cond = "fire", cutoff = 140,
    pattern = { "balrug" } },
  { name = "fire_160", cond = "fire", cutoff = 160,
    pattern = { "will-o-the-wisp", "ophan", "fire giant", "golden dragon", "fire dragon", "salamander tyrant",
                "tengu reaver" } },
  { name = "fire_240", cond = "fire", cutoff = 240,
    pattern = { "hellephant", "crystal (guardian|echidna)", "draconian scorcher" } },

  { name = "cold_80", cond = "cold", cutoff = 80,
    pattern = { "rime drake" } },
  { name = "cold_120", cond = "cold", cutoff = 120,
    pattern = { "blizzard demon", "bog body", "ironbound frostheart", "demonspawn blood saint",
                "white draconian" } },
  { name = "cold_160", cond = "cold", cutoff = 160,
    pattern = { "golden dragon", "draconian knight", "frost giant", "ice dragon", "tengu reaver" } },
  { name = "cold_180", cond = "cold", cutoff = 180,
    pattern = { "(?<!dread)(?<!ancient) lich", "lich king" } },
  { name = "cold_240", cond = "cold", cutoff = 240,
    pattern = { "crystal (guardian|echidna)" } },

  { name = "drain_100", cond = "drain", cutoff = 100,
    pattern = { "orc sorcerer" } },
  { name = "drain_120", cond = "drain", cutoff = 120,
    pattern = { "necromancer" } },
  { name = "drain_150", cond = "drain", cutoff = 150,
    pattern = { "revenant", "demonspawn blood saint" } },
  { name = "drain_190", cond = "drain", cutoff = 190,
    pattern = { "shadow dragon" } },
} -- end fm_patterns (do not remove this comment)

local function init_conditional_alerts()
  -- Conditionally add miasma monsters
  if not BRC.you.miasma_immune() then
    util.append(FM_PATTERNS, {
      name = "miasma", cond = "always", cutoff = 0,
      pattern = { "death drake", "tainted leviathan", "putrid mouth", }
    })
  end

  -- Conditionally add tormentors
  if not you.torment_immune() then
    util.append(FM_PATTERNS, {
      name = "torment", cond = "always", cutoff = 0,
      pattern = { "tormentor", "curse (toe|skull)", "Fiend", "tzitzimi", "royal mummy",
                  "mummy priest", "(dread|ancient) lich", "lurking horror", }
    })
  end

  -- Set mutators to either flash (if undead) or a conditional fm
  local mutator_str = "cacodemon|neqoxec|shining eye"
  if BRC.you.mutation_immune() then
    BRC.set.flash_screen_message("monster_warning:"..mutator_str, true)
  else
    util.append(FM_PATTERNS, { name = "malmutate", cond = "mut", cutoff = 1, pattern = mutator_str, })
  end

  -- If configured, add fm for all uniques and pan lords
  if BRC.Config.fm_on_uniques then
    BRC.set.force_more("monster_warning:(?-i:[A-Z].*(?<!rb Guardian) comes? into view", true)
  end
end
------------------- End config section -------------------

-- Local variables
local active_alert -- which ones are on
local monsters_to_mute -- which packs to mute at next ready()
local last_fm_turn -- when the mute started

-- Local constants
local WARN_PREFIX = "monster_warning:(?<!spectral )("
local WARN_SUFFIX = ")(?! (zombie|skeleton|simulacrum)).*comes? into view"
local YOU_ARE_VINE_STALKER = you.race() == "Vine Stalker"

-- Local functions
local function set_monster_alert(monster_str, add_pattern, do_flash_screen)
  if do_flash_screen then
    BRC.set.flash_screen_message(table.concat({ WARN_PREFIX, monster_str, WARN_SUFFIX }), add_pattern)
  else
    BRC.set.force_more(table.concat({ WARN_PREFIX, monster_str, WARN_SUFFIX }), add_pattern)
  end
end

local function check_alert_three_pip(hp, dmg_threshold, resistance)
  -- Dmg taken is 1/1; 1/2; 1/3; 1/5 (for 0; 1; 2; 3 resistance)
  if resistance >= 3 then return hp < dmg_threshold / 5 end
  return hp < dmg_threshold / (resistance + 1)
end

local function update_pack_mutes()
  -- Put pending mutes into effect
  for _, v in ipairs(monsters_to_mute) do
    set_monster_alert(v, false) -- "Mute" the alert by removing the fm (but active_alert[] is still true)
  end
  monsters_to_mute = {}

  -- Remove expired mutes
  for i, v in ipairs(FM_PATTERNS) do
    if v.is_pack and last_fm_turn[i] ~= -1 and you.turns() >= last_fm_turn[i] + BRC.Config.pack_monster_turns then
      last_fm_turn[i] = -1
      if v.cond == "always" then
        set_monster_alert(v, true, v.flash_screen) -- Alert is aleady active. Just turn it back on
      else
        active_alert[i] = false -- Set to false and let the main logic decide if it should reactivate it.
      end
    end
  end
end

-- Hook functions
function f_alert_monsters.init()
  active_alert = {}
  monsters_to_mute = {}
  last_fm_turn = {}
  init_conditional_alerts()

  -- Convert table patterns to strings
  for _, v in ipairs(FM_PATTERNS) do
    if type(v.pattern) == "table" then v.pattern = table.concat(v.pattern, "|") end
  end

  for i, v in ipairs(FM_PATTERNS) do
    last_fm_turn[i] = -1
    active_alert[i] = v.cond == "always"
    if active_alert[i] then set_monster_alert(v.pattern, true, v.flash_screen) end
  end
end

function f_alert_monsters.c_message(text, channel)
  if channel ~= "monster_warning" then return end
  if BRC.Config.pack_monster_turns <= 0 then return end

  -- Identify when a mute should be turned on
  if not text:find("comes? into view") then return end
  for i, v in ipairs(FM_PATTERNS) do
    if v.is_pack then
      if text:find(v.pattern) and last_fm_turn[i] == -1 then
        last_fm_turn[i] = you.turns()
        monsters_to_mute[#monsters_to_mute + 1] = v.pattern
      end
    end
  end
end

function f_alert_monsters.ready()
  local activated = {}
  local deactivated = {}

  -- Load all stats before loop. Most of them are used multiple times.
  local hp, _ = you.hp()
  local amulet = items.equipped_at("amulet")
  if YOU_ARE_VINE_STALKER or (amulet and amulet.name() == "amulet of guardian spirit") then
    local mp, _ = you.mp()
    hp = hp + mp
  end
  local xl = you.xl()
  local int = you.intelligence()
  local willpower = you.willpower()
  local res_mut = you.res_mutation()
  local res_pois = you.res_poison()
  local res_elec = you.res_shock()
  local res_corr = you.res_corr()
  local res_fire = you.res_fire()
  local res_cold = you.res_cold()
  local res_drain = you.res_draining()

  for i, v in ipairs(FM_PATTERNS) do
    local should_be_active = nil

    if BRC.Config.disable_alert_monsters_in_zigs and you.branch() == "Zig" then
      should_be_active = false
    elseif v.cond == "always" then
      should_be_active = true
    elseif not v.cond and not active_alert[i] then
      should_be_active = true
    elseif v.cond == "xl" then
      should_be_active = xl < v.cutoff
    elseif v.cond == "hp" then
      should_be_active = hp < v.cutoff
    elseif v.cond == "int" then
      should_be_active = int < v.cutoff
    elseif v.cond == "will" then
      should_be_active = willpower < v.cutoff
    elseif v.cond == "mut" then
      should_be_active = res_mut == 0
    elseif v.cond == "pois" then
      should_be_active = res_pois == 0 and hp < v.cutoff
    elseif v.cond == "elec" then
      should_be_active = res_elec == 0 and hp < v.cutoff
    elseif v.cond == "corr" then
      should_be_active = not res_corr and hp < v.cutoff
    elseif v.cond == "fire" then
      should_be_active = check_alert_three_pip(hp, v.cutoff, res_fire)
    elseif v.cond == "cold" then
      should_be_active = check_alert_three_pip(hp, v.cutoff, res_cold)
    elseif v.cond == "drain" then
      should_be_active = check_alert_three_pip(hp, v.cutoff, res_drain)
    end

    if should_be_active ~= active_alert[i] then
      active_alert[i] = should_be_active
      set_monster_alert(v.pattern, should_be_active, v.flash_screen)

      if BRC.Config.debug_alert_monsters then
        if should_be_active then
          activated[#activated + 1] = v.name or v.pattern
        else
          deactivated[#deactivated + 1] = v.name or v.pattern
        end
      end
    end
  end

  if BRC.Config.debug_alert_monsters then
    if #activated > 0 then BRC.log.debug(string.format("Activating f_m: %s", table.concat(activated, ", "))) end
    if #deactivated > 0 then BRC.log.debug(string.format("Deactivating f_m: %s", table.concat(deactivated, ", "))) end
  end

  if BRC.Config.pack_monster_turns > 0 then update_pack_mutes() end
end

}
############################### End lua/features/alert-monsters.lua ###############################
##########################################################################################

################################### Begin lua/features/announce-hp-mp.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
--[[
Feature: announce-hp-mp
Description: Announces changes in HP/MP with visual meters and damage warnings
Author: magus, buehler
Dependencies: core/config.lua, core/data.lua, core/constants.lua, core/util.lua
--]]

f_announce_hp_mp = {}
f_announce_hp_mp.BRC_FEATURE_NAME = "announce-hp-mp"

-- Persistent variables
ad_prev = BRC.data.persist("ad_prev", { hp = 0, mhp = 0, mp = 0, mmp = 0 })

-- Local constants / configuration
local NUM_PIPS_PER_METER = 5
local METER_LENGTH = 2 + NUM_PIPS_PER_METER + 2 * (BRC.Emoji.HP_BORDER and #BRC.Emoji.HP_BORDER or 0)

-- Local functions
local function create_meter(perc, emojis)
  perc = math.max(0, math.min(1, perc)) -- Clamp between 0 and 1

  local num_halfpips = math.floor(perc * NUM_PIPS_PER_METER / 100)
  local num_full_emojis = math.floor(num_halfpips / 2)
  local num_part_emojis = num_halfpips % 2
  local num_empty_emojis = NUM_PIPS_PER_METER - num_full_emojis - num_part_emojis

  return table.concat({
    emojis.BORDER or "",
    string.rep(emojis.FULL, num_full_emojis),
    string.rep(emojis.PART, num_part_emojis),
    string.rep(emojis.EMPTY, num_empty_emojis),
    emojis.BORDER or "",
  })
end

local function format_delta(delta)
  if delta > 0 then
    return BRC.text.green(string.format("+%s", delta))
  elseif delta < 0 then
    return BRC.text.red(delta)
  else
    return BRC.text.darkgrey("+0")
  end
end

local function format_ratio(cur, max)
  local color
  if cur <= (max * 0.25) then
    color = BRC.COLORS.lightred
  elseif cur <= (max * 0.50) then
    color = BRC.COLORS.red
  elseif cur <= (max * 0.75) then
    color = BRC.COLORS.yellow
  elseif cur < max then
    color = BRC.COLORS.white
  else
    color = BRC.COLORS.green
  end

  return BRC.text.color(color, string.format(" -> %s/%s", cur, max))
end

local function get_hp_message(hp_delta, mhp_delta)
  local hp, mhp = you.hp()
  local msg_tokens = {}
  msg_tokens[#msg_tokens + 1] = create_meter(hp / mhp, BRC.Emoji.HP_METER)
  msg_tokens[#msg_tokens + 1] = BRC.text.white(string.format(" HP[%s]", format_delta(hp_delta)))
  msg_tokens[#msg_tokens + 1] = format_ratio(hp, mhp)

  if mhp_delta ~= 0 then
    local text = string.format(" (%s max HP)", format_delta(mhp_delta))
    msg_tokens[#msg_tokens + 1] = BRC.text.lightgrey(text)
  end

  if not BRC.Config.announce.same_line and hp == mhp then msg_tokens[#msg_tokens + 1] = BRC.text.white(" (Full HP)") end

  return table.concat(msg_tokens)
end

local function get_mp_message(mp_delta, mmp_delta)
  local mp, mmp = you.mp()
  local msg_tokens = {}
  msg_tokens[#msg_tokens + 1] = create_meter(mp / mmp, BRC.Emoji.MP_METER)
  msg_tokens[#msg_tokens + 1] = BRC.text.lightcyan(string.format(" MP[%s]", format_delta(mp_delta)))
  msg_tokens[#msg_tokens + 1] = format_ratio(mp, mmp)

  if mmp_delta ~= 0 then
    local tok = string.format(" (%s max MP)", format_delta(mmp_delta))
    msg_tokens[#msg_tokens + 1] = BRC.text.cyan(tok)
  end

  if not BRC.Config.announce.same_line and mp == mmp then
    msg_tokens[#msg_tokens + 1] = BRC.text.lightcyan(" (Full MP)")
  end

  return table.concat(msg_tokens)
end

local function last_msg_is_meter()
  local last_msg = crawl.messages(1)
  local check = last_msg and #last_msg > METER_LENGTH + 4 and last_msg:sub(METER_LENGTH + 1, METER_LENGTH + 4)
  return check and (check == " HP[" or check == " MP[")
end

-- Hook functions
function f_announce_hp_mp.init()
  ad_prev.hp = 0
  ad_prev.mhp = 0
  ad_prev.mp = 0
  ad_prev.mmp = 0

  if BRC.Config.dmg_fm_threshold > 0 and BRC.Config.dmg_fm_threshold <= 0.5 then
    BRC.set.message_mute("Ouch! That really hurt!", true)
  end
end

function f_announce_hp_mp.ready()
  -- Update prev state first, so we can safely return early below
  local hp, mhp = you.hp()
  local mp, mmp = you.mp()
  local is_startup = ad_prev.hp == 0
  local hp_delta = hp - ad_prev.hp
  local mp_delta = mp - ad_prev.mp
  local mhp_delta = mhp - ad_prev.mhp
  local mmp_delta = mmp - ad_prev.mmp
  local damage_taken = mhp_delta - hp_delta
  ad_prev.hp = hp
  ad_prev.mhp = mhp
  ad_prev.mp = mp
  ad_prev.mmp = mmp

  if is_startup then return end
  if hp_delta == 0 and mp_delta == 0 and last_msg_is_meter() then return end
  local is_very_low_hp = hp <= BRC.Config.announce.very_low_hp * mhp

  -- Determine which messages to show
  local do_hp = true
  local do_mp = true
  if hp_delta <= 0 and hp_delta > -BRC.Config.announce.hp_loss_limit then do_hp = false end
  if hp_delta >= 0 and hp_delta < BRC.Config.announce.hp_gain_limit then do_hp = false end
  if mp_delta <= 0 and mp_delta > -BRC.Config.announce.mp_loss_limit then do_mp = false end
  if mp_delta >= 0 and mp_delta < BRC.Config.announce.mp_gain_limit then do_mp = false end

  if not do_hp and is_very_low_hp and hp_delta ~= 0 then do_hp = true end
  if not do_hp and not do_mp then return end
  if BRC.Config.announce.always_both then
    do_hp = true
    do_mp = true
  end

  -- Put messages together
  local hp_msg = get_hp_message(hp_delta, mhp_delta)
  local mp_msg = get_mp_message(mp_delta, mmp_delta)
  local msg_tokens = {}
  msg_tokens[1] = (BRC.Config.announce.hp_first and do_hp) and hp_msg or mp_msg
  if do_mp and do_hp then
    msg_tokens[2] = BRC.Config.announce.same_line and "       " or "\n"
    msg_tokens[3] = BRC.Config.announce.hp_first and mp_msg or hp_msg
  end
  if #msg_tokens > 0 then BRC.mpr.que(table.concat(msg_tokens)) end

  -- Add Damage-related warnings, when damage >= threshold
  if damage_taken >= mhp * BRC.Config.dmg_flash_threshold then
    if is_very_low_hp then return end -- mute % HP alerts
    local is_force_more_msg = damage_taken >= (mhp * BRC.Config.dmg_fm_threshold)
    local emoji, msg
    if is_force_more_msg then
      emoji = BRC.Emoji.EXCLAMATION_2
      msg = BRC.text.lightmagenta(" MASSIVE DAMAGE ")
    else
      emoji = BRC.Emoji.EXCLAMATION
      msg = BRC.text.magenta(" BIG DAMAGE ")
    end
    BRC.mpr.que_optmore(is_force_more_msg, emoji .. msg .. emoji)
  end
end

}
############################### End lua/features/announce-hp-mp.lua ###############################
##########################################################################################

################################### Begin lua/features/color-inscribe.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
--[[
Feature: color-inscribe
Description: Colorizes inscriptions on items with appropriate colors for resistances, stats, and other properties
Author: buehler
Dependencies: core/config.lua, core/constants.lua
--]]

f_color_inscribe = {}
f_color_inscribe.BRC_FEATURE_NAME = "color-inscribe"

-- Local constants / configuration
local MULTI_PLUS = "%++"
local MULTI_MINUS = "%-+"
local NEG_NUM = "%-%d+%.?%d*"
local POS_NUM = "%+%d+%.?%d*"
local COLORIZE_TAGS = {
  { "rF" .. MULTI_PLUS, BRC.COLORS.lightred },
  { "rF" .. MULTI_MINUS, BRC.COLORS.red },
  { "rC" .. MULTI_PLUS, BRC.COLORS.lightblue },
  { "rC" .. MULTI_MINUS, BRC.COLORS.blue },
  { "rN" .. MULTI_PLUS, BRC.COLORS.lightmagenta },
  { "rN" .. MULTI_MINUS, BRC.COLORS.magenta },
  { "rPois", BRC.COLORS.lightgreen },
  { "rElec", BRC.COLORS.lightcyan },
  { "rCorr", BRC.COLORS.yellow },
  { "rMut", BRC.COLORS.brown },
  { "sInv", BRC.COLORS.white },
  { "MRegen" .. MULTI_PLUS, BRC.COLORS.cyan },
  { "Regen" .. MULTI_PLUS, BRC.COLORS.green },
  { "Stlth" .. MULTI_PLUS, BRC.COLORS.white },
  { "Will" .. MULTI_PLUS, BRC.COLORS.brown },
  { "Will" .. MULTI_MINUS, BRC.COLORS.darkgrey },
  { "Wiz" .. MULTI_PLUS, BRC.COLORS.white },
  { "Wiz" .. MULTI_MINUS, BRC.COLORS.darkgrey },
  { "Slay" .. POS_NUM, BRC.COLORS.white },
  { "Slay" .. NEG_NUM, BRC.COLORS.darkgrey },
  { "Str" .. POS_NUM, BRC.COLORS.white },
  { "Str" .. NEG_NUM, BRC.COLORS.darkgrey },
  { "Dex" .. POS_NUM, BRC.COLORS.white },
  { "Dex" .. NEG_NUM, BRC.COLORS.darkgrey },
  { "Int" .. POS_NUM, BRC.COLORS.white },
  { "Int" .. NEG_NUM, BRC.COLORS.darkgrey },
  { "AC" .. POS_NUM, BRC.COLORS.white },
  { "AC" .. NEG_NUM, BRC.COLORS.darkgrey },
  { "EV" .. POS_NUM, BRC.COLORS.white },
  { "EV" .. NEG_NUM, BRC.COLORS.darkgrey },
  { "SH" .. POS_NUM, BRC.COLORS.white },
  { "SH" .. NEG_NUM, BRC.COLORS.darkgrey },
  { "HP" .. POS_NUM, BRC.COLORS.white },
  { "HP" .. NEG_NUM, BRC.COLORS.darkgrey },
  { "MP" .. POS_NUM, BRC.COLORS.white },
  { "MP" .. NEG_NUM, BRC.COLORS.darkgrey },
}

-- Local functions
local function colorize_subtext(text, s, tag)
  local idx = text:find(s)
  if not idx then return text end
  if idx > 1 then
    -- Avoid '!r' or an existing color tag
    local prev = text:sub(idx - 1, idx - 1)
    if prev == "!" or prev == ">" then return text end
  end

  return text:gsub(string.format("(%s)", s), string.format("<%s>%%1</%s>", tag, tag))
end

-- Hook functions
function f_color_inscribe.c_assign_invletter(it)
  if not BRC.Config.colorize_inscriptions then return end
  if it.artefact then return end
  -- If enabled, call out to inscribe stats before coloring
  if f_inscribe_stats.do_stat_inscription then f_inscribe_stats.do_stat_inscription(it) end

  local text = it.inscription
  for _, tag in ipairs(COLORIZE_TAGS) do
    text = colorize_subtext(text, tag[1], tag[2])
  end

  it.inscribe(text, false)
end

--[[
TODO: To colorize more, need a way to:
  intercept messages before they're displayed (or delete and re-insert)
  insert tags that affect menus
  colorize artefact text
function f_color_inscribe.c_message(text, _)
  local orig_text = text
  text = colorize_subtext(text)
  if text == orig_text then return end

  local cleaned = BRC.text.clean_text(text)
  if cleaned:sub(2, 4) == " - " then
    text = " " .. text
  end

  crawl.mpr(text)
end
--]]

}
############################### End lua/features/color-inscribe.lua ###############################
##########################################################################################

################################### Begin lua/features/drop-inferior.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
--[[
Feature: drop-inferior
Description: Auto-tags inferior items and adds them to the drop list for quick dropping with ","
Author: buehler
Dependencies: core/config.lua, core/constants.lua, core/util.lua
--]]

f_drop_inferior = {}
f_drop_inferior.BRC_FEATURE_NAME = "drop-inferior"

-- Local constants
local DROP_KEY = "~~DROP_ME"

-- Local functions
local function inscribe_drop(it)
  local new_inscr = it.inscription:gsub(DROP_KEY, "") .. DROP_KEY
  it.inscribe(new_inscr, false)
  if BRC.Config.msg_on_inscribe then
    BRC.mpr.cyan(string.format("(You can drop %s - %s)", it.slot, it.name()))
  end
end

-- Hook functions
function f_drop_inferior.init()
  if not BRC.Config.drop_inferior then return end
  crawl.setopt(string.format("drop_filter += %s", DROP_KEY))
end

function f_drop_inferior.c_assign_invletter(it)
  if not BRC.Config.drop_inferior then return end
  -- Remove any previous DROP_KEY inscriptions
  it.inscribe(it.inscription:gsub(DROP_KEY, ""), false)

  if not (it.is_weapon or BRC.is.armour(it)) then return end

  local it_ego = BRC.get.ego(it)
  for inv in iter.invent_iterator:new(items.inventory()) do
    local inv_ego = BRC.get.ego(inv)
    -- To be an upgrade: subtypes must match, and either the egos match or we upgraded no ego to a non-risky ego
    if inv.subtype() == it.subtype() and (inv_ego == it_ego or not (inv_ego or BRC.is.risky_ego(it_ego))) then
      if it.is_weapon then
        if you.race() == "Coglin" then return end -- More trouble than it's worth
        if inv.plus <= it.plus then inscribe_drop(inv) end
      else
        if BRC.get.armour_ac(inv) <= BRC.get.armour_ac(it) and inv.encumbrance >= it.encumbrance then
          if you.race() == "Poltergeist" then return end -- More trouble than it's worth
          inscribe_drop(inv)
        end
      end
    end
  end
end

}
############################### End lua/features/drop-inferior.lua ###############################
##########################################################################################

################################### Begin lua/features/dynamic-options.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
--[[
Feature: dynamic-options
Description: Changes options based on game state: xl, class, race, god, skills
Author: buehler
Dependencies: core/config.lua, core/constants.lua
--]]

f_dynamic_options = {}
f_dynamic_options.BRC_FEATURE_NAME = "dynamic-options"

-- Local constants / configuration
local XL_FORCE_MORES = {
  { pattern = "monster_warning:wielding.*of electrocution", xl = 5 },
  { pattern = "You.*re more poisoned", xl = 7 },
  { pattern = "^(?!.*Your?).*speeds? up", xl = 10 },
  { pattern = "danger:goes berserk", xl = 18 },
  { pattern = "monster_warning:carrying a wand of", xl = 15 },
}

local IGNORE_SPELLBOOKS_STRING = table.concat(BRC.ALL_SPELLBOOKS, ", ")
local SPELLCASTING_ITEMS_STRING = "scrolls? of amnesia, potions? of brilliance, ring of wizardry"

-- Local state
local cur_god
local ignoring_spellcasting
local ignoring_spellbooks
local xl_force_mores_active

-- Local functions
local function set_class_options()
  if you.class() == "Hunter" then
    crawl.setopt("view_delay = 30")
  elseif you.class() == "Shapeshifter" then
    BRC.set.autopickup_exception("<flux bauble", true)
  end
end

local function set_god_options()
  local new_god = you.god()
  if new_god ~= cur_god then
    if cur_god == "No God" then
      BRC.set.force_more("Found.*the Ecumenical Temple", false)
      BRC.set.flash_screen_message("Found.*the Ecumenical Temple", true)
      BRC.set.runrest_stop_message("Found.*the Ecumenical Temple", true)
    elseif new_god == "Beogh" then
      BRC.set.runrest_ignore_message("no longer looks.*", true)
      BRC.set.force_more("Your orc.*dies", true)
    elseif new_god == "Jiyva" then
      BRC.set.force_more("god:splits in two", true)
      BRC.set.force_more("god:Your prayer is over.", true)
      BRC.set.message_mute("You hear a.*(slurping|squelching) noise", true)
    elseif new_god == "Qazlal" then
      BRC.set.force_more("god:You feel.*protected", false)
    elseif new_god == "Xom" then
      BRC.set.force_more("god:", true)
    end

    cur_god = new_god
  end
end

local function set_race_options()
  if util.contains(BRC.ALL_UNDEAD_RACES, you.race()) then
    BRC.set.force_more("monster_warning:wielding.*of holy wrath", true)
  end

  if not util.contains(BRC.ALL_POIS_RES_RACES, you.race()) then
    BRC.set.force_more("monster_warning:curare", true)
  end

  if you.race() == "Gnoll" then BRC.set.message_mute("intrinsic_gain:skill increases to level", true) end
end

local function set_xl_options()
  for i, v in ipairs(XL_FORCE_MORES) do
    local should_be_active = you.xl() <= v.xl
    if xl_force_mores_active[i] ~= should_be_active then
      xl_force_mores_active[i] = should_be_active
      BRC.set.force_more(v.pattern, should_be_active)
    end
  end
end

local function set_skill_options()
  -- If zero spellcasting, don't stop on spellbook pickup
  local zero_spellcasting = you.skill("Spellcasting") == 0
  -- If current ignore behavior doesn't match desired behavior, update it
  if ignoring_spellbooks ~= zero_spellcasting then
    ignoring_spellbooks = zero_spellcasting
    BRC.set.explore_stop_pickup_ignore(IGNORE_SPELLBOOKS_STRING, zero_spellcasting)
  end

  -- If heavy armour and low armour skill, ignore spellcasting items
  if you.race() ~= "Mountain Dwarf" then
    local worn = items.equipped_at("armour")
    local heavy_arm = worn ~= nil and worn.encumbrance > 4 + you.skill("Armour") / 2
    local skip_items = zero_spellcasting and heavy_arm
    -- If current ignore behavior doesn't match desired behavior, update it
    if ignoring_spellcasting ~= skip_items then
      ignoring_spellcasting = skip_items
      BRC.set.autopickup_exception(SPELLCASTING_ITEMS_STRING, skip_items)
    end
  end
end

-- Hook functions
function f_dynamic_options.init()
  cur_god = "No God"
  ignoring_spellcasting = false
  ignoring_spellbooks = false
  xl_force_mores_active = {}

  set_race_options()
  set_class_options()
  set_god_options()
end

function f_dynamic_options.ready()
  set_god_options()
  set_xl_options()
  set_skill_options()
end

}
############################### End lua/features/dynamic-options.lua ###############################
##########################################################################################

################################### Begin lua/features/exclude-dropped.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
--[[
Feature: exclude-dropped
Description: Automatically excludes dropped items from autopickup and removes exclusion when items are picked up
Author: buehler
Dependencies: core/config.lua, core/data.lua, core/constants.lua, core/util.lua
--]]

f_exclude_dropped = {}
f_exclude_dropped.BRC_FEATURE_NAME = "exclude-dropped"

-- Persistent variables
ed_dropped_items = BRC.data.persist("ed_dropped_items", {})

-- Local functions
local function add_exclusion(item_name)
  if not util.contains(ed_dropped_items, item_name) then table.insert(ed_dropped_items, item_name) end
  BRC.set.autopickup_exception(item_name, true)
end

local function remove_exclusion(item_name)
  util.remove(ed_dropped_items, item_name)
  BRC.set.autopickup_exception(item_name, false)
end

local function enchantable_weap_in_inv()
  for inv in iter.invent_iterator:new(items.inventory()) do
    if
      inv.is_weapon
      and not BRC.is.magic_staff(inv)
      and inv.plus < 9
      and (not inv.artefact or you.race() == "Mountain Dwarf")
    then
      return true
    end
  end
  return false
end

local function clean_item_text(text)
  text = BRC.text.clean_text(text, false) -- remove tags
  text = text:gsub("{.*}", "")
  text = text:gsub("[.]", "")
  text = text:gsub("%(.*%)", "")
  return util.trim(text)
end

local function extract_jewellery_or_evoker(text)
  local idx = text:find("ring of", 1, true) or text:find("amulet of", 1, true) or text:find("wand of", 1, true)
  if idx then return text:sub(idx, #text) end

  for _, item_name in ipairs(BRC.ALL_MISC_ITEMS) do
    if text:find(item_name) then return item_name end
  end
end

local function extract_missile(text)
  for _, item_name in ipairs(BRC.ALL_MISSILES) do
    if text:find(item_name) then return item_name end
  end
end

local function extract_potion(text)
  local idx = text:find("potions? of")
  if idx then return "potions? of " .. util.trim(text:sub(idx + 10, #text)) end
end

local function extract_scroll(text)
  local idx = text:find("scrolls? of")
  if idx then return "scrolls? of " .. util.trim(text:sub(idx + 10, #text)) end
end

--[[
  get_item_name() - Tries to extract item name from text.
  Returns name of item, or nil if not recognized as an excludable item.
--]]
local function get_item_name(text)
  text = clean_item_text(text)
  return extract_jewellery_or_evoker(text) or
         extract_missile(text) or
         extract_potion(text) or
         extract_scroll(text)
end

local function should_exclude(item_name)
  -- Enchant/Brand weapon scrolls continue pickup if they're still useful
  local weap_scroll = item_name:find("enchant weapon", 1, true) or item_name:find("brand weapon", 1, true)
  if BRC.Config.ignore_stashed_weapon_scrolls and weap_scroll and enchantable_weap_in_inv() then return false end

  -- Don't exclude if we dropped partial stack (except for jewellery)
  for inv in iter.invent_iterator:new(items.inventory()) do
    if inv.name("qual"):find(item_name, 1, true) then
      if BRC.is.jewellery(inv) then return true end
      local qty_str = string.format("ou drop %s %s", inv.quantity, item_name)
      return inv.quantity == 1 or item_name:find(qty_str, 1, true)
    end
  end

  return true
end

-- Hook functions
function f_exclude_dropped.init()
  if not BRC.Config.exclude_dropped then return end

  for _, v in ipairs(ed_dropped_items) do
    add_exclusion(v)
  end
end

function f_exclude_dropped.c_message(text, channel)
  if not BRC.Config.exclude_dropped then return end
  if channel ~= "plain" then return end

  local picked_up
  if text:find(" %- ") then
    picked_up = true
  elseif text:find("ou drop ", 1, true) then
    picked_up = false
  else
    return
  end

  local item_name = get_item_name(text)
  if not item_name then return end

  if picked_up then
    remove_exclusion(item_name)
  elseif should_exclude(item_name) then
    add_exclusion(item_name)
  end
end

}
############################### End lua/features/exclude-dropped.lua ###############################
##########################################################################################

################################### Begin lua/features/fully-recover.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
--[[
Feature: fully-recover
Description: Automatically rests until fully recovered from negative statuses, with smart recovery logic
Author: buehler
Dependencies: core/config.lua, core/data.lua, core/util.lua
--]]

f_fully_recover = {}
f_fully_recover.BRC_FEATURE_NAME = "fully-recover"

-- Persistent variables
fr_start_turn = BRC.data.persist("fr_start_turn", 0)
fr_explore_after = BRC.data.persist("fr_explore_after", false)

-- Local constants / configuration
local MAX_TURNS_TO_WAIT = 500
local WAITING_MESSAGE = "You start waiting."

-- Local functions
local function abort_fully_recover()
  fr_start_turn = 0
  fr_explore_after = false
  BRC.set.message_mute(WAITING_MESSAGE, false)
  you.stop_activity()
end

local function finish_fully_recover()
  local turns = you.turns() - fr_start_turn
  BRC.mpr.lightgreen(string.format("Fully recovered (%d turns)", turns))

  fr_start_turn = 0
  BRC.set.message_mute(WAITING_MESSAGE, false)
  you.stop_activity()

  if fr_explore_after then
    fr_explore_after = false
    BRC.util.do_cmd("CMD_EXPLORE")
  end
end

local function should_ignore_status(s)
  if s == "corroded" then
    return BRC.you.by_slimy_wall() or you.branch() == "Dis"
  elseif s == "slowed" then
    return BRC.you.zero_stat()
  end
  return false
end

local function fully_recovered()
  local hp, mhp = you.hp()
  local mp, mmp = you.mp()
  if hp ~= mhp then return false end
  if mp ~= mmp then return false end

  local status = you.status()
  for _, s in ipairs(BRC.Config.rest_off_statuses) do
    if status:find(s) then
      if not should_ignore_status(s) then return false end
    end
  end

  return true
end

local function remove_statuses_from_config()
  local status = you.status()
  local to_remove = {}
  for _, s in ipairs(BRC.Config.rest_off_statuses) do
    if status:find(s) then table.insert(to_remove, s) end
  end
  for _, s in ipairs(to_remove) do
    util.remove(BRC.Config.rest_off_statuses, s)
    crawl.error(string.format("  Removed: %s", s))
  end
end

local function start_fully_recover()
  fr_start_turn = you.turns()
  BRC.set.message_mute(WAITING_MESSAGE, true)
end

-- Macro function: Attach full recovery to auto-explore
function macro_f_fully_recover_explore()
  if fully_recovered() then
    if fr_start_turn > 0 then
      finish_fully_recover()
    else
      BRC.util.do_cmd("CMD_EXPLORE")
    end
  else
    fr_explore_after = true
    BRC.util.do_cmd("CMD_REST")
  end
end

-- Hook functions
function f_fully_recover.init()
  fr_start_turn = 0
  fr_explore_after = false
  util.remove(BRC.Config.rest_off_statuses, "slowed") -- special case handled elsewhere

  BRC.set.runrest_ignore_message("recovery:.*", true)
  BRC.set.runrest_ignore_message("duration:.*", true)
  BRC.set.macro(BRC.get.command_key("CMD_EXPLORE") or "o", "macro_f_fully_recover_explore")
end

function f_fully_recover.c_message(text, channel)
  if channel == "plain" then
    if text:find(WAITING_MESSAGE, 1, true) or text:find("ou start resting", 1, true) then
      if not fully_recovered() then start_fully_recover() end
    end
  elseif fr_start_turn > 0 then
    if channel == "timed_portal" then
      abort_fully_recover()
    elseif fully_recovered() then
      finish_fully_recover()
    end
  end
end

function f_fully_recover.ready()
  if fr_start_turn > 0 then
    if fully_recovered() then
      finish_fully_recover()
    elseif not you.feel_safe() then
      abort_fully_recover()
    elseif you.turns() - fr_start_turn > MAX_TURNS_TO_WAIT then
      BRC.log.error(string.format("fully-recover timed out after %s turns.", MAX_TURNS_TO_WAIT))
      BRC.log.error("Adjusting BRC.Config.rest_off_statuses:")
      remove_statuses_from_config()
      abort_fully_recover()
    else
      BRC.util.do_cmd("CMD_SAFE_WAIT")
    end
  else
    fr_explore_after = false
  end
end

}
############################### End lua/features/fully-recover.lua ###############################
##########################################################################################

################################### Begin lua/features/fm-disable.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
--[[
Feature: fm-disable
Description: Disables force_more messages for specific game events to improve gameplay flow
Author: buehler
Dependencies: core/config.lua
--]]

f_fm_disable = {}
f_fm_disable.BRC_FEATURE_NAME = "fm-disable"

-- Local constants / configuration
local FM_DISABLES = {
  "ou kneel at the altar",
  "need to enable at least one skill for training",
  "Okawaru grants you throwing weapons",
  "Okawaru offers you a choice",
} -- FM_DISABLES (do not remove this comment)

-- Hook functions
function f_fm_disable.c_message(text, _)
  if not BRC.Config.fm_disable then return end
  for _, v in ipairs(FM_DISABLES) do
    if text:find(v) then
      crawl.enable_more(false)
      return
    end
  end

  crawl.enable_more(true)
end

}
############################### End lua/features/fm-disable.lua ###############################
##########################################################################################

################################### Begin lua/features/inscribe-stats.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
--[[
Feature: inscribe-stats
Description: Automatically inscribes+updates weapon DPS/dmg/delay, or armour AC/EV/SH, on items in inventory
Author: buehler
Dependencies: core/config.lua, core/constants.lua, core/util.lua
--]]

f_inscribe_stats = {}
f_inscribe_stats.BRC_FEATURE_NAME = "inscribe-stats"

-- Local constants / configuration
local NUM_PATTERN = "[%+%-:]%d+%.%d*" -- Matches numbers w/ decimal

-- Local functions
local function inscribe_armour_stats(it)
  local abbr = BRC.is.shield(it) and "SH" or "AC"
  local primary, ev = BRC.get.armour_info(it)

  local new_insc
  if it.inscription:find(abbr .. NUM_PATTERN) then
    -- Replace each stat individually, to avoid overwriting <color> tags
    new_insc = it.inscription:gsub(abbr .. NUM_PATTERN, primary)
    if ev and ev ~= "" then new_insc = new_insc:gsub("EV" .. NUM_PATTERN, ev) end
  else
    new_insc = primary
    if ev and ev ~= "" then new_insc = string.format("%s, %s", new_insc, ev) end
    if it.inscription and it.inscription ~= "" then new_insc = string.format("%s; %s", new_insc, it.inscription) end
  end

  it.inscribe(new_insc, false)
end

local function inscribe_weapon_stats(it)
  local orig_inscr = it.inscription
  local dps_inscr = BRC.get.weapon_info(it, BRC.DMG_TYPE[BRC.Config.inscribe_dps_type])
  local prefix, suffix = "", ""

  local idx = orig_inscr:find("DPS:", 1, true)
  if idx then
    if idx > 1 then prefix = orig_inscr:sub(1, idx - 1) .. "; " end
    if idx + #dps_inscr - 1 < #orig_inscr then suffix = orig_inscr:sub(idx + #dps_inscr, #orig_inscr) end
  elseif #orig_inscr > 0 then
    suffix = "; " .. orig_inscr
  end

  it.inscribe(table.concat({ prefix, dps_inscr, suffix }), false)
end

-- Hook functions
function f_inscribe_stats.do_stat_inscription(it)
  if BRC.Config.inscribe_weapons and it.is_weapon then
    inscribe_weapon_stats(it)
  elseif BRC.Config.inscribe_armour and BRC.is.armour(it) and not BRC.is.scarf(it) then
    inscribe_armour_stats(it)
  end
end

function f_inscribe_stats.ready()
  for inv in iter.invent_iterator:new(items.inventory()) do
    f_inscribe_stats.do_stat_inscription(inv)
  end
end

}
############################### End lua/features/inscribe-stats.lua ###############################
##########################################################################################

################################### Begin lua/features/misc-alerts.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
--[[
Feature: misc-alerts
Description: Provides various single-purpose alerts: low HP, faith amulet, and spell level changes
Author: orig save w/msg by gammafunk, buehler
Dependencies: core/config.lua, core/data.lua, core/constants.lua, core/util.lua
--]]

f_misc_alerts = {}
f_misc_alerts.BRC_FEATURE_NAME = "misc-alerts"

-- Persistent variables
ma_alerted_max_piety = BRC.data.persist("ma_alerted_max_piety", false)
ma_prev_spell_levels = BRC.data.persist("ma_prev_spell_levels", 0)
ma_saved_msg = BRC.data.persist("ma_saved_msg", "")

-- Local constants / configuration
local REMOVE_FAITH_MSG = "6 star piety! Maybe ditch that amulet soon."

-- Local variables
local below_hp_threshold

-- Local functions
local function alert_low_hp()
  local hp, mhp = you.hp()
  if below_hp_threshold then
    below_hp_threshold = hp ~= mhp
  elseif hp <= BRC.Config.alert_low_hp_threshold * mhp then
    below_hp_threshold = true
    local low_hp_msg = string.format(" Dropped below %s%% HP ", 100 * BRC.Config.alert_low_hp_threshold)
    BRC.mpr.que_optmore(true, BRC.Emoji.EXCLAMATION .. BRC.text.magenta(low_hp_msg) .. BRC.Emoji.EXCLAMATION)
  end
end

local function alert_remove_faith()
  if not ma_alerted_max_piety and you.piety_rank() == 6 then
    local am = items.equipped_at("amulet")
    if am and am.subtype() == "amulet of faith" and not am.artefact then
      if you.god() == "Uskayaw" then return end
      BRC.mpr.more(REMOVE_FAITH_MSG, BRC.COLORS.lightcyan)
      ma_alerted_max_piety = true
    end
  end
end

local function alert_spell_level_changes()
  local new_spell_levels = you.spell_levels()
  if new_spell_levels > ma_prev_spell_levels then
    local delta = new_spell_levels - ma_prev_spell_levels
    local msg = string.format("Gained %s spell level%s", delta, delta > 1 and "s" or "")
    local avail = string.format(" (%s available)", new_spell_levels)
    crawl.mpr(BRC.text.lightcyan(msg) .. BRC.text.cyan(avail))
  elseif new_spell_levels < ma_prev_spell_levels then
    BRC.mpr.magenta(string.format("%s spell levels remaining", new_spell_levels))
  end

  ma_prev_spell_levels = new_spell_levels
end

-- Macro function: Save with message feature
function macro_f_misc_alerts_save_with_message()
  if not BRC.mpr.yesno("Save game and exit?", BRC.COLORS.lightcyan) then
    crawl.mpr("Okay, then.")
    return
  end

  crawl.formatted_mpr("Leave a message: ", "prompt")
  ma_saved_msg = crawl.c_input_line()
  BRC.util.do_cmd("CMD_SAVE_GAME_NOW")
end

-- Hook functions
function f_misc_alerts.init()
  ma_prev_spell_levels = you.spell_levels()
  below_hp_threshold = false

  if BRC.Config.save_with_msg then
    BRC.set.macro(BRC.get.command_key("CMD_SAVE_GAME") or "S", "macro_f_misc_alerts_save_with_message")
    if ma_saved_msg and ma_saved_msg ~= "" then
      BRC.mpr.white(string.format("MESSAGE: %s", ma_saved_msg))
      ma_saved_msg = nil
    end
  end
end

function f_misc_alerts.ready()
  if BRC.Config.alert_remove_faith then alert_remove_faith() end
  if BRC.Config.alert_low_hp_threshold > 0 then alert_low_hp() end
  if BRC.Config.alert_spell_level_changes then alert_spell_level_changes() end
end

}
############################### End lua/features/misc-alerts.lua ###############################
##########################################################################################

################################### Begin lua/features/remind-id.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
--[[
Feature: remind-id
Description: Reminds to read ID scrolls, and stops explore on increased stack sizes before finding ID scrolls
Author: buehler
Dependencies: core/config.lua, core/data.lua, core/constants.lua, core/util.lua
--]]

f_remind_id = {}
f_remind_id.BRC_FEATURE_NAME = "remind-id"

-- Persistent variables
ri_max_scroll_stack = BRC.data.persist("ri_max_scroll_stack", BRC.Config.stop_on_scrolls_count - 1)
ri_max_potion_stack = BRC.data.persist("ri_max_potion_stack", BRC.Config.stop_on_pots_count - 1)
ri_found_scroll_of_id = BRC.data.persist("ri_found_scroll_of_id", false)

-- Local constants / configuration
local IDENTIFY_MSG = BRC.text.magenta(" You have something to identify. ")
if BRC.Emoji.REMIND_ID then IDENTIFY_MSG = BRC.Emoji.REMIND_ID .. IDENTIFY_MSG .. BRC.Emoji.REMIND_ID end

-- Local variables
local do_remind_id_check

-- Local functions
local function alert_remind_identify()
  BRC.mpr.stop(IDENTIFY_MSG)
end

local function get_max_stack_size(class, skip_slot)
  local max_stack_size = 0
  for inv in iter.invent_iterator:new(items.inventory()) do
    if
      inv.quantity > max_stack_size
      and inv.class(true) == class
      and inv.slot ~= skip_slot
      and not inv.is_identified
    then
      max_stack_size = inv.quantity
    end
  end
  return max_stack_size
end

local function have_scroll_of_id()
  for inv in iter.invent_iterator:new(items.inventory()) do
    if inv.name("qual") == "scroll of identify" then return true end
  end
  return false
end

local function have_unid_item()
  for inv in iter.invent_iterator:new(items.inventory()) do
    if not inv.is_identified then return true end
  end
  return false
end

-- Hook functions
function f_remind_id.init()
  do_remind_id_check = true
end

function f_remind_id.c_assign_invletter(it)
  if not it.is_identified then
    if have_scroll_of_id() then
      you.stop_activity()
      do_remind_id_check = true
      return
    end
  elseif it.name("qual") == "scroll of identify" then
    if have_unid_item() then
      you.stop_activity()
      do_remind_id_check = true
      return
    end
  end
end

function f_remind_id.c_message(text, channel)
  if channel ~= "plain" then return end

  if text:find("scrolls? of identify") then
    ri_found_scroll_of_id = true
    if not text:find("ou drop ", 1, true) and have_unid_item() then
      you.stop_activity()
      do_remind_id_check = true
    end
  elseif not ri_found_scroll_of_id then
    -- Pre-ID: Stop when largest stack of pots/scrolls increases
    local idx = text:find(" %- ")
    if not idx then return end

    local slot = items.letter_to_index(text:sub(idx - 1, idx - 1))
    local it = items.inslot(slot)

    if not it or it.is_identified then return end
    -- Picking up known items still returns identified == false
    -- Doing some hacky checks below instead

    local it_class = it.class(true)
    if it_class == "scroll" then
      if it.quantity > math.max(ri_max_scroll_stack, get_max_stack_size("scroll", slot)) then
        you.stop_activity()
        ri_max_scroll_stack = it.quantity
      end
    elseif it_class == "potion" then
      if it.quantity > math.max(ri_max_potion_stack, get_max_stack_size("potion", slot)) then
        you.stop_activity()
        ri_max_potion_stack = it.quantity
      end
    end
  end
end

function f_remind_id.ready()
  if do_remind_id_check then
    do_remind_id_check = false
    if have_unid_item() and have_scroll_of_id() then alert_remind_identify() end
  end
end

}
############################### End lua/features/remind-id.lua ###############################
##########################################################################################

################################### Begin lua/features/runrest-features.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
--[[
Feature: runrest-features
Description: Simple features related to auto-explore stops: altars, gauntlets, portals, stairs, etc
Author: buehler
Dependencies: core/config.lua, core/data.lua, core/constants.lua, core/util.lua
--]]

f_runrest_features = {}
f_runrest_features.BRC_FEATURE_NAME = "runrest-features"

-- Persistent variables
rr_autosearched_temple = BRC.data.persist("rr_autosearched_temple", false)
rr_autosearched_gauntlet = BRC.data.persist("rr_autosearched_gauntlet", false)

-- Local constants / configuration
local GAUNTLET_SEARCH_STRING = "gauntlet && !!leading && !!transporter && !!pieces && !!trap"

-- Local variables
local stop_on_altars
local stop_on_portals
local stop_on_pan_gates
local stop_on_hell_stairs

-- Local functions

-- Altar and religion functions
local function religion_is_handled()
  if you.race() == "Demigod" then return true end
  if you.god() == "No God" then return false end
  if you.good_god() then return you.xl() > 9 end
  return true
end

local function ready_ignore_altars()
  if stop_on_altars and religion_is_handled() then
    stop_on_altars = false
    BRC.set.explore_stop("altars", false)
  elseif not stop_on_altars and not religion_is_handled() then
    stop_on_altars = true
    BRC.set.explore_stop("altars", true)
  end
end

-- Temple-related functions
local function search_altars()
  local cmd_key = BRC.get.command_key("CMD_SEARCH_STASHES") or BRC.util.control_key("f")
  crawl.sendkeys({ cmd_key, "altar", BRC.KEYS.CR })
end

local function ready_temple_macro()
  if you.branch() == "Temple" and not rr_autosearched_temple then
    search_altars()
    rr_autosearched_temple = true
  end
end

local function c_message_temple(text, _)
  if you.branch() == "Temple" then
    -- Search again after explore
    if text:find("explor", 1, true) then search_altars() end
  end
end

-- Gauntlet-related functions
local function search_gauntlet()
  local cmd_key = BRC.get.command_key("CMD_SEARCH_STASHES") or BRC.util.control_key("f")
  crawl.sendkeys({ cmd_key, GAUNTLET_SEARCH_STRING, BRC.KEYS.CR })
end

local function ready_gauntlet_macro()
  if you.branch() == "Gauntlet" and not rr_autosearched_gauntlet then
    search_gauntlet()
    rr_autosearched_gauntlet = true
  end
end

local function c_message_gauntlet(text, _)
  -- Search again after explore
  if you.branch() == "Gauntlet" then
    if text:find("explor", 1, true) then search_gauntlet() end
  end
end



-- Stairs and branch-specific functions
local function ready_ignore_exits()
  if stop_on_portals and util.contains(BRC.ALL_PORTAL_NAMES, you.branch()) then
    stop_on_portals = false
    BRC.set.explore_stop("portals", false)
  elseif not stop_on_portals and not util.contains(BRC.ALL_PORTAL_NAMES, you.branch()) then
    stop_on_portals = true
    BRC.set.explore_stop("portals", true)
  end
end

local function ready_stop_on_pan_gates()
  local branch = you.branch()
  if stop_on_pan_gates and branch ~= "Pan" then
    stop_on_pan_gates = false
    BRC.set.explore_stop("stairs", false)
  elseif not stop_on_pan_gates and branch == "Pan" then
    stop_on_pan_gates = true
    BRC.set.explore_stop("stairs", true)
  end
end

local function ready_stop_on_hell_stairs()
  if stop_on_hell_stairs and not BRC.you.in_hell() then
    stop_on_hell_stairs = false
    BRC.set.explore_stop("stairs", false)
  elseif not stop_on_hell_stairs and BRC.you.in_hell() then
    stop_on_hell_stairs = true
    BRC.set.explore_stop("stairs", true)
  end
end

-- Hook functions
function f_runrest_features.init()
  stop_on_altars = true
  stop_on_portals = true
  stop_on_pan_gates = false
  stop_on_hell_stairs = false
end

function f_runrest_features.c_message(text, _)
  if BRC.Config.temple_macros then c_message_temple(text, _) end
  if BRC.Config.gauntlet_macros then c_message_gauntlet(text, _) end
end

function f_runrest_features.ready()
  if BRC.Config.ignore_altars then ready_ignore_altars() end
  if BRC.Config.ignore_portal_exits then ready_ignore_exits() end
  if BRC.Config.stop_on_pan_gates then ready_stop_on_pan_gates() end
  if BRC.Config.stop_on_hell_stairs then ready_stop_on_hell_stairs() end
  if BRC.Config.temple_macros then ready_temple_macro() end
  if BRC.Config.gauntlet_macros then ready_gauntlet_macro() end
end

}
############################### End lua/features/runrest-features.lua ###############################
##########################################################################################

################################### Begin lua/features/safe-consumables.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
--[[
Feature: safe-consumables
Description: Automatically manages !q and !r inscriptions. An upgrade to using autoinscribe.
Author: buehler
Dependencies: core/config.lua, core/util.lua
--]]

f_safe_consumables = {}
f_safe_consumables.BRC_FEATURE_NAME = "safe-consumables"

-- Local constants
local NO_INSCRIPTION_NEEDED = {
  "acquirement",
  "amnesia",
  "blinking",
  "brand weapon",
  "enchant armour",
  "enchant weapon",
  "identify",
  "immolation",
  "noise",
  "vulnerability",
  "attraction",
  "lignification",
  "mutation",
} -- NO_INSCRIPTION_NEEDED (do not remove this comment)

-- Hook functions
function f_safe_consumables.ready()
  if not BRC.Config.safe_consumables then return end
  -- Remove the default "!r" and "!q" inscriptions after identify
  for inv in iter.invent_iterator:new(items.inventory()) do
    local inv_class = inv.class(true)
    local st = inv.subtype()
    if inv_class == "scroll" then
      if
        (st == "poison" and you.res_poison() > 0)
        or (st == "torment" and you.torment_immune())
        or util.contains(NO_INSCRIPTION_NEEDED, st)
      then
        if inv.inscription:find("%!r") then inv.inscribe(inv.inscription:gsub("%!r", ""), false) end
      elseif not inv.inscription:find("%!r") then
        inv.inscribe("!r")
      end
    elseif inv_class == "potion" then
      if util.contains(NO_INSCRIPTION_NEEDED, st) then
        if inv.inscription:find("%!q") then inv.inscribe(inv.inscription:gsub("%!q", ""), false) end
      elseif not inv.inscription:find("%!q") then
        inv.inscribe("!q")
      end
    end
  end
end

}
############################### End lua/features/safe-consumables.lua ###############################
##########################################################################################

################################### Begin lua/features/safe-stairs.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
--[[
Feature: safe-stairs
Description: Prevents accidental stairs use by warning about backtracking and dangerous locations like Vaults:5
Author: buehler, rypofalem (V5 warning idea)
Dependencies: core/config.lua, core/data.lua, core/constants.lua, core/util.lua
--]]

f_safe_stairs = {}
f_safe_stairs.BRC_FEATURE_NAME = "safe-stairs"

-- Persistent variables
ss_prev_location = BRC.data.persist("ss_prev_location", "")
ss_cur_location = BRC.data.persist("ss_cur_location", "")
ss_last_stair_turn = BRC.data.persist("ss_last_stair_turn", 0)
ss_v5_unwarned = BRC.data.persist("ss_v5_unwarned", true)

-- Local functions
local function check_new_location(cmd)
  local feature = view.feature_at(0, 0)
  local one_way_stair = feature:find("escape_hatch", 1, true) or feature:find("shaft", 1, true)

  local turn_diff = you.turns() - ss_last_stair_turn
  if ss_prev_location ~= ss_cur_location and turn_diff > 0 and turn_diff < BRC.Config.warn_stairs_threshold then
    if cmd == "CMD_GO_DOWNSTAIRS" then
      if not (feature:find("down", 1, true) or feature:find("shaft", 1, true)) then
        BRC.util.do_cmd(cmd)
        return
      end
    else
      if not feature:find("up", 1, true) then
        BRC.util.do_cmd(cmd)
        return
      end
    end

    if not BRC.mpr.yesno("Really go right back?") then
      crawl.mpr("Okay, then.")
      return
    end
  elseif BRC.Config.warn_v5 and ss_v5_unwarned and ss_cur_location == "Vaults4" and cmd == "CMD_GO_DOWNSTAIRS" then
    if feature:find("down", 1, true) or feature:find("shaft", 1, true) then
      if not BRC.mpr.yesno("Really go to Vaults:5?") then
        crawl.mpr("Okay, then.")
        return
      end
      ss_v5_unwarned = false
    end
  end

  BRC.util.do_cmd(cmd)
  if not one_way_stair then ss_last_stair_turn = you.turns() end
end

-- Macro functions
function macro_f_safe_stairs_down()
  check_new_location("CMD_GO_DOWNSTAIRS")
end

function macro_f_safe_stairs_up()
  check_new_location("CMD_GO_UPSTAIRS")
end

-- Hook functions
function f_safe_stairs.init()
  ss_prev_location = you.branch() .. you.depth()
  ss_cur_location = you.branch() .. you.depth()
  ss_last_stair_turn = 0
  ss_v5_unwarned = true

  BRC.set.macro(BRC.get.command_key("CMD_GO_DOWNSTAIRS") or ">", "macro_f_safe_stairs_down")
  BRC.set.macro(BRC.get.command_key("CMD_GO_UPSTAIRS") or "<", "macro_f_safe_stairs_up")
end

function f_safe_stairs.ready()
  ss_prev_location = ss_cur_location
  ss_cur_location = you.branch() .. you.depth()
end

}
############################### End lua/features/safe-stairs.lua ###############################
##########################################################################################

################################### Begin lua/features/startup.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
--[[
Feature: startup
Description: Handles startup features like skill menu display and auto-setting skill targets
Author: rwbarton, buehler
Dependencies: core/config.lua, core/constants.lua, core/util.lua
--]]

f_startup = {}
f_startup.BRC_FEATURE_NAME = "startup"

-- Hook functions
function f_startup.ready()
  if you.turns() == 0 then
    if BRC.Config.show_skills_on_startup then
      local show_skills_on_startup = (you.race() ~= "Gnoll" or you.class() == "Wanderer")
      if show_skills_on_startup then BRC.util.do_cmd("CMD_DISPLAY_SKILLS") end
    end

    ---- Auto-set default skill targets ----
    if BRC.Config.auto_set_skill_targets then
      for _, skill_target in ipairs(BRC.Config.auto_set_skill_targets) do
        local skill, target = unpack(skill_target)
        if you.skill(skill) < target then
          for _, s in ipairs(BRC.ALL_TRAINING_SKILLS) do
            you.train_skill(s, 0)
          end
          you.set_training_target(skill, target)
          you.train_skill(skill, 2)
          break
        end
      end
    end
  end
end

}
############################### End lua/features/startup.lua ###############################
##########################################################################################

################################### Begin lua/features/weapon-slots.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
--[[
Feature: weapon-slots
Description: Automatically moves weapons to slots a, b, and w with intelligent priority-based organization
Author: buehler
Dependencies: core/config.lua, core/util.lua
--]]

f_weapon_slots = {}
f_weapon_slots.BRC_FEATURE_NAME = "weapon-slots"

-- Local variables
local do_cleanup_weapon_slots
local priorities_ab
local priorities_w
local slots_changed

-- Local functions
local function get_first_empty_slot()
  for slot = 1, 52 do
    if not items.inslot(slot) then return slot end
  end
end

local function get_priority_ab(it)
  if not it.is_weapon then return -1 end
  if it.equipped then return 1 end

  if BRC.is.magic_staff(it) then return 3 end
  if it.is_ranged then return (you.skill("Ranged Weapons") >= 4) and 2 or 5 end
  if BRC.is.polearm(it) then return (you.skill("Polearms") >= 4) and 2 or 4 end
  return 2
end

local function get_priority_w(it)
  if not it.is_weapon then return -1 end
  if it.is_ranged then return 1 end
  if BRC.is.polearm(it) then return 2 end
  if BRC.is.magic_staff(it) then return 3 end
  return 4
end

local function generate_priorities()
  priorities_ab = { -1, -1, -1, -1, -1 }
  priorities_w = { -1, -1, -1, -1 }

  for inv in iter.invent_iterator:new(items.inventory()) do
    local p = get_priority_w(inv)
    if p > 0 then
      if priorities_w[p] == -1 then
        priorities_w[p] = inv.slot
      else
        priorities_w[p + 1] = inv.slot
      end
    end

    p = get_priority_ab(inv)
    if p > 0 then
      if priorities_ab[p] == -1 then
        priorities_ab[p] = inv.slot
      else
        priorities_ab[p + 1] = inv.slot
      end
    end
  end
end

local function cleanup_ab(slot)
  local inv = items.inslot(slot)
  if inv and inv.is_weapon then return end

  for p = 1, #priorities_ab do
    if priorities_ab[p] > slot then -- Not from earlier slot
      items.swap_slots(priorities_ab[p], slot)
      slots_changed = true
      priorities_ab[p] = -1
      return
    end
  end
end

local function cleanup_w()
  local slot_w = items.letter_to_index("w")
  local inv = items.inslot(slot_w)
  if inv and inv.is_weapon then return end

  for p = 1, #priorities_w do
    if priorities_w[p] > 1 then -- Not from slots a or b
      items.swap_slots(priorities_w[p], slot_w)
      slots_changed = true
      return
    end
  end
end

local function cleanup_weapon_slots()
  generate_priorities()
  cleanup_ab(0)
  cleanup_ab(1)
  cleanup_w()
end

-- Hook functions
function f_weapon_slots.init()
  do_cleanup_weapon_slots = false
  slots_changed = false
  priorities_ab = nil
  priorities_w = nil
end

function f_weapon_slots.c_assign_invletter(it)
  if not BRC.Config.do_auto_weapon_slots_abw then return end
  if not it.is_weapon then return end

  for i = 0, 2 do
    local slot = i == 2 and items.letter_to_index("w") or i

    local inv = items.inslot(slot)
    if not inv then return slot end
    if not inv.is_weapon then
      items.swap_slots(slot, get_first_empty_slot())
      slots_changed = true
      return slot
    end
  end
end

function f_weapon_slots.c_message(text, channel)
  if not BRC.Config.do_auto_weapon_slots_abw then return end
  do_cleanup_weapon_slots = channel == "plain" and text:find("ou drop ", 1, true)
end

function f_weapon_slots.ready()
  if do_cleanup_weapon_slots then
    cleanup_weapon_slots()
    do_cleanup_weapon_slots = false
    if slots_changed then
      BRC.mpr.darkgrey("Weapon slots updated (ab+w).")
      crawl.redraw_screen()
      slots_changed = false
    end
  end
end

}
############################### End lua/features/weapon-slots.lua ###############################
##########################################################################################

## (Resuming init.txt) ##

### Pickup and alert - Core files ###

################################### Begin lua/pickup-alert/pa-main.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
--[[
Feature: pickup-alert
Description: Comprehensive pickup and alert system for weapons, armour, and miscellaneous items
Author: buehler
Dependencies: core/config.lua, core/data.lua, core/constants.lua, core/util.lua,
  pickup-alert/pa-armour.lua, pickup-alert/pa-data.lua, pickup-alert/pa-misc.lua, pickup-alert/pa-weapons.lua
--]]

f_pickup_alert = {}
f_pickup_alert.BRC_FEATURE_NAME = "pickup-alert"

-- Persistent variables
pa_num_autopickup_funcs = BRC.data.persist("pa_num_autopickup_funcs", #chk_force_autopickup + 1)

-- Local variables
local pause_pa_system

-- Local functions
local function has_configured_force_more(it)
  if it.artefact then
    if BRC.Config.fm_alert.artefact then return true end
    if BRC.Config.fm_alert.trained_artefacts and BRC.get.skill_with(it) > 0 then return true end
  end
  if BRC.Config.fm_alert.armour_ego and BRC.is.armour(it) and BRC.get.ego(it) then return true end
  return false
end

-- Public API
function f_pickup_alert.autopickup(it, _)
  local unworn_aux_item = nil -- Conditionally set below for pa-alert-armour
  if pause_pa_system then return end
  if you.have_orb() then return end
  if BRC.get.ego(it) and not it.is_identified then return false end
  if not it.is_useless then
    if f_pa_armour and BRC.Config.pickup.armour and BRC.is.armour(it) then
      if f_pa_armour.pickup_armour(it) then return true end
    elseif f_pa_misc and BRC.Config.pickup.staves and BRC.is.magic_staff(it) then
      if f_pa_misc.pickup_staff(it) then return true end
    elseif f_pa_weapons and BRC.Config.pickup.weapons and it.is_weapon then
      if f_pa_weapons.pickup_weapon(it) then return true end
    elseif f_pa_misc and f_pa_misc.is_unneeded_ring(it) then
      return false
    end
  else
    -- Useless item; allow alerts for aux armour if you're carrying one (implies a temporary mutation)
    if BRC.is.aux_armour(it) then return end

    local st = it.subtype()
    for inv in iter.invent_iterator:new(items.inventory()) do
      local inv_st = inv.subtype()
      if inv_st and inv_st == st then
        unworn_aux_item = inv
        break
      end
    end
    if not unworn_aux_item then return end
  end

  -- Not picking up this item. Now check for alerts.
  if not BRC.Config.alert.system_enabled or f_pa_data.find(pa_items_alerted, it) then return end

  if f_pa_misc and BRC.Config.alert.one_time and #BRC.Config.alert.one_time > 0 then
    if f_pa_misc.alert_OTA(it) then return end
  end

  if f_pa_misc and BRC.Config.alert.staff_resists and BRC.is.magic_staff(it) then
    if f_pa_misc.alert_staff(it) then return end
  elseif f_pa_misc and BRC.Config.alert.orbs and BRC.is.orb(it) then
    if f_pa_misc.alert_orb(it) then return end
  elseif f_pa_misc and BRC.Config.alert.talismans and BRC.is.talisman(it) then
    if f_pa_misc.alert_talisman(it) then return end
  elseif f_pa_armour and BRC.Config.alert.armour and BRC.is.armour(it) then
    if f_pa_armour.alert_armour(it, unworn_aux_item) then return end
  elseif f_pa_weapons and BRC.Config.alert.weapons and it.is_weapon then
    if f_pa_weapons.alert_weapon(it) then return end
  end
end

function f_pickup_alert.do_alert(it, alert_type, emoji, force_more)
  local item_name = f_pa_data.get_keyname(it, true)
  local alert_col
  if it.is_weapon then
    alert_col = BRC.AlertColor.weapon
    f_pa_data.update_high_scores(it)
    local weapon_info = string.format(" (%s)", BRC.get.weapon_info(it))
    item_name = item_name .. BRC.text.color(BRC.AlertColor.weapon.stats, weapon_info)
  elseif BRC.is.body_armour(it) then
    alert_col = BRC.AlertColor.body_arm
    f_pa_data.update_high_scores(it)
    local ac, ev = BRC.get.armour_info(it)
    local armour_info = string.format(" {%s, %s}", ac, ev)
    item_name = item_name .. BRC.text.color(BRC.AlertColor.body_arm.stats, armour_info)
  elseif BRC.is.armour(it) then
    alert_col = BRC.AlertColor.aux_arm
  elseif BRC.is.orb(it) then
    alert_col = BRC.AlertColor.orb
  elseif BRC.is.talisman(it) then
    alert_col = BRC.AlertColor.talisman
  else
    alert_col = BRC.AlertColor.misc
  end

  local tokens = {}
  tokens[1] = emoji and emoji or BRC.text.cyan("----")
  tokens[#tokens + 1] = BRC.text.color(alert_col.desc, string.format(" %s:", alert_type))
  tokens[#tokens + 1] = BRC.text.color(alert_col.item, string.format(" %s ", item_name))
  tokens[#tokens + 1] = tokens[1]
  BRC.mpr.que_optmore(force_more or has_configured_force_more(it), table.concat(tokens))

  f_pa_data.insert(pa_recent_alerts, it)
  f_pa_data.insert(pa_items_alerted, it)
  you.stop_activity()
  return true
end

-- Hook functions
function f_pickup_alert.init()
  BRC.log.debug("Initializing pickup-alert submodules...")
  local indent = "  "
  pause_pa_system = false
  f_pa_data.init()
  BRC.log.debug(indent .. "pa-data loaded")

  if f_pa_armour then
    if f_pa_armour.init then f_pa_armour.init() end
    BRC.log.debug(indent .. "pa-armour loaded")
  end

  if f_pa_weapons then
    if f_pa_weapons.init then f_pa_weapons.init() end
    BRC.log.debug(indent .. "pa-weapons loaded")
  end

  if f_pa_misc then
    if f_pa_misc.init then f_pa_misc.init() end
    BRC.log.debug(indent .. "pa-misc loaded")
  end

  -- Check for duplicate autopickup creation (affects local only)
  if pa_num_autopickup_funcs < #chk_force_autopickup then
    BRC.log.warning(table.concat({
      "Warning: Extra autopickup funcs detected. (Commonly from reloading a local game.)\n",
      "Expected: ", pa_num_autopickup_funcs, " but got: ", #chk_force_autopickup, "\n",
      "If this is not expected, restart crawl to clear its memory."
    }))
    if not BRC.mpr.yesno("Continue adding BRC autopickup function?") then
      BRC.log.info("Skipping BRC autopickup function.")
      return
    end
  end

  pa_num_autopickup_funcs = #chk_force_autopickup
end

function f_pickup_alert.c_assign_invletter(it)
  f_pa_misc.alert_OTA(it)
  f_pa_data.remove(pa_recent_alerts, it)
  if it.is_weapon and you.race() == "Coglin" then
    -- Allow 1 more alert for an identical weapon, if dual-wielding possible.
    -- ie, Reset the alert the first time you pick up.
    if f_pa_data.find(pa_items_picked, it) then f_pa_data.remove(pa_items_alerted, it) end
  end

  f_pa_data.insert(pa_items_picked, it)

  if it.is_weapon or BRC.is.armour(it) then
    f_pa_data.update_high_scores(it)
    you.stop_activity() -- crawl misses this sometimes
  end
end

function f_pickup_alert.c_message(text, channel)
  if channel == "multiturn" then
    if not pause_pa_system and text:find("ou start ", 1, true) then pause_pa_system = true end
  elseif channel == "plain" then
    if pause_pa_system and (text:find("ou stop ", 1, true) or text:find("ou finish ", 1, true)) then
      pause_pa_system = false
    elseif text:find("one exploring", 1, true) or text:find("artly explored", 1, true) then
      local tokens = { "Recent alerts:" }
      for _, v in ipairs(pa_recent_alerts) do
        tokens[#tokens + 1] = string.format("\n  %s", v)
      end
      if #tokens > 1 then BRC.mpr.que(table.concat(tokens), BRC.COLORS.magenta) end
      pa_recent_alerts = {}
    end
  end
end

function f_pickup_alert.ready()
  if pause_pa_system then return end
  f_pa_weapons.ready()
  f_pa_data.update_high_scores(items.equipped_at("armour"))
end

}
############################### End lua/pickup-alert/pa-main.lua ###############################
##########################################################################################

################################### Begin lua/pickup-alert/pa-data.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
--[[
Feature: pickup-alert-data
Description: Data management and persistent storage for the pickup-alert system
Author: buehler
Dependencies: core/config.lua, core/data.lua, core/constants.lua, core/util.lua
--]]

f_pa_data = {}
--f_pa_data.BRC_FEATURE_NAME = "pickup-alert-data"

-- Persistent variables
pa_items_picked = BRC.data.persist("pa_items_picked", {})
pa_items_alerted = BRC.data.persist("pa_items_alerted", {})
pa_recent_alerts = BRC.data.persist("pa_recent_alerts", {})
pa_OTA_items = BRC.data.persist("pa_OTA_items", BRC.Config.alert.one_time)
pa_high_score = BRC.data.persist("pa_high_score", { ac = 0, weapon = 0, plain_dmg = 0 })

-- Local functions
local function get_pa_keys(it, plain_name)
  if it.class(true) == "bauble" then
    return it.name("qual"):gsub('"', ""), 0
  elseif BRC.is.talisman(it) or BRC.is.orb(it) then
    return it.name():gsub('"', ""), 0
  elseif BRC.is.magic_staff(it) then
    return it.name("base"):gsub('"', ""), 0
  else
    local name = it.name(plain_name and "plain" or "base"):gsub('"', "")
    local value = tonumber(name:sub(1, 3))
    if not value then return name, 0 end
    return util.trim(name:sub(4)), value
  end
end

-- Public API
-- Return name of first entry found in item name, or nil if not found
function f_pa_data.find(table_ref, it)
  if table_ref == pa_OTA_items then
    local qualname = it.name("qual")
    for _, v in ipairs(pa_OTA_items) do
      if v and qualname:find(v) then return v end
    end
  else
    local name, value = get_pa_keys(it)
    if table_ref[name] ~= nil and tonumber(table_ref[name]) >= value then return name end
  end
end

function f_pa_data.insert(table_ref, it)
  if table_ref == pa_recent_alerts then
    pa_recent_alerts[#pa_recent_alerts + 1] = f_pa_data.get_keyname(it)
  elseif it.is_weapon or BRC.is.armour(it, true) or BRC.is.talisman(it) then
    local name, value = get_pa_keys(it)
    local cur_val = tonumber(table_ref[name])
    if not cur_val or value > cur_val then table_ref[name] = value end
  end
end

function f_pa_data.remove(table_ref, it)
  if table_ref == pa_OTA_items then
    repeat
      local item_name = f_pa_data.find(pa_OTA_items, it)
      if item_name == nil then return end
      util.remove(pa_OTA_items, item_name)
    until item_name == nil
  elseif table_ref == pa_recent_alerts then
    util.remove(pa_recent_alerts, f_pa_data.get_keyname(it))
  else
    local name, _ = get_pa_keys(it)
    util.remove(table_ref, name)
  end
end

-- Get name with plus included and quotes removed; stored in pa_recent_alerts table
function f_pa_data.get_keyname(it, plain_name)
  local name, value = get_pa_keys(it, plain_name)
  if BRC.is.talisman(it) or BRC.is.orb(it) or BRC.is.magic_staff(it) then return name end
  if value >= 0 then value = string.format("+%s", value) end
  return string.format("%s %s", value, name)
end

-- Returns a string of the high score type if item sets a new high score, else nil
function f_pa_data.update_high_scores(it)
  if not it then return end
  local ret_val = nil

  if BRC.is.armour(it) then
    local ac = BRC.get.armour_ac(it)
    if ac > pa_high_score.ac then
      pa_high_score.ac = ac
      if not ret_val then ret_val = "Highest AC" end
    end
  elseif it.is_weapon then
    -- Don't alert for unusable weapons
    if BRC.get.hands(it) == 2 and not BRC.you.free_offhand() then return end

    local dmg = BRC.get.weap_damage(it, BRC.DMG_TYPE.branded)
    if dmg > pa_high_score.weapon then
      pa_high_score.weapon = dmg
      if not ret_val then ret_val = "Highest damage" end
    end

    dmg = BRC.get.weap_damage(it, BRC.DMG_TYPE.plain)
    if dmg > pa_high_score.plain_dmg then
      pa_high_score.plain_dmg = dmg
      if not ret_val then ret_val = "Highest plain damage" end
    end
  end

  return ret_val
end

-- Hook functions
function f_pa_data.init()
  -- Update alerts & tables for starting items
  for inv in iter.invent_iterator:new(items.inventory()) do
    f_pa_data.remove(pa_OTA_items, inv)
    f_pa_data.insert(pa_items_picked, inv)
  end
end

}
############################### End lua/pickup-alert/pa-data.lua ###############################
##########################################################################################

## (Resuming init.txt) ##

### Pickup and alert - Feature files ###

################################### Begin lua/pickup-alert/pa-armour.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
--[[
Feature: pickup-alert-armour
Description: Armour pickup logic and alert system for the pickup-alert system
Author: Original Equipment autopickup by Medar, gammafunk, and various others. Extended by buehler.
Dependencies: core/config.lua, core/data.lua, core/constants.lua, core/util.lua
--]]

f_pa_armour = {}
--f_pa_armour.BRC_FEATURE_NAME = "pickup-alert-armour"

-- Local constants / configuration
local ENCUMB_ARMOUR_DIVISOR = 2 -- Encumbrance penalty is offset by (Armour / ENCUMB_ARMOUR_DIVISOR)
local SAME = "same_ego"
local LOST = "lost_ego"
local GAIN = "gain_ego"
local DIFF = "diff_ego"
local HEAVIER = "heavier"
local LIGHTER = "lighter"

local ARMOUR_ALERT = {
  artefact = { msg = "Artefact armour", emoji = BRC.Emoji.ARTEFACT },
  [GAIN] = { msg = "Gain ego", emoji = BRC.Emoji.EGO },
  [DIFF] = { msg = "Diff ego", emoji = BRC.Emoji.EGO },
  [LIGHTER] = {
    [GAIN] = { msg = "Gain ego (Lighter armour)", emoji = BRC.Emoji.EGO },
    [DIFF] = { msg = "Diff ego (Lighter armour)", emoji = BRC.Emoji.EGO },
    [SAME] = { msg = "Lighter armour", emoji = BRC.Emoji.LIGHTER },
    [LOST] = { msg = "Lighter armour (Lost ego)", emoji = BRC.Emoji.LIGHTER },
  },
  [HEAVIER] = {
    [GAIN] = { msg = "Gain ego (Heavier armour)", emoji = BRC.Emoji.EGO },
    [DIFF] = { msg = "Diff ego (Heavier armour)", emoji = BRC.Emoji.EGO },
    [SAME] = { msg = "Heavier Armour", emoji = BRC.Emoji.HEAVIER },
    [LOST] = { msg = "Heavier Armour (Lost ego)", emoji = BRC.Emoji.HEAVIER },
  }, -- ARMOUR_ALERT.heavier (do not remove this comment)
} -- ARMOUR_ALERT (do not remove this comment)

-- Local functions
local function aux_slot_is_impaired(it)
  local st = it.subtype()
  -- Skip boots/gloves/helmet if wearing Lear's hauberk
  local worn = items.equipped_at("armour")
  if worn and worn.name("qual") == "Lear's hauberk" and st ~= "cloak" then return true end

  -- Mutation interference
  if st == "gloves" then
    return BRC.get.mut(BRC.MUTATIONS.demonic_touch, true) >= 3 and not BRC.you.free_offhand()
        or BRC.get.mut(BRC.MUTATIONS.claws, true) > 0 and not items.equipped_at("weapon")
  elseif st == "boots" then
    return BRC.get.mut(BRC.MUTATIONS.hooves, true) > 0
        or BRC.get.mut(BRC.MUTATIONS.talons, true) > 0
  elseif it.name("base"):find("helmet", 1, true) then
    return BRC.get.mut(BRC.MUTATIONS.horns, true) > 0
        or BRC.get.mut(BRC.MUTATIONS.beak, true) > 0
        or BRC.get.mut(BRC.MUTATIONS.antennae, true) > 0
  end

  return false
end

local function get_adjusted_ev_delta(encumb_delta, ev_delta)
  local encumb_skills = you.skill("Spellcasting")
    + you.skill("Ranged Weapons")
    - you.skill("Armour") / ENCUMB_ARMOUR_DIVISOR
  local encumb_impact = encumb_skills / you.xl()
  encumb_impact = math.max(0, math.min(1, encumb_impact)) -- Clamp to 0-1

  -- Subtract weighted encumbrance penalty, to align with ev_delta (negative == heavier)
  return ev_delta - encumb_delta * encumb_impact * BRC.Tuning.armour.encumb_penalty_weight
end

local function get_ego_change_type(cur_ego, it_ego)
  if it_ego == cur_ego then
    return SAME
  elseif not it_ego then
    return LOST
  elseif not cur_ego then
    return GAIN
  else
    return DIFF
  end
end

local function is_new_ego(ego_change)
  return ego_change == GAIN or ego_change == DIFF
end

local function send_armour_alert(it, alert_type)
  return f_pickup_alert.do_alert(it, alert_type.msg, alert_type.emoji, BRC.Config.fm_alert.body_armour)
end

-- Local functions: Pickup
local function pickup_body_armour(it)
  local cur = items.equipped_at("armour")
  if not cur then return false end -- surely am naked for a reason

  -- No pickup if either item is an artefact
  if cur.artefact or it.artefact then return false end

  -- No pickup if adding encumbrance or losing AC
  local encumb_delta = it.encumbrance - cur.encumbrance
  if encumb_delta > 0 then return false end

  local ac_delta = BRC.get.armour_ac(it) - BRC.get.armour_ac(cur)
  if ac_delta < 0 then return false end

  -- Pickup: Diff ego, Gain AC (w/o losing ego), Lower encumbrance (w/o losing ego)
  local it_ego = BRC.get.ego(it)
  local cur_ego = BRC.get.ego(cur)
  if cur_ego then
    if not it_ego then return false end
    return it_ego ~= cur_ego or ac_delta > 0 or encumb_delta < 0
  else
    return it_ego or ac_delta > 0 or encumb_delta < 0
  end
end

local function pickup_shield(it)
  local cur = items.equipped_at("offhand")

  -- Don't replace these
  if not BRC.is.shield(cur) then return false end
  if cur.encumbrance ~= it.encumbrance then return false end
  if cur.artefact then return false end

  -- Pickup: artefact
  if it.artefact then return true end

  -- Pickup: diff ego (w/o losing SH), gain ego, gain SH (w/o losing ego)
  local it_ego = BRC.get.ego(it)
  local cur_ego = BRC.get.ego(cur)
  if cur_ego then
    if it_ego == cur_ego then return it.plus > cur.plus end
    return it_ego and it.plus >= cur.plus
  end
  return it_ego or it.plus > cur.plus
end

local function pickup_aux_armour(it)
  -- Pickup: Anything if the slot is empty
  if aux_slot_is_impaired(it) then return false end
  -- Use a list to support Poltergeists; for most races it's a 1-item list
  local st = it.subtype()
  local all_equipped, num_slots = BRC.get.equipped_aux(st)
  if #all_equipped < num_slots then
    -- If we're carrying one (implying a blocking mutation), don't pickup another
    if #all_equipped == 0 and num_slots == 1 then
      for inv in iter.invent_iterator:new(items.inventory()) do
        if inv.subtype() == st then return false end
      end
    end

    return true
  end

  -- Pickup: artefact, unless slot(s) already full of artefact(s)
  for i, cur in ipairs(all_equipped) do
    if not cur.artefact then break end
    if i == num_slots then return false end
  end
  if it.is_identified and it.artefact then return true end

  -- Pickup: gain ego, gain AC (w/o losing ego), diff ego (w/o losing AC)
  local it_ac = BRC.get.armour_ac(it)
  local it_ego = BRC.get.ego(it)
  for _, cur in ipairs(all_equipped) do
    local cur_ac = BRC.get.armour_ac(cur)
    local cur_ego = BRC.get.ego(cur)
    if cur_ego then
      if it_ego then
        if it_ac > cur_ac then return true end
        if it_ac == cur_ac and it_ego ~= cur_ego then return true end
      end
    else
      if it_ego or it_ac > cur_ac then return true end
    end
  end
end

-- Local functions: Alerting
local function should_alert_body_armour(weight, gain, loss, ego_change)
  local meets_ratio = loss <= 0 or (gain / loss > BRC.Tuning.armour[weight][ego_change])
  if not meets_ratio then return false end

  -- Additional ego-specific restrictions
  if is_new_ego(ego_change) then
    return loss <= BRC.Tuning.armour[weight].max_loss
  elseif ego_change == LOST then
    return gain >= BRC.Tuning.armour[weight].min_gain
  end

  return true
  -- local function should_alert_lighter_armour(ac_delta, ev_delta, ego_change)
  --     local meets_ratio = ac_delta >= 0 or (ev_delta / -ac_delta > BRC.Tuning.armour.lighter[ego_change])
  --     if not meets_ratio then return false end

  --     -- Apply ego-specific restrictions
  --     if ego_change == LOST and ev_delta < BRC.Tuning.armour.lighter.min_gain then return false end
  --     if ego_change ~= SAME and -ac_delta > BRC.Tuning.armour.lighter.max_loss then return false end

  --     return true
  -- end

  -- local function should_alert_heavier_armour(ac_delta, ev_delta, ego_change)
  --     local meets_ratio = ev_delta >= 0 or (ac_delta / -ev_delta > BRC.Tuning.armour.heavier[ego_change])
  --     if not meets_ratio then return false end

  --     -- Apply ego-specific restrictions
  --     if ego_change == LOST and ac_delta < BRC.Tuning.armour.heavier.min_gain then return false end
  --     if ego_change ~= SAME and -ev_delta > BRC.Tuning.armour.heavier.max_loss then return false end

  --     return true
  -- end
end

-- If training armour in early/mid game, alert user to any armour that is the strongest found so far
local function alert_pa_high_score_ac(it)
  if not BRC.is.body_armour(it) then return false end
  if you.skill("Armour") == 0 then return false end
  if you.xl() > 12 then return false end

  if pa_high_score.ac == 0 then
    local worn = items.equipped_at("armour")
    if not worn then return false end
    pa_high_score.ac = BRC.get.armour_ac(worn)
  else
    local itAC = BRC.get.armour_ac(it)
    if itAC > pa_high_score.ac then
      pa_high_score.ac = itAC
      return f_pickup_alert.do_alert(it, "Highest AC", BRC.Emoji.STRONGEST, BRC.Config.fm_alert.high_score_armour)
    end
  end

  return false
end

local function alert_body_armour(it)
  local cur = items.equipped_at("armour")
  if not cur then return false end

  -- Always alert artefacts once identified
  if it.artefact then
    if not it.is_identified then return false end
    return send_armour_alert(it, ARMOUR_ALERT.artefact)
  end

  -- Get changes to ego, AC, EV, encumbrance
  local it_ego = BRC.get.ego(it)
  local cur_ego = BRC.get.ego(cur)
  local ego_change = get_ego_change_type(cur_ego, it_ego)
  local ac_delta = BRC.get.armour_ac(it) - BRC.get.armour_ac(cur)
  local ev_delta = BRC.get.armour_ev(it) - BRC.get.armour_ev(cur)
  local encumb_delta = it.encumbrance - cur.encumbrance

  -- Alert new egos if same encumbrance, or small change to total (AC+EV)
  if is_new_ego(ego_change) then
    if encumb_delta == 0 then return send_armour_alert(it, ARMOUR_ALERT[ego_change]) end

    local weight = encumb_delta < 0 and LIGHTER or HEAVIER
    if math.abs(ac_delta + ev_delta) <= BRC.Tuning.armour[weight].ignore_small then
      return send_armour_alert(it, ARMOUR_ALERT[weight][ego_change])
    end
  end

  -- Alert for lighter/heavier armour, based on configured AC/EV ratio
  if encumb_delta < 0 then
    if should_alert_body_armour(LIGHTER, ev_delta, -ac_delta, ego_change) then
      return send_armour_alert(it, ARMOUR_ALERT.lighter[ego_change])
    end
  elseif encumb_delta > 0 then
    local adj_ev_delta = get_adjusted_ev_delta(encumb_delta, ev_delta)
    if should_alert_body_armour(HEAVIER, ac_delta, -adj_ev_delta, ego_change) then
      return send_armour_alert(it, ARMOUR_ALERT.heavier[ego_change])
    end
  end

  -- Alert for highest AC found so far, or early armour with any ego
  if alert_pa_high_score_ac(it) then return true end
  if it_ego and you.xl() <= BRC.Tuning.armour.early_xl then
    return f_pickup_alert.do_alert(it, "Early armour", BRC.Emoji.EGO)
  end
end

local function alert_shield(it)
  if it.artefact then
    if not it.is_identified then return false end
    return f_pickup_alert.do_alert(it, "Artefact shield", BRC.Emoji.ARTEFACT, BRC.Config.fm_alert.shields)
  end

  -- Don't alert shields if not wearing one (one_time_alerts fire for the first of each type)
  local cur = items.equipped_at("offhand")
  if not BRC.is.shield(cur) then return false end

  -- Alert: New ego, Gain SH
  local ego_change = get_ego_change_type(BRC.get.ego(cur), BRC.get.ego(it))
  if is_new_ego(ego_change) then
    local alert_msg = ego_change == DIFF and "Diff ego" or "Gain ego"
    return f_pickup_alert.do_alert(it, alert_msg, BRC.Emoji.EGO, BRC.Config.fm_alert.shields)
  elseif BRC.get.shield_sh(it) > BRC.get.shield_sh(cur) then
    return f_pickup_alert.do_alert(it, "Higher SH", BRC.Emoji.STRONGER, BRC.Config.fm_alert.shields)
  end
end

local function alert_aux_armour(it, unworn_inv_item)
  if it.artefact then
    if not it.is_identified then return false end
    return f_pickup_alert.do_alert(it, "Artefact aux armour", BRC.Emoji.ARTEFACT, BRC.Config.fm_alert.aux_armour)
  end

  -- Use a list to support Poltergeists; for other races it's a 1-item list
  local all_equipped, num_slots = BRC.get.equipped_aux(it.subtype())
  if #all_equipped < num_slots then
    if unworn_inv_item then
      all_equipped[#all_equipped + 1] = unworn_inv_item
    else
      -- Catch dangerous brands or items blocked by non-innate mutations
      return f_pickup_alert.do_alert(it, "Aux armour", BRC.Emoji.EXCLAMATION, BRC.Config.fm_alert.aux_armour)
    end

    local it_ego = BRC.get.ego(it)
    for _, cur in ipairs(all_equipped) do
      local ego_change = get_ego_change_type(BRC.get.ego(cur), it_ego)
      if is_new_ego(ego_change) then
        local alert_msg = ego_change == DIFF and "Diff ego" or "Gain ego"
        return f_pickup_alert.do_alert(it, alert_msg, BRC.Emoji.EGO, BRC.Config.fm_alert.aux_armour)
      elseif BRC.get.armour_ac(it) > BRC.get.armour_ac(cur) then
        return f_pickup_alert.do_alert(it, "Higher AC", BRC.Emoji.STRONGER, BRC.Config.fm_alert.aux_armour)
      end
    end
  end
end

-- Public API
function f_pa_armour.pickup_armour(it)
  if BRC.is.risky_ego(BRC.get.ego(it)) then return false end

  if BRC.is.body_armour(it) then
    return pickup_body_armour(it)
  elseif BRC.is.shield(it) then
    return pickup_shield(it)
  else
    return pickup_aux_armour(it)
  end
end

--[[
    f_pa_armour.alert_armour() - Alerts armour items that didn't auto-pickup but are worth consideration.
    This comes after pickup, so there will be no pure upgrades.
    Optional `unworn_inv_item` param, to compare against an unworn aux armour item in inventory.
--]]
function f_pa_armour.alert_armour(it, unworn_inv_item)
  if BRC.is.body_armour(it) then
    return alert_body_armour(it)
  elseif BRC.is.shield(it) then
    return alert_shield(it)
  else
    return alert_aux_armour(it, unworn_inv_item)
  end
end

}
############################### End lua/pickup-alert/pa-armour.lua ###############################
##########################################################################################

################################### Begin lua/pickup-alert/pa-misc.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
--[[
Feature: pickup-alert-misc
Description: Miscellaneous item pickup logic and alert system for the pickup-alert system
Author: buehler
Dependencies: core/config.lua, core/constants.lua, core/util.lua
--]]

f_pa_misc = {}
--f_pa_misc.BRC_FEATURE_NAME = "pickup-alert-misc"

function f_pa_misc.alert_orb(it)
  if not it.is_identified then return false end
  return f_pickup_alert.do_alert(it, "New orb", BRC.Emoji.ORB, BRC.Config.fm_alert.orbs)
end

function f_pa_misc.alert_OTA(it)
  local ota_item = f_pa_data.find(pa_OTA_items, it)
  if not ota_item then return end

  local do_alert = true

  if BRC.is.shield(it) then
    if you.skill("Shields") < BRC.Config.alert.OTA_require_skill.shield then return end

    -- Don't alert if already wearing a larger shield
    if ota_item == "buckler" then
      if BRC.you.have_shield() then do_alert = false end
    elseif ota_item == "kite shield" then
      local sh = items.equipped_at("offhand")
      if sh and sh.name("qual") == "tower shield" then do_alert = false end
    end
  elseif BRC.is.armour(it) then
    if you.skill("Armour") < BRC.Config.alert.OTA_require_skill.armour then return end
  elseif it.is_weapon then
    if you.skill(it.weap_skill) < BRC.Config.alert.OTA_require_skill.weapon then return end
  end

  f_pa_data.remove(pa_OTA_items, it)
  if not do_alert then return false end
  return f_pickup_alert.do_alert(it, "Rare item", BRC.Emoji.RARE_ITEM, BRC.Config.fm_alert.one_time_alerts)
end

function f_pa_misc.alert_staff(it)
  if not it.is_identified then return false end
  local needRes = false
  local basename = it.name("base")

  if basename == "staff of fire" then
    needRes = you.res_fire() == 0
  elseif basename == "staff of cold" then
    needRes = you.res_cold() == 0
  elseif basename == "staff of air" then
    needRes = you.res_shock() == 0
  elseif basename == "staff of poison" then
    needRes = you.res_poison() == 0
  elseif basename == "staff of death" then
    needRes = you.res_draining() == 0
  end

  if not needRes then return false end
  return f_pickup_alert.do_alert(it, "Staff resistance", BRC.Emoji.STAFF_RESISTANCE, BRC.Config.fm_alert.staff_resists)
end

function f_pa_misc.alert_talisman(it)
  if it.artefact then
    if not it.is_identified then return false end
    return f_pickup_alert.do_alert(it, "Artefact talisman", BRC.Emoji.TALISMAN, BRC.Config.fm_alert.talismans)
  end
  local required_skill = BRC.get.talisman_min_level(it) - BRC.Config.alert.talisman_lvl_diff
  if required_skill > you.skill("Shapeshifting") then return false end
  return f_pickup_alert.do_alert(it, "New talisman", BRC.Emoji.TALISMAN, BRC.Config.fm_alert.talismans)
end

function f_pa_misc.is_unneeded_ring(it)
  if not BRC.is.ring(it) or it.artefact or you.race() == "Octopode" then return false end
  local missing_hand = BRC.get.mut(BRC.MUTATIONS.missing_hand, true)
  local st = it.subtype()
  local found_first = false
  for inv in iter.invent_iterator:new(items.inventory()) do
    if BRC.is.ring(inv) and inv.subtype() == st then
      if found_first or missing_hand then return true end
      found_first = true
    end
  end
  return false
end

function f_pa_misc.pickup_staff(it)
  if not it.is_identified then return false end
  if BRC.get.skill(BRC.get.staff_school(it)) == 0 then return false end
  return not f_pa_data.find(pa_items_picked, it)
end

}
############################### End lua/pickup-alert/pa-misc.lua ###############################
##########################################################################################

################################### Begin lua/pickup-alert/pa-weapons.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
--[[
Feature: pickup-alert-weapons
Description: Weapon pickup logic, caching, and alert system for the pickup-alert system
Author: buehler
Dependencies: core/config.lua, core/data.lua, core/util.lua
--]]

f_pa_weapons = {}
--f_pa_weapons.BRC_FEATURE_NAME = "pickup-alert-weapons"

-- Persistent variables
lowest_num_hands_alerted = BRC.data.persist("lowest_num_hands_alerted", {
  ["Ranged Weapons"] = 3, -- Start with 3 (to fire both 1 and 2-handed alerts)
  ["Polearms"] = 3, -- Start with 3 (to fire both 1 and 2-handed alerts)
}) -- lowest_num_hands_alerted (do not remove this comment)

-- Local constants / configuration
local FIRST_WEAPON_XL_CUTOFF = 4 -- Stop looking for first weapon after this XL
local RANGED_XL_THRESHOLD = 3 -- At this skill level, don't bother alerting for polearms
local RANGED = "range_"
local MELEE = "melee_"

-- Local variables
local top_attack_skill

-- Global variable: Cache weapons in inventory (so we don't recompute DPS, etc on every autopickup call)
_weapon_cache = {}

function _weapon_cache.get_primary_key(it)
  local tokens = {}
  tokens[1] = it.is_ranged and RANGED or MELEE
  tokens[2] = tostring(it.hands)
  if BRC.get.ego(it) then tokens[3] = "b" end
  return table.concat(tokens)
end

-- Get all categories this weapon fits into (both its real category and any more-restrictive categories)
function _weapon_cache.get_keys(is_ranged, hands, is_branded)
  local ranged_types = is_ranged and { RANGED, MELEE } or { MELEE }
  local handed_types = hands == 1 and { "1", "2" } or { "2" }
  local branded_types = is_branded and { "b", "" } or { "" }

  -- Generate all combinations
  local keys = {}
  for _, r in ipairs(ranged_types) do
    for _, h in ipairs(handed_types) do
      for _, b in ipairs(branded_types) do
        keys[#keys + 1] = table.concat({ r, h, b })
      end
    end
  end

  return keys
end

function _weapon_cache.add_weapon(it)
  local weap_data = {}
  weap_data.is_weapon = it.is_weapon
  weap_data.basename = it.name("base")
  weap_data.subtype = it.subtype()
  weap_data.weap_skill = it.weap_skill
  weap_data.skill_lvl = BRC.get.skill(it.weap_skill)
  weap_data.is_ranged = it.is_ranged
  weap_data.hands = BRC.get.hands(it)
  weap_data.artefact = it.artefact
  weap_data._ego = BRC.get.ego(it)
  weap_data.ego = function() return weap_data._ego end
  weap_data.plus = it.plus or 0
  weap_data.acc = it.accuracy + weap_data.plus
  weap_data.damage = it.damage
  weap_data.dps = BRC.get.weap_dps(it)
  weap_data.score = BRC.get.weap_score(it)
  weap_data.unbranded_score = BRC.get.weap_score(it, true)

  -- Track unique egos
  if weap_data._ego and not util.contains(_weapon_cache.egos, weap_data._ego) then
    _weapon_cache.egos[#_weapon_cache.egos + 1] = weap_data._ego
  end

  -- Track max damage for applicable weapon categories
  local keys = _weapon_cache.get_keys(weap_data.is_ranged, weap_data.hands, weap_data._ego ~= nil)

  -- Update the max DPS for each category
  for _, key in ipairs(keys) do
    if weap_data.dps > _weapon_cache.max_dps[key].dps then
      _weapon_cache.max_dps[key].dps = weap_data.dps
      _weapon_cache.max_dps[key].acc = weap_data.acc
    end
  end

  _weapon_cache.weapons[#_weapon_cache.weapons + 1] = weap_data
  return weap_data
end

function _weapon_cache.is_empty()
  return _weapon_cache.max_dps["melee_2"].dps == 0 -- The most restrictive category
end

function _weapon_cache.serialize()
  local tokens = { "\n---INVENTORY WEAPONS---" }
  for _, weap in ipairs(_weapon_cache.weapons) do
    tokens[#tokens + 1] = string.format("\n%s\n", weap.basename)
    for k, v in pairs(weap) do
      if k ~= "basename" then tokens[#tokens + 1] = string.format("  %s: %s\n", k, tostring(v)) end
    end
  end
  return table.concat(tokens)
end

-- Local functions
-- is_weapon_upgrade(it, cur) -> boolean : For pickup; Check if a weapon is an upgrade to one currently in inventory.
-- `cur` comes from _weapon_cache - it has some pre-computed values
local function is_weapon_upgrade(it, cur)
  if it.subtype() == cur.subtype then
    -- Exact weapon type match
    if it.artefact then return true end
    if cur.artefact then return false end
    local it_ego = BRC.get.ego(it)
    if cur.ego and not it_ego then return false end
    if it_ego and it.is_identified and not cur.ego then
      return BRC.get.weap_score(it) / cur.score > BRC.Tuning.weap.pickup.add_ego
    end
    return it_ego == cur.ego and BRC.get.weap_score(it) > cur.score
  elseif it.weap_skill == cur.weap_skill or you.race() == "Gnoll" then
    -- Return false if no clear upgrade possible
    if BRC.get.hands(it) > cur.hands then return false end
    if cur.is_ranged ~= it.is_ranged then return false end
    if BRC.is.polearm(cur) ~= BRC.is.polearm(it) then return false end

    if it.artefact then return true end
    if cur.artefact then return false end

    local min_ratio = it.is_ranged and BRC.Tuning.weap.pickup.same_type_ranged or BRC.Tuning.weap.pickup.same_type_melee
    return BRC.get.weap_score(it) / cur.score > min_ratio
  end

  return false
end

local function need_first_weapon()
  return you.xl() < FIRST_WEAPON_XL_CUTOFF
    and _weapon_cache.is_empty()
    and you.skill("Unarmed Combat") == 0
    and BRC.get.mut(BRC.MUTATIONS.claws, true) == 0
end

-- Local functions: Alerting
local function alert_first_of_skill(it, silent)
  local skill = it.weap_skill
  if not lowest_num_hands_alerted[skill] then return false end

  local hands = BRC.get.hands(it)
  if lowest_num_hands_alerted[skill] > hands then
    -- Some early checks to skip alerts
    if hands == 2 and BRC.you.have_shield() then return false end
    if skill == "Polearms" and you.skill("Ranged Weapons") >= RANGED_XL_THRESHOLD then return false end

    -- Update lowest # hands alerted, and alert
    lowest_num_hands_alerted[skill] = hands
    if silent then return true end
    local msg = string.format("First %s%s", string.sub(skill, 1, -2), hands == 1 and " (1-handed)" or "")
    return f_pickup_alert.do_alert(it, msg, BRC.Emoji.WEAPON, BRC.Config.fm_alert.early_weap)
  end
  return false
end

local function alert_early_weapons(it)
  -- Alert really good usable ranged weapons
  if you.xl() <= BRC.Tuning.weap.alert.early_ranged.xl then
    if it.is_identified and it.is_ranged then
      if
        it.plus >= BRC.Tuning.weap.alert.early_ranged.min_plus and BRC.get.ego(it)
        or it.plus >= BRC.Tuning.weap.alert.early_ranged.branded_min_plus
      then
        local low_shield_training = you.skill("Shields") <= BRC.Tuning.weap.alert.early_ranged.max_shields
        if BRC.get.hands(it) == 1 or not BRC.you.have_shield() or low_shield_training then
          return f_pickup_alert.do_alert(it, "Ranged weapon", BRC.Emoji.RANGED, BRC.Config.fm_alert.early_weap)
        end
      end
    end
  end

  if you.xl() <= BRC.Tuning.weap.alert.early.xl then
    -- Skip items if we're clearly going another route
    local skill_setting = BRC.Tuning.weap.alert.early.skill
    local skill_diff = BRC.get.skill(top_attack_skill) - BRC.get.skill(it.weap_skill)
    if skill_diff > you.xl() * skill_setting.factor + skill_setting.offset then return false end

    if BRC.get.ego(it) or it.plus and it.plus >= BRC.Tuning.weap.alert.early.branded_min_plus then
      return f_pickup_alert.do_alert(it, "Early weapon", BRC.Emoji.WEAPON, BRC.Config.fm_alert.early_weap)
    end
  end

  return false
end

--[[
alert_interesting_weapon() -> boolean : `cur` comes from _weapon_cache - it has some pre-computed values
Check if weapon is worth alerting for, compared against one weapon currently in inventory
--]]
local function alert_interesting_weapon(it, cur)
  if it.artefact and it.is_identified then return f_pickup_alert.do_alert(it, "Artefact weapon", BRC.Emoji.ARTEFACT) end

  local inv_best = _weapon_cache.max_dps[_weapon_cache.get_primary_key(it)]
  local best_dps = math.max(cur.dps, inv_best and inv_best.dps or 0)
  local best_score = math.max(cur.score, inv_best and BRC.get.weap_score(inv_best) or 0)

  if cur.subtype == it.subtype() then
    -- Exact weapon type match; alert new egos or higher DPS/weap_score
    local it_ego = BRC.get.ego(it, true) -- Don't overvalue Speed/Heavy egos (only look at their DPS)
    if not cur.artefact and it_ego and (it_ego ~= cur.ego) then
      return f_pickup_alert.do_alert(it, "Diff ego", BRC.Emoji.EGO, BRC.Config.fm_alert.weap_ego)
    elseif BRC.get.weap_score(it) > best_score or BRC.get.weap_dps(it) > best_dps then
      return f_pickup_alert.do_alert(it, "Weapon upgrade", BRC.Emoji.WEAPON, BRC.Config.fm_alert.upgrade_weap)
    end
    return false
  end

  if cur.is_ranged ~= it.is_ranged then return false end
  if BRC.is.polearm(cur) ~= BRC.is.polearm(it) then return false end
  if 2 * BRC.get.skill(it.weap_skill) < BRC.get.skill(cur.weap_skill) then return false end

  -- Penalize lower-trained skills
  local damp = BRC.Tuning.weap.alert.low_skill_penalty_damping
  local penalty = (BRC.get.skill(it.weap_skill) + damp) / (BRC.get.skill(top_attack_skill) + damp)
  local ratio = penalty * BRC.get.weap_score(it) / best_score

  if BRC.get.hands(it) > cur.hands then
    if BRC.you.free_offhand() or (you.skill("Shields") < BRC.Tuning.weap.alert.add_hand.ignore_sh_lvl) then
      local it_ego = BRC.get.ego(it)
      local unique_ego = it_ego and not util.contains(_weapon_cache.egos, it_ego)
      if unique_ego and ratio > BRC.Tuning.weap.alert.new_ego then
        return f_pickup_alert.do_alert(it, "New ego (2-handed)", BRC.Emoji.EGO, BRC.Config.fm_alert.weap_ego)
      elseif ratio > BRC.Tuning.weap.alert.add_hand.not_using then
        return f_pickup_alert.do_alert(it, "2-handed weapon", BRC.Emoji.TWO_HAND, BRC.Config.fm_alert.upgrade_weap)
      end
    elseif BRC.get.ego(it) and not cur.ego and ratio > BRC.Tuning.weap.alert.add_hand.add_ego_lose_sh then
      local msg = "2-handed weapon (Gain ego)"
      return f_pickup_alert.do_alert(it, msg, BRC.Emoji.TWO_HAND, BRC.Config.fm_alert.weap_ego)
    end
  else -- No extra hand required
    if cur.artefact then return false end
    if BRC.get.ego(it, true) then -- Don't overvalue Speed/Heavy egos (only look at their DPS)
      local it_ego = BRC.get.ego(it)
      if not cur.ego then
        if ratio > BRC.Tuning.weap.alert.gain_ego then
          return f_pickup_alert.do_alert(it, "Gain ego", BRC.Emoji.EGO, BRC.Config.fm_alert.weap_ego)
        end
      elseif not util.contains(_weapon_cache.egos, it_ego) and ratio > BRC.Tuning.weap.alert.new_ego then
        return f_pickup_alert.do_alert(it, "New ego", BRC.Emoji.EGO, BRC.Config.fm_alert.weap_ego)
      end
    end
    if ratio > BRC.Tuning.weap.alert.pure_dps then
      return f_pickup_alert.do_alert(it, "Weapon upgrade", BRC.Emoji.WEAPON, BRC.Config.fm_alert.upgrade_weap)
    end
  end

  return false
end

local function alert_interesting_weapons(it)
  for _, inv in ipairs(_weapon_cache.weapons) do
    if alert_interesting_weapon(it, inv) then return true end
  end
  return false
end

local function alert_weap_high_scores(it)
  local category = f_pa_data.update_high_scores(it)
  if not category then return false end
  return f_pickup_alert.do_alert(it, category, BRC.Emoji.WEAPON, BRC.Config.fm_alert.high_score_weap)
end

-- Public API
function f_pa_weapons.pickup_weapon(it)
  -- Check if we need the first weapon of the game
  if need_first_weapon() then
    -- Staves don't go into _weapon_cache; check if we're carrying just a staff
    for inv in iter.invent_iterator:new(items.inventory()) do
      if inv.is_weapon then return false end -- fastest way to check if it's a staff
    end
    return true
  end

  if BRC.is.risky_ego(BRC.get.ego(it)) then return false end
  if f_pa_data.find(pa_items_picked, it) then return false end
  for _, inv in ipairs(_weapon_cache.weapons) do
    if is_weapon_upgrade(it, inv) then return true end
  end
end

function f_pa_weapons.alert_weapon(it)
  if alert_interesting_weapons(it) then return true end
  if alert_first_of_skill(it) then return true end
  if alert_early_weapons(it) then return true end

  -- Skip high score alerts if not using weapons
  if _weapon_cache.is_empty() then return false end
  return alert_weap_high_scores(it)
end

-- Hook functions
function f_pa_weapons.init()
  _weapon_cache.weapons = {}
  _weapon_cache.egos = {}

  -- Track max DPS by weapon category
  _weapon_cache.max_dps = {}
  local keys = {
    "melee_1",
    "melee_1b",
    "melee_2",
    "melee_2b",
    "range_1",
    "range_1b",
    "range_2",
    "range_2b",
  } -- _weapon_cache.max_dps (do not remove this comment)
  for _, key in ipairs(keys) do
    _weapon_cache.max_dps[key] = { dps = 0, acc = 0 }
  end

  -- Set top weapon skill
  top_attack_skill = "Unarmed Combat"
  local max_weap_skill = BRC.get.skill(top_attack_skill)
  for _, v in ipairs(BRC.ALL_WEAP_SCHOOLS) do
    if BRC.get.skill(v) > max_weap_skill then
      max_weap_skill = BRC.get.skill(v)
      top_attack_skill = v
    end
  end
end

function f_pa_weapons.ready()
  f_pa_weapons:init()
  for inv in iter.invent_iterator:new(items.inventory()) do
    if inv.is_weapon and not BRC.is.magic_staff(inv) then
      _weapon_cache.add_weapon(inv)
      f_pa_data.update_high_scores(inv)
    end
  end
end

}
############################### End lua/pickup-alert/pa-weapons.lua ###############################
##########################################################################################

## (Resuming init.txt) ##


############## Lua Hook Functions ##############
{
-- Hook functions that delegate to BRC
function ready()
    if BRC and BRC.ready then BRC.ready() end
end

function c_message(text, channel)
    if BRC and BRC.c_message then BRC.c_message(text, channel) end
end

function c_answer_prompt(prompt)
    if BRC and BRC.c_answer_prompt then return BRC.c_answer_prompt(prompt) end
end

function c_assign_invletter(it)
  if BRC and BRC.c_assign_invletter then return BRC.c_assign_invletter(it) end
end


-- This is the only line of top-level code, aside from declaring variables (without values)
-- Done to give confidence in simple re-inits
if BRC and BRC.init then BRC.init() end
}
