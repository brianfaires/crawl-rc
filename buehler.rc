## Config at top

################################### Begin lua/config.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
if loaded_lua_config_file then return end
loaded_lua_config_file = true
CONFIG = { }

-- Use emojis in alerts and damage announcements
CONFIG.emojis = true

-- Announce HP/MP when change is greater than this value
CONFIG.ANNOUNCE_HP_THRESHOLD = 1
CONFIG.ANNOUNCE_MP_THRESHOLD = 0
-- Force more prompt for losing this percentage of max HP
CONFIG.ANNOUNCE_HP_MASSIVE_THRESHOLD = 0.20

-- Inscribe stats
CONFIG.inscribe_weapons = true
CONFIG.inscribe_armour = true

-- Runrest features
CONFIG.ignore_altars = true
CONFIG.ignore_portal_exits = true
CONFIG.ignore_gauntlet_msgs = true
CONFIG.stop_on_pan_gates = true
CONFIG.search_altars_in_temple = true

-- Misc alerts
CONFIG.warn_v5 = true
CONFIG.warn_stairs_threshold = 5 -- Warn if taking stairs back within # turns; 0 to disable
CONFIG.alert_remove_faith = true
CONFIG.alert_low_hp_threshold = 0.5 -- % max HP to alert; 0 to disable
CONFIG.save_with_msg = true
CONFIG.stop_on_scrolls_count = 2 -- Before finding ID, stop when you have this many un-ID'd scrolls
CONFIG.stop_on_pots_count = 3 -- Before finding ID, stop when you have this many un-ID'd potions

---- Pickup/Alert system
CONFIG.pickup_armour = true
CONFIG.pickup_weapons = true
CONFIG.pickup_staves = true

CONFIG.alert_system_enabled = true
CONFIG.alert_armour = true
CONFIG.alert_weapons = true
CONFIG.alert_orbs = true
CONFIG.alert_talismans = true
CONFIG.alert_staff_resists = true
CONFIG.alert_one_time_items = true
CONFIG.one_time_alerts = {
  "broad axe", "executioner's axe", "eveningstar", "demon whip",
  "sacred scourge", "lajatang", "bardiche", "demon trident", "trishula",
  "quick blade", "demon blade", "double sword", "triple sword", "eudemon blade",
  "crystal plate armour", "gold dragon scales", "pearl dragon scales",
  "storm dragon scales", "shadow dragon scales", "wand of digging",
  "triple crossbow", "hand cannon", "buckler", "kite shield", "tower shield"
} -- one_time_alerts (do not remove this comment)

-- Startup
CONFIG.show_skills_on_startup = true
CONFIG.auto_set_skill_targets = {
  {"Stealth", 2},
  {"Fighting", 2}
} -- auto_set_skill_targets (do not remove this comment)

-- Debugging
CONFIG.debug_pa_array_freq = 1000 -- 0 to disable

}
############################### End lua/config.lua ###############################
##########################################################################################

## (Resuming init.txt) ##

####### Main options #######
easy_confirm = all
show_more = false
small_more = true
mouse_input = false
default_manual_training = true
drop_disables_autopickup = true
autofight_caught = true
rest_wait_both = true
rest_wait_ancestor = true

autofight_stop = 66
hp_warning = 20
item_stack_summary_minimum = 8
fail_severity_to_confirm = 4

sort_menus = true:equipped,art,ego,glowing,identified,basename,qualname,>qty
drop_filter += useless_item, forbidden
fire_order = silver javelin, javelin, silver boomerang, boomerang, curare-tipped dart, poisoned dart, stone


####### Explore options #######
explore_delay = -1
travel_delay = -1
rest_delay = -1
view_delay = 80
show_travel_trail = true

explore_greedy_visit = artefacts,glowing_items,stacks
explore_stop = artefacts,altars,branches,portals,runed_doors,greedy_pickup_smart
explore_stop_pickup_ignore += scroll, potion, wand, stone, dart, boomerang, javelin




####### Includes #######
### Shared files; do not disable

################################### Begin lua/constants.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
-- Lists of things that may need to be updated as crawl changes
if loaded_lua_constants_file then return end
local loaded_lua_constants_file = true

all_undead_races = {
  "Demonspawn", "Mummy", "Poltergeist", "Revenant",
} -- all_undead_races (do not remove this comment)

all_missiles = {
  " stone", "poisoned dart", "atropa", "curare", "datura",
  "boomerang", "javelin", "large rock", "throwing net",
} -- all_missiles (do not remove this comment)

all_misc = {
  "box of beasts", "condenser vane", "figurine of a ziggurat",
  "Gell's gravitambourine", "horn of Geryon", "lightning rod",
  "phantom mirror", "phial of floods", "sack of spiders", "tin of tremorstones",
} -- all_misc (do not remove this comment)

staff_schools = {
  fire = "Fire Magic", cold = "Ice Magic", earth = "Earth Magic", air = "Air Magic",
  poison = "Poison Magic", death = "Necromancy", conjuration = "Conjurations",
} -- staff_schools (do not remove this comment)

gods_with_allies = {
  "Beogh", "Hepliaklqana", "Jiyva", "Yredelemnul",
} -- gods_with_allies (do not remove this comment)

all_weap_schools = {
  "axes", "maces & flails", "polearms", "long blades",
  "short blades", "staves", "unarmed combat", "ranged weapons",
} -- all_weap_schools (do not remove this comment)

all_portal_names = {
  "Bailey", "Bazaar", "Desolation", "Gauntlet", "Ice Cave",
  "Ossuary", "Sewer", "Trove", "Volcano", "Wizlab", "Ziggurat",
} -- all_portal_names (do not remove this comment)

all_training_skills = {
  "Air Magic", "Alchemy", "Armour", "Axes", "Conjurations", "Dodging",
  "Earth Magic", "Evocations", "Fighting", "Fire Magic", "Forgecraft", "Hexes",
  "Ice Magic", "Invocations", "Long Blades", "Maces & Flails", "Necromancy",
  "Polearms", "Ranged Weapons", "Shapeshifting", "Shields", "Short Blades", "Spellcasting",
  "Staves", "Stealth", "Summonings", "Translocations", "Unarmed Combat", "Throwing",
} -- all_training_skills (do not remove this comment)

-- Color map to single digit tags (less text than explicit)
-- 0:black, 1:blue, 2:green, 3:cyan, 4:red, 5:magenta, 6:brown,
-- 7:lightgrey, 8:darkgrey, 9:lightblue, 10:lightgreen, 11:lightcyan,
-- 12:lightred, 13:lightmagenta, 14:yellow, 15:white
COLORS = {
  blue = 1, green = 2, cyan = 3, red = 4, magenta = 5,
  brown = 6, lightgrey = 7, darkgrey = 8, lightblue = 9,
  lightgreen = 10, lightcyan = 11, lightred = 12,
  lightmagenta = 13, yellow = 14, white = "w",
  black = 0,
} -- COLORS (do not remove this comment)

SIZE_PENALTY = { LITTLE = -2, SMALL = -1, NORMAL = 0, LARGE = 1, GIANT = 2 }

}
############################### End lua/constants.lua ###############################
##########################################################################################

################################### Begin lua/util.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
if loaded_util_lua then return end
local loaded_util_lua = true

---- Text Formatting ----
function colorize_itext(color, str)
  return string.format("<%s>%s</%s>", color, str, color)
end

-- Removes tags from text, and optionally escapes special characters --
function cleanup_text(text, escape_chars)
  local SPECIAL_CHARS = "([%^%$%(%)%%%.%[%]%*%+%-%?])"
  -- Fast path: if no tags, just handle newlines and escaping
  if not text:find("<") then
      if not escape_chars then
          return text:gsub("\n", "")
      end
      return text:gsub("\n", ""):gsub(SPECIAL_CHARS, "%%%1")
  end
  
  -- Use a table to build the result instead of string concatenation
  local result = {}
  local pos = 1
  local len = #text
  
  while pos <= len do
      local tag_start = text:find("<", pos)
      if not tag_start then
          -- No more tags, append remaining text
          result[#result + 1] = text:sub(pos)
          break
      end
      
      -- Append text before tag
      if tag_start > pos then
          result[#result + 1] = text:sub(pos, tag_start - 1)
      end
      
      -- Find end of tag
      local tag_end = text:find(">", tag_start)
      if not tag_end then
          -- Malformed tag, append remaining text
          result[#result + 1] = text:sub(pos)
          break
      end
      
      pos = tag_end + 1
  end
  
  -- Join all parts and handle newlines
  local cleaned = table.concat(result):gsub("\n", "")
  
  -- Handle escaping if needed
  if escape_chars then
      return cleaned:gsub("([%^%$%(%)%%%.%[%]%*%+%-%?])", "%%%1")
  end
  
  return cleaned
end

--- Key codes & modifiers ---
KEYS = { LF = string.char(10), CR = string.char(13) }
function control_key(c)
  return string.char(string.byte(c) - string.byte('a') + 1)
end

--- Code readability ---
function if_el(cond, a, b)
  if cond then
    return a
  else
    return b
  end
end

--- Helper ---
function you_have_allies()
  return you.skill("Summonings") + you.skill("Necromancy") > 0 or
      util.contains(gods_with_allies, CACHE.god)
end

function is_body_armour(it)
  return it and it.subtype() == "body"
end

function is_armour(it)
  return it and it.class(true) == "armour"
end

function is_shield(it)
  return it and it.class(true) == "armour" and it.subtype() == "offhand"
end

function is_weapon(it)
  return it and (it.delay ~= nil)
end

function is_staff(it)
  return it and it.class(true) == "magical staff"
end

function is_ring(it)
  return it and it.name("base") == "ring"
end

function is_amulet(it)
  return it and it.name("base") == "amulet"
end

function is_orb(it)
  -- return it and it.name("base"):find("orb of ") -- TODO: check which is more efficient
  return it and it.subtype() == "offhand" and it.class(true) ~= "armour"
end

function is_talisman(it)
  return it and it.name("base"):find("talisman")
end

function get_mut(mutation, include_temp)
  return you.get_base_mutation_level(mutation, include_temp)
end

function have_shield()
  return items.equipped_at("shield") ~= nil
end

function get_body_armour()
  return items.equipped_at("armour")
end

-- Data persistence --
local persist_data_type_handlers = {
    str = function(name)
        return name.." = \"".._G[name].."\""..KEYS.LF
    end,
    
    int = function(name)
        return name.." = ".._G[name]..KEYS.LF
    end,
    
    bool = function(name)
        return name.." = "..if_el(_G[name], "true", "false")..KEYS.LF
    end,
    
    list = function(name)
        local cmd_init = name.." = {"
        local cmd = cmd_init
        for _,v in ipairs(_G[name]) do
            if cmd ~= cmd_init then cmd = cmd..", " end
            cmd = cmd.."\""..v.."\""
        end
        return cmd.."}"..KEYS.LF
    end,
    
    dict = function(name)
        local cmd_init = name.." = {"
        local cmd = cmd_init
        for k,v in pairs(_G[name]) do
            if cmd ~= cmd_init then cmd = cmd..", " end
            cmd = cmd..k.."=\""..v.."\""
        end
        return cmd.."}"..KEYS.LF
    end
} -- data_persist_type_handlers (do not remove this comment)

local function get_var_type(value)
    if type(value) == "string" then return "str"
    elseif type(value) == "number" then return "int"
    elseif type(value) == "boolean" then return "bool"
    elseif type(value) == "table" then
        if #value > 0 then return "list"
        else return "dict"
        end
    end
    crawl.mpr("Unsupported type: " .. type(value))
end

-- Creates a persistent global variable, initialized to the default value
-- Once initialized, the variable is persisted across saves without re-init
function create_persistent_data(name, default_value)
    if _G[name] == nil then
        _G[name] = default_value
    end
    
    table.insert(chk_lua_save,
        function()
            local type = get_var_type(_G[name])
            if not persist_data_type_handlers[type] then
                crawl.mpr("Unknown persistence type: " .. type)
                return
            end
            return persist_data_type_handlers[type](name)
        end)
end

}
############################### End lua/util.lua ###############################
##########################################################################################

################################### Begin lua/cache.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
-- Cache of commonly pulled values, for increased performance
if loaded_cache then return end
loaded_cache = true

CACHE = {}

-- Once per game
CACHE.class = you.class()
CACHE.race = you.race()
if CACHE.race == "Spriggan" then CACHE.size_penalty = SIZE_PENALTY.LITTLE
elseif CACHE.race == "Kobold" then CACHE.size_penalty = SIZE_PENALTY.SMALL
elseif CACHE.race == "Armataur" or CACHE.race == "Naga" or
    CACHE.race == "Oni" or CACHE.race == "Troll" then CACHE.size_penalty = SIZE_PENALTY.LARGE
else CACHE.size_penalty = SIZE_PENALTY.NORMAL
end
CACHE.undead =  util.contains(all_undead_races, CACHE.race)
CACHE.poison_immune = you.res_poison() >= 3

CACHE.EMOJI = {}
if CONFIG.emojis then
  CACHE.EMOJI.HP_MAX = "ðŸ˜Ž"
  CACHE.EMOJI.HP_HIGH = "ðŸ˜•"
  CACHE.EMOJI.HP_MID = "ðŸ˜®"
  CACHE.EMOJI.HP_LOW = "ðŸ˜¨"
  CACHE.EMOJI.HP_CRIT = "ðŸ˜±"

  CACHE.EMOJI.RARE_ITEM = "ðŸ’Ž"
  CACHE.EMOJI.ORB = "ðŸ”®"
  CACHE.EMOJI.TALISMAN = "ðŸ§¬"
  CACHE.EMOJI.BODY_ARMOUR = "ðŸ›¡ï¸"
  CACHE.EMOJI.ARMOUR = "ðŸ›¡ï¸"

  CACHE.EMOJI.WEAPON = "âš”ï¸"
  CACHE.EMOJI.RANGED = "ðŸ¹"
  CACHE.EMOJI.TWO_HANDED = "ðŸ™Œ"
  CACHE.EMOJI.HAT = "ðŸ§¢"
  CACHE.EMOJI.GLOVES = "ðŸ§¤"
  CACHE.EMOJI.BOOTS = "ðŸ¥¾"
  CACHE.EMOJI.STAFF_RESISTANCE = "ðŸ³ï¸â€ðŸŒˆ"

  CACHE.EMOJI.ACCURACY = "ðŸŽ¯"
  CACHE.EMOJI.STRONGER = "ðŸ’ª"
  CACHE.EMOJI.STRONGEST = "ðŸ’ªðŸ’ª"
  CACHE.EMOJI.EGO = "ðŸ§ª"
  CACHE.EMOJI.LIGHTER = "â¬"
  CACHE.EMOJI.HEAVIER = "â«"
  CACHE.EMOJI.ARTEFACT = "ðŸ’ "

  CACHE.EMOJI.REMIND_IDENTIFY = "ðŸŽ"
  CACHE.EMOJI.EXCLAMATION = "â€¼ï¸"

  -- "ðŸ†•" "ðŸ’Ž"
else
  -- Define non-emoji fallbacks
  CACHE.EMOJI.HP_MAX = ":D"
  CACHE.EMOJI.HP_HIGH = ":|"
  CACHE.EMOJI.HP_MID = ":/"
  CACHE.EMOJI.HP_LOW = ":o"
  CACHE.EMOJI.HP_CRIT = "âŠ™â–‚âŠ™"

  CACHE.EMOJI.REMIND_IDENTIFY = "----"
  CACHE.EMOJI.EXCLAMATION = "!!"
end

-- Once per turn
function ready_CACHE()
  CACHE.turn = you.turns()
  CACHE.str = you.strength()
  CACHE.dex = you.dexterity()
  CACHE.int = you.intelligence()
  CACHE.will = you.willpower()
  
  CACHE.hp, CACHE.mhp = you.hp()
  CACHE.mp, CACHE.mmp = you.mp()

  CACHE.god = you.god()
  CACHE.xl = you.xl()

  CACHE.s_armour = you.skill("Armour")
  CACHE.s_shields = you.skill("Shields")
  CACHE.s_dodging = you.skill("Dodging")
  CACHE.s_fighting = you.skill("Fighting")
  CACHE.s_spellcasting = you.skill("Spellcasting")

  CACHE.rMut = you.res_mutation()
  CACHE.rPois = you.res_poison()
  CACHE.rElec = you.res_shock()
  CACHE.rCorr = you.res_corr()
  CACHE.rF = you.res_fire()
  CACHE.rC = you.res_cold()
  CACHE.rN = you.res_draining()

end

}
############################### End lua/cache.lua ###############################
##########################################################################################

## (Resuming init.txt) ##

### Mostly normal RC options ###

################################### Begin rc/autoinscribe.rc ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
ai := autoinscribe

# Armour
ai += fire dragon scale:rF++, rC-
ai += gold dragon scale:rC+, rF+, rPois
ai += ice dragon scale:rC++, rF-
ai += pearl dragon scale:rN+
ai += storm dragon scale:rElec
ai += swamp dragon scale:rPois
ai += quicksilver dragon scale:MR+
ai += shadow dragon scale:Stlth+

# Amulets
ai += amulet of faith:Faith, !P

# Rings
ai += ring of fire:rF+, rC-
ai += ring of flight:+Fly
ai += ring of ice:rC+, rF-
ai += ring of resist corrosion:rCorr
ai += ring of poison resistance:rPois
ai += ring of magical power:MP+9
ai += ring of positive energy:rN+
ai += ring of protection from cold:rC+
ai += ring of protection from fire:rF+
ai += ring of protection from magic:MR+
ai += ring of see invisible:sInv
ai += ring of stealth:Stlth+
ai += ring of teleportation:*tele
ai += ring of wizardry:wiz+

# Staves
ai += staff of air:rElec
ai += staff of cold:rC+
ai += staff of death:rN+
ai += staff of fire:rF+
ai += staff of poison:rPois


{
  -- Protective consumable inscriptions on everything w/o a built-in prompt
  -- Updates every turn to:
    -- Inscribe starting items
    -- Update inscriptions after ID
  
  local no_inscription_needed = {
    "acquirement", "amnesia", "blinking", "brand weapon", "enchant armour", "enchant weapon",
    "identify", "immolation", "noise", "vulnerability", "attraction", "lignification", "mutation"}

  ------------------- Hook -------------------
  function ready_safe_consumables()
    -- Remove the default "!r" and "!q" inscriptions after identify
    for inv in iter.invent_iterator:new(items.inventory()) do
      local inv_class = inv.class(true)
      if inv_class == "potion" or inv_class == "scroll" then
        local st, _ = inv.subtype()
        if (st == "poison" and you.res_poison() > 0)
          or (st == "torment" and you.torment_immune())
          or util.contains(no_inscription_needed, st) then
            if inv.inscription:find("%!r") then inv.inscribe(inv.inscription:gsub("%!r", ""), false) end
            if inv.inscription:find("%!q") then inv.inscribe(inv.inscription:gsub("%!q", ""), false) end
        elseif inv_class == "scroll" and not inv.inscription:find("!r") then
            inv.inscribe("!r")
        elseif inv_class == "potion" and not inv.inscription:find("!q") then
            inv.inscribe("!q")
        end
      end
    end
  end
}

############################### End rc/autoinscribe.rc ###############################
##########################################################################################

################################### Begin rc/autopickup.rc ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
####### Autopickup exceptions #######
ae := autopickup_exceptions
ae ^= <potions? of attraction, <potions? of lignification, <potions? of mutation
ae ^= <scrolls? of immolation, <scrolls? of poison
ae ^= >useless_item, <misc
ae ^= >staff of.*

# Exclude the 3rd copy of any ring
{
  add_autopickup_func(function (it, name)
    if it.class(true) ~= "jewellery" or it.artefact or CACHE.race == "Octopode" then return end
    local st = it.subtype()
    local found_first = false
    for inv in iter.invent_iterator:new(items.inventory()) do
      if inv.class(true) == "jewellery" and inv.subtype() == st then
        if found_first then return false end
        found_first = true
      end
    end
  end)
}

############################### End rc/autopickup.rc ###############################
##########################################################################################

################################### Begin rc/display.rc ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
## Mutes are at end of file, so they override the rest

stat_colour = 3:red, 7:lightred

hp_colour = 100:green, 99:lightgrey, 75:yellow, 50:lightred, 25:red
mp_colour = 100:green, 99:lightgrey, 75:yellow, 50:lightred, 25:red

tile_font_crt_family  = Lucida Console
tile_font_stat_family = Lucida Console
tile_font_msg_family  = Lucida Console
tile_font_lbl_family  = Lucida Console


####### Menu Colors #######
# Set Alias & clear defaults
menu := menu_colour
menu =

# Variables
$decent := white
$mp := lightcyan
$interface := cyan
$danger := lightred
$item_dmg := red
$warning := yellow
$boring := darkgrey
$negative := brown
$positive := green
$good := lightblue
$verypositive := lightgreen
$awesome := lightmagenta

# General
menu += $boring:(melded)
menu += $boring:.*useless_item.*
menu += $item_dmg:.*evil_item.*
menu += inventory:$interface:.*equipped.*
#menu += $decent:.*artefact.*

menu += $warning:^unidentified .*(jewellery|potion|scroll|wand).*
menu += $good:^unidentified .*weapon.*(runed|glowing)
menu += $good:^unidentified .*armour.*(runed|glowing|embroidered|shiny|dyed)

# Staves
menu += $positive:[^r]staff of

# Wands
menu += $decent:wand of (flame|paralysis|polymorph|disintegration|enslavement|iceblast)
menu += $good:wand of (acid|digging|clouds|scattershot)

# Scrolls
menu += $danger:scrolls? of torment
menu += $boring:scrolls? of noise
menu += $decent:scrolls? of (amnesia|identify|immolation)
menu += $good:scrolls? of (fear|fog|silence|summoning|vulnerability)
menu += $positive:scrolls? of (brand|enchant|revelation)
menu += $verypositive:scrolls? of (blinking|teleportation|butterflies)
menu += $awesome:scrolls? of (acquirement)

# Potions
menu += $danger:potions? of berserk
menu += magenta:potions? of mutation
menu += $decent:potions? of (enlightenment|lignification|ambrosia)
menu += $good:potions? of (stabbing|brilliance|cancellation|invisibility|might|resistance)
menu += $positive:potions? of curing
menu += $mp:potions? of magic
menu += $verypositive:potions? of (haste|heal wounds)
menu += $awesome:potions? of experience

# Amulets
menu += $good:amulet of (guardian spirit|the acrobat)
menu += $positive:amulet of (faith|reflection|magic regeneration|regeneration)

# Rings
menu += $warning:ring of (fire|ice)
menu += $decent:ring of flight
menu += $verypositive:ring of (.*slaying)
menu += $positive:ring of (poison resistance|protection from cold|protection from fire|protection from magic|see invisible|resist corrosion)
menu += $good:ring of (.*evasion|.*protection|magical power|wizardry)

# Misc items
menu += blue:inert
menu += $good:throwing net
menu += $good:artefact

# Deck colouring
menu += $verypositive:deck of escape
menu += $positive:deck of summoning
menu += $danger:deck of destruction


######## Message coloring ########
# black, blue, green, cyan, red, magenta, brown, lightgrey,
# darkgrey, lightblue, lightgreen, lightcyan, lightred,
# lightmagenta, yellow, white

# Standard colours to be used for message highlighting
$danger   := lightred
$item_dmg := red
$warning  := yellow
$boring   := darkgrey
$negative := brown
$good     := lightblue
$positive := green
$verypositive := lightgreen
$awesome := lightmagenta
$interface := cyan
$takesaction := blue
$godaction := magenta
$mp := lightcyan

# Set Alias & clear defaults
msc := message_colour
msc =

msc += $mp:You feel your power returning

msc += $danger:roused to righteous anger
msc += $danger:is roused by the hymn
msc += $danger:A magical barricade bars your way
msc += $danger:is repulsed
msc += $danger:seems less drained
msc += $danger:preventing you from leaping
msc += $danger:shrugs off the wave
msc += $danger:Your unholy channel expires
msc += $danger:Being near the torpor snail leaves you feeling lethargic
msc += $danger:The amulet engulfs you in a massive magical discharge
msc ^= $danger:Your.*appears confused
msc ^= $danger:You open a gate to Pandemonium
msc += $danger:Some icy apparitions appear
msc += $danger:You feel less empathic
msc ^= $danger:Qazlal is no longer ready to protect you from an element
msc ^= $danger:Your divine halo fades away
msc ^= $danger:Your divine shield disappears
msc ^= $danger:The orb of electricity explodes
msc ^= $danger:Your divine shield fades away
msc += $danger:visions of slaying
msc += $danger:You.*no longer.*bleed smoke
msc += $danger:Your shadow no longer tangibly mimics your actions
msc += $danger:You are even more entangled
msc += $danger:You have drawn Pain
msc += $danger:Your magical shield disappears
msc ^= $danger:Your.*appears confused
msc += $danger:creates some ice likenesses
msc += $danger:soul is no longer ripe for the taking
msc += $danger:You are no longer magically infusing your attacks
msc += $danger:The ambient light returns to normal
msc += $danger:An iron grate slams shut
msc += $danger:begins to accept
msc += $danger:begins to recite a word of recall
msc += $danger:begins to radiate toxic energy
msc += $danger:The shadow imp is revulsed by your support of nature
msc += $danger:Careful! You are starting to lose your buoyancy
msc ^= $danger:plants?.*suddenly grows? acid sacs
msc ^= $danger:Your.*is devoured by a tear in reality
msc += $danger:Your body is bloodless
msc += $danger:Your unliving flesh cannot be transformed in this way
msc += $danger:You can't disarm
msc += $danger:You feel strangely static
msc += $danger:A powerful magic interferes with your control of the blink
msc += $danger:burns.*terribly
msc += $danger:You are no longer teleporting projectiles to their destination
msc += $danger:Water floods your area
msc += $danger:You feel the presence of a powerless spirit
msc += $danger:You feel less (resistant|protected)
msc += $danger:You hear a crashing sound
msc += $danger:The tree smolders and burns
msc += $danger:You are contaminated with residual magics
msc += $danger:is duplicated
msc += $danger:You sense a malign presence
msc += $danger:The deck only has
msc += $danger:blocks your orb of destruction
msc += $danger:There are no remains here to animate
msc += $danger:Your ring of flames gutters out
msc += $danger:The elephant guardians awaken
msc += $danger:slides away
msc += $danger:moves from beneath you
msc += $danger:A powerful magic prevents control of your teleportation
msc += $danger:There's only.*cards? left!
msc += $danger:A huge vortex of air appears
msc += $danger:you're silenced
msc += $danger:Your hands slow down
msc += $danger:Your shroud falls apart
msc += $danger:Not with that terrain in the way
msc += $danger:Your teleport is interrupted
msc += $danger:Your.*revert to.*normal proportions
msc += $danger:Its appearance distorts for a moment
msc += $danger:A shaft opens up in the floor
msc += $danger:You are held in a net
msc += $danger:(The|Your).*falls away!
msc += $danger:The orbs collide in a blinding explosion
msc += $danger:You feel the power of the Abyss delaying your translocation
msc += $danger:Mara shimmers
msc += $danger:Your.*is blown up
msc += $danger:seems to grow more fierce
msc += $danger:attacks!
msc += $danger:You sense the presence of something unfriendly
msc += $danger:Your.*falls into the water
msc += $danger:Something unseen opens the huge gate
msc += $danger:changes into something you cannot see
msc += $danger:The rod doesn't have enough magic points
msc += $danger:The power of the Abyss keeps you in your place
msc += $danger:Your.*is destroyed
msc += $danger:You feel your control is inadequate
msc += $danger:A great vortex of raging winds appears
msc += $danger:You blow up your
msc += $danger:The sixfirhy seems to be charged up
msc += $danger:You feel your power drain away
msc += $danger:You cannot cast spells when silenced
msc += $danger:You feel hot and cold all over
msc += $danger:You don't have the energy to cast that spell
msc += $danger:and don't expect to remain undetected
msc += $danger:but the box appears empty
msc += $danger:your gold pieces vanish
msc += $danger:Your.*dies
msc += $danger:You cannot teleport right now
msc += $danger:You feel your power drawn to a protective spirit
msc += $danger:your magic stops regenerating
msc += $danger:Some monsters swap places
msc += $danger:You turn into a spiny porcupine
msc += $danger:Your limbs have turned to stone
msc += $danger:Your skin feels tender
msc += $danger:You turn into a fleshy mushroom
msc += $danger:The sound of falling rocks suddenly begins to subside
msc += $danger:The walls and floor vibrate strangely for a moment
msc += $danger:Your.*(armour|shield) melts away
msc += $danger:drains you
msc += $danger:feel drained
msc += $danger:strangely unstable
msc += $danger:curare-tipped.*hits you
msc += $danger:Space warps.* around you
msc += $danger:Space bends around you
msc += $danger:Space bends sharply around you!
msc += $danger:sense of stasis
msc += $danger:clumsily bash
msc += $danger:goes berserk
msc += $danger:Forgetting.* will destroy the book
msc += $danger:The blast of calcifying dust hits you
msc += $danger:You are engulfed in calcifying dust
msc += $danger:^It .* you
msc += $danger:[^f]Something.*you[^r]
msc += $danger:grabs you[^r]
msc += $danger:you convulse
msc += $danger:is unaffected
msc += $danger:blinks into view
msc += $danger:seems to speed up
msc += $danger:You feel yourself slow down
msc += $danger:The alarm trap emits a blaring wail
msc += $danger:The mark upon you grows brighter.
msc += $danger:flickers (and vanishes|out of sight)
msc += $danger:Terrible wounds (open|spread)
msc += $danger:The acid burns
msc += $danger:The.*is recalled
msc += $danger:The.*blows on a signal horn!
msc += $danger:You miscast
msc += $danger:zaps a wand
msc += $danger:You are no longer berserk
msc += $danger:You suddenly lose the ability to move
msc += $danger:Your.*glows black for a moment
msc += $danger:You are caught in a web
msc += $danger:You are knocked back by the lance of force
msc += $danger:You are knocked back by the blast of cold
msc += $danger:You are knocked back by the great wave of water
msc += $danger:You feel very sick
msc += $danger:Your.*falls away
msc += $danger:splits in two
msc += $danger:assumes the form|sacrifices itself
msc += $danger:Necromantic energies
msc += $danger:You feel an extremely numb sensation
msc += $danger:You feel jittery
msc += $danger:You are caught in (a|the) (net|web)
msc += $danger:You become entangled in (a|the) (net|web)
msc += $danger:You fall asleep
msc += $danger:The forest starts to sway and rumble
msc += $danger:Vines fly forth from the trees!
msc += $danger:Roots grasp at your
msc += $danger:Roots rise up from beneath you and drag you back to the ground
msc += $danger:The.*picks up a wand
msc += $danger:You struggle against (a|the) (net|web)
msc += $danger:You struggle to escape the net
msc += $danger:The.*engulfs you in water
msc += $danger:Your magical defenses are stripped away
msc += $danger:appears out of thin air
msc += $danger:You feel less protected from missiles
msc += $danger:The power of Zot is invoked against
msc += $danger:you fail to dodge
msc += $danger:Death has come for you
msc += $danger:Your body is wracked with pain
msc += $danger:You sense an overwhelmingly malignant aura
msc += $danger:Space twists in upon itself
msc += $danger:Strange energies course through your body
msc += $danger:You feel haunted
msc += $danger:Your.*suddenly stops moving
msc += $danger:You feel incredibly sick
msc += $danger:You don't have enough magic
msc += $danger:You haven't enough magic at the moment
msc += $danger:You fall through a shaft
msc += $danger:You fall into a shaft
msc += $danger:seems to grow stronger
msc += $danger:Dowan seems to find hidden reserves of power
msc += $danger:You struggle to resist
msc += $danger:You barely resist
msc += $danger:You turn into an animated tree
msc += $danger:Your roots penetrate the ground
msc += $danger:is no longer charmed
msc += $danger:You try to slip out of the net
msc += $danger:You become entangled in the net
msc += $danger:You feel a build-up of mutagenic energy
msc += $danger:You cannot pacify this monster
msc += $danger:You feel a (horrible|terrible) chill
msc += $danger:You are burned terribly
msc += $danger:moth of wrath (goads|infuriates) the
msc += $danger:you trip and fall back down the stairs
msc += $danger:the glow from your corona prevents you from becoming completely invisible
msc += $danger:A red film seems to cover your vision as you go berserk
msc += $danger:Your limbs are stiffening
msc += $danger:You have turned to stone
msc += $danger:Draining that being is not a good idea
msc += $danger:You feel.*ill
msc += $danger:You can't gag anything down
msc += $danger:Something feeds on your intellect
msc += $danger:The barbed spikes become lodged in your body
msc += $danger:You feel your translocation being delayed
msc += $danger:You fail to use your ability
msc += $danger:Oh no! You have blundered into a Zot trap
msc += $danger:Wisps of shadow swirl around
msc += $danger:The.*grows two more
msc += $danger:There is a sealed passage
msc += $danger:doors? slams? shut
msc += $danger:A basket of spiders falls from above
msc += $danger:is bolstered by the flame
msc ^= $danger:Mennas' surroundings become eerily quiet
msc += $danger:attempts to bespell you
msc += $danger:You feel horribly lethargic
msc += $danger:firmly anchored in space
msc += $danger:You stop (a|de)scending the stairs
msc += $danger:You tear a large gash into the net
msc += $danger:reflects
msc += $danger:The walls disappear
msc += $danger:You cannot afford.*fee
msc += $danger:This weapon is already enchanted
msc += $danger:You feel.*sluggish
msc += $danger:You no longer adapt resistances upon receiving elemental damage
msc += $danger:The storm surrounding you is now too weak to repel missiles
msc += $danger:You feel extremely strange
msc += $danger:You feel rather ponderous
msc += $danger:That seemed strangely inert
msc += $danger:You can't unwield your weapon to draw a new one
msc += $danger:the volcano erupts with a roar
msc += $danger:Your guardian golem overheats
msc += $danger:burn any scroll you tried to read
msc += $danger:You are blown backwards
msc += $danger:It is caustic
msc += $danger:Not only inedible but also greatly harmful
msc += $danger:evokes.*(amulet|ring)
msc += $danger:take too long for a potion to reach your roots
msc += $danger:There was something very wrong with that liquid
msc += $danger:You cannot move
msc += $danger:stands defiantly in death's doorway
msc += $danger:twongs alarmingly
msc += $danger:You( suddenly)? feel( more| all small and)? vulnerable
msc += $danger:The poison in your body grows stronger
msc += $danger:You are being crushed by all of your possessions
msc += $danger:You are carrying too much
msc += $danger:You draw Wild Magic
msc += $danger:You draw the Helix
msc += $danger:This potion can/'t work under stasis
msc += $danger:Your icy (armour|shield) evaporates
msc += $danger:You struggle to detach yourself from the web
msc += $danger:You are more confused
msc += $danger:You are confused
msc += $danger:breaks free
msc += $danger:(You are|You're) too confused
msc += $danger:Your skin stops crawling
msc += $danger:Your attempt to break free
msc += $danger:Your resistance to elements expires
msc += $danger:You are blasted by holy energy
msc += $danger:You feel uncertain
msc += $danger:You are firmly grounded in the material plane once more
msc += $danger:The writing blurs in front of your eyes
msc += $danger:You cannot cast spells while unable to breathe
msc += $danger:You feel your rage building
msc += $danger:You feel a little less
msc += $danger:This card doesn't seem to belong here
msc += $danger:You flicker back
msc += $danger:something.*blocking the
msc += $danger:You slice into (a|the) (net|web)
msc += $danger:It doesn't seem very happy
msc += $danger:You have been turned into a pig
msc += $danger:comes? into view
msc += $danger:You feel quite a bit less full
msc += $danger:Your unstable footing causes you to fumble your attack
msc += $danger:You are being weighed down by all of your possessions
msc += $danger:flinch away in fear
msc += $danger:is completely unfazed by your meager offer of peace
msc += $danger:deflects the
msc += $danger:The blink frog basks in the distortional energy
msc += $danger:appears unharmed
msc ^= $danger:You and your allies can no longer gain power from killing the unholy and evil
msc += $danger:You have lost your religion
msc += $danger:Your shroud unravels
msc += $danger:Your attacks are no longer magically infused
msc += $danger:You feel your attacks grow feeble
msc += $danger:Magical energy is drained from your
msc += $danger:A chorus of chattering voices calls out to you
msc += $danger:You can no longer
msc += $danger:The.*shudders
msc ^= $danger:Your unholy and evil allies forsake you
msc += $danger:Your transformation has ended
msc += $danger:Nothing appears to have answered your call
msc += $danger:The grasping roots prevent you from becoming airborne
msc += $danger:You kill your
msc += $danger:You feel less regenerative
msc += $danger:Lernaean hydra knocks down a tree
msc += $danger:You are caught in an explosion of electrical discharges
msc += $danger:bends your attack away
msc += $danger:Your song has ended
msc += $danger:goes into a battle-frenzy
msc += $danger:Your aura of abjuration expires
msc += $danger:Your.*is blown up
msc += $danger:There's only one card left
msc += $danger:You deal a card
msc += $danger:darts out from under the net
msc += $danger:You wield the.*\'s
msc += $danger:dips into the water
msc += $danger:You destroy your
msc += $danger:You're too exhausted to jump
msc += $danger:Your battlesphere expends the last of its energy and dissipates
msc += $danger:You feel your bond with your battlesphere wane
msc += $danger:Your battlesphere wavers and loses cohesion
msc += $danger:You lose concentration completely
msc += $danger:go into a battle-frenzy
msc += $danger:You can't jump while in water
msc += $danger:staircase.*moves
msc += $danger:You wield
msc += $danger:is filled with.*inner flame
msc += $danger:You feel guilty
msc += $danger:You feel extremely guilty
msc += $danger:picks up.*throwing net
msc += $danger:You feel less protected from physical attacks
msc ^= $danger:Your.*falters for a moment
msc += $danger:Mutagenic energy flows through the plutonium sword
msc += $danger:Your.*is incinerated
msc ^= $danger:begins absorbing vital energies
msc += $danger:Blessed fire suddenly surrounds you
msc ^= $danger:Your.*is poisoned
msc ^= $danger:Your.*looks even sicker
msc ^= $danger:Your.*is no longer beserk
msc += $danger:You swing wildly
msc += $danger:You lose your focus
msc += $danger:You feel threatened and lose the ability
msc ^= $danger:Your.*looks rather confused

# Item Destruction, gaining bad mutations, or losing good ones, penance, and gong
msc += $item_dmg:Your teeth shrink to normal size
msc += $item_dmg:Your.*scales disappear
msc += $item_dmg:You feel a strong urge to yell
msc += $item_dmg:Your wild genetic ride slows down
msc += $item_dmg:The barb on your tail disappears
msc += $item_dmg:Your wings shrivel and weaken
msc += $item_dmg:You feel very strange
msc += $item_dmg:You feel conductive
msc += $item_dmg:A chill runs up and down your throat
msc += $item_dmg:You feel forlorn
msc += $item_dmg:Your skin no longer functions as natural camouflage
msc += $item_dmg:Your natural healing is weakened
msc += $item_dmg:Your rate of healing slows
msc += $item_dmg:Your talons dull and shrink into feet
msc += $item_dmg:You feel genetically unstable
msc += $item_dmg:The horns on your head shrink a bit
msc += $item_dmg:You feel an ache in your throat
msc += $item_dmg:You feel yourself wasting away
msc += $item_dmg:You feel angry
msc += $item_dmg:You feel a little pissed off
msc += $item_dmg:Your hooves look more like feet
msc += $item_dmg:You feel a little hungry
msc += $item_dmg:A piece of fruit is consumed
msc += $item_dmg:pieces of fruit are consumed
msc += $item_dmg:You feel slightly disoriented
msc += $item_dmg:Your system partially rejects artificial healing
msc += $item_dmg:You feel even more weirdly uncertain
msc += $item_dmg:You feel weirdly uncertain
msc += $item_dmg:The drain falls to bits
msc += $item_dmg:acid corrodes
msc += $item_dmg:catch(es)? fire
msc ^= $item_dmg:freezes? and shatters?
msc += $item_dmg:covered with spores
msc += $item_dmg:devours some of your food
msc += $item_dmg:rots? away
msc += $item_dmg:It has a very clean taste
msc += $item_dmg:You feel your flesh rotting away
msc += $item_dmg:You are engulfed in dark miasma
msc += $item_dmg:You feel very guilty
msc += $item_dmg:Done waiting
msc += $item_dmg:That really hurt
msc += $item_dmg:You fall into the water
msc += $item_dmg:PTOANNNG
msc += $item_dmg:PANG
msc += $item_dmg:GONNNNG
msc += $item_dmg:BOUMMMMG
msc += $item_dmg:SHROANNG
msc += $item_dmg:BONNNG
msc ^= $item_dmg:This attack would place you under penance
msc += $item_dmg:You will pay for your transgression. mortal
msc += $item_dmg:You hear a distant slurping noise
msc ^= $item_dmg:picks up.*(potions?|scrolls?|wand)
msc += $item_dmg:drinks a potion
msc += $item_dmg:You hear a zap
msc += $item_dmg:reads a scroll
msc += $item_dmg:Mutagenic energies flood into your body
msc += $item_dmg:your body twists? and deforms?
msc += $item_dmg:You really shouldn't be using
msc += $item_dmg:You die.
msc += $item_dmg:You are engulfed in mutagenic fog
msc += $item_dmg:You feel the urge to shout
msc += $item_dmg:Your vision blurs
msc += $item_dmg:You feel frail
msc += $item_dmg:the book crumbles to dust
msc += $item_dmg:Your thinking seems confused
msc += $item_dmg:You are heavily infused with residual magics
msc += $item_dmg:Your vision seems duller
msc += $item_dmg:You feel less energetic


msc += $warning:You yowl
msc += $warning:You scream at
msc += $warning:is no longer distracted by gold
msc += $warning:boulder beetle smashes into something
msc += $warning:grate falls apart
msc += $warning:Your passage of Golubria closes with a snap
msc += $warning:is no longer weakened
msc += $warning:Something blocks
msc += $warning:Your aim is not that steady anymore
msc += $warning:You feel strangely alone
msc += $warning:You feel the tide rushing in
msc += $warning:Failed to move towards target
msc += $warning:Your protection from physical attacks is fading
msc ^= $warning:The Screaming Sword
msc += $warning:A large net falls onto you
msc += $warning:You stop recalling your allies
msc += $warning:You feel a little guilty
msc += $warning:snaps.*out of.*fear
msc += $warning:Your stasis keeps you stable
msc += $warning:You retract your mandibles
msc += $warning:The boots cling to your feet
msc ^= $warning:Your ring of flames is guttering out
msc += $warning:reforms as a
msc += $warning:You draw the first five cards.*and discard the rest
msc += $warning:You have damaged your brain
msc += $warning:A thin mist springs up around you
msc += $warning:The mangrove smolders and burns
msc += $warning:You feel your anger subside
msc += $warning:You feel nervous for a moment
msc += $warning:Your.*is burned terribly
msc += $warning:Your.*is frozen
msc += $warning:There is nothing there. so you fail to move
msc += $warning:You enter the passage of Golubria
msc += $warning:You start to feel a little slower
msc += $warning:drowns your?
msc += $warning:puts on a
msc += $warning:Faint laughter comes from somewhere
msc += $warning:shroud bends your.*attack away
msc += $warning:shadowy figures dance through the air in front of you
msc += $warning:This room is filled with shadowy figures
msc += $warning:You feel spirits watching over you
msc += $warning:You feel a genetic drift
msc += $warning:You return to the normal time flow
msc += $warning:reappears nearby
msc += $warning:I'll put it outside for you
msc += $warning:A pair of horns grows on your head
msc += $warning:is held in a (net|web)
msc += $warning:Smoke pours forth from your.*of chaos
msc += $warning:You cannot go berserk while under stasis
msc += $warning:You feel less woody
msc += $warning:is no longer paralysed
msc += $warning:The antennae on your head shrink away
msc += $warning:You feel less stealthy
msc += $warning:falls into the lava
msc ^= $warning:Your spellforged servitor disappears
msc += $warning:The shock serpent's electric aura discharges
msc += $warning:The air sparks with electricity
msc += $warning:You sense an evil presence
msc += $warning:Jory draws you further into his thrall
msc += $warning:grabs your
msc += $warning:You shudder from the earth-shattering force
msc += $warning:Smoke pours from your
msc += $warning:curses noisily
msc += $warning:is no longer blind
msc += $warning:Lightning arcs down from a storm cloud
msc += $warning:You feel strangely numb
msc += $warning:You feel less sure on your feet
msc += $warning:The air around you crackles with electrical energy
msc += $warning:The vortex of raging winds lifts you up
msc += $warning:creates a blast of rain
msc += $warning:shimmers and seems to become two
msc += $warning:Your ball lightning explodes
msc += $warning:There is a sudden explosion of flames
msc += $warning:You feel extremely nervous for a moment
msc += $warning:The orb fizzles
msc += $warning:A film of ice covers the
msc += $warning:That ambrosia tasted strange
msc += $warning:orb of destruction hits.*wall
msc += $warning:Something tries to affect you
msc += $warning:You block its attack
msc += $warning:A large net falls down
msc += $warning:You have made a black mistake
msc += $warning:You are stuck in your current form
msc += $warning:You feel like a pig
msc += $warning:Your hearing returns
msc += $warning:You feel less in control of your magic
msc += $warning:You feel your magical power running wild
msc += $warning:are frozen
msc += $warning:Something hits you but does no damage
msc += $warning:You turn into a bat
msc += $warning:A demon appears
msc += $warning:twists and deforms
msc += $warning:There is a sudden blast of acid
msc += $warning:Die. mortal
msc += $warning:You choke on the stench
msc += $warning:Your summoned allies are left behind
msc += $warning:You feel that your aim is more steady
msc += $warning:There's a creature in the
msc += $warning:They are\:
msc += $warning:A card falls out of the deck
msc += $warning:(dart|javelin|large rock|stone|boomerang) disappears in a puff of smoke
msc += $warning:You can't close doors while held in a net
msc += $warning:A slime creature suddenly
msc += $warning:You feel closer to the material plane
msc += $warning:leaps out from its hiding place
msc += $warning:You stop removing your armour
msc += $warning:You smell decay
msc += $warning:You feel a malignant aura surround you
msc += $warning:briefly surrounded by a scintillating aura of random colours
msc += $warning:looks stronger
msc += $warning:You have difficulty breathing
msc += $warning:The heat melts your.*(armour|shield)
msc += $warning:You are engulfed in a cloud of spores
msc += $warning:You feel less perceptive
msc += $warning:A profound silence engulfs you
msc += $warning:An unnatural silence engulfs you
msc ^= $warning:Hurry and find it before the entrance collapses
msc += $warning:Your memory of.*unravels
msc += $warning:You speak a Word of immense power
msc += $warning:seems to move somewhat quicker
msc += $warning:steals.*your
msc += $warning:A tentacle flies out from the starspawn's body
msc += $warning:The explosive bolt releases an explosion
msc += $warning:There is a Zot trap here
msc += $warning:You enter a teleport trap
msc += $warning:You need to enable at least one skill for training
msc += $warning:You (resume|stop) training
msc += $warning:You feel slightly jumpy
msc += $warning:You are splashed with acid
msc += $warning:ticking.*clock
msc += $warning:dying ticks
msc += $warning:distant snort
msc += $warning:odd grinding sound
msc += $warning:creaking of ancient gears
msc += $warning:floor suddenly vibrates
msc += $warning:a sudden draft
msc += $warning:coins.*counted
msc += $warning:tolling.*bell
msc += $warning:fails to return
msc += $warning:Something appears in a flash of light
msc += $warning:you turn into a fiery being
msc += $warning:no longer ripe
msc += $warning:The wave splashes down
msc += $warning:The spell fizzles
msc += $warning:The crackling of melting ice is subsiding rapidly
msc += $warning:seems to gain new vigour
msc += $warning:You feel strangely stable
msc += $warning:(asks|barks|bellows|boasts|brags|breathes|buzzes|cackles|calls|caws|chants|cheers)
msc += $warning:(chilling moan|complains|cries|croak|curses loudly|embarks|explains|Floosh|gibbers|giggles)
msc += $warning:(grits|groans|growls|grumbles|grunts|gurgles|hisses|jeers|keens|laughs|launches|makes a sound)
msc += $warning:(mewls|moans|mumbles|murmurs|mutters|pleads|prattles|preaches|queries|recites|roars|says)
msc += $warning:(scowls|screams|screeches|shout|shriek|sighs|sings|snarls|sneers|snorts|threatens|trumpets)
msc += $warning:(utters an oath|wail|wails|whimpers|whisper|yells)
msc += $warning:you roar
msc += $warning:imitates the bagpipes
msc += $warning:looks more energetic
msc += $warning:suddenly curses
msc += $warning:Dowan breathes
msc += $warning:Dowan shakes his head
msc += $warning:You hear strange voices
msc += $warning:You hear
msc += $warning:You drop
msc += $warning:You hear an irritating high-pitched whine
msc += $warning:You hear snatches of song
msc += $warning:seems more stable
msc += $warning:opens the (door|gate|large door)
msc += $warning:dissolves into sparkling lights
msc += $warning:[^un]wields
msc += $warning:There is a portal leading out of here
msc += $warning:Natasha's spirit plunges in to the ground
msc += $warning:Natasha's spirit rises from its lifeless body
msc += $warning:wears
msc += $warning:You are.*contaminated
msc += $warning:blinks
msc += $warning:You are starting to lose your buoyancy
msc += $warning:You float gracefully downwards
msc += $warning:Your surroundings suddenly seem different
msc += $warning:It (begins to drip with poison|bursts into flame|glows with a cold blue light|softly glows with a divine radiance|stops glowing)
msc += $warning:Your.*drips with poison
msc += $warning:You sense an unholy aura
msc += $warning:It is covered in frost
msc += $warning:The shock serpent begins to gather electrical charge
msc += $warning:moves out of view
msc += $warning:basks in the mutagenic energy
msc += $warning:Several doors burst open
msc += $warning:Flickering shadows surround you
msc += $warning:You.*one of the.*heads off
msc += $warning:slime creatures merge
msc += $warning:roars a battle-cry
msc += $warning:The.*is healed
msc += $warning:You stumble backwards
msc += $warning:Are you sure you want to stumble around while confused
msc += $warning:it creaks loudly
msc += $warning:The.*explodes
msc += $warning:You are caught in (a fiery explosion|an explosion of ice and frost)
msc += $warning:stops burning
msc += $warning:(The |.*)is healed
msc += $warning:You feel less studious
msc += $warning:(corpses?|macabre mass) merges with
msc += $warning:You start to feel a little uncertain
msc += $warning:corpses? begins to drag
msc += $warning:corpses meld into an agglomeration of writhing flesh
msc += $warning:beckons forth a restless soul
msc += $warning:Something reaches out for you
msc += $warning:Something tries to feed on your intellect
msc += $warning:You feel a brief urge to hack something to bits
msc += $warning:Pain shudders through your
msc += $warning:The.*passes through your shield
msc += $warning:draws strength from your injuries
msc += $warning:The.*pierces through
msc += $warning:The forest fire spreads
msc += $warning:The tree burns like a torch
msc += $warning:magical defenses are stripped away
msc += $warning:You blink
msc += $warning:You teleport
msc += $warning:You step into.*shadow
msc += $warning:Grasping roots rise from the ground around the
msc += $warning:The winds start to flow at the.*will
msc += $warning:The .*(are|is) blown away
msc += $warning:goes into a frenzy at the smell of blood
msc += $warning:Something picks up
msc += $warning:You smell burning wood
msc += $warning:stumbles backwards
msc += $warning:looks slightly unstable
msc += $warning:slips into darkness
msc += $warning:The air around.*erupts in flames
msc += $warning:hops backward while attacking
msc += $warning:violent explosion of flames
msc += $warning:turns its malign attention towards you
msc += $warning:Splash!
msc += $warning:Harold gasps with his last breath
msc += $warning:You see a puff of smoke
msc += $warning:pour from your
msc += $warning:Tentacles burst out of the water
msc += $warning:calls forth a grand avatar
msc += $warning:focuses on the pain
msc += $warning:suddenly seems more agile
msc += $warning:regenerates before your eyes
msc += $warning:You feel corrupt for a moment
msc += $warning:Send 'em back where they came from
msc += $warning:The net rips apart
msc += $warning:Your surroundings seem slightly different
msc += $warning:You are under the weather
msc += $warning:You are standing in the rain
msc += $warning:The rain has left you waist-deep in water
msc += $warning:We do not forgive those who trespass against us
msc += $warning:A.*appears from out of thin air
msc += $warning:looks more healthy
msc += $warning:A mysterious force pulls you upwards
msc += $warning:punctures the fabric of the universe
msc += $warning:degenerates into a cloud
msc += $warning:wounds heal themselves
msc += $warning:is no longer moving slowly
msc += $warning:is completely healed
msc += $warning:You heal
msc += $warning:It is briefly surrounded by a scintillating aura of random colours
msc += $warning:Partly explored
msc += $warning:There is a shaft here
msc += $warning:You feel that this wand is rather unreliable
msc += $warning:You feel less protected
msc += $warning:You hear a crashing sound
msc += $warning:shatters
msc += $warning:apparitions take form around you
msc += $warning:You feel your magic capacity is already quite full
msc += $warning:pulls away from the web
msc += $warning:withdraws into its
msc += $warning:is no longer petrified
msc += $warning:You remove
msc += $warning:Your.*dissolves into shadows
msc += $warning:Your.*stops moving altogether
msc += $warning:hides itself under the floor
msc += $warning:puts on a burst of speed
msc += $warning:decay slows
msc += $warning:Your.*is caught in
msc += $warning:Thorny briars emerge from the ground!
msc += $warning:You flicker for a moment
msc += $warning:There is a.*altar.*here
msc += $warning:You kneel at the altar
msc += $warning:You feel a strong urge to attack something
msc += $warning:You cannot move away from
msc += $warning:The pull of.*song draws you forwards
msc += $warning:Shadowy forms rise from the deep
msc += $warning:You feel as though you will be slow longer
msc += $warning:disappears!
msc += $warning:Your.*is no longer moving quickly
msc += $warning:You feel your magic capacity decrease
msc += $warning:drains the heat from the surrounding environment
msc += $warning:pounces on you
msc += $warning:A tentacle rises from the water
msc += $warning:comes (down|up) the stairs
msc += $warning:You catch a bit of a chill
msc += $warning:A ballistomycete grows in the wake of the spore
msc += $warning:A fungus suddenly grows
msc += $warning:A toadstool grows
msc += $warning:then quickly surges around you
msc += $warning:There is a sudden explosion of frost
msc += $warning:That was not very filling
msc += $warning:You failed to disarm the trap
msc += $warning:is covered with a thin layer of ice
msc += $warning:draws out.*weapon's spirit
msc += $warning:You are pushed out
msc ^= $warning:Your.*seems to slow down
msc += $warning:thirsts for the lives of mortals
msc += $warning:emits a brilliant flash of light
msc += $warning:is firebranded into
msc += $warning:is no longer bleeding
msc += $warning:The dungeon rumbles around Jorgrun!
msc += $warning:evaporates and reforms as
msc += $warning:You turn into a venomous arachnid creature
msc += $warning:infuriates you
msc += $warning:Your extra speed is starting to run out
msc += $warning:Your skin is crawling a little less now
msc += $warning:You stumble into the trap
msc += $warning:Your transformation is almost over
msc += $warning:You feel magic leave you
msc += $warning:You feel magic returning to you
msc += $warning:Your (horns|talons) disappear
msc += $warning:Tentacles burst from the starspawn
msc += $warning:you must find a gate leading back
msc += $warning:You fall off the wall
msc += $warning:Blech - you need (greens|meat)
msc += $warning:A starcursed mass splits
msc += $warning:You draw the Sage
msc += $warning:You feel a wave of frost pass over you
msc += $warning:The creatures around you are filled with an inner flame
msc += $warning:is filled with an inner flame
msc += $warning:You feel less healthy
msc += $warning:summons a great blast of wind
msc += $warning:Your attack snaps.*out of its fear
msc += $warning:You feel blessed for a moment
msc += $warning:You draw a card
msc += $warning:Walls emerge from the floor
msc += $warning:You feel like more of a target
msc += $warning:is knocked back by the flood of elemental water
msc += $warning:blown away by the wind
msc += $warning:is surrounded by Orcish apparitions
msc += $warning:The.*reappears nearby
msc += $warning:The deck of cards disappears
msc += $warning:The.*looks more experienced
msc += $warning:There is a rocky tunnel leading out of this place here
msc += $warning:Your icy (armour|shield) starts to melt
msc += $warning:Your legs become a tail
msc += $warning:You feel the effects of Trog's Hand fading
msc += $warning:You slam the door shut with a bang
msc += $warning:magical effects unravel
msc += $warning:You awkwardly throw
msc += $warning:You erupt
msc += $warning:The flames covering.*go out
msc += $warning:bleats in terror
msc += $warning:seems to regain.*courage
msc += $warning:You have a feeling of ineptitude
msc += $warning:falls through a shaft
msc += $warning:You cannot throw anything while held in a net
msc += $warning:furiously retaliates
msc += $warning:The blast of chaos engulfs your?
msc += $warning:You are engulfed in seething chaos
msc += $warning:Your song is almost over
msc += $warning:is in the way
msc += $warning:You are too berserk
msc += $warning:The tentacle pulls you backwards
msc += $warning:starcursed mass shudders and
msc += $warning:The kraken squirts a massive cloud of ink
msc += $warning:Wisps of shadow whirl around
msc += $warning:You are too injured to fight recklessly
msc += $warning:shakes off its lethargy
msc += $warning:I don't know how to get there
msc += $warning:Your.*warbles
msc += $warning:chimes melodiously
msc += $warning:erupts into laughter
msc += $warning:makes a deep moaning sound
msc += $warning:raves incoherently
msc += $warning:speaks gibberish
msc += $warning:belts out
msc += $warning:yelps
msc += $warning:goes tick-tock
msc += $warning:gives off a wolf whistle
msc ^= $warning:[e] your.* of resist
msc += $warning:phases out as you
msc += $warning:momentarily phases out
msc += $warning:cracks jokes
msc += $warning:Your orb of destruction dissipates
msc += $warning:regales you with its life story
msc += $warning:parrots the noises around you
msc += $warning:lets out a mournful sigh
msc += $warning:tootles away
msc += $warning:makes a horrible noise
msc += $warning:burps loudly
msc += $warning:You are caught in a violent explosion
msc += $warning:pulses with an eldritch light
msc += $warning:the glow from your magical contamination prevents you from becoming completely invisible
msc += $warning:appears from out of your range of vision
msc += $warning:You stop putting on your armour
msc += $warning:We have you now
msc += $warning:You do not belong in this place
msc += $warning:There is a sudden explosion of magical energy
msc += $warning:Something forms from out of thin air
msc += $warning:You sense a hostile presence
msc += $warning:Trespassers are not welcome here
msc += $warning:You feel a terrible foreboding
msc += $warning:You will not leave this place
msc += $warning:wrenching scream
msc += $warning:before it is too late
msc += $warning:picks up
msc += $warning:Nothing appears to happen
msc += $warning:The dead are
msc += $warning:The boulder beetle hits a closed door
msc += $warning:begin to drag.*along the ground
msc += $warning:merge to form a (large abomination|macabre mass|small abomination)
msc += $warning:Two macabre masses merge
msc += $warning:falls through the shaft
msc += $warning:There is a crawl-hole back to the Lair here
msc += $warning:There is a hole to the Spider Nest here
msc += $warning:You create a pond
msc += $warning:Mennas becomes audible again
msc += $warning:That was extremely unsatisfying
msc += $warning:The wind howls around you
msc += $warning:You are feeling less magically infused
msc += $warning:Something invisible bursts forth from the water
msc += $warning:Something.*misses
msc += $warning:There is a cloud of mutagenic fog here
msc += $warning:howls
msc += $warning:You part the fleshy orifice with a squelch
msc += $warning:The orb of energy explodes
msc += $warning:The air shimmers briefly around you
msc += $warning:You are much too full right now
msc += $warning:turns to fight
msc += $warning:You feel transcendent for a moment
msc += $warning:You're too terrified to move while being watched
msc += $warning:The weapon returns to the
msc += $warning:The queen bee calls on the killer bee to defend her
msc += $warning:You turn into a bat
msc += $warning:Your.*looks incredibly listless
msc += $warning:The mass is resisting your pull
msc += $warning:escapes
msc += $warning:The silence causes your song to end
msc += $warning:You feel (slightly|somewhat) less full
msc += $warning:The light of Elyvilon fails to reach
msc += $warning:The light of Elyvilon almost touches upon
msc += $warning:[^r]pulls free of the water
msc += $warning:Your piety has decreased
msc += $warning:struggles to resist
msc += $warning:You feel.*more hungry
msc += $warning:You are outlined in light
msc += $warning:Your.*is outlined in light
msc += $warning:You feel momentarily disoriented
msc += $warning:You are now empty
msc += $warning:(prevent|prevents) you from hitting
msc += $warning:The water nymph flows with the water
msc += $warning:summons a
msc += $warning:cannot make way for you
msc += $warning:The horns on your head shrink away
msc += $warning:Your shroud begins to fray at the edges
msc += $warning:You'd need three hands to do that
msc += $warning:Your.*disappears
msc += $warning:That's too.*for you
msc += $warning:The dungeon trembles and rubble falls from the walls
msc += $warning:Finesse? Hah! Time to rip out guts
msc += $warning:You fail to extend your transformation any further
msc += $warning:This spell does not affect your current form
msc += $warning:You can't wield anything in your present form
msc += $warning:Your.*revert to their normal proportions
msc += $warning:Suddenly Natasha's spirit rises from her lifeless body
msc += $warning:Your.*shudders
# Demonspawn gaining a mutation they already have
msc += $warning:Your mutations feel more permanent
msc += $warning:Roots rise up from beneath.*and drag it to the ground
msc ^= $warning:You feel a sudden chill
msc += $warning:You feel hot for a moment
msc += $warning:stop glowing
msc += $warning:The water foams
msc += $warning:The satyr's allies are stirred to greatness
msc += $warning:Mushrooms sprout up around you
msc += $warning:seems less confused
msc += $warning:You could not reach far enough
msc ^= $warning:The golden flame engulfs you
msc += $warning:You shudder
msc += $warning:The giant firefly flashes a warning beacon
msc += $warning:vibrate crazily for a second
msc += $warning:Harold falls down. and clutches his wounds
msc += $warning:You finish recalling your allies
msc += $warning:Your.*wears
msc += $warning:Something (bites|hits) your?
msc += $warning:You feel more confident with your borrowed prowess
msc += $warning:Your hands get new energy
msc += $warning:You squeal for attention
msc ^= $warning:changes into
msc += $warning:The crackle of the magical portal is almost imperceptible now
msc += $warning:blocks (the|you)
msc += $warning:You start to feel a little faster
msc += $warning:You meow for attention
msc += $warning:The lightning arc arcs out of your line of sight
msc += $warning:The lightning arc suddenly appears
msc += $warning:The bush is engulfed in roaring flames
msc += $warning:A yell rips itself from your throat
msc += $warning:Purgy wonders. \"What am I doing in here\?\"
msc += $warning:You create some ball lightning
msc += $warning:dances into the air
msc += $warning:appears
msc += $warning:Your divine protection wanes
msc += $warning:The sheep \"Baaaas\" balefully
msc += $warning:is blown backwards by the freezing wind


msc += $boring:Your tentacles glow momentarily
msc += $boring:You feel a little dazed
msc += $boring:You feel mildly nauseous
msc += $boring:looks momentarily confused
msc += $boring:Motes of dust swirl before your eyes
msc ^= $boring:You squeeze the fleshy orifice shut
msc += $boring:Gastronok glows a brilliant shade of cerise
msc += $boring:fingertips start to glow
msc += $boring:eyes start to glow
msc += $boring:You smell tea
msc += $boring:Your ghoul eats
msc += $boring:seems to dim momentarily
msc += $boring:The net is caught on your fulminant prism
msc += $boring:The shadows disperse without effect
msc += $boring:You feel woody for a moment
msc += $boring:Your vision is briefly tinged with green
msc ^= $boring:Sigmund is suddenly surrounded by pale red light
msc += $boring:has a weird expression for a moment
msc += $boring:You feel roots moving beneath the ground
msc += $boring:This spell is already in effect
msc ^= $boring:You displace your
msc ^= $boring:whispers something so quietly that you cannot hear
msc ^= $boring:for a moment.*blends into the shadows
msc ^= $boring:picks up a beetle and eats it
msc += $boring:Everything looks hazy for a moment
msc += $boring:There is a strange surge of energy around
msc += $boring:orc priest shimmers for a moment
msc += $boring:orc priest's eyes start to glow
msc += $boring:The weapon returns to your
msc += $boring:Your bandages flutter
msc += $boring:The water in the fountain briefly bubbles
msc += $boring:The bush looks momentarily different
msc += $boring:Dowan's feet meld with the ground. briefly
msc += $boring:briefly looks nauseous
msc += $boring:twitches
msc += $boring:Jessica looks very angry
msc += $boring:You fall off the door
msc += $boring:as though insubstantial
msc += $boring:The Killer Klown sprays water
msc += $boring:The Killer Klown honks
msc += $boring:wriggles its tentacles
msc += $boring:You reach down and part the fleshy orifice
msc += $boring:orb spider pulsates with a strange energy
msc += $boring:orb spider begins to weave its threads into a brightly glowing ball
msc += $boring:Your eyebrows briefly feel incredibly bushy
msc += $boring:briefly appears rusty
msc += $boring:Your.*stops glowing
msc += $boring:Your.*briefly vibrates
msc += $boring:You feel gritty
msc += $boring:You briefly become tangled in your
msc += $boring:Your eyebrows wriggle
msc += $boring:You detect nothing
msc += $boring:Your.*shimmers for a moment
msc += $boring:Your.*eyes start to glow
msc += $boring:Your.*spins!
msc += $boring:grins madly
msc += $boring:You lose your grip on
msc += $boring:The water engulfing you falls away
msc += $boring:The disc glows for a moment
msc += $boring:Your.*briefly glows
msc += $boring:You feel numb
msc += $boring:The chaos spawn grows dozens of eye stalks in order to get a better look at you
msc += $boring:Jory stares carefully at you
msc += $boring:seems to be having trouble coordinating.*its legs
msc += $boring:Your.*flashes
msc += $boring:You create a blast of thin mist
msc ^= $boring:then vanish
msc += $boring:avoids triggering.*trap
msc += $boring:Terence looks scornfully at you
msc += $boring:Sigmund looks at you with fury
msc += $boring:holds.*ground
msc += $boring:The door collapses
msc += $boring:You smell baking bread
msc += $boring:The lightning arc grounds out
msc += $boring:Fannar glares icily
msc ^= $boring:A poisoned needle shoots out and hits your shield
msc += $boring:ghost twirls its
msc += $boring:You attack empty space
msc += $boring:Eustachio twirls his moustache
msc += $boring:is briefly tinged with black
msc += $boring:The dust glows
msc += $boring:Crazy Yiuf scratches his head thoughtfully
msc += $boring:Crazy Yiuf counts something out on his finger
msc += $boring:You aren't quite hungry enough to eat that
msc += $boring:The crystal guardian glitters
msc += $boring:The wizard's fingertips start to glow
msc += $boring:You are already empty-
msc ^= $boring:the.*shaped block of ice
msc ^= $boring:briefly gains? a (green|red|yellow) sheen
msc += $boring:The great wave of water passes through the water elemental
msc += $boring:shimmers and vanishes
msc += $boring:You do an impromptu tapdance
msc += $boring:You feel uncomfortable
msc ^= $boring:The shadow imp breathes mist at you
msc += $boring:That snozzcumber tasted truly putrid
msc += $boring:The reaper draws a finger across its throat
msc += $boring:Your.*seems to dim momentarily
msc += $boring:Your.*is briefly tinged with black
msc += $boring:Your.*shivers with cold
msc += $boring:A malignant aura surrounds your
msc += $boring:Your.*twitches violently
msc += $boring:The world appears momentarily distorted
msc += $boring:The iron imp grinds its teeth
msc += $boring:unwise to walk into this
msc += $boring:The tree breaks and falls down
msc += $boring:Nessos tries to tell you a complicated story about hydras
msc += $boring:You feel blessed for a moment
msc += $boring:The boulder beetle hits.*wall
msc += $boring:A root reaches out and grasps at passing movement
msc += $boring:Tangled roots snake along the ground
msc += $boring:You smell coffee
msc += $boring:The white imp grinds its teeth
msc += $boring:Your.*imp grins impishly at you
msc += $boring:Your hooves feel warm
msc += $boring:Your.*jumps up and down with excitement
msc += $boring:Strange appendages sprout from
msc += $boring:Suppurating sores blossom under
msc += $boring:That beef jerky was jerk
msc += $boring:A dozen eyes blink open in the
msc += $boring:You part the fleshy orifice
msc += $boring:There is an open fleshy orifice here
msc += $boring:Your hair momentarily turns into snakes
msc += $boring:The crimson imp grinds its teeth
msc ^= $boring:The crimson imp spits at you
msc += $boring:then rights herself and shakes her weapon
msc += $boring:You smell burning hair
msc += $boring:Your nose twitches suddenly
msc += $boring:You are wearing that object
msc += $boring:You can't wield jewellery
msc += $boring:There is an abandoned shop here
msc += $boring:You don't have any such object
msc += $boring:Mennas is caught in a moment of prayer
msc += $boring:You spin around
msc += $boring:Aizul coils and then uncoils
msc += $boring:The tide is released from Ilsuiw's call
msc += $boring:Polyphemus seems to be sizing you up for his next meal
msc += $boring:You can't read that
msc += $boring:You can't drink that
msc += $boring:Your.*falls into the water
msc += $boring:A large abomination twists grotesquely
msc += $boring:collapse into pulpy
msc ^= $boring:You reach to attack
msc += $boring:avoids the shaft
msc += $boring:Your bones ache
msc += $boring:Thank you for shopping
msc += $boring:Your ears itch
msc += $boring:Prince Ribbit hops awkwardly around
msc += $boring:You pass into a different region of Pandemonium
msc += $boring:You smell brimstone
msc += $boring:Something frightening happens
msc += $boring:Multicoloured lights dance before your eyes
msc += $boring:Some snowflakes condense on Fannar
msc += $boring:shape twists and changes as it dies
msc += $boring:No such ability
msc += $boring:The plume of ash settles
msc += $boring:You feel uncomfortably hot
msc += $boring:You can't wield that with a shield
msc ^= $boring:The blast of magma explodes
msc += $boring:Crazy Yiuf glowers
msc += $boring:Crazy Yiuf flaps his cloak
msc += $boring:Crazy Yiuf waves his quarterstaff at you
msc += $boring:You feel lost and a long
msc += $boring:The world around you seems to dim momentarily
msc += $boring:tears through a web
msc += $boring:Pikel waves his whip at you
msc += $boring:Wisps of condensation drift from your
msc += $boring:A chill runs through your body
msc += $boring:Frost covers your body
msc += $boring:numb with cold
msc += $boring:That.*was very bland
msc += $boring:That lemon was rather sour
msc += $boring:You call on the dead to rise
msc += $boring:You can't wear that
msc += $boring:vibrates crazily for a second
msc ^= $boring:The crimson imp breathes (mist|steam) at you
msc += $boring:showing sharp teeth
msc += $boring:Branches wave dangerously above you
msc += $boring:A root lunges up near you
msc += $boring:Maurice looks sneaky
msc += $boring:Suddenly you are surrounded with a pale green light
msc += $boring:really hit the spot
msc += $boring:Mmmm... Yummy
msc += $boring:Grum bares his teeth
msc += $boring:Grum sniffs the air and quickly glances around
msc += $boring:The shadow imp grinds its teeth
msc += $boring:looks to the heavens
msc += $boring:beckons to you
msc += $boring:Your.*struggles to escape
msc += $boring:Your.*struggles against
msc += $boring:Your.*struggles to get unstuck from
msc += $boring:fades away
msc += $boring:You feel electric
msc += $boring:sharp shower of sparks
msc += $boring:pulsates ominously
msc += $boring:You feel earthy
msc += $boring:Sparks of electricity dance between your
msc += $boring:Edmund gestures with his flail
msc += $boring:You feel very uncomfortable
msc += $boring:Xtahua glares at you
msc += $boring:You pass through the gate
msc += $boring:The starspawn's tentacles wither and die
msc += $boring:Trunks creak and shift
msc += $boring:unmelds from your body
msc += $boring:The air around.*crackles with energy
msc += $boring:Something.*the (bush|plant)
msc += $boring:There's nothing there!
msc += $boring:You briefly turn translucent
msc += $boring:unborn seems to be listening
msc += $boring:You can only put on jewellery
msc += $boring:Ouch!
msc += $boring:There isn't anything here
msc += $boring:The air around you briefly surges with heat
msc += $boring:Your skin glows momentarily
msc += $boring:You draw two cards from the deck
msc += $boring:You shuffle the cards back into the deck
msc += $boring:The drowned soul returns to the deep
msc += $boring:Your.*stays? behind
msc += $boring:You prostrate yourself
msc += $boring:You shiver with cold
msc += $boring:glows? .* for a moment
msc += $boring:Waves of light ripple over
msc += $boring:Your skin tingles
msc += $boring:looks braver
msc += $boring:You enjoyed that
msc += $boring:Your brain hurts
msc += $boring:becomes somewhat translucent
msc += $boring:generates a fountain of clear water
msc += $boring:You cannot attack while caught
msc += $boring:You cannot throw anything while caught
msc += $boring:grinds (her|his) teeth
msc += $boring:bristles in rage as it notices you
msc += $boring:You feel forgetful for a moment
msc += $boring:The briar patch crumbles away
msc += $boring:You feel momentarily lethargic
msc += $boring:...but nothing happens
msc += $boring:Wisps of smoke drift from your
msc += $boring:You smell salt
msc += $boring:tries to hide in the shadows
msc += $boring:stops crackling
msc ^= $boring:Your.*is no longer covered in acid
msc += $boring:You momentarily stiffen
msc += $boring:waves its rhizomes
msc += $boring:The flesh is too rotten for a proper zombie
msc += $boring:You smell (smoke|something weird)
msc += $boring:The floor shifts beneath you alarmingly
msc += $boring:The reaper smiles without lips
msc += $boring:great wave of water passes through
msc += $boring:crushes a nearby insect and laughs
msc += $boring:Welcome back to the Dungeon
msc += $boring:You are blasted with air
msc ^= $boring:There is a collapsed entrance here
msc += $boring:You can't see any susceptible monsters within range! (Use Z to cast anyway.)
msc += $boring:You can't go (down|up) here
msc += $boring:Your hair stands on end
msc += $boring:Wisps of vapour drift from your
msc += $boring:The Killer Klown smiles at you
msc += $boring:the (bush|fungus|plant)
msc += $boring:You are momentarily dazzled by a (brilliant|flash of) light
msc ^= $boring:(flickers out of sight|flickers and vanishes|slips into darkness) for a moment
msc += $boring:The golden flame engulfs your?
msc += $boring:The shaft crumbles and collapses
msc += $boring:An air elemental (forms|merges) itself (from|into) the air
msc += $boring:A corpse collapses into a pulpy mess
msc += $boring:You start (resting|waiting)
msc += $boring:Unknown command
msc += $boring:but (do no|doesn't do any|does no) damage
msc += $boring:miss
msc += $boring:Wisps of poison gas drift from your
msc += $boring:You walk carefully through
msc += $boring:grow from
msc += $boring:withers and dies
msc += $boring:There is nothing on the other side of the stone arch
msc += $boring:misses you
msc += $boring:You block
msc += $boring:You are waved at by a branch
msc += $boring:The trees move their gnarly branches around
msc += $boring:Heat runs through your body
msc += $boring:Lukewarm flames ripple over your body
msc += $boring:stops (dripping with poison|flaming)
msc += $boring:Press.*to see all runes
msc += $boring:There is a.*(door|gate)
msc += $boring:(antennae|eye-stalks|whiskers)
msc += $boring:You feel troubled
msc += $boring:You feel a wave of unholy energy pass over you
msc += $boring:grins evilly
msc += $boring:A huge blade swings just past you
msc += $boring:(The|Something).*disappears
msc += $boring:The.*glitters chillingly
msc += $boring:You feel a strange surge of energy
msc += $boring:There are no unholy or evil weapons here to destroy
msc += $boring:close doors on yourself
msc += $boring:Your.*falls off the wall
msc += $boring:stops rolling
msc += $boring:(gazes forward|pauses|quivers|skips|sputters|stops to sniff|summons a swarm of flies)
msc += $boring:turns its.*gaze
msc += $boring:Your summoned ally is left behind
msc += $boring:That felt strangely unrewarding
msc += $boring:The air around you crackles with energy
msc += $boring:(drops|unwields)
msc += $boring:The battlesphere dissipates
msc += $boring:(The|Your?).*(passes|pick your way) through a web
msc += $boring:passes through a web
msc += $boring:You feel extremely cold
msc += $boring:You feel terrible
msc += $boring:You sense a malignant aura
msc += $boring:You (hold|stand) your ground
msc += $boring:Your.*(holds|stands) its ground
msc += $boring:The.*eats the
msc += $boring:The winds cease moving at the.*will
msc += $boring:The ground creaks as gnarled roots bulge its surface
msc += $boring:rages
msc += $boring:Your acid blob dissolves into a puddle of slime
msc += $boring:You feel a wrenching sensation
msc += $boring:The.*falls off the wall
msc += $boring:The.*jiggles
msc += $boring:The.*looks excited
msc += $boring:Pikel cracks his whip
msc += $boring:slime creature splits
msc += $boring:stops glowing
msc += $boring:splashes around in the water
msc += $boring:tentacles slide back into the water
msc += $boring:(You|reach down and) (close|open) the.*(door|gate)
msc += $boring:You (climb|fly) (down|up)wards
msc += $boring:You go (down|up)
msc += $boring:You fly (down|up) through the gate
msc += $boring:You must enter the number of times for the command to repeat
msc += $boring:Use Z to cast anyway
msc += $boring:There are no items here
msc += $boring:it crumbles to dust
msc += $boring:The hatch slams shut behind you
msc += $boring:There is an empty arch of ancient stone here
msc += $boring:The world spins around you as you enter the gateway
msc += $boring:This spell is.*dangerous to cast
msc += $boring:There is a web.*here
msc += $boring:You pick your way through the web
msc += $boring:You hold your ground
msc += $boring:The floor vibrates
msc += $boring:Sand pours from your
msc += $boring:Strange energies run through your body
msc += $boring:evades a web
msc += $boring:The.*goes (down|up) the
msc += $boring:jumps into the shaft
msc += $boring:Why would you want to do that
msc += $boring:you're not good enough to have a special ability
msc += $boring:holds its.*at the ready
msc += $boring:There is a.*fountain.*here
msc += $boring:Little bolts of electricity crackle over the disc
msc += $boring:tries to grin evilly
msc += $boring:The corpses? collapses? into a pulpy mess
msc += $boring:There is an empty arch of ancient stone
msc += $boring:The runic seals? fades? away
msc += $boring:looks hungrier
msc += $boring:Something drops
msc += $boring:tears the web
msc += $boring:lashes its tail
msc += $boring:smirks and points a slender finger
msc += $boring:The orb of destruction dissipates
msc += $boring:Your (claws|elbows|hands|wings) glow momentarily
msc += $boring:Weird images run through your mind
msc += $boring:safely over a trap
msc += $boring:avoid triggering a
msc += $boring:A net swings high above you
msc += $boring:Natasha extends her claws
msc += $boring:The shadow imp breathes steam at you
msc += $boring:You can't see any susceptible monsters within range
msc += $boring:You are momentarily dazzled by a brilliant light
msc += $boring:You feel momentarily weightless
msc += $boring:You feel uncomfortably cold
msc += $boring:Your fire elemental sizzles in the rain
msc += $boring:Nessos pounds the earth with his hooves
msc += $boring:Frost spreads across the the floor
msc += $boring:You sense an ancient evil watching you
msc += $boring:Your.*(looks|smiles) at you
msc += $boring:You experience a momentary feeling of inescapable doom
msc += $boring:assumes a wrestling stance
msc += $boring:feints to the
msc += $boring:Purgy looks around nervously
msc += $boring:You smell pepper
msc += $boring:You feel faint for a moment
msc += $boring:takes off
msc += $boring:There is a rock-blocked tunnel here
msc += $boring:falls off the
msc += $boring:The bat flutters around in erratic circles
msc += $boring:You swing at nothing
msc += $boring:electric golem crackles and sizzles
msc += $boring:ghost ripples
msc += $boring:Maud (frowns|looks upset)
msc += $boring:There is an ice choked empty arch of ancient stone here
msc += $boring:Sparks fly from your
msc += $boring:crimson imp breathes smoke at you
msc += $boring:Distant voices call out to you
msc += $boring:You are showered with tiny particles of grit
msc += $boring:The scroll reassembles itself in your
msc += $boring:You feel uncomfortably hot
msc += $boring:Nergalle blows her nose
msc += $boring:You release your grip on
msc += $boring:Nergalle looks more energetic
msc += $boring:stampedes away
msc += $boring:fails to trigger a.*trap
msc += $boring:You feel a numb sensation
msc += $boring:You smell sulphur
msc += $boring:There's nothing to (close|open) nearby
msc += $boring:Your.*stumbles backwards
msc += $boring:ghost takes a fighting stance
msc += $boring:You shiver with fear
msc += $boring:Your.*falls like a stone
msc += $boring:You feel a surge of energy from the ground
msc += $boring:You release your grip on
msc += $boring:Your head hurts
msc += $boring:The lightning grounds out
msc += $boring:Your.*feel warm
msc += $boring:This isn't a weapon
msc += $boring:You feel as though nothing has changed
msc += $boring:Blork the orc's eyes start to glow
msc += $boring:Blork the orc shakes
msc += $boring:You smell wet wool
msc += $boring:You create a blast of rain
msc += $boring:There is a rose-covered archway here
msc += $boring:becomes larger for a moment
msc += $boring:falls out of your pack
msc += $boring:leaps into the air
msc += $boring:body glows momentarily
msc += $boring:shimmers violently
msc += $boring:makes a popping sound
msc += $boring:your.*spectral.*

# Enemies taking damage
msc += $good:You (beat|bite|bludgeon|burn|carve|chop|claw|constrict|crush|cut|devastate|dice|drain|electrocute|eviscerate)
msc += $good:You (flatten|fracture|freeze|grab|hammer|headbutt|hit|impale|kick|mangle|maul|open|peck|perforate|pierce|pound)
msc += $good:You (pulverise|pummel|punch|puncture|punish|scratch|sears|shatter|shave|shred|skewer|slash|slice|smack|sock)
msc += $good:You (spit|squash|squeeze|stick|strike|tail-slap|tentacle-slap|thrash|thump|touch|trample|whack|knocked back)
msc += $good:(attacks|bites|burns|carves|chops|claws|constricts|crushes|cuts|drains|draws|electrocutes|engulfs) [^y]
msc += $good:(eviscerates|freezes|gores|grabs|headbutts|hits|hits|kicks|mauls|melts|opens|pecks|perforates) [^y]
msc += $good:(poisons|pulverises|pummels|punches|punctures|sears|shocks|shreds|skewers|slashes|slices|smacks) [^y]
msc += $good:(spits|squashes|sticks|stings|strikes|tail-slaps|tentacle-slaps|touches|tramples|trunk-slaps) [^y]
msc += $good:You smite
msc ^= $good:Your fire elemental burns
msc += $good:is flooded with distortional energies
msc += $good:You draw life from
msc += $good:is struck by the twisting air
msc += $good:burns!
msc += $good:Asterion shares his spectral weapon's damage
msc += $good:is struck by lightning
msc += $good:A guardian golem appears
msc += $good:is covered in liquid flames
msc += $good:is engulfed in
msc += $good:Your.*tramples the
msc += $good:The orb of electricity engulfs the
msc += $good:The (.*hellfire|blast of flame|blast of lightning|blast of magma|explosion) engulfs [^y]
msc += $good:The (explosion of.*fragments|explosion of spores|fiery explosion|fireball|ghostly fireball) engulfs [^y]
msc += $good:The (great blast of fire|plume of ash|stinking cloud) engulfs [^y]
msc += $good:is smitten
msc += $good:struck by your spines
msc += $good:There is a sudden explosion of sparks
msc += $good:is drained
msc += $good:You drain (her|his|its) (magic|power)
msc += $good:You drain the
msc += $good:Something (bites|hits)
msc += $good:is blasted
msc += $good:is burned by your radiant heat
msc += $good:The boulder beetle smashes into the
msc += $good:The golden flame engulfs
msc += $good:The eldritch tentacle writhes
msc ^= $good:The.*pierces through the
msc += $good:Space (bends|warps horribly) around
msc += $good:(convulses|writhes in agony)
msc += $good:is splashed with acid
msc += $good:You feel life coursing into your body
msc += $good:is struck by lightning
msc += $good:is burned by acid
msc += $good:seems to burn from within
msc += $good:Space warps around
msc ^= $good:statue shatters

# Non-damage combat messages
msc += $positive:You pounce on
msc += $positive:but is stunned by your will
msc += $positive:by your wave of power
msc += $positive:is stunned by your will and fails to attack
msc += $positive:The sticky flame splashes onto
msc ^= $positive:Your orcs go into a battle-frenzy
msc += $positive:falters in the face of your power
msc += $positive:in retribution by your aura
msc += $positive:Your slowness suddenly goes away
msc ^= $positive:Your.*seems less confused
msc += $positive:is no longer regenerating
msc += $positive:You repair your equipment
msc += $positive:You extend your infusion
msc += $positive:You draw (the Helm|Dowsing)
msc += $positive:You shrug off the repeated paralysis
msc ^= $positive:You begin infusing your attacks with magical energy
msc += $positive:It gets dark
msc += $positive:is outlined in light
msc += $positive:moth of wrath (goads|infuriates) your
msc += $positive:Some water evaporates in the bright sunlight
msc += $positive:You become one with your weapon
msc += $positive:Your bond becomes stronger
msc += $positive:A magical shield forms in front of you
msc += $positive:Your attacks no longer feel as feeble
msc += $positive:You feel odd
msc += $positive:The shadowy forms in the deep grow still as others approach
msc += $positive:You renew your portal
msc += $positive:You begin teleporting projectiles to their destination
msc += $positive:is no longer invulnerable
msc += $positive:blocks its attack
msc += $positive:sizzles in the rain
msc += $positive:gets badly buffeted
msc += $positive:Your legs become a tail as you enter the water
msc += $positive:You feel a sudden desire to slay dragons
msc += $positive:You feel weakened for a moment
msc += $positive:Your stone body feels more resilient
msc += $positive:You swoop lightly up into the air
msc += $positive:You feel very comfortable in the air
msc += $positive:The air around you leaps into flame
msc += $positive:is knocked back by the great wave of water
msc += $positive:Your.*wounds heal themselves
msc += $positive:is recalled
msc += $positive:You renew your shroud
msc += $positive:One of your tentacles grows a vicious spike
msc += $positive:A mana viper appears with a sibilant hiss
msc += $positive:melts!
msc += $positive:You extend your mandibles
msc ^= $positive:Your?.*appears? unharmed
msc += $positive:You finish merging with the rock
msc += $positive:You gain the combat prowess of a mighty hero
msc += $positive:shroud falls apart
msc += $positive:Your.*glows blue
msc += $positive:your mind becomes perfectly clear
msc += $positive:You create a blast of noxious fumes!
msc += $positive:Roots rise up to grasp you
msc += $positive:is no longer moving quickly
msc += $positive:You create a snake
msc += $positive:apparition takes form in the air
msc += $positive:The rubble rises up and takes form
msc += $positive:You begin to abjure the creatures around you
msc += $positive:You extend your aura of abjuration
msc += $positive:A divine shield forms around you
msc += $positive:Your attacks no longer feel as feeble
msc += $positive:Your shroud bends.*attack away
msc += $positive:illusion disappears in a puff of smoke
msc += $positive:A beastly little devil appears in a puff
msc += $positive:Your.*is no longer encased in ice
msc += $positive:You deflect
msc += $positive:The lightning arcs
msc += $positive:is knocked back by the lance of force
msc += $positive:is dazzled
msc += $positive:is doused terribly
msc += $positive:You summon a servant imbued with your destructive magic
msc += $positive:You are suffused with power
msc += $positive:The sheep.*panic
msc += $positive:The sheep turns to a blind rush
msc += $positive:Smoke pours from your nose
msc += $positive:The trap is out of ammunition
msc += $positive:You dart out from under the net
msc += $positive:The manticore spikes snap loose
msc += $positive:Your jumping spider.*pounces on the
msc += $positive:You are unaffected
msc += $positive:no longer looks unusually strong
msc += $positive:The area is filled with flickering shadows
msc += $positive:flinches away
msc += $positive:The.*is (deflected|repelled)
msc += $positive:Your.*is no longer paralysed.
msc += $positive:Your.*seems less confused
msc += $positive:You feel less contaminated with magical energies
msc += $positive:Your.*breaks free
msc += $positive:You feel momentarily confused
msc += $positive:That potion was really gluggy
msc += $positive:You( easily| partially)? resist
msc += $positive:Your skin crawls
msc += $positive:You draw out your weapon's spirit
msc += $positive:You catch the
msc += $positive:fails to defend (herself|himself|itself)
msc += $positive:falters for a moment
msc += $positive:You feel invigorated
msc += $positive:flops around on dry land
msc += $positive:You escape
msc += $positive:glows a violent red
msc += $positive:You emit a cloud
msc += $positive:icy envelope dissipates
msc ^= $positive:appears confused
msc += $positive:looks drowsy
msc += $positive:is caught in a (net|web)
msc += $positive:struggles to get unstuck from the (net|web)
msc += $positive:loses its grip on you
msc += $positive:looks rather.*confused
msc ^= $positive:The sentinel's mark upon you fades away
msc += $positive:The lost soul (fades away|flickers out)
msc += $positive:You turn into a creature of crystalline ice
msc ^= $positive:The.*dark mirror aura disappears
msc += $positive:is no longer berserk
msc += $positive:You wake up
msc += $positive:The grasping roots settle back into the ground
msc += $positive:The forest abruptly stops moving
msc += $positive:You feel more buoyant
msc += $positive:You fly up into the air
msc += $positive:You gasp with relief as air once again reaches your lungs
msc += $positive:A film of ice covers your body
msc += $positive:Your.*has recharged
msc += $positive:you pull free of the water engulfing you
msc += $positive:You feel a surge of unholy energy
msc += $positive:your?.*stops? burning
msc += $positive:begins to rapidly decay
msc += $positive:Your possessions no longer seem quite so burdensome
msc += $positive:You feel in control
msc += $positive:You feel odd for a moment
msc += $positive:suddenly stops moving
msc += $positive:is poisoned
msc += $positive:looks even sicker
msc += $positive:A film of ice covers your body
msc += $positive:is stunned!
msc += $positive:is flash-frozen
msc += $positive:seems to slow down
msc += $positive:is moving more slowly
msc += $positive:stops moving altogether
msc += $positive:Your skin hardens
msc += $positive:Your new body merges with your .* armour
msc += $positive:gives you a mild electric shock
msc += $positive:Eating
msc += $positive:the sound returns
msc += $positive:Your icy armour thickens
msc += $positive:The naga ritualist's toxic aura wanes
msc += $positive:Your.*pulls away from the web
msc += $positive:You become transparent for a moment
msc += $positive:is charmed
msc += $positive:Your skin feels harder
msc += $positive:Shadowy shapes form in the air around you
msc += $positive:is burned terribly
msc += $positive:[^y].*is frozen
msc += $positive:You furiously retaliate
msc += $positive:The scroll dissolves into smoke
msc ^= $positive:Your.*reflects
msc ^= $positive:You reflect
msc += $positive:is no longer unusually agile
msc += $positive:struggles to blink free from constriction
msc += $positive:You pull the items towards yourself
msc += $positive:the former slaves? thanks? you
msc += $positive:Something gets caught in the net
msc += $positive:[^y].*rots
msc += $positive:the hog turns into a human
msc += $positive:the hogs revert to their human forms
msc += $positive:You feel the strange sensation of being on two planes at once
msc += $positive:A flood of magical energy pours into your mind
msc += $positive:You feel the material plane grow further away
msc += $positive:You momentarily phase out as.*passes through you
msc += $positive:You feel less exhausted
msc ^= $positive:Your.*(resist[^a]|resists|unaffected)
msc += $positive:The flame cauterises the wound
msc += $positive:the.*last head off
msc += $positive:You carefully extract the manticore spikes from your body
msc += $positive:You melt the
msc += $positive:has finally been put to rest
msc += $positive:begins to bleed from.*wounds
msc += $positive:Your.*draws strength from
msc += $positive:You feel yourself moving faster
msc += $positive:looks sick
msc += $positive:Your feet morph into talons
msc += $positive:You grow a pair of large bovine horns
msc += $positive:You extend your transformation
msc += $positive:Your.*turns? into razor-sharp scythe blades?
msc += $positive:You conjure a globe of magical energy
msc += $positive:You imbue your battlesphere with additional charge
msc += $positive:You feel resistant
msc += $positive:You are no longer poisoned
msc += $positive:looks frightened
msc += $positive:The.*is outlined in light
msc += $positive:You feel quick
msc += $positive:You no longer feel sluggish
msc += $positive:You feel odd for a moment
msc += $positive:returns to your pack
msc += $positive:Space distorts slightly along a thin shroud covering your body
msc += $positive:You are covered in a thin layer of ice
msc += $positive:You feel (clumsy|dopey|weak) for a moment
msc += $positive:stops singing
msc += $positive:and things crawl out
msc += $positive:You feel more catlike
msc += $positive:A crackling disc of dense vapour forms in the air
msc += $positive:icy armour evaporates
msc += $positive:Your.*looks invigorated
msc += $positive:repels the curse
msc += $positive:Yoink! You pull the item towards yourself
msc += $positive:The disc of vapour around you crackles
msc += $positive:turns into a zombie
msc += $positive:You summon
msc += $positive:hydra's last head off
msc += $positive:You feel a.*surge of power
msc += $positive:magic leaks into the air
msc += $positive:You focus on the pain
msc += $positive:Your.*darts out from under the net
msc += $positive:struggles to escape constriction
msc += $positive:submits to your will
msc += $positive:You channel some magical energy
msc += $positive:is caught in the net
msc += $positive:struggles (against|to escape) the net
msc += $positive:Your magic seems less tainted
msc += $positive:You shudder from the blast and a jelly pops out
msc += $positive:looks weaker
msc += $positive:falls into the water
msc += $positive:You fade into the shadows
msc += $positive:life force is offered up
msc += $positive:is calmed by your holy aura
msc ^= $positive:You fade into invisibility
msc ^= $positive:grand avatar fades into the ether
msc ^= $positive:Your attacks are magically infused
msc ^= $positive:You feel protected from missiles
msc ^= $positive:You feel a little less hungry
msc ^= $positive:Your.*is no longer moving slowly
msc ^= $positive:You are no longer (entranced|glowing)
msc ^= $positive:You feel as if something is helping you
msc += $positive:appears in a shower of sparks
msc += $positive:Malign forces permeate your being
msc += $positive:A glowing mist starts to gather
msc ^= $positive:begin to glow red
msc ^= $positive:begin to glow brighter

#msc += $verypositive:
msc ^= $verypositive:The.*zombie.*rots away
msc += $verypositive:You feel buoyant
msc ^= $verypositive:You feel very safe from missiles
msc ^= $verypositive:You are no longer firmly anchored in space
msc += $verypositive:Magical energy flows into your mind!
msc ^= $verypositive:The terrible wounds on your body vanish
msc += $verypositive:Your.*rumbles
msc += $verypositive:You feel life flooding into your body
msc += $verypositive:You feel purified
msc += $verypositive:You feel more resilient
msc += $verypositive:You get a glimpse of the first card
msc += $verypositive:You turn into a swirling mass of dark shadows
msc += $verypositive:You feel nimbler
msc += $verypositive:the tentacle is hauled back through the portal
msc += $verypositive:You feel more in control of your magic
msc += $verypositive:releases its grip on you
msc += $verypositive:You feel magically charged
msc += $verypositive:You turn to flesh and can move again
msc += $verypositive:Your magma supply has returned
msc += $verypositive:You (blow up|destroy|kill)
msc += $verypositive:is blown up
msc += $verypositive:dies
msc += $verypositive:is destroyed
msc += $verypositive:is killed
msc += $verypositive:is incinerated
msc += $verypositive:is devoured by a tear in reality
msc += $verypositive:turns neutral
msc += $verypositive:The spatial vortex dissipates
msc += $verypositive:Your magical contamination has.*faded
msc += $verypositive:drowns
msc += $verypositive:The.*falls from the air
msc += $verypositive:The.*simulacrum vapourises
msc += $verypositive:more experienced
msc ^= $verypositive:rots away and dies
msc ^= $verypositive:You.*and break free
msc += $verypositive:The web tears apart
msc += $verypositive:You disentangle yourself
msc += $verypositive:Saving game... please wait
msc += $verypositive:You finish memorising
msc += $verypositive:You may choose your destination
msc += $verypositive:You feel yourself speed up
msc += $verypositive:You feel stealthy
msc += $verypositive:Your skill with magical items lets you calculate the power of this device
msc += $verypositive:You can move again
msc += $verypositive:The fungal colony is destroyed
msc ^= $verypositive:The starcursed mass shudders and is absorbed by its neighbour
msc ^= $verypositive:The starcursed mass shudders and withdraws
msc += $verypositive:You are no longer firmly anchored in space
msc += $verypositive:Magic courses through your body
msc += $verypositive:You have disarmed the trap
msc += $verypositive:You are healed
msc += $verypositive:Pain shudders through your arm
msc += $verypositive:You slip out of the net
msc += $verypositive:You break free from the net
msc += $verypositive:Your life force is being protected
msc += $verypositive:It is a scroll of recharging
msc += $verypositive:is converted
msc += $verypositive:It is a scroll of enchant
msc += $verypositive:That put a bit of spring back into your step
msc += $verypositive:You feel vaguely more buoyant than before
msc += $verypositive:You feel (better|faster|mighty|much better|protected|refreshed)
msc += $verypositive:You feel.* mighty all of a sudden
msc += $verypositive:You feel.*agile all of a sudden
msc += $verypositive:You feel aware of your surroundings
msc += $verypositive:You detect (creatures|items)
msc += $verypositive:You feel the corruption within you wane
msc += $verypositive:You feel perceptive
msc ^= $verypositive:You feel less confused
msc += $verypositive:You feel a little better
msc += $verypositive:You feel studious about
msc += $verypositive:You feel telepathic
msc += $verypositive:You feel your magic capacity increase
msc += $verypositive:You feel the abyssal rune guiding you out of this place
msc += $verypositive:You feel fantastic
msc += $verypositive:Found.*altar
msc += $verypositive:Found a one-way gate to the infinite horrors of the Abyss
msc += $verypositive:Found a glowing drain
msc += $verypositive:Found a gate leading back out of here
msc += $verypositive:Found a hole to the Spider Nest
msc += $verypositive:Found a frozen archway
msc += $verypositive:Found an ice covered gate leading
msc += $verypositive:Found a dark tunnel
msc += $verypositive:Found a labyrinth entrance
msc += $verypositive:Found a flagged portal
msc += $verypositive:Found an exit through the horrors of the Abyss
msc += $verypositive:Found a gateway leading out of the Abyss
msc += $verypositive:Found a gateway leading deeper into the Abyss
msc += $verypositive:Found a gate leading out of Pandemonium
msc += $verypositive:Found a gate leading to another region
msc += $verypositive:Found a gate to the Vaults
msc += $verypositive:Found a gateway
msc += $verypositive:Found a rocky tunnel leading out of this place
msc += $verypositive:Found a portal to a secret trove of treasure
msc += $verypositive:Found a magical portal
msc += $verypositive:Found a flickering gateway to a bazaar
msc += $verypositive:Found a one-way gate leading to the halls of Pandemonium
msc += $verypositive:Found a portal leading out of here
msc += $verypositive:Found.*staircase
msc += $verypositive:Found.*(Accessories|Antiques|Boutique|Distillery|Elixirs|Emporium|shop|Smithy|store)
msc += $verypositive:You feel your magical essence form a protective shroud around your flesh
msc += $verypositive:You feel your.*returning
msc += $verypositive:It is a scroll of brand weapon
msc ^= $verypositive:Your.*seems to speed up
msc += $verypositive:An interdimensional caravan has stopped on this level and set up a bazaar
msc += $verypositive:Your demonic ancestry asserts itself
msc += $verypositive:You feel (agile|clever|stronger)
msc += $verypositive:You feel more protected from negative energy

# Positive mutation - or losing bad ones
msc += $awesome:You feel more resistant
msc += $awesome:Your fur grows into a thick mane
msc += $awesome:Your magic regains its normal vibrancy
msc += $awesome:Your thick fur grows shaggy and warm
msc += $awesome:You feel more sure on your
msc += $awesome:You feel breathless
msc += $awesome:Your genes go into a fast flux
msc += $awesome:A poisonous barb forms on the end of your tail
msc += $awesome:Your wings grow larger and stronger
msc += $awesome:You feel more spiritual
msc ^= $awesome:You feel immune to rotting
msc += $awesome:Your system.*accepts artificial healing
msc += $awesome:You feel completely energised by your suffering
msc += $awesome:An ominous black mark forms on your body
msc += $awesome:You feel a strange anaesthesia
msc += $awesome:You feel saturated with power
msc += $awesome:You feel power rushing into your body
msc += $awesome:Your blood runs red-hot
msc += $awesome:Your feet have mutated into hooves
msc += $awesome:You feel power flowing into your body
msc ^= $awesome:You feel more in touch with the powers of death
msc += $awesome:Your urge to yell lessens
msc += $awesome:One of your lower tentacles grows a sharp spike
msc += $awesome:You regain control of your magic
msc += $awesome:The horns on your head grow some more
msc += $awesome:You feel less concerned about heat
msc += $awesome:You smell fire and brimstone
msc += $awesome:You begin to radiate miasma
msc += $awesome:You feel genetically stable
msc ^= $awesome:You feel a.*healthier
msc += $awesome:You feel your life force and your magical essence meld
msc ^= $awesome:You feel your magical essence form a protective shroud around your flesh
msc += $awesome:You feel your magic shroud grow more resilient
msc += $awesome:Your body becomes stretchy
msc += $awesome:Your skin becomes partially translucent
msc += $awesome:You feel less concerned
msc += $awesome:You are surrounded by darkness
msc += $awesome:Your skin functions as natural camouflage
msc += $awesome:You begin to emit a foul stench of rot and decay
msc ^= $awesome:You feel energised by your suffering
msc ^= $awesome:You feel even more energised by your suffering
msc += $awesome:Your teeth lengthen and sharpen
msc += $awesome:Your natural healing is strengthened
msc += $awesome:You begin to regenerate
msc += $awesome:You begin to radiate repulsive energy
msc += $awesome:Your repulsive radiation grows stronger
msc += $awesome:Your body's shape seems more normal
msc += $awesome:You feel the presence of a demonic guardian
msc += $awesome:Your guardian grows in power
msc += $awesome:Your scales feel tougher
msc += $awesome:Your teeth are very long and razor-sharp
msc += $awesome:You feel negative
msc += $awesome:You begin to heal more quickly
msc += $awesome:You feel healthy
msc += $awesome:You feel a little more calm
msc += $awesome:You feel nature experimenting on you
msc += $awesome:You feel a strange attunement to the structure of the dungeons
msc += $awesome:Your mouth lengthens and hardens into a beak
msc += $awesome:Fur sprouts all over your body
msc += $awesome:Your attunement to dungeon structure grows
msc += $awesome:You slip into the darkness of the dungeon
msc += $awesome:You slip further into the darkness
msc += $awesome:Your thoughts seem clearer
msc += $awesome:A wave of death washes over you
msc += $awesome:The wave of death grows in power
msc += $awesome:Sharp spines emerge from
msc += $awesome:Your vision sharpens
msc += $awesome:Your urge to shout disappears
msc ^= $awesome:scales grow over part of your
msc ^= $awesome:scales spread over more of your
msc += $awesome:scales cover you.*completely
msc += $awesome:You are partially covered in thin metallic scales
msc ^= $awesome:Something appears at your feet
msc ^= $awesome:Something appears before you
msc ^= $awesome:Your urge to shout disappears
msc += $awesome:Your metabolism slows
msc += $awesome:Your bones become.*less dense
msc += $awesome:You feel (more robust|robust|very robust)
msc += $awesome:You feel more energetic
msc += $awesome:You feel (health|insulated|stable|clean)
msc += $awesome:Your (fingernails|toenails) (lengthen|sharpen)
msc += $awesome:Your hands twist into claws
msc += $awesome:Your feet stretch into talons
msc += $awesome:Your feet thicken and deform
msc ^= $awesome:A pair of antennae grows on your head
msc ^= $awesome:The antennae on your head grow some more
msc ^= $awesome:There is a nasty taste in your mouth for a moment
msc += $awesome:Large bone plates (cover|grow|spread)
msc += $awesome:Your throat feels
msc += $awesome:Your teeth grow very long and razor-sharp
msc ^= $awesome:You feel less vulnerable
msc ^= $awesome:You no longer feel vulnerable
msc ^= $awesome:You feel a little less angry

# Other rare and awesome stuff
msc += $awesome:word of recall is interrupted
msc ^= $awesome:is protecting you
msc ^= $awesome:You are shrouded in an aura of darkness
msc += $awesome:You are surrounded by a storm
msc += $awesome:You sense an aura of extreme power
msc += $awesome:Your.*shines brightly
msc ^= $awesome:The Shining One will now bless your weapon at an altar
msc ^= $awesome:You and your allies can gain power from killing the unholy and evil
msc ^= $awesome:A divine halo surrounds you
msc += $awesome:There is a labyrinth entrance here
msc += $awesome:You adapt resistances upon receiving elemental damage
msc += $awesome:The storm surrounding you grows powerful enough to repel missiles
msc += $awesome:There is a magical portal here
msc ^= $awesome:There is a gateway to a ziggurat here
msc ^= $awesome:Fruit sprouts up around you
msc ^= $awesome:A sheep catches fire
msc += $awesome:plants?.*grows? in the rain
msc += $awesome:You are restored by drawing out deep reserves of power within
msc ^= $awesome:There is a gate to the Realm of Zot here
msc += $awesome:A monocle briefly appears
msc += $awesome:You feel an empty sense of dread
msc += $awesome:That felt like a moral victory
msc += $awesome:A shaft materialises beneath you
msc += $awesome:You draw Experience
msc += $awesome:You draw the Mercenary
msc += $awesome:Your body is suffused with negative energy
msc ^= $awesome:Qazlal will now grant you protection from an element of your choosing
msc ^= $awesome:Kikubaaqudgha will now enhance your necromancy at an altar
msc += $awesome:You rejoin the land of the living
msc += $awesome:The sixfirhy explodes in a shower of sparks
msc += $awesome:With a swish of your cloak
msc += $awesome:Some fountains start gushing blood
msc += $awesome:A genie takes form and thunders\: \"Choose your reward
msc += $awesome:You turn into a fearsome dragon
msc += $awesome:You turn into a living statue of rough stone
msc += $awesome:You manage to scramble free
msc += $awesome:Your.*(rod|wand).*glows for a moment
msc += $awesome:You sense traps nearby
msc += $awesome:You now sometimes bleed smoke when heavily injured by enemies
msc += $awesome:Your shadow now sometimes tangibly mimics your actions
msc += $awesome:You sense items nearby
msc += $awesome:Suddenly you stand beside yourself
msc += $awesome:You feel somewhat nimbler
msc += $awesome:A mystic portal forms
msc += $awesome:You may select the general direction of your translocation
msc += $awesome:It is briefly surrounded by shifting shadows
msc += $awesome:The deck has exactly five cards
msc += $awesome:You are no longer firmly anchored in space
msc += $awesome:There is a gate to the Realm of Zot here
msc += $awesome:A terribly searing pain shoots up your
msc += $awesome:Your strength has recovered
msc += $awesome:A flood of memories washes over you
msc ^= $awesome:Vehumet offers you knowledge of
msc ^= $awesome:With a loud hiss the gate opens wide
msc += $awesome:You have collected all the runes
msc += $awesome:a hidden mimic gets squished
msc += $awesome:Now go and win
msc += $awesome:You feel knowledgeable
msc += $awesome:The arc blade crackles to life
msc ^= $awesome:There is a gate leading out of Pandemonium here
msc += $awesome:You feel powerful
msc ^= $awesome:You can now
msc += $awesome:joins your ranks
msc += $awesome:Your magic begins regenerating once more
msc += $awesome:Your.*is now the
msc += $awesome:There is a glowing drain
msc ^= $awesome:There is a gateway leading out of the Abyss here
msc += $awesome:There is a sand-covered staircase here
msc += $awesome:Your.*crackles with electricity
msc ^= $awesome:This is a scroll of acquirement
msc += $awesome:You pick up the.*rune
msc += $awesome:You now have.*rune
msc += $awesome:Your.*skill increases
msc += $awesome:You have reached level
msc += $awesome:Your experience leads to an increase in your attributes
msc ^= $awesome:There is a frozen archway here
msc ^= $awesome:There is a dark tunnel here
msc ^= $awesome:There is a flagged portal here
msc ^= $awesome:There is a portal to a secret trove of treasure here
msc ^= $awesome:There is a flickering gateway to a bazaar here
msc ^= $awesome:There is an entrance to.*on this level
msc += $awesome:3 runes! That's enough to enter the realm of Zot
msc += $awesome:The lock glows eerily
msc += $awesome:Heavy smoke blows from the lock
msc += $awesome:You have escaped!
msc += $awesome:rune into the lock
msc += $awesome:With a loud hiss the gate opens wide
msc += $awesome:You sensed
msc += $awesome:You are wearing\:
msc += $awesome:With a loud hiss the gate opens wide
msc += $awesome:The shadows inhabiting this place fade forever
msc += $awesome:You have identified the last
msc += $awesome:You feel a craving for the dungeon's cuisine
msc ^= $awesome:Lugonu will now corrupt your weapon
msc ^= $awesome:You now have enough gold to petition Gozag for potion effects
msc ^= $awesome:You now have enough gold to fund merchants seeking to open stores in the dungeon

# Weapon brands/enchantment
msc ^= $awesome:A searing pain shoots up your
msc += $awesome:You hear the crackle of electricity
msc += $awesome:You see sparks fly
msc += $awesome:Your hands tingle
msc += $awesome:Your claws tingle
msc += $awesome:You feel a dreadful hunger
msc ^= $awesome:Your.*glows (green|purple|red|.*yellow)
msc += $awesome:briefly pass through it before

# You or an ally takes damage
#msc += $negative:
msc += $negative:you trip and fall down the stairs
msc += $negative:You are engulfed in blessed fire
msc += $negative:The fountain mimic splashes you
msc += $negative:Your body is twisted very painfully
msc += $negative:crushes you
msc ^= $negative:drains your
msc += $negative:Your body is distorted in a weirdly horrible way
msc += $negative:starcursed mass engulfs you
msc ^= $negative:Your.*is struck by the twisting air
msc += $negative:You are constricted
msc ^= $negative:Your.*is blasted
msc += $negative:Electricity courses through your body
msc ^= $negative:Your.*is struck by lightning
msc += $negative:You are struck by lightning
msc += $negative:silver sears your?
msc += $negative:You draw magical energy from your own body
msc += $negative:Rocks fall onto you out of nowhere
msc += $negative:You are engulfed in raging winds
msc ^= $negative:Your.*convulses
msc += $negative:You are struck by the briar patch's thorns
msc += $negative:You feel like your blood is boiling
msc += $negative:The magical storm engulfs you
msc += $negative:Your body is flooded with distortional energies
msc += $negative:You are caught in a strong localised spatial distortion
msc ^= $negative:The Shining One blasts you with cleansing flame
msc += $negative:You are struck by lightning
msc += $negative:You are caught in an extremely strong localised spatial distortion
msc += $negative:You are blasted with searing flames
msc += $negative:Your.*suffers a backlash
msc ^= $negative:Your.*is smitten
msc += $negative:You are blasted with fire
msc ^= $negative:Your.*is engulfed in
msc ^= $negative:A huge blade swings out and slices into your?
msc += $negative:Flames sear your flesh
msc += $negative:A wave of violent energy washes through your body
msc += $negative:You are caught in a localised spatial distortion
msc += $negative:The acid blast engulfs you
msc ^= $negative:Heat is drained from your body
msc += $negative:Energy rips through your body
msc += $negative:You feel you are being watched by something
msc += $negative:Unholy energy fills the air
msc += $negative:You are caught in a localised field of spatial distortion
msc += $negative:The ghost moth stares at you
msc += $negative:Your ice beast melts
msc ^= $negative:burns you
msc += $negative:Your.*burn
msc += $negative:draws from the surrounding life force
msc += $negative:The boulder beetle smashes into you
msc += $negative:You feel very cold
msc ^= $negative:The.*pierces through (you|your)
msc ^= $negative:The walls? burns? you
msc ^= $negative:Your.*is blown up
msc += $negative:The throwing net hits your
msc += $negative:Your body is suffused with distortional energy
msc += $negative:constricts your?
msc += $negative:(bites|burns|claws|freezes|gores|gores|headbutts|hits|kicks|pecks|pecks|poisons|punches) your?
msc += $negative:(shocks|skewers|slaps|smites|stings|tail-slaps|tentacle-slaps|touches|tramples|trunk-slaps) your?
# Thanks killer klowns
msc += $negative:(defenestrates|elbows|flogs|headlocks|pinches|pokes|pounds|prods|squeezes|strangle-hugs|teases|tickles|trip-wires|wrestles) your?
msc += $negative:Your.*burned by acid
msc += $negative:Your?.*is struck by the.*spines
msc += $negative:Your.*spectral.* shares its damage
msc += $negative:The.*begins to radiate
msc += $negative:The.*toxic radiance grows
msc += $negative:Your.*loses its grip
msc += $negative:The water swirls and strikes you
msc += $negative:Your.*is knocked back
msc += $negative:The shock serpent's electric aura discharges violently
msc += $negative:The lightning shocks
msc += $negative:The tentacled starspawn engulfs you
msc += $negative:The.*ugly thing engulfs you
msc ^= $negative:Your life force is offered up
msc ^= $negative:The (.*hellfire|blast of flame|blast of lightning|blast of magma|explosion) engulfs your?
msc ^= $negative:The (explosion of.*fragments|explosion of spores|fiery explosion|fireball|ghostly fireball) engulfs your?
msc ^= $negative:The (great blast of fire|plume of ash|stinking cloud) engulfs your?
msc += $negative:Pain shoots through your body
msc += $negative:Your.*is flash-frozen
msc += $negative:You writhe in agony
msc += $negative:you feel sick
msc += $negative:Something smites you
msc += $negative:The air twists around and.*strikes you
msc += $negative:You are hit by a branch
msc += $negative:You are caught in an explosion of flying shrapnel
msc += $negative:You are hit by flying rocks
msc ^= $negative:strikes at you from the darkness
msc += $negative:Your?.*burned terribly
msc += $negative:covered in liquid flames
msc += $negative:You are blasted with ice
msc += $negative:Your.*seems to slow down
msc += $negative:You are electrocuted
msc += $negative:and unravels at your touch
msc += $negative:You are struck by the.*spines
msc += $negative:The water rises up and strikes you
msc += $negative:The torrent of lightning arcs to you
msc += $negative:A root smacks your
msc += $negative:The eye of draining stares at you
msc += $negative:The orb of electricity engulfs you
msc += $negative:The barbed spikes dig painfully into your body as you move
msc += $negative:You are engulfed in (a cloud of scalding steam|flames|freezing|freezing vapours)
msc += $negative:You are engulfed in (ghostly flame|negative energy|noxious fumes|poison gas|roaring flames)
msc += $negative:A root smacks you from below
msc += $negative:Ka-crash
msc += $negative:You are frozen
msc ^= $negative:draws life force from you
msc += $negative:You have a terrible headache
msc += $negative:Your damage is reflected back at you
msc += $negative:Your body is twisted painfully
msc += $negative:Your scythe-like blades burn
msc += $negative:Your.*is splashed with acid
msc += $negative:Your.*is constricted
msc += $negative:The freed slave is burned by acid
msc += $negative:Something.*your
msc += $negative:snaps closed at you
msc += $negative:headbutts you!
msc += $negative:engulfs your
msc += $negative:You are blasted with magical energy
msc += $negative:The large rock crashes through you
msc += $negative:You are blasted!
msc += $negative:The great icy blast engulfs you
msc += $negative:is hit by a branch
msc += $negative:The wandering mushroom releases spores at your?

#monster resists
msc += $danger:completely resists
msc += $warning:resists

# For the text that describes ranged attacks and spells
msc += $takesaction:chants a haunting song
msc += $takesaction:You release an incredible blast of power in all directions
msc += $takesaction:calls upon its god to speed up
msc += $takesaction:You create a blast
msc += $takesaction:The ophan calls forth blessed flames
msc += $takesaction:You exhale
msc += $takesaction:You enter the passage of Golubria
msc += $takesaction:You conjure a prism of explosive energy
msc += $takesaction:A raging storm of fire appears
msc += $takesaction:Sojobo summons a great blast of wind
msc += $takesaction:A fierce wind blows from the fan
msc ^= $takesaction:Rupert roars wildly at you
msc += $takesaction:A fierce wind blows
msc += $takesaction:The wizard shimmers violently
msc += $takesaction:releases spores
msc += $takesaction:The giant eyeball stares at you
msc += $takesaction:You begin recalling your allies
msc += $takesaction:You begin to radiate toxic energy
msc += $takesaction:The wretched star glows turbulently
msc += $takesaction:You begin to meditate on the wall
msc += $takesaction:You dig through the rock wall
msc += $takesaction:You ignite the poison in your surroundings
msc += $takesaction:You attempt to give life to the dead
msc ^= $takesaction:hurls a stone arrow
msc += $takesaction:weaves a glowing orb of energy
msc += $takesaction:spins a strand of pure energy
msc += $takesaction:Aizul coils himself and waves his upper body at you
msc ^= $takesaction:The royal jelly spits out
msc ^= $takesaction:calls upon Beogh to heal
msc ^= $takesaction:prays to Beogh
msc ^= $takesaction:calls down the wrath of
msc ^= $takesaction:invokes the aid of Beogh
msc += $takesaction:utters an invocation to Beogh
msc += $takesaction:shining eye gazes
msc += $takesaction:orb of fire glows
msc += $takesaction:orb of fire emits
msc += $takesaction:utters an invocation to its god
msc += $takesaction:offers its life energy for powerful magic
msc += $takesaction:utters a dark prayer and points at you
msc += $takesaction:waves its arms in wide circles
msc += $takesaction:is infused with unholy energy
msc += $takesaction:shambling mangrove reaches out with a gnarled limb
msc += $takesaction:You jump-attack
msc += $takesaction:The injured rakshasa weaves a defensive illusion
msc += $takesaction:Mara seems to draw the.*out of itself
msc += $takesaction:Mara shimmers
msc += $takesaction:Your battlesphere fires
msc += $takesaction:curse skull calls on the powers of darkness
msc += $takesaction:curse skull rattles its jaw
msc += $takesaction:Your shadow mimicks your spell
msc += $takesaction:calls down the wrath of its god upon you
msc += $takesaction:invokes the aid of its god against you
msc += $takesaction:rakshasa weaves an illusion
msc += $takesaction:coils itself and waves its upper body at you
msc += $takesaction:casts a spell
msc += $takesaction:You breathe a
msc ^= $takesaction:You draw life from your surroundings
msc += $takesaction:You step out of the flow of time
msc += $takesaction:You can feel time thicken for a moment
msc += $takesaction:The flow of time bends around you
msc += $takesaction:You start singing a song of slaying
msc += $takesaction:The disc erupts in an explosion of electricity!
msc += $takesaction:and something leaps out
msc += $takesaction:You assume a fearsome visage
msc ^= $takesaction:Asterion utters an invocation to Makhleb
msc ^= $takesaction:Asterion conjures a destructive force in the name of Makhleb
msc ^= $takesaction:wizard howls an incantation
msc ^= $takesaction:draws from the surrounding life force
msc ^= $takesaction:Gastronok chants a spell
msc ^= $takesaction:(breathes|spits).*at
msc += $takesaction:You conjure a mighty blast of ice
msc += $takesaction:conjures a mighty blast of ice
msc ^= $takesaction:Your spellforged servitor (casts|conjures|launches)
msc += $takesaction:You reach into the bag
msc += $takesaction:You gaze into the crystal ball
msc += $takesaction:Your jumping spider leaps
msc ^= $takesaction:ice dragon breathes frost
msc ^= $takesaction:points at you and mumbles some strange words
msc += $takesaction:(fires|shoots|throws) [^n]
msc += $takesaction:You (fire|shoot|throw)
msc += $takesaction:(conjures|fires|gestures|plays a|radiates)
msc ^= $takesaction:mumbles some strange (prayers|words)
msc ^= $takesaction:spriggan berserker (invokes|prays to|utters an invocation to) Trog
msc ^= $takesaction:calls down the wrath of the Shining One
msc += $takesaction:casts a spell.*floats close
msc += $takesaction:offers itself to Yredelemnul
msc ^= $takesaction:launches metal splinters at you
msc += $takesaction:(Angry insects surge|Agitated ravens fly) out from beneath the
msc ^= $takesaction:begins absorbing vital energies
msc ^= $takesaction:calls forth a grand avatar
msc ^= $takesaction:exhales a fierce blast of wind
msc ^= $takesaction:curls into a ball and starts rolling
msc ^= $takesaction:You open the lid...
msc ^= $takesaction:jumps down from its now dead mount
msc ^= $takesaction:swoops through the air toward you
msc ^= $takesaction:jumping spider pounces on
msc ^= $takesaction:jumping spider leaps
msc += $takesaction:manticore flicks its tail
msc += $takesaction:You begin to abjure the creatures around you
msc ^= $takesaction:The golden eye blinks at you
msc ^= $takesaction:activates a sealing rune
msc ^= $takesaction:offers up its power
msc += $takesaction:You warp the flow of time around you
msc += $takesaction:summons
msc += $takesaction:great orb of eyes gazes at
msc += $takesaction:You radiate an aura of cold

msc ^= $godaction:Dithmenos does not appreciate your starting fires
msc += $godaction:Beogh throws an implement of electrocution at you
msc += $godaction:Beogh throws implements of electrocution at you
msc += $godaction:Beogh sends forth an army of orcs
msc += $godaction:you feel ready to understand
msc += $godaction:You feel a surge of divine interest
msc += $godaction:(Ashenzari|Beogh|Cheibriados|Dithmenos|Elyvilon|Fedhas|Gozag|Igni Ipthes|Jiyva|Kikubaaqudgha|Lugonu)
msc += $godaction:(Makhleb|Nemelex Xobeh|Okawaru|Qazlal|Sif Muna|The Shining One|Trog|Vehumet|Xom|Yredelemnul|Zin[^g])
msc ^= $godaction:(Ashenzari|Beogh|Cheibriados|Dithmenos|Elyvilon|Fedhas|Gozag|Igni Ipthes|Jiyva|Kikubaaqudgha|Lugonu) says
msc ^= $godaction:(Makhleb|Nemelex Xobeh|Okawaru|Qazlal|Sif Muna|The Shining One|Trog|Vehumet|Xom|Yredelemnul|Zin[^g]) says
msc ^= $godaction:Your divine halo returns
msc += $godaction:is distracted by the nearby gold
msc += $godaction:soul is now ripe for the taking
msc += $godaction:sets up shop in the Dungeon
msc ^= $godaction:You redirect
msc ^= $godaction:You feel protected from physical attacks
msc ^= $godaction:You feel protected from cold
msc ^= $godaction:You feel protected from fire
msc ^= $godaction:You feel protected from electricity
msc += $godaction:resistances upon receiving elemental damage
msc += $godaction:A storm cloud blasts the area with cutting wind
msc += $godaction:A blizzard blasts the area with ice
msc += $godaction:Magma suddenly erupts from the ground
msc ^= $godaction:Xom calls
msc += $godaction:The storm around you weakens
msc += $godaction:The ground shakes violently
msc += $godaction:The storm around you strengthens
msc += $godaction:due to Igni's heat
msc += $godaction:A mighty gale blasts forth
msc += $godaction:A fiery fortress appears around you!
msc += $godaction:is consumed in a column of flame
msc += $godaction:The toadstool can now pick up its mycelia and move
msc += $godaction:Slime for the Slime God
msc ^= $godaction:Cheibriados rebukes [^y]
msc ^= $godaction:You hear Xom
msc ^= $godaction:Go forth and redecorate
msc += $godaction:This is a.*sacrifice
msc ^= $godaction:Xom.*touches
msc ^= $godaction:You need some minor
msc ^= $godaction:Let me alter your
msc ^= $godaction:Xom complains about the scenery
msc ^= $godaction:Xom howls with laughter
msc ^= $godaction:This place needs a little more atmosphere
msc ^= $godaction:The area is suffused with divine lightning
msc ^= $godaction:Let's go for a ride
msc ^= $godaction:Xom momentarily opens a gate
msc ^= $godaction:Where it stops
msc ^= $godaction:\"First here. now there\.\"
msc ^= $godaction:\"Over there now!\"
msc ^= $godaction:Serve the toy. my child
msc ^= $godaction:Fight to survive. mortal
msc ^= $godaction:Xom opens a gate
msc ^= $godaction:Xom slaps you with
msc ^= $godaction:You hear crickets chirping
msc ^= $godaction:Get over here
msc ^= $godaction:Go forth and destroy
msc ^= $godaction:Xom laughs nastily
msc ^= $godaction:Everything around seems to assume a strange transparency
msc ^= $godaction:You feel watched
msc ^= $godaction:The walls suddenly lose part of their structure
msc ^= $godaction:You are now a BORING thing
msc ^= $godaction:Xom makes a sudden noise
msc ^= $godaction:Xom roars with laughter
msc ^= $godaction:You feel someone pinching you\. As you turn. you see no one
msc ^= $godaction:\"Try this\.\"
msc ^= $godaction:\"Whee!\"
msc ^= $godaction:\"Catch!\"
msc ^= $godaction:\"Here.\"
msc ^= $godaction:\"Boo!\"
msc ^= $godaction:\"Tag. you\'re it!\"
msc ^= $godaction:\"Boring in life. Boring in death\"
msc ^= $godaction:\"This might be better!\"
msc ^= $godaction:\"I like them better like this\.\"
msc ^= $godaction:\"Heh heh heh\.\.\.\"
msc ^= $godaction:\"Burn. baby. burn!\"
msc ^= $godaction:\"Time to have some fun!\"
msc ^= $godaction:\"Have a taste of chaos. mortal\.\"
msc ^= $godaction:\"See what I see. my child!\"
msc ^= $godaction:\"Just a minor improvement\.\.\.\"
msc ^= $godaction:\"Hum-dee-hum-dee-hum\.\.\.\"
msc ^= $godaction:\"There. this looks better\.\"
msc ^= $godaction:\"You have grown too confident for your meagre worth\.\"
msc ^= $godaction:\"Take this token of my esteem\.\"
msc ^= $godaction:\"Take this instrument of something!\"
msc ^= $godaction:\"See what I see. my child!\"
msc ^= $godaction:\"What!\? Thats's it\?!\"c
msc ^= $godaction:\"Serve the (mortal|toy). my (child|children)!\"
msc ^= $godaction:Let\'s see if it\'s strong enough to survive yet
--These don't seem to work, maybe a bug?
msc ^= $boring:disappears without a glow
msc ^= $boring:disappears without a sign
msc ^= $boring:glow with a rainbow of weird colours and disappear
msc ^= $boring:glows slightly and disappears
msc ^= $boring:is slowly consumed by flames
msc ^= $boring:slowly burns to ash
msc ^= $boring:slowly crumbles into the ground
msc ^= $boring:shimmers? and breaks? into pieces
msc ^= $boring:disappears into the void
msc ^= $boring:stares at you suspiciously for a moment
msc += $boring:trembles before you
msc += $boring:You feel mildly nauseous
msc += $boring:Multicoloured lights dance around

# Interface Messages - These shouldn't take any turns
msc += $interface:You cannot read scrolls
msc += $interface:You cannot drink potions
msc += $interface:too exhausted to
msc += $interface:There are no objects that can be picked up here
msc += $interface:Calm down first
msc += $interface:You enter a permanent teleport trap
msc += $interface:too cloudy to do that here
msc += $interface:A powerful magic interferes with the creation of the passage
msc += $interface:You cannot apport that
msc += $interface:The film of ice won't work on stone
msc += $interface:You see nothing there to enslave the soul of
msc += $interface:There isn't anything that you can close there
msc += $interface:Choose some type of armour to enchant
msc += $interface:You can't place the prism on a creature
msc += $interface:You are too depleted to cast spells recklessly
msc += $interface:It's stuck to you
msc += $interface:You're in a travel-excluded area
msc += $interface:You are unable to make a sound
msc += $interface:Choose an unidentified item
msc += $interface:There is nothing here that can be animated
msc += $interface:No.*are visible
msc += $interface:No evolvable flora in sight
msc += $interface:You must target a plant or fungus
msc += $interface:No target in range
msc += $interface:This is a.*deck
msc += $interface:No exploration algorithm can help you here
msc += $interface:You cannot walk through the dense trees
msc += $interface:This wall is too hard to dig through
msc += $interface:You can't dig through that
msc += $interface:You are already wielding that
msc ^= $interface:Something interferes with your magic
msc += $interface:You can only heal others!
msc += $interface:You are already wielding that
msc += $interface:You don't know.*spells?
msc += $interface:That is presently inert
msc += $interface:That isn't a deck
msc += $interface:Reset throwing quiver to default
msc += $interface:You can't memorise that many levels of magic yet
msc += $interface:You aren't wielding a weapon
msc += $interface:You'd need your.*free
msc += $interface:I'll put part of them outside for you
msc += $interface:You're in a travel-excluded area. stopping explore
msc += $interface:There is a passage of Golubria here
msc += $interface:you can't auto-travel out of here
msc += $interface:waypoint
msc += $interface:You aren't in the Abyss
msc += $interface:You haven't found any runes yet
msc += $interface:This weapon is holy and will not allow you to wield it
msc += $interface:Huh\?
msc += $interface:You can't drink
msc += $interface:You cannot cast that spell in your current form
msc ^= $interface:is stuck to you
msc += $interface:is melded into your body
msc ^= $interface:Your.*feels? slithery
msc += $interface:You can't wear anything in your present form
msc += $interface:You're too inexperienced to learn that spell
msc += $interface:You're already wearing two cursed rings
msc += $interface:You need a rune to enter this place
msc ^= $interface:There is an ice covered gate leading back out of here here
msc += $interface:The bosom of this dungeon contains the most powerful artefact
msc += $interface:Clearing travel trail
msc += $interface:Your pack is full
msc += $interface:You can't pick everything up
msc += $interface:Could not pick up an item
msc += $interface:You can't carry that many items
msc += $interface:You enter the Abyss
msc += $interface:You enter the halls of Pandemonium
msc += $interface:This wand has
msc += $interface:That is beyond the maximum range
msc += $interface:You can't (drink|read) that
msc += $interface:You cannot shoot.*while held in a net
msc += $interface:You're already here
msc += $interface:You can't do that
msc += $interface:Cleared annotation
msc += $interface:You have no means to grasp a wand firmly enough
msc += $interface:Choose a valid weapon
msc += $interface:No previous command
msc += $interface:You sense a monster
msc += $interface:Welcome
msc += $interface:There is a.*trap here
msc += $interface:There is a.*(entrance).*here
msc += $interface:That item cannot be evoked
msc += $interface:Please enjoy your stay
msc += $interface:You now have enough gold to buy
msc += $interface:Showing terrain only
msc += $interface:Returning to normal view
msc += $interface:Done exploring
msc += $interface:You pace your travel speed to your slowest ally
msc += $interface:The water rises up and takes form
msc += $interface:The winds coalesce and take form
msc += $interface:The.*answers the.*call
msc += $interface:You're too full
msc += $interface:Your memorisation is interrupted
msc += $interface:surroundings become eerily quiet
msc += $interface:You fall into the shallow water
msc += $interface:an escape hatch
msc += $interface:You stop dropping stuff
msc += $interface:melds into your body
msc += $interface:Clearing level map
msc += $interface:There's nothing close enough
msc += $interface:Autopickup is now
msc += $interface:Hurry and find it before the portal
msc += $interface:You slide downwards
msc += $interface:Can't find anything matching that
msc += $interface:No item to drop
msc += $interface:you feel a great hunger. Being not satiated
msc += $interface:You finish taking off
msc += $interface:appears from thin air
msc += $interface:You feel more attuned to
msc += $interface:(Attack!|Fall back!|Follow me!|Stop fighting!|Wait here!)
msc += $interface:You have finished your manual
msc += $interface:You have no appropriate body parts free
msc ^= $interface:You finish putting on
msc += $interface:isn't holding a weapon that can be rebranded
msc += $interface:You feel the dreadful sensation subside
msc += $interface:You feel an oppressive heat about you
msc += $interface:You travel at normal speed
msc += $interface:Your reserves of magic are already full
msc += $interface:There are no corpses nearby
msc += $interface:No target in view
msc += $interface:It (is|was) a (potion|scroll)
msc += $interface:Aborting
msc += $interface:Created macro
msc += $interface:Saving macro


# 3-k Message Channels
# --------------------

#Channels
#channel.plain =
channel.prompt = $interface
channel.god = $godaction
channel.duration = $warning
channel.danger = $danger
channel.warning = $danger
channel.recovery = $verypositive
channel.talk = mute
channel.talk_visual = $boring
channel.timed_portal = $warning
channel.intrinsic_gain = $awesome
#channel.mutation = --either danger/warning/awesome
channel.monster_spell = $takesaction
#channel.monster_enchant = --either danger/warning/boring/takesaction
channel.friend_spell = $takesaction
#channel.friend_enchant = --either danger/warning/boring/takesaction
channel.friend_action = $takesaction
channel.monster_damage = mute
#channel.banishment = --either positive or danger
channel.equipment = $interface
#channel.floor =
channel.multiturn = $boring
#channel.examine =
#channel.examine_filter =
#channel.diagnostics =
#channel.error =
#channel.tutorial =
channel.orb = $awesome
#channel.hell_effect = -either danger/warning/boring


#### MUTES Be careful with these! Last, so they override the rest
msc ^= mute:plain:No target in view!
msc ^= mute:There is a.*door here

# Unnecessary
msc ^= mute:HP restored
msc ^= mute:Magic restored
msc ^= mute:A chill wind blows around you
msc ^= mute:The.*dissolves into shadows
msc ^= mute:The (bush|fungus|plant) is (engulfed|struck)
#msc ^= mute:Cast which spell
msc ^= mute:Use which ability
msc ^= mute:Evoke which item
#msc ^= mute:Confirm with
msc ^= mute:You can\'t see any susceptible monsters within range
msc ^= mute:for a list of commands and other information
msc ^= mute:You swap places
msc ^= mute:Your.*spectral.*disappears
msc ^= mute:There is an open.*door here


msc ^= mute:Moving in this stuff is going to be slow
msc ^= mute:You enter the shallow water
msc ^= mute:There is a.*(staircase).*here

msc ^= mute:is lightly (damaged|wounded)
msc ^= mute:is moderately (damaged|wounded)
msc ^= mute:is heavily (damaged|wounded)
msc ^= mute:is severely (damaged|wounded)
msc ^= mute:is almost (dead|destroyed)

msc ^= mute:Was it this warm in here before
msc ^= mute:The flames dance
msc ^= mute:Your shadow attacks
msc ^= mute:Marking area around
msc ^= mute:Placed new exclusion
msc ^= mute:Reduced exclusion size to a single square
msc ^= mute:Removed exclusion
msc ^= mute:You can access your shopping list by pressing
msc ^= mute:As you enter the labyrinth
msc ^= mute:previously moving walls settle noisily into place
msc ^= mute:The plant looks sick
msc ^= mute:Shift\-Dir \- straight line
msc ^= mute:Your foxfire dissipates
msc ^= mute:evades? a web
msc ^= mute:An electric hum fills the air
msc ^= mute:You pick up a book of
msc ^= mute:accepts your kill
msc ^= mute:Okawaru is honoured by your kill
msc ^= mute:you see here a.*corpse

############################### End rc/display.rc ###############################
##########################################################################################

################################### Begin rc/fm-messages.rc ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
more := force_more_message
flash := flash_screen_message

# Remove annoying defaults
more -= You have reached level
more -= The lock glows eerily
more -= Heavy smoke blows from the lock
more -= The gate opens wide
more -= With a soft hiss the gate opens wide
more -= You pick up the .* rune and feel its power
more -= welcomes you( back)?!

# Significant spells/effects ending
more += is no longer charmed
more += You.*re starting to lose your buoyancy
# Death's Door
more += time is.*running out
more += life is in your own
# Death channel
more += unholy channel is weakening

# Monsters doing things
more += monster_warning:wielding.*of (distortion|chaos)
more += monster_warning:carrying a wand of
more += monster_warning:curare
more += begins to recite a word of recall
more += There is.*feeling in your soul
more += wretched star pulses
more += Strange energies course through your body

flash += doors? slams? shut
flash += blows.*on a signal horn
flash += Deactivating autopickup
flash += Its appearance distorts for a moment
flash += The.*offers itself to Yredelemnul
flash += The forest starts to sway and rumble
flash += Your?.*suddenly stops? moving


# Crowd control
more += You.*((?<!(too|less)).*confused
more += You.*|(?<!(hands|graspers) slow.*down|lose consciousness)
more += infuriates you
more += hits you.*distortion
more += Space.*around you
more += surroundings become eerily quiet
more += Your limbs are stiffening

flash += You.*(blown|knocked back|mesmerised|trampled|stumble backwards|encased)
flash += Your magical (effects|defenses) are (unraveling|stripped away)
flash += You stop (a|de)scending the stairs
flash += A sentinel's mark forms upon you
flash += The pull of.*song draws you forward
flash += The.*engulfs you in water

# Clouds
more += danger:(calcify|mutagenic)
more += You.*re engulfed in.*miasma
flash += Miasma billows from the

# You Screwed Up
more += is no longer ready
more += You really shouldn't be using
more += You don't have enough magic to cast this spell
flash += Your body shudders with the violent release
flash += power of Zot

# Found something important
more += Found.*the Ecumenical Temple
more += walls and floor vibrate strangely for a moment
more += Found.*(treasure|bazaar|ziggurat)
more += .*resides here
more += You have a vision of.*gates?
more += byssal rune
flash += timed_portal:.*

# Translocations
more += danger:sense of stasis
more += Your surroundings.*(different|flicker)
more += You.*re suddenly pulled into a different region
flash += You blink
flash += danger:You feel strangely .*stable
flash += delayed

# Big damage
more += MASSIVE DAMAGE!!
more += your body is wracked
more += Ouch! That really hurt!
more += The poison in your body grows stronger
more += You.*re lethally poisoned
more += danger:You convulse
more += You feel a (horrible|terrible) chill
more += Your.*terribly
more += You are.*terribly

# Hit by something
more += Terrible wounds open
more += The air around.*erupts in flames
more += The air twists around and violently strikes you in flight
more += You shudder from the earth-shattering force
more += You feel.*(?<!less).*( haunted| rot| vulnerable)
flash += danger:corrodes you
flash += Your damage is reflected back at you
flash += (?<!You.*)reflects

# FYI
more += seems mollified
more += You have finished your manual

# Unexpected monsters
more += appears in a (shower|flash)
more += appears out of thin air
more += You sense the presence of something unfriendly
more += Wisps of shadow swirl around

# Misc
more += hell effect:.*
more += god:wrath finds you
more += The walls disappear

# Ashenzari
more += god:Ashenzari invites you to partake
# Dithmenos
more += god:You are shrouded in an aura of darkness
more += god:You now sometimes bleed smoke
more += god:You.*no longer.*bleed smoke
more += god:Your shadow no longer tangibly mimics your actions
more += god:Your shadow now sometimes tangibly mimics your actions
# Fedhas
more += god:Fedhas invokes the elements against you
# Jivya
more += god:will now unseal the treasures of the Slime Pits
more += god:Jiyva alters your body
# Kikubaaqudgha
more += god:Kikubaaqudgha will grant you
# Lugonu
more += god:Lugonu will now corrupt your weapon
more += god:Lugonu sends minions to punish you
# Okawaru
more += god:Okawaru sends forces against you
# Qazlal
flash += god:resistances upon receiving elemental damage
flash += god:You are surrounded by a storm which can block enemy attacks
# The Shining One
more += god:Your divine shield starts to fade
more += god:Your divine shield fades away
# Trog
more += god:You feel the effects of Trog's Hand fading
more += god:You feel less resistant to hostile enchantments
# Xom
more += staircase.*moves
more += Some monsters swap places
# Yredelemnul
more += god:soul is no.* ripe for the taking
more += god:dark mirror aura disappears
# Zin
more += god:will now cure all your mutations


{
-- Exclusions; for built-in force_mores that can't just be -='d
local fm_exclude_messages = {
  "Okawaru grants you throwing weapons",
  "Okawaru offers you a choice",
  "need to enable at least one skill for training",
} -- fm_exclude_messages (do not remove this comment)

function c_message_fm_exclude(text, _)
  for _,v in ipairs(fm_exclude_messages) do
    if text:find(v) then
      crawl.enable_more(false)
      return
    end
  end

  crawl.enable_more(true)
end
}

############################### End rc/fm-messages.rc ###############################
##########################################################################################

################################### Begin rc/macros.rc ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
bindkey = [~] CMD_LUA_CONSOLE

# Numpad keymaps
macros += K \{-1019} f
macros += K \{-1018} 3
macros += K \{-1016} \{9}
macros += K \{-1015} 2
macros += K \{-1012} 1
macros += K \{-1010} o
macros += K \{-1000} .
macros += K \{-247} 5
macros += K2 \{-1019} .

# Spellcasting macros
macros += M 1 za
macros += M 2 zb
macros += M 3 zc
macros += M 4 zd
macros += M 6 zf
macros += M 7 zg
macros += M 8 zh
macros += M 9 zi
macros += M 0 zj

# Confirm targeting with same keys as spellcasting
macros += K2 \{-1018} \{13}
macros += K2 \{-1015} \{13}
macros += K2 \{-1012} \{13}
macros += K2 1 \{13}
macros += K2 2 \{13}
macros += K2 4 \{13}
macros += K2 6 \{13}
macros += K2 7 \{13}
macros += K2 8 \{13}
macros += K2 9 \{13}
macros += K2 0 \{13}

############################### End rc/macros.rc ###############################
##########################################################################################

################################### Begin rc/runrest.rc ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
# Aliases
stop := runrest_stop_message
ignore := runrest_ignore_message

# Ignore these stops
interrupt_travel -= sense_monster
interrupt_travel -= mimic
ignore ^= "sense a monster nearby"

# Monsters to ignore at a distance
runrest_ignore_monster += fire vortex:1

# Stop for consumables you want to use immediately
stop += potions? of experience
stop += scrolls? of acquirement

# Don't stop for noisy doors unless someone shouts back
stop -= it creaks loudly
stop -= flies open with a bang
stop += You hear

# Re-enable stops for all ally actions then ignore some
ignore -= friend_action:
ignore -= friend_spell:
ignore -= friend_enchant:
ignore ^= butterfly disappears
ignore ^= friend_action:(a|the) web
ignore ^= friend_action:(seems|blinks)
stop += friend_action:
stop += friend_spell:
stop += friend_enchant:
stop += appears from out of your range of vision
stop += hits your
stop += our.*is destroyed

# Expiring effects; Turn on transmutation|flight|swiftness ending and ignore the rest
ignore -= transformation is almost over\.
ignore -= transformation has ended\.
ignore -= revert to a slightly less stony form\.
ignore -= revert to your normal fleshy form\.
ignore -= You feel yourself come back to life
ignore ^= unholy channel is weakening
ignore ^= magical contamination.*faded
ignore ^= our foxfire dissipates
stop ^= transformation is almost over
stop ^= transformation has ended
stop ^= revert to a slightly less stony form\.
stop ^= revert to your normal fleshy form
stop ^= feel yourself come back to life
stop ^= unholy channel expires
stop ^= are starting to lose your buoyancy
stop ^= feel.*sluggish
# Expiring effects for friends too
stop ^= no longer petrified
ignore ^= no longer.*(covered in acid|unusually strong)
ignore ^= looks more healthy

# Misc
stop -= You now have enough gold to
stop ^= timed_portal:.*
ignore ^= nearby plant withers and dies
ignore ^= disentangle yourself
ignore ^= You swap places.

# Summonings
ignore ^= our.*crimson imp blinks
ignore ^= our.*simulacrum vaporises
ignore ^= our.*returns to the shadows of the Dungeon
ignore ^= our.*skeleton crumbles into dust
ignore ^= our.*fades into mist
ignore ^= our.*looks more healthy
ignore ^= our.*is no longer (corroded|moving slowly)
ignore ^= our.*dissolves into a puddle of slime

# Ru
stop += god:Ru believes you are ready to make a new sacrifice
# Hepliaklqana
ignore ^= emerges from the mists of memory
# Wu Jian Council
ignore += heavenly storm settles

############################### End rc/runrest.rc ###############################
##########################################################################################

################################### Begin rc/slot-defaults.rc ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
####### Item Slots #########
# Rings to P/p for easy swapping
item_slot += ring of:Pp

# ignored: degeneration, noise, torment
# unassigned slots: d, e, k, F
item_slot ^= scroll of acquirement:q
item_slot ^= scroll of amnesia:E
item_slot ^= scroll of blinking:B
item_slot ^= scroll of brand weapon:D
item_slot ^= scroll of butterflies:s
item_slot ^= scroll of enchant armour:u
item_slot ^= scroll of enchant weapon:W
item_slot ^= scroll of fear:f
item_slot ^= scroll of fog:F
item_slot ^= scroll of identify:i
item_slot ^= scroll of immolation:o
item_slot ^= scroll of revelation:j
item_slot ^= scroll of poison:y
item_slot ^= scroll of silence:S
item_slot ^= scroll of summoning:s
item_slot ^= scroll of teleportation:t
item_slot ^= scroll of vulnerability:v

item_slot ^= potion of ambrosia:A
item_slot ^= potion of attraction:n
item_slot ^= potion of berserk rage:z
item_slot ^= potion of brilliance:R
item_slot ^= potion of cancellation:C
item_slot ^= potion of curing:c
item_slot ^= potion of experience:x
item_slot ^= potion of enlightenment:g
item_slot ^= potion of haste:H
item_slot ^= potion of heal wounds:h
item_slot ^= potion of invisibility:I
item_slot ^= potion of lignification:l
item_slot ^= potion of magic:M
item_slot ^= potion of might:m
item_slot ^= potion of resistance:r
item_slot ^= potion of mutation:U

item_slot ^= condenser vane:V
item_slot ^= phial of floods:O
item_slot ^= phantom mirror:N
item_slot ^= box of beasts:X
item_slot ^= tin of tremorstones:T
item_slot ^= lightning rod:L

item_slot ^= wand of digging:K
item_slot ^= wand of flame:Q
item_slot ^= wand of mindburst:Y
item_slot ^= wand of acid:G
item_slot ^= wand of light:G
item_slot ^= wand of quicksilver:G
item_slot ^= wand of iceblast:Z
item_slot ^= wand of roots:Z
item_slot ^= wand of charming:J
item_slot ^= wand of paralysis:J



######## Spell Slots #########
spell_slot ^= Alistair's Intoxication:AITX
spell_slot ^= Alistairâ€™s Walking Alembic:AWKLMBSTEI
spell_slot ^= Anguish:ANGUISH
spell_slot ^= Animate Armour:ANMT
spell_slot ^= Animate Dead:ADNMT
spell_slot ^= Arcjolt:AJCOLT
spell_slot ^= Blink:BLNK
spell_slot ^= Borgnjor's Revivification:BRVF
spell_slot ^= Call Canine Familiar:CFN
spell_slot ^= Call Imp:ICMP
spell_slot ^= Cause Fear:CFSUR
spell_slot ^= Chain Lightning:LCHGNT
spell_slot ^= Cigotuvi's Dreadful Rot:CDRVT
spell_slot ^= Confusing Touch:CTF
spell_slot ^= Conjure Ball Lightning:BLCTN
spell_slot ^= Construct Spike Launcher:CSLPKNRAUE
spell_slot ^= Corpse Rot:CRPS
spell_slot ^= Dazzling Flash:DZFLSHNG
spell_slot ^= Death Channel:DCNL
spell_slot ^= Death's Door:DROTHEA
spell_slot ^= Detonation Catalyst:DCTNYTSAEO
spell_slot ^= Diamond Sawblades:DSWBLNIAO
spell_slot ^= Discord:DISCORD
spell_slot ^= Disjunction:DJNIS
spell_slot ^= Dispersal:DPLIS
spell_slot ^= Dragon's Call:DCRGN
spell_slot ^= Forge Monarch Bomb:FMBONRCHGEA
spell_slot ^= Forge Phalanx Beetle:FPBENXORG
spell_slot ^= Fortress Blast:FBRTSLA
spell_slot ^= Foxfire:FXOIRE
spell_slot ^= Fugue of the Fallen:FUGALNE
spell_slot ^= Fulsome Fusillade:FLSOMADE
spell_slot ^= Hoarfrost Cannonade:HCORFND
spell_slot ^= Ice Form:IFORM
spell_slot ^= Ignite Poison:IPOSN
spell_slot ^= Ignition:IGNTO
spell_slot ^= Infestation:INFESTAON
spell_slot ^= Irradiate:IRADTE
spell_slot ^= Iskenderun's Battlespehere:BSI
spell_slot ^= Iskenderun's Mystic Blast:IMB
spell_slot ^= Jinxbite:JNXBITE
spell_slot ^= Leda's Liquefaction:LQFND
spell_slot ^= Malign Gateway:MGWTN
spell_slot ^= Manifold Assault:MANFT
spell_slot ^= Martyr's Knell:MKNARTYEL
spell_slot ^= Maxwell's Capacitive Coupling:MCXW
spell_slot ^= Metabolic Englaciation:MENC
spell_slot ^= Monstrous Menagerie:MNGR
spell_slot ^= Nazjaâ€™s Percussive Tempering:NPTZJACUE
spell_slot ^= Olgreb's Toxic Radiance:TOR
spell_slot ^= Ozocubu's Armour:OAMR
spell_slot ^= Ozocubu's Refrigeration:ROZFG
spell_slot ^= Permafrost Eruption:PERUTFMAOSTIN
spell_slot ^= Platinum Paragon:PLTGNMAO
spell_slot ^= Polar Vortex:PVXT
spell_slot ^= Rending Blade:RBENDALG
spell_slot ^= Scorch:SCORH
spell_slot ^= Shatter:SHTR
spell_slot ^= Sigil of Binding:SBGILDNG
spell_slot ^= Silence:SICL
spell_slot ^= Spellforged Servitor:SVFR
spell_slot ^= Sphinx Sisters:SPHINXR
spell_slot ^= Starburst:SBUT
spell_slot ^= Static Discharge:DSCGT
spell_slot ^= Sublimation of Blood:SBLM
spell_slot ^= Summon Blazeheart Golem:SBGLZOM
spell_slot ^= Summon Cactus Giant:CGS
spell_slot ^= Summon Forest:FSRTM
spell_slot ^= Summon Horrible Things:HST
spell_slot ^= Summon Hydra:HYDRA
spell_slot ^= Summon Ice Beast:ISB
spell_slot ^= Summon Lightning Spire:SMLIRNG
spell_slot ^= Summon Mana Viper:MSV
spell_slot ^= Summon Seismosaurus Egg:EGSMIEOAU
spell_slot ^= Summon Small Mammal:SMLAUON
spell_slot ^= Swiftness:SWIFT
spell_slot ^= Volatile Blastmotes:VBOLMASTE
:if CACHE.class == "Summoner" then
  spell_slot ^= (summon|call):abcdefgh
:end

############################### End rc/slot-defaults.rc ###############################
##########################################################################################

## (Resuming init.txt) ##

### Features ###

################################### Begin lua/after-shaft.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{

----- Add stops for stairs after being shafted -----
create_persistent_data("as_shaft_depth", 0)
create_persistent_data("as_shaft_branch", "NA")

-- Initial logic to maintain persistent state
if as_shaft_depth ~= 0 then
  crawl.setopt("explore_stop += stairs")
else
  crawl.setopt("explore_stop -= stairs")
end


------------------- Hooks -------------------
function c_message_after_shaft(text, _)
  if as_shaft_depth ~= 0 then return end
  if text:find("fall into a shaft") then
    as_shaft_depth = you.depth()
    as_shaft_branch = you.branch()
    crawl.setopt("explore_stop += stairs")
  end
end

function ready_after_shaft()
  if as_shaft_depth ~= 0 then
    if you.depth() == as_shaft_depth and you.branch() == as_shaft_branch then
      crawl.setopt("explore_stop -= stairs")
      as_shaft_depth = 0
      as_shaft_branch = "NA"
    end
  end
end

}
############################### End lua/after-shaft.lua ###############################
##########################################################################################

################################### Begin lua/announce-damage.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
----- Initially from https://github.com/magus/dcss -----

function delta_color(delta)
  local color = delta < 0 and COLORS.red or COLORS.green
  local signDelta = delta < 0 and delta or "+"..delta
  return string.format("<%s>%s</%s>", color, signDelta, color)
end

function colorize_text(color, text)
  return string.format("<%s>%s</%s>", color, text, color)
end

local AD_Messages = {
  ["HPSimple"] = function(delta)
    return colorize_text(COLORS.white,
      string.format("HP[%s]", delta_color(0 - delta))
    )
  end,
  ["HPMax"] = function (_, _, hpm, delta)
    crawl.mpr(
      colorize_text(COLORS.lightgreen,
        string.format("You have %s max hp (%s).", hpm, delta_color(delta))
      )
    )
  end,
  ["HPLoss"] = function (color, hp, hpm, loss)
    crawl.mpr(
      string.format("%s%s",
        colorize_text(COLORS.red, string.format("You take %s damage,", loss)),
        colorize_text(color, string.format(" and have %s/%s hp.", hp, hpm))
      )
    )
  end,
  ["HPGain"] = function (color, hp, hpm, gain)
    crawl.mpr(
      string.format("%s%s",
        colorize_text(COLORS.lightgreen, string.format("You gained %s hp,", gain)),
        colorize_text(color, string.format(" and have %s/%s hp.", hp, hpm))
      )
    )
  end,
  ["HPFull"] = function (_, hp)
    crawl.mpr(
      colorize_text(COLORS.lightgreen,
        string.format("Your hp is full (%s).", hp)
      )
    )
  end,
  ["HPMassive"] = function ()
    crawl.mpr(
      colorize_text(COLORS.lightred, "MASSIVE DAMAGE!!")
    )
  end,
  ["MPSimple"] = function(delta)
    return colorize_text(COLORS.white,
      string.format("MP[%s]", delta_color(0 - delta))
    )
  end,
  ["MPLoss"] = function (color, mp, mpm, loss)
    crawl.mpr(
      string.format("%s%s",
        colorize_text(COLORS.cyan, string.format("You lost %s mp,", loss)),
        colorize_text(color, string.format(" and have %s/%s mp.", mp, mpm))
      )
    )
  end,
  ["MPGain"] = function (color, mp, mpm, gain)
    crawl.mpr(
      string.format("%s%s",
        colorize_text(COLORS.cyan, string.format("You gained %s mp,", gain)),
        colorize_text(color, string.format(" and have %s/%s mp.", mp, mpm))
      )
    )
  end,
  ["MPFull"] = function (_, mp)
    crawl.mpr(
      colorize_text(COLORS.cyan, string.format("Your mp is full (%s).", mp))
    )
  end,
  [""]="",
} --AD_Messages (do not remove this comment)

local prev_hp = 0
local prev_hp_max = 0
local prev_mp = 0
local prev_mp_max = 0

-- Simplified condensed HP and MP output
-- Print a single condensed line showing HP & MP change
-- e.g.ðŸ˜¨ HP[-2] MP[-1]
local function simple_announce_damage(hp_diff, mp_diff)
  local emoji
  local message
  
  if hp_diff > CONFIG.ANNOUNCE_HP_THRESHOLD then
    if mp_diff > CONFIG.ANNOUNCE_MP_THRESHOLD then
      -- HP[-2] MP[-1]
      message = string.format("%s %s", AD_Messages.HPSimple(hp_diff), AD_Messages.MPSimple(mp_diff))
    else
      -- HP[-2]
      message = AD_Messages.HPSimple(hp_diff)
    end
  elseif mp_diff > CONFIG.ANNOUNCE_MP_THRESHOLD then
    -- MP[-1]
    message = AD_Messages.MPSimple(mp_diff)
  end

  if message ~= nil then
    if CACHE.hp <= (CACHE.mhp * 0.25) then
      emoji = CACHE.EMOJI.HP_CRIT
    elseif CACHE.hp <= (CACHE.mhp * 0.50) then
      emoji = CACHE.EMOJI.HP_LOW
    elseif CACHE.hp <= (CACHE.mhp *  0.75) then
      emoji = CACHE.EMOJI.HP_MID
    elseif CACHE.hp < CACHE.mhp then
      emoji = CACHE.EMOJI.HP_HIGH
    else
      emoji = CACHE.EMOJI.HP_MAX
    end
    crawl.mpr(string.format("\n%s %s %s", emoji, message, emoji))
  end
end

-- Try to sync with colors defined in Interface.rc
local function color_by_max(message_func, cur, max, diff)
  if cur <= (max * 0.25) then
    message_func(COLORS.red, cur, max, diff)
  elseif cur <= (max * 0.50) then
    message_func(COLORS.lightred, cur, max, diff)
  elseif cur <= (max *  0.75) then
    message_func(COLORS.yellow, cur, max, diff)
  else
    message_func(COLORS.lightgrey, cur, max, diff)
  end
end

function ready_announce_damage()
  --Skips message on initializing game
  if prev_hp > 0 then
    local hp_diff = prev_hp - CACHE.hp
    local mhp_diff = CACHE.mhp - prev_hp_max
    local mp_diff = prev_mp - CACHE.mp
    local mmp_diff = CACHE.mmp - prev_mp_max

    -- Simplified condensed HP and MP output
    simple_announce_damage(hp_diff, mp_diff)

    -- HP Max
    if mhp_diff > 0 then
      AD_Messages.HPMax(COLORS.green, CACHE.hp, CACHE.mhp, mhp_diff)
    elseif mhp_diff < 0 then
      AD_Messages.HPMax(COLORS.yellow, CACHE.hp, CACHE.mhp, mhp_diff)
    end

    -- HP Loss relative to max HP change
    if (hp_diff - mhp_diff > CONFIG.ANNOUNCE_HP_THRESHOLD) then
      color_by_max(AD_Messages.HPLoss, CACHE.hp, CACHE.mhp, hp_diff)

      if hp_diff > (CACHE.mhp * CONFIG.ANNOUNCE_HP_MASSIVE_THRESHOLD) then
        AD_Messages.HPMassive()
      end
    end

    -- HP Gain
    if (hp_diff - mhp_diff < -CONFIG.ANNOUNCE_HP_THRESHOLD) then
      -- Remove the negative sign by taking absolute value
      local hp_gain = math.abs(hp_diff)

      if (hp_gain > 1) and (CACHE.hp ~= CACHE.mhp) then
        color_by_max(AD_Messages.HPGain, CACHE.hp, CACHE.mhp, hp_gain)
      end

      if (CACHE.hp == CACHE.mhp) then
        AD_Messages.HPFull(nil, CACHE.hp)
      end
    end

    -- MP Gain
    -- More than 1 MP gained
    if (mp_diff - mmp_diff < -CONFIG.ANNOUNCE_MP_THRESHOLD) then
      -- Remove the negative sign by taking absolute value
      local mp_gain = math.abs(mp_diff)

      if (mp_gain > 1) and (CACHE.mp ~= CACHE.mmp) then
        color_by_max(AD_Messages.MPGain, CACHE.mp, CACHE.mmp, mp_gain)
      end

      if (CACHE.mp == CACHE.mmp) then
        AD_Messages.MPFull(nil, CACHE.mp)
      end
    end

    -- MP Loss
    -- Ensure we lost MORE than the change in max mp
    -- i.e. a change in max mp should not be considered loss
    if (mp_diff - mmp_diff > CONFIG.ANNOUNCE_MP_THRESHOLD) then
      color_by_max(AD_Messages.MPLoss, CACHE.mp, CACHE.mmp, mp_diff)
    end

  end

  --Set previous hp/mp and form at end of turn
  prev_hp = CACHE.hp
  prev_hp_max = CACHE.mhp
  prev_mp = CACHE.mp
  prev_mp_max = CACHE.mmp
end

}
############################### End lua/announce-damage.lua ###############################
##########################################################################################

################################### Begin lua/color-inscribe.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
-- Colorize inscriptions --
-- Long inscriptions can break certain menus. In-game inscriptions seem limited to 78 chars.
-- If INSCRIPTION_MAX_LENGTH is exceeded, ending tags are removed. A final tag is added to resume writing in lightgrey.

local INSCRIPTION_MAX_LENGTH = 70

local function colorize_subtext(text, s, tag)
  local idx = text:find(s)
  if not idx then return text end
  if idx > 1 then
    -- Avoid '!r' or an existing color tag
    local prev = text:sub(idx-1, idx-1)
    if prev == "!" or prev == ">" then return text end
  end

  local retval = text:gsub("("..s..")", "<"..tag..">%1</"..tag..">")
  return retval
end


local multi_plus = "%++"
local multi_minus = "%-+"
local pos_num = "%+%d+%.?%d*"
local neg_num = "%-%d+%.?%d*"
local colorize_tags = {
  { "rF"..multi_plus, COLORS.lightred },
  { "rC"..multi_plus, COLORS.lightblue },
  { "rN"..multi_plus, COLORS.lightmagenta },
  { "rF"..multi_minus, COLORS.red },
  { "rC"..multi_minus, COLORS.blue },
  { "rN"..multi_minus, COLORS.magenta },
  { "rPois", COLORS.green },
  { "rElec", COLORS.lightcyan },
  { "rCorr", COLORS.yellow },
  { "rMut", COLORS.brown },
  { "Slay"..pos_num, COLORS.white},
  {  "Str"..pos_num, COLORS.white },
  {  "Dex"..pos_num, COLORS.white },
  {  "Int"..pos_num, COLORS.white },
  {   "AC"..pos_num, COLORS.white },
  {   "EV"..pos_num, COLORS.white },
  {   "SH"..pos_num, COLORS.white },
  {   "HP"..pos_num, COLORS.white },
  {   "MP"..pos_num, COLORS.white },
  { "Slay"..neg_num, COLORS.darkgrey },
  {  "Str"..neg_num, COLORS.darkgrey },
  {  "Dex"..neg_num, COLORS.darkgrey },
  {  "Int"..neg_num, COLORS.darkgrey },
  {   "AC"..neg_num, COLORS.darkgrey },
  {   "EV"..neg_num, COLORS.darkgrey },
  {   "SH"..neg_num, COLORS.darkgrey },
  {   "HP"..neg_num, COLORS.darkgrey },
  {   "MP"..neg_num, COLORS.darkgrey },
} --colorize_tags (do not remove this comment)

------------------- Hooks -------------------
function c_assign_invletter_color_inscribe(it)
  local text = it.inscription
  for _, tag in ipairs(colorize_tags) do
    text = colorize_subtext(text, tag[1], tag[2])
  end

  if text:len() > INSCRIPTION_MAX_LENGTH then
    text = text:gsub("<.*>", "").."<7>"
  end
  it.inscribe(text, false)
end

-- To colorize more, need a way to:
  -- intercept messages before they're displayed
  -- insert tags that affect menus
  -- colorize artefact text
-- function c_message_color_inscribe(text, _)
--   local orig_text = text
--   text = colorize_subtext(text)
--   if text == orig_text then return end

--   local cleaned = cleanup_text(text)
--   if cleaned:sub(2, 4) == " - " then
--     text = " "..text
--   end

--   crawl.mpr(text)
-- end

}
############################### End lua/color-inscribe.lua ###############################
##########################################################################################

################################### Begin lua/drop-inferior.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
------- Auto-tag inferior items and add to drop list -----

local DROP_KEY = "~~DROP_ME"

crawl.setopt("drop_filter += "..DROP_KEY)

local function inscribe_drop(it)
  local new_inscr = it.inscription:gsub(DROP_KEY, "")..DROP_KEY
  it.inscribe(new_inscr, false)
end

------------------ Hook ------------------
function c_assign_invletter_drop_inferior(it)
  -- Skip brands that are potentially harmful
  local it_ego = it.ego()
  if it_ego == "distortion" or it_ego == "chaos" or it_ego == "infusion" then return end

  if not is_weapon(it) and not is_armour(it) then return end

  local risky_artefact = false
  if it.artefact then
    local qualname = it.name("qual")
    if qualname:find("%-") or qualname:find("Harm") or qualname:find("Infuse") then
      risky_artefact = true
    end
  end

  if risky_artefact then return end

  local st = it.subtype()

  for inv in iter.invent_iterator:new(items.inventory()) do
    local item_match = false
    if inv.subtype() == st then
      if is_body_armour(it) then
        if inv.encumbrance >= it.encumbrance then item_match = true end
      else
        if inv.subtype() == st then item_match = true end
      end
    end

    if not inv.artefact and item_match and (not has_ego(inv) or get_ego(inv) == get_ego(it)) then
      if is_weapon(it) then
        if inv.plus <= it.plus then inscribe_drop(inv) end
      else
        if get_armour_ac(inv) <= get_armour_ac(it) then inscribe_drop(inv) end
      end
    end
  end
end


function c_assign_invletter_exclude_dropped(it)
 -- Remove DROP_KEY inscription on pickup
  it.inscribe(it.inscription:gsub(DROP_KEY, ""), false)
end

}
############################### End lua/drop-inferior.lua ###############################
##########################################################################################

################################### Begin lua/dynamic-options.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
----- Set any options based on game state -----

local dynopt_cur_god = "No God"
local ignoring_spellcasting = false
local ignoring_spellbooks = false
local warn_early_levels = false
local warn_mid_levels = false
local warn_late_levels = false

local early_warnings = {
} -- early_warnings (do not remove this comment)

local mid_warnings = {
  "wielding.*of electrocution",
  "You.*re more poisoned"
} -- mid_warnings (do not remove this comment)

local late_warnings = {
  "(?<!You)(?<!yourself) speeds? up",
  "danger:goes berserk"
} -- late_warnings (do not remove this comment)


local function set_dyn_fm(warnings, create)
  for _, v in ipairs(warnings) do
    if create then
      crawl.setopt("force_more_message += "..v)
    else
      crawl.setopt("force_more_message -= "..v)
    end
  end
end


---- race-specific ---
local function set_race_options()
  if CACHE.undead then
    crawl.setopt("force_more_message += monster_warning:wielding.*of holy wrath")
  end

  if CACHE.poison_immune then
    crawl.setopt("force_more_message -= monster_warning:curare")
  end

  if CACHE.race == "Gnoll" then
    crawl.setopt("message_colour ^= mute:intrinsic_gain:skill increases to level")
  end
end

---- class-specific ---
local function set_class_options()
  if CACHE.class == "Hunter" then
    crawl.setopt("view_delay = 30")
  end
end

---- god-specific ----
-- force_mores that you don't mind on everyone are in fm-message.rc
local function set_god_options()
  local new_god = CACHE.god
  if new_god then
    crawl.setopt("force_more_message -= Found.*the Ecumenical Temple")
    crawl.setopt("flash_screen_message += Found.*the Ecumenical Temple")
    crawl.setopt("runrest_stop_message += Found.*the Ecumenical Temple")
  end
  if new_god ~= dynopt_cur_god then
    if new_god == "Beogh" then
      crawl.setopt("runrest_ignore_message += no longer looks.*")
      crawl.setopt("force_more_message += Your orc.*dies")
    elseif new_god == "Jiyva" then
      crawl.setopt("force_more_message += god:splits in two")
      crawl.setopt("force_more_message += god:Your prayer is over.")
      crawl.setopt("message_colour ^= mute:You hear a.*(slurping|squelching) noise")
      crawl.setopt("message_colour ^= mute:You feel a little less hungry")
    elseif new_god == "Qazlal" then
      crawl.setopt("force_more_message -= god:You feel.*protected")
    elseif new_god == "Xom" then
      crawl.setopt("force_more_message += god:")
    end

    dynopt_cur_god = new_god
  end
end

---- xl-specific ----
local function set_xl_options()
  if not warn_early_levels and CACHE.xl <= 5 then
    warn_early_levels = true
    set_dyn_fm(early_warnings, true)
  elseif warn_early_levels and CACHE.xl > 5 then
    warn_early_levels = false
    set_dyn_fm(early_warnings, false)
  end

  if not warn_mid_levels and CACHE.xl <= 10 then
    warn_mid_levels = true
    set_dyn_fm(mid_warnings, true)
  elseif warn_mid_levels and CACHE.xl > 10 then
    warn_mid_levels = false
    set_dyn_fm(mid_warnings, false)
  end

  if not warn_late_levels and CACHE.xl <= 15 then
    warn_late_levels = true
    set_dyn_fm(late_warnings, true)
  elseif not warn_late_levels and CACHE.xl > 15 then
    warn_late_levels = false
    set_dyn_fm(late_warnings, false)
  end
end


---- skill-specific ----
local function set_skill_options()
  -- Ignore spellbook reading if you have no spellcasting skill
  -- Ignore all spellcaster items if wearing heavy armour or not much armour skill
  local zero_spellcasting = CACHE.s_spellcasting == 0
  if not ignoring_spellbooks and zero_spellcasting then
    ignoring_spellbooks = true
    crawl.setopt("explore_stop_pickup_ignore += ^book of")
    crawl.setopt("runrest_ignore_message += You add the spell")
    crawl.mpr("ignoring spellbooks")
  elseif ignoring_spellbooks and not zero_spellcasting then
    ignoring_spellbooks = false
    crawl.setopt("explore_stop_pickup_ignore -= ^book of")
    crawl.setopt("runrest_ignore_message -= You add the spell")
    crawl.mpr("not ignoring spellbooks")
  end

  local arm = items.equipped_at("armour")
  local heavy_arm = zero_spellcasting and arm ~= nil and arm.encumbrance > 4 + CACHE.s_armour/2
  if not ignoring_spellcasting and heavy_arm then
    ignoring_spellcasting = true
    crawl.setopt("explore_stop_pickup_ignore += ^book of")
    crawl.setopt("autopickup_exceptions ^= >scrolls? of amnesia, >potions? of brilliance, >ring of wizardry")
    crawl.setopt("runrest_ignore_message += You add the spell")
    crawl.mpr("ignoring spellcasting")
  elseif ignoring_spellcasting and not heavy_arm then
    ignoring_spellcasting = false
    crawl.setopt("explore_stop_pickup_ignore -= ^book of")
    crawl.setopt("autopickup_exceptions -= >scrolls? of amnesia, >potions? of brilliance, >ring of wizardry")
    crawl.setopt("runrest_ignore_message -= You add the spell")
    crawl.mpr("not ignoring spellcasting")
  end
end


------------------ Hook ------------------
function ready_dynamic_options()
  if CACHE.turn == 0 then
    set_race_options()
    set_class_options()
  end

  set_god_options()
  set_xl_options()
  set_skill_options()
end

}
############################### End lua/dynamic-options.lua ###############################
##########################################################################################

################################### Begin lua/exclude-dropped.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
-- Add autopickup exclusion for any jewellery/missile/evocable item that is dropped
-- Exclusion is removed when you pick the item back up
-- Also exclude scrolls of enchant weapon/brand weapon, when no enchantable weapons are in inventory
if loaded_exclude_dropped then return end
local loaded_exclude_dropped = true

create_persistent_data("dropped_item_exclusions", "")

-- Init autopickup missiles
local started_with_ranged = false
if you.skill("Ranged Weapons") > 2 then
  for inv in iter.invent_iterator:new(items.inventory()) do
    if inv.is_ranged then
      started_with_ranged = true
      break
    end
  end
end
if not started_with_ranged then crawl.setopt("autopickup_exceptions ^= < stone, <boomerang") end
crawl.setopt("autopickup_exceptions ^= <dart, <javelin")
if CACHE.size_penalty >= SIZE_PENALTY.LARGE then crawl.setopt("autopickup_exceptions ^= <large rock") end

if dropped_item_exclusions ~= "" then crawl.setopt("autopickup_exceptions ^= "..dropped_item_exclusions) end

local function get_jewellery_name(text)
  local idx  = text:find("ring of ")
  if not idx then idx = text:find("amulet of ") end
  if not idx then return end

  text = text:gsub(" {.*}", "")
  text = text:gsub("[.]", "")
  return text:sub(idx,#text)
end

local function get_missile_name(text)
  for _,item_name in ipairs(all_missiles) do
    if text:find(item_name) then
      if item_name == "boomerang" or item_name == "javelin" then
        if text:find("silver") then
          item_name = "silver "..item_name
        elseif text:find("dispersal") then
          item_name = item_name.."s? of dispersal"
        else
          item_name = "(?<!silver )"..item_name.."(?!(s? of dispersal))"
        end
      end

      return item_name
    end
  end
end

local function get_misc_name(text)
  for _,item_name in ipairs(all_misc) do
    if text:find(item_name) then return item_name end
  end
end

local function has_enchantable_weap_in_inv()
  for inv in iter.invent_iterator:new(items.inventory()) do
    if is_weapon(inv) and inv.plus < 9 and (not inv.artefact or you.race() == "Mountain Dwarf") then
      return true
    end
  end

  return false
end

local function get_excludable_scroll_name(text)
  if text:find("enchant weapon") then
    if has_enchantable_weap_in_inv() then return end
    return "enchant weapon"
  elseif text:find("brand weapon") then
    if has_enchantable_weap_in_inv() then return end
    return "brand weapon"
  else
    local excludable = { "enchant armour", "torment", "immolation", "silence" }
    for _,v in ipairs(excludable) do
      if text:find(v) then return v end
    end
  end
end


------------------ Hook ------------------
function c_message_exclude_dropped(text, channel)
  if channel ~= "plain" then return end

  local exclude
  if text:find("You drop ") then exclude = true
  elseif text:find(" %- ") then exclude = false
  else return
  end

  local item_name = get_jewellery_name(text)
  if not item_name then item_name = get_missile_name(text) end
  if not item_name then item_name = get_misc_name(text) end
  if not item_name then item_name = get_excludable_scroll_name(text) end
  if not item_name then return end

  if exclude then
    crawl.setopt("autopickup_exceptions ^= >"..item_name)
    if dropped_item_exclusions ~= "" then dropped_item_exclusions = dropped_item_exclusions.."," end
    dropped_item_exclusions = dropped_item_exclusions..">"..item_name
  else
    crawl.setopt("autopickup_exceptions -= >"..item_name)
    -- Remove persistent exclusion (try 3 times to make sure we capture comma)
    dropped_item_exclusions = dropped_item_exclusions:gsub(",>"..item_name, "")
    dropped_item_exclusions = dropped_item_exclusions:gsub(">"..item_name..",", "")
    dropped_item_exclusions = dropped_item_exclusions:gsub(">"..item_name, "")
  end
end

}
############################### End lua/exclude-dropped.lua ###############################
##########################################################################################

################################### Begin lua/fully-rest.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
----- Fully rest off effects -----
local status_to_wait_off = { "berserk", "short of breath", "corroded", "vulnerable",
    "confused", "marked", "tree%-form", "sluggish" }

local waiting_for_recovery = false
local explore_after_recovery = false

crawl.setopt("runrest_ignore_message += recovery:.*")
crawl.setopt("runrest_ignore_message += duration:.*")

local function fully_recovered()
  -- Confirm sure HP and MP are full
  local hp, mhp = you.hp()
  if hp ~= mhp then return false end
  local mp, mmp = you.mp()
  if mp ~= mmp then return false end

  -- Statuses that will always rest off
  local status = you.status()

  for _,s in ipairs(status_to_wait_off) do
    if status:find(s) then return false end
  end

  -- If stat drain, don't wait for slow
  if status:find("slowed") then
    return CACHE.str <= 0 or CACHE.dex <= 0 or CACHE.int <= 0
  end

  return true
end

-- Attach full recovery to auto-explore
function macro_explore_full_recovery()
  if fully_recovered() then
    crawl.do_commands({"CMD_EXPLORE"})
  else
    explore_after_recovery = true
    crawl.do_commands({"CMD_REST"})
  end
end
crawl.setopt("macros += M o ===macro_explore_full_recovery")


function ch_stop_running_full_recovery(kind)
  if kind == "run" and not fully_recovered() then
    waiting_for_recovery = true
    crawl.setopt("message_colour += mute:You start waiting.")
  end
end

function c_message_fully_recover(text, _)
  if text:find("You start waiting.") or text:find("You start resting.") then
    if not fully_recovered() then
      waiting_for_recovery = true
      crawl.setopt("message_colour += mute:You start waiting.")
    end
  elseif waiting_for_recovery and channel == "timed_portal" then
    you.stop_activity()
    waiting_for_recovery = false
    crawl.setopt("message_colour -= mute:You start waiting.")
    explore_after_recovery = false
  end
end

function ready_fully_recover()
  if waiting_for_recovery then
    if fully_recovered() then
      you.stop_activity()
      crawl.setopt("message_colour -= mute:You start waiting.")
      waiting_for_recovery = false
      crawl.mpr("Fully recovered.")

      if explore_after_recovery then
        crawl.sendkeys("o")
        explore_after_recovery = false
      end
    elseif not you.feel_safe() then
      you.stop_activity()
      waiting_for_recovery = false
      explore_after_recovery = false
    else
      crawl.do_commands({"CMD_SAFE_WAIT"})
    end
  else
    explore_after_recovery = false
  end
end

}
############################### End lua/fully-rest.lua ###############################
##########################################################################################

################################### Begin lua/fm-monsters.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
------------------- Dynamic force_mores config -------------------
-- hp-specific force_mores() by gammafunk, edits by buehler
-- WARNING: Never put a '}' on a line by itself. This breaks crawl's RC parser.
-- Note: If you want an alert to silenceable by the fm_pack feature,
-- It must be on an alert by itself (not part of a multi-monster pattern)



local debug_fm_monsters = false -- Set to true to get a message when the fm change
local turns_to_delay = 15 -- Turns before alerting for a pack monster again

-- Stop on all Uniques & Pan lords
crawl.setopt("force_more_message += monster_warning:" ..
              "(?-i:[A-Z]).*comes? into view")

-- Always screen flash
local always_flash_screen_monsters = {
  -- Noteworthy abilities
  "vault warden", "vault guardian", "ghost crab"
} -- always_flash_screen_monsters (do not remove this comment)

-- Always more prompt
local always_force_more_monsters = {
  -- High damage/speed
    "juggernaut", "orbs? of fire", "flayed ghost",
  -- Torment
    "tormentor", "curse (toe|skull)", "Fiend", "tzitzimi", "royal mummy",
    "mummy priest", "(dread|ancient) lich", "lurking horror",
  --Summoning
    "shadow demon", "guardian serpent", "ironbound convoker",
    "draconian stormcaller", "spriggan druid", "dryad", "worldbinder",
    "halazid warlock", "deep elf elementalist", "demonspawn corrupter",
    "elemental wellspring",
  --Dangerous abilities
    "swamp worm", "air elemental", "wendingo", "wyrmhole",
    "torpor snail", "water nymph", "shambling mangrove", "iron giant",
    "starflower", "merfolk aquamancer", "deep elf knight", "wretched star",
  --Dangerous clouds
    "catoblepas", "death drake", "apocalypse crab", "putrid mouth",
} -- always_force_more_monsters (do not remove this comment)

-- Only alert once per pack
local fm_pack = {
  "dream sheep", "shrike", "boggart", "floating eye"
} -- fm_pack (do not remove this comment)

-- Once per pack, but alerts created through dynamic adds
local fm_pack_no_init_add = {
  "electric eel", "golden eye", "great orb of eyes"
} -- fm_pack_no_init_add (do not remove this comment)


local fm_patterns = {
  -- Early game Dungeon problems for chars with low mhp. (adder defined below)
  {name = "30hp", cond = "hp", cutoff = 30,
      pattern = "hound|gnoll"},

  -- Monsters dangerous until a certain point
  {name = "xl_7", cond = "xl", cutoff = 7,
      pattern = "orc wizard"},
  {name = "xl_12", cond = "xl", cutoff = 12,
      pattern = "hydra|bloated husk"},

  -- Monsters that can hit for ~50% of hp from range with unbranded attacks
  {name = "40hp", cond = "hp", cutoff = 40,
      pattern = "orc priest" },
  {name = "50hp", cond = "hp", cutoff = 50,
      pattern = "orc high priest|manticore" },
  {name = "70hp", cond = "hp", cutoff = 70,
      pattern = "yaktaur(?! captain)|cyclops|centaur(?! warrior)" },
  {name = "70hp_melai", cond = "hp", cutoff = 70,
      pattern = "meliai"},
  {name = "80hp", cond = "hp", cutoff = 80,
      pattern = "gargoyle" },
  {name = "90hp", cond = "hp", cutoff = 90,
      pattern = "deep elf archer|tengu conjurer" },
  {name = "110hp", cond = "hp", cutoff = 110,
      pattern = "centaur warrior|yaktaur captain|hellion|eye of devastation|sun moth"..
                  "deep elf high priest|deep troll earth mage|stone giant|cacodemon" },
  {name = "120hp", cond = "hp", cutoff = 120,
      pattern = "quicksilver (dragon|elemental)|magenta draconian|thorn hunter" },
  {name = "160hp", cond = "hp", cutoff = 160,
      pattern = "brimstone fiend|deep elf sorcerer"..
              "hell sentinal|war gargoyle|draconian (knight|scorcher)" },
  {name = "200hp", cond = "hp", cutoff = 200,
      pattern = "(draconian|deep elf) annihilator|iron (dragon|elemental)" },

  -- Monsters that can crowd-control you without sufficient willpower
  -- Cutoff ~10% for most spells; lower for more significant spells like banish
  {name = "willpower2", cond = "will", cutoff = 2,
      pattern = "basilisk|naga ritualist|vampire(?! bat)(?! mage)(?! mosquito)|sphinx marauder" },
  {name = "willpower3", cond = "will", cutoff = 3,
      pattern = "deep elf (demonologist|sorcerer|archer)|(?<!orc )wizard|"..
              "merfolk siren|fenstrider witch|cacodemon|"..
              "imperial myrmidon|guardian sphinx|nagaraja|draconian shifter|"..
              "glowing orange brain|orc sorcerer|"..
              "ogre mage|satyr|vault sentinel|iron elemental|"..
              "death knight|vampire knight" },
  {name = "willpower3_great_orb_of_eyes", cond = "will", cutoff = 3,
      pattern = "great orb of eyes" },
  {name = "willpower3_golden_eye", cond = "will", cutoff = 3,
      pattern = "golden eye" },
  {name = "willpower4", cond = "will", cutoff = 4,
      pattern = "merfolk avatar|tainted leviathan|nargun" },

  -- Malmutate without rMut
  {name = "malmutate", cond = "mut", cutoff = 1,
      pattern = "cacodemon|neqoxec|shining eye" },
  -- Brain feed with low int
  {name = "brainfeed", cond = "int", cutoff = 6,
      pattern = "glowing orange brain|neqoxec" },

  -- Alert if no resist and HP below cutoff
  {name = "pois_30", cond = "pois", cutoff = 30,
      pattern = "adder"},
  {name = "pois_80", cond = "pois", cutoff = 80,
      pattern = "golden dragon|green draconian|swamp dragon" },
  {name = "pois_120", cond = "pois", cutoff = 120,
      pattern = "green death|naga mage|nagaraja|fenstrider witch" },
  {name = "pois_140", cond = "pois", cutoff = 140,
      pattern = "tengu reaver" },

  {name = "elec_40", cond = "elec", cutoff = 40,
      pattern = "electric eel" },
  {name = "elec_80", cond = "elec", cutoff = 80,
      pattern = "shock serpent|raiju|spark wasp" },
  {name = "elec_120", cond = "elec", cutoff = 120,
      pattern = "black draconian|blizzard demon|deep elf zephyrmancer|"..
                "storm dragon|tengu conjurer" },
  {name = "elec_140", cond = "elec", cutoff = 140,
      pattern = "electric golem|titan|servants? of whisper|spriggan air mage|"..
                "ball lightning|tengu reaver" },

  {name = "corr_60", cond = "corr", cutoff = 60,
      pattern = "acid dragon" },
  {name = "corr_140", cond = "corr", cutoff = 140,
      pattern = "tengu reaver|entropy weaver|demonspawn corrupter|moon troll" },

  {name = "fire_60", cond = "fire", cutoff = 60,
      pattern = "steam dragon|lindwurm|fire crab|lava snake" },
  {name = "fire_100", cond = "fire", cutoff = 100,
      pattern = "efreet|deep elf pyromancer|smoke demon|sun moth" },
  {name = "fire_120", cond = "fire", cutoff = 120,
      pattern = "orc sorcerer|hell hound|demonspawn blood saint|red draconian|"..
                "ogre mage|molten gargoyle|hell knight" },
  {name = "fire_140", cond = "fire", cutoff = 140,
      pattern = "balrug" },
  {name = "fire_160", cond = "fire", cutoff = 160,
      pattern = "will-o-the-wisp|ophan|fire giant|golden dragon|"..
                "fire dragon|salamander tyrant|tengu reaver" },
  {name = "fire_240", cond = "fire", cutoff = 240,
      pattern = "hellephant|crystal (guardian|echidna)|draconian scorcher" },

  {name = "cold_80", cond = "cold", cutoff = 80,
      pattern = "rime drake" },
  {name = "cold_120", cond = "cold", cutoff = 120,
      pattern = "blizzard demon|bog body|ironbound frostheart|"..
                "demonspawn blood saint|white draconian" },
  {name = "cold_160", cond = "cold", cutoff = 160,
      pattern = "golden dragon|draconian knight|frost giant|ice dragon|tengu reaver" },
  {name = "cold_180", cond = "cold", cutoff = 180,
      pattern = "(?>!dread)(?>!ancient) lich" },
  {name = "cold_240", cond = "cold", cutoff = 240,
      pattern = "crystal (guardian|echidna)" },

  {name = "drain_100", cond = "drain", cutoff = 100,
      pattern = "orc sorcerer" },
  {name = "drain_120", cond = "drain", cutoff = 120,
      pattern = "necromancer" },
  {name = "drain_150", cond = "drain", cutoff = 150,
      pattern = "revenant|demonspawn blood saint" },
  {name = "drain_190", cond = "drain", cutoff = 190,
      pattern = "shadow dragon" },
} -- end fm_patterns (do not remove this comment)
------------------- End config section -------------------

local active_fm = {} -- which ones are on
local active_fm_index = {} -- lookup table for speed
local monsters_to_mute = {} -- which packs are muted
local last_fm_turn = {} -- when the mute started


local function set_monster_option(sign, monster_str, option)
  local fm_str = "monster_warning:(?<!spectral )("..monster_str..
      ")(?! (zombie|skeleton|simulacrum)).*comes? into view"
  crawl.setopt(option .. " " .. sign .. "= "..fm_str)
end

local function set_monster_fm(sign, monster_str)
  set_monster_option(sign, monster_str, "force_more_message")
end

local function set_monster_flash(sign, monster_str)
  set_monster_option(sign, monster_str, "flash_screen_message")
end

local function set_all(monster_list, option)
  local mon_str = nil
  for _, v in ipairs(monster_list) do
    if not mon_str then
      mon_str = v
    else
      mon_str = mon_str .. "|" .. v
    end
  end
  set_monster_option("+", mon_str, option)
end

local function get_three_pip_action(active, hp, cutoff, res)
  -- Util for checks against resistance and hp
  local div = res+1
  if div == 4 then div = 5 end

  if active then
    if hp >= cutoff/div then return "-" end
  else
    if hp < cutoff/div then return "+" end
  end
end


------------------- Hooks -------------------
function ready_force_mores()
  local activated = {}
  local deactivated = {}

  local hp = CACHE.hp
  local maxhp = CACHE.mhp
  local willpower = CACHE.will
  local res_mut = CACHE.rMut
  local res_pois = CACHE.rPois
  local res_elec = CACHE.rElec
  local res_corr = CACHE.rCorr
  local res_fire = CACHE.rF
  local res_cold = CACHE.rC
  local res_drain = CACHE.rN
  local int = CACHE.int

  for i,v in ipairs(fm_patterns) do
    local action = nil

    if not v.cond and not active_fm[i] then
      action = "+"
    elseif v.cond == "xl" then
      if active_fm[i] and CACHE.xl >= v.cutoff then action = "-"
      elseif not active_fm[i] and CACHE.xl < v.cutoff then action = "+"
      end
    elseif v.cond == "maxhp" then
      if active_fm[i] and maxhp >= v.cutoff then action = "-"
      elseif not active_fm[i] and maxhp < v.cutoff then action = "+"
      end
    elseif v.cond == "hp" then
      if active_fm[i] and hp >= v.cutoff then action = "-"
      elseif not active_fm[i] and hp < v.cutoff then action = "+"
      end
    elseif v.cond == "int" then
      if active_fm[i] and int >= v.cutoff then action = "-"
      elseif not active_fm[i] and int < v.cutoff then action = "+"
      end
    elseif v.cond == "will" then
      if active_fm[i] and willpower >= v.cutoff then action = "-"
      elseif not active_fm[i] and willpower < v.cutoff then action = "+"
      end
    elseif v.cond == "mut" then
      if active_fm[i] and res_mut > 0 then action = "-"
      elseif not active_fm[i] and res_mut == 0 then action = "+"
      end
    elseif v.cond == "pois" then
      if active_fm[i] and (res_pois > 0 or hp >= v.cutoff) then action = "-"
      elseif not active_fm[i] and res_pois == 0 and hp < v.cutoff then action = "+"
      end
    elseif v.cond == "elec" then
      if active_fm[i] and (res_elec > 0 or hp >= v.cutoff) then action = "-"
      elseif not active_fm[i] and res_elec == 0 and hp < v.cutoff then action = "+"
      end
    elseif v.cond == "corr" then
      if active_fm[i] and (res_corr or hp >= v.cutoff) then action = "-"
      elseif not active_fm[i] and not res_corr and hp < v.cutoff then action = "+"
      end
    elseif v.cond == "fire" then
      action = get_three_pip_action(active_fm[i], hp, v.cutoff, res_fire)
    elseif v.cond == "cold" then
      action = get_three_pip_action(active_fm[i], hp, v.cutoff, res_cold)
    elseif v.cond == "drain" then
      action = get_three_pip_action(active_fm[i], hp, v.cutoff, res_drain)
    end

    if action then
      fm_mon_str = nil
      local fm_name = v.pattern
      if v.name then fm_name = v.name end

      if type(v.pattern) == "table" then
        for _, p in ipairs(v.pattern) do
          if not fm_mon_str then
            fm_mon_str = p
          else
            fm_mon_str = fm_mon_str .. "|" .. p
          end
        end
      else
        fm_mon_str = v.pattern
      end

      set_monster_fm(action, fm_mon_str)
      active_fm[i] = not active_fm[i]

      if debug_fm_monsters then
        if action == "+" then
          activated[#activated + 1] = fm_name
        elseif action == "-" then
          deactivated[#deactivated + 1] = fm_name
        end
      end
    end
  end

  if debug_fm_monsters then
    if #activated > 0 then
      crawl.mpr("Activating force_mores: " .. table.concat(activated, ", "), "plain")
    end
    if #deactivated > 0 then
      crawl.mpr("Deactivating force_mores: " .. table.concat(deactivated, ", "), "plain")
    end
  end
end

function c_message_fm_pack(text, _)
  -- Identifies when a mute should be turned on
  if not text:find("comes? into view") then return end
  for _, v in ipairs(fm_pack) do
    if text:find(v) and last_fm_turn[v] == -1 then
      last_fm_turn[v] = CACHE.turn
      monsters_to_mute[#monsters_to_mute+1] = v
    end
  end
end

function ready_fm_pack()
  -- Put pending mutes into effect
  for _, v in ipairs(monsters_to_mute) do
    set_monster_fm("-", v)
  end
  monsters_to_mute = {}

  -- Remove mutes that have expired
  for _, v in ipairs(fm_pack) do
    if CACHE.turn == last_fm_turn[v] + turns_to_delay then
      set_monster_fm("+", v)
      last_fm_turn[v] = -1
    end
  end

  -- For no-init pack monsters, just deactivate the fm
  for _, v in ipairs(fm_pack_no_init_add) do
    if CACHE.turn == last_fm_turn[v] + turns_to_delay then
      active_fm[active_fm_index[v]] = false
      last_fm_turn[v] = -1
    end
  end
end


------ Startup code ------
set_all(always_flash_screen_monsters, "flash_screen_message")
set_all(always_force_more_monsters, "force_more_message")

-- Init packs
for _, v in ipairs(fm_pack) do
  set_monster_fm("+", v)
  last_fm_turn[v] = -1
end

for _,v in ipairs(fm_pack_no_init_add) do
  fm_pack[#fm_pack+1] = v
  last_fm_turn[v] = -1
end

-- Build table of indexes, used for fm_pack logic
for i,v in ipairs(fm_patterns) do
  if not v.pattern:find("|") then
    active_fm_index[v.pattern] = i
  end
end

-- Init all active_fm to false
for _,_ in ipairs(fm_patterns) do
  active_fm[#active_fm + 1] = false
end

}
############################### End lua/fm-monsters.lua ###############################
##########################################################################################

################################### Begin lua/inscribe-stats.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
----- Inscribe stats on items -----

local skipped_first_redraw = false

local function inscribe_armour_stats(it)
  -- Will add to the beginning of inscriptions, or replace it's own values
  -- This gsub's stats individually to avoid overwriting <color> tags
  -- NUM_PATTERN searches for numbers w/ decimal, to avoid artefact inscriptions
  local NUM_PATTERN = "[%+%-:]%d+%.%d*"
  local abbr = if_el(is_shield(it), "SH", "AC")
  local primary, ev = get_armour_info_strings(it)

  local new_insc
  if it.inscription:find(abbr..NUM_PATTERN) then
    new_insc = it.inscription:gsub(abbr..NUM_PATTERN, primary)
    if ev and ev ~= "" then
      new_insc = new_insc:gsub("EV"..NUM_PATTERN, ev)
    end
  else
    new_insc = primary
    if ev and ev ~= "" then
      new_insc = new_insc..", "..ev
    end
    if it.inscription and it.inscription ~= "" then
      new_insc = new_insc.." "..it.inscription
    end
  end

  it.inscribe(new_insc, false)
end

local function inscribe_weapon_stats(it)
  local new_inscr = get_weapon_info_string(it)

  local idx = it.inscription:find("DPS:")
  if idx then
    if idx + #new_inscr <= #it.inscription then
      new_inscr = new_inscr..it.inscription:sub(idx + #new_inscr, #it.inscription)
    end
    if idx > 1 then new_inscr = it.inscription:sub(1, idx-1)..new_inscr end
  end

  it.inscribe(new_inscr, false)
  return new_inscr
end


------------------ Hook ------------------
function ready_inscribe_stats()
  for inv in iter.invent_iterator:new(items.inventory()) do
    if is_weapon(inv) or is_staff(inv) then
      if CONFIG.inscribe_weapons then inscribe_weapon_stats(inv) end
    elseif is_armour(inv) then
      if CONFIG.inscribe_armour then inscribe_armour_stats(inv) end
    end
  end

  -- This redraw can causes crashes if called during an autopickup.
  -- Be sure not to hook any of this to c_message, or anything that can trigger during an autopickup
  if skipped_first_redraw then crawl.redraw_screen()
  else skipped_first_redraw = true
  end
end

}
############################### End lua/inscribe-stats.lua ###############################
##########################################################################################

################################### Begin lua/misc-alerts.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
if loaded_misc_alerts then return end
loaded_misc_alerts = true

------ Max piety w/ amulet of faith reminder ----
create_persistent_data("alerted_max_piety", 0)

local function alert_remove_faith()
  if alerted_max_piety == 0 and you.piety_rank() == 6 then
    local am = items.equipped_at("amulet")
    if am and am.subtype() == "amulet of faith" and not am.artefact then
      if CACHE.god == "Uskayaw" or CACHE.god == "Kikubaaqudgha" then return end
      crawl.mpr("<cyan>6 star piety! Maybe ditch that amulet soon.</cyan>")
      crawl.more()
      alerted_max_piety = 1
    end
  end
end

----- Alert once at a specific HP threshold -----
local hp, mhp = you.hp()
local below_hp_threshold = hp <= CONFIG.alert_low_hp_threshold * mhp

local function alert_low_hp()
  hp, mhp = you.hp()
  if below_hp_threshold then
    below_hp_threshold = hp ~= mhp
  elseif hp <= CONFIG.alert_low_hp_threshold * mhp then
    below_hp_threshold = true
    local threshold_perc = 100 * CONFIG.alert_low_hp_threshold
    crawl.mpr(CACHE.EMOJI.EXCLAMATION .. " <red>Dropped below "..threshold_perc.."% HP </red>" .. CACHE.EMOJI.EXCLAMATION)
    crawl.more()
  end
end

----- Save with message -----
-- by gammafunk, edits by buehler
function macro_save_with_message()
  crawl.formatted_mpr("Save game and exit? (y/n)", "prompt")
  local res = crawl.getch()
  if not (string.char(res) == "y" or string.char(res) == "Y") then
    crawl.formatted_mpr("Okay, then.", "prompt")
    return
  end
  crawl.formatted_mpr("Leave a message: ", "prompt")
  saved_game_msg = crawl.c_input_line()
  create_persistent_data("saved_game_msg", saved_game_msg)
  crawl.sendkeys(control_key("s"))
end

if CONFIG.save_with_msg then
  crawl.setopt("macros += M S ===macro_save_with_message")
  if saved_game_msg and saved_game_msg ~= "" then
    crawl.mpr("MESSAGE: " .. saved_game_msg, message_color)
    saved_game_msg = nil
  end
end

------------------ Hook ------------------
function ready_misc_alerts()
  if CONFIG.alert_remove_faith then alert_remove_faith() end
  if CONFIG.alert_low_hp_threshold > 0 then alert_low_hp() end
end

}
############################### End lua/misc-alerts.lua ###############################
##########################################################################################

## (Resuming init.txt) ##
#lua_file = crawl-rc/lua/mute-swaps.lua

################################### Begin lua/remind-id.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{

---- Track if found ID yet ----
create_persistent_data("found_scroll_of_id", 0)

---- Remind to identify items when you have scroll of ID + unidentified item ----
local function remind_unidentified_items()
  for inv in iter.invent_iterator:new(items.inventory()) do
    if not inv.is_identified then
      for inv_id in iter.invent_iterator:new(items.inventory()) do
        if inv_id and inv_id.name("qual"):find("scroll of identify") then
          crawl.mpr(CACHE.EMOJI.REMIND_IDENTIFY .. " <magenta> You have something to identify. </magenta>" .. CACHE.EMOJI.REMIND_IDENTIFY, "plain")
          break
        end
      end

      return
    end
  end
end
crawl.setopt("runrest_stop_message += You have something to identify")

------------------- Hooks -------------------
function c_message_remind_identify(text, channel)
  if channel ~= "plain" then return end

  if text:find(" of identify") then
    found_scroll_of_id = 1
    if not text:find("drop") and not text:find("read") then
      remind_unidentified_items()
    end
  elseif found_scroll_of_id == 0 then
    local idx = text:find(" %- ")
    if idx then
      local slot = text:sub(idx - 1, idx - 1)
      local it = items.inslot(items.letter_to_index(slot))
      if it.class(true) == "scroll" and it.quantity >= CONFIG.stop_on_scrolls_count or
          it.class(true) == "potion" and it.quantity >= CONFIG.stop_on_pots_count then
        you.stop_activity()
      end
    end
  end
end

function c_assign_invletter_remind_identify(it)
  if not it.is_identified or it.name("qual"):find("scroll of identify") then
    remind_unidentified_items()
  end
end

}
############################### End lua/remind-id.lua ###############################
##########################################################################################

################################### Begin lua/runrest-features.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
-- A collection of simple features related to resting and auto-explore stops

local stop_on_altars = true
local stop_on_portals = true
local stop_on_pan_gates = false
local ignoring_all_gauntlet = false


---- Ignore exit portals ----
local function ready_ignore_exits()
  local branch = you.branch()
  if stop_on_portals and util.contains(all_portal_names, branch) then
    stop_on_portals = false
    crawl.setopt("explore_stop -= portals")
  elseif not stop_on_portals and not util.contains(all_portal_names, branch) then
    stop_on_portals = true
    crawl.setopt("explore_stop += portals")
  end
end

---- Ignore altars ----
local function religion_is_handled()
  return CACHE.god ~= "No God" or CACHE.race == "Demigod" or
    (you.good_god() and CACHE.xl > 9)
end

local function ready_ignore_altars()
  if stop_on_altars and religion_is_handled() then
    stop_on_altars = false
    crawl.setopt("explore_stop -= altars")
  elseif not stop_on_altars and not religion_is_handled() then
    stop_on_altars = true
    crawl.setopt("explore_stop += altars")
  end
end

---- Automated temple actions ----
local function c_message_search_altars_in_temple(text, _)
  if you.branch() == "Temple" then
    if text:find("explor") then
      crawl.sendkeys({ 6, "altar\r" })
    elseif text:find("welcomes you!") then
      crawl.sendkeys("X<\r")
    end
  end
end

---- Stop on Pan Gates ----
local function ready_stop_on_pan_gates()
  local branch = you.branch()
  if stop_on_pan_gates and branch ~= "Pan" then
    stop_on_pan_gates = false
    crawl.setopt("explore_stop -= stairs")
  elseif not stop_on_pan_gates and branch == "Pan" then
    stop_on_pan_gates = true
    crawl.setopt("explore_stop += stairs")
  end
end

---- Ignore gauntlet msgs ----
local function c_message_ignore_gauntlet_msgs(text, _)
  if ignoring_all_gauntlet then
    if you.branch() ~= "Gauntlet" or text:find("Done exploring.") or text:find("Partly explored") then
      ignoring_all_gauntlet = false
      crawl.setopt("runrest_ignore_message -= .*")
    end
  else
    if text:find("enter a gauntlet!") then
      ignoring_all_gauntlet = true
      crawl.setopt("runrest_ignore_message ^= .*")
    end
  end
end

---------------- Hooks ----------------
function ready_runrest_features()
  if CONFIG.ignore_altars then ready_ignore_altars() end
  if CONFIG.ignore_portal_exits then ready_ignore_exits() end
  if CONFIG.stop_on_pan_gates then ready_stop_on_pan_gates() end
end

function c_message_runrest_features(text, _)
  if CONFIG.search_altars_in_temple then c_message_search_altars_in_temple(text, _) end
  if CONFIG.ignore_gauntlet_msgs then c_message_ignore_gauntlet_msgs(text, _) end
end

}
############################### End lua/runrest-features.lua ###############################
##########################################################################################

################################### Begin lua/safe-stairs.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{

----- Prevent accidental stairs usage -----
local prev_location, temp_location = you.branch()..you.depth(), you.branch()..you.depth()
local last_stair_turn = 0

crawl.setopt("macros += M > ===macro_do_safe_downstairs")
crawl.setopt("macros += M < ===macro_do_safe_upstairs")

local function check_new_location(key)
  local cur_location = you.branch()..you.depth()
  local turn_diff = CACHE.turn - last_stair_turn
  local question = nil
  if prev_location ~= cur_location and turn_diff > 0 and turn_diff < CONFIG.warn_stairs_threshold then
    question = "Really go right back? (y/n)"
  elseif CONFIG.warn_v5 and cur_location == "Vaults4" and key == ">" then
    -- V5 warning idea by rypofalem --
    question = "Really go to Vaults:5? (y/n)"
    CONFIG.warn_v5 = false
  end

  if question then
    crawl.formatted_mpr(question, "prompt")
    local res = crawl.getch()
    if string.lower(string.char(res)) ~= "y" then
      crawl.mpr("Okay, then.")
      return
    end
  end

  crawl.sendkeys(key)
  last_stair_turn = CACHE.turn
end

function macro_do_safe_upstairs()
  check_new_location("<")
end

function macro_do_safe_downstairs()
  check_new_location(">")
end

------------------- Hook -------------------
function ready_safe_stairs()
  prev_location = temp_location
  temp_location = you.branch()..you.depth()
end

}
############################### End lua/safe-stairs.lua ###############################
##########################################################################################

################################### Begin lua/startup.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{

if you.turns() == 0 then
  ---- Skill menu on startup (by rwbarton, edits by buehler) ----
  if CONFIG.show_skills_on_startup then
    local show_skills_on_startup = (CACHE.race ~= "Gnoll" or CACHE.class == "Wanderer")
    if show_skills_on_startup then
      crawl.sendkeys("m")
    end
  end

  ---- Auto-set default skill targets ----
  if CONFIG.auto_set_skill_targets then
    for _, skill_target in ipairs(CONFIG.auto_set_skill_targets) do
      local skill, target = unpack(skill_target)
      if you.skill(skill) < target then
        for _, s in ipairs(all_training_skills) do
          you.train_skill (s, 0)
        end
        you.set_training_target (skill, target)
        you.train_skill (skill, 2)
        break
      end
    end
  end
end

}
############################### End lua/startup.lua ###############################
##########################################################################################

################################### Begin lua/weapon-slots.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
---- Cleanup weapon slots ----
--Whenever you drop an item:
  -- Assign weapons to slots a and b
      -- Priority: 1:wielded, 2:weapon, not polearm/ranged unless skill
      -- 3:magical staff, 4:polearm, 5:ranged
  -- Assign weap to w: ranged/polearm/any


local do_cleanup_weapon_slots = false
local priorities_ab = nil
local priorities_w = nil

local function get_first_empty_slot()
  for slot=1,52 do
    if not items.inslot(slot) then return slot end
  end
end

local function get_priority_ab(it)
  if not it or not it.weap_skill then return -1 end
  if it.equipped then return 1 end

  if is_staff(it) then return 3 end
  if is_weapon(it) then
    if it.is_ranged then
      if you.skill("Ranged Weapons") >= 4 then return 2 end
      return 5
    end

    if it.weap_skill == "Polearms" then
      if you.skill("Polearms") >= 4 then return 2 end
      return 4
    end

    return 2
  end

  return -1
end

local function get_priority_w(it)
  if not it or not it.weap_skill then return -1 end
  if it.is_ranged then return 1 end
  if it.weap_skill == "Polearms" then return 2 end
  return 3
end


local function generate_priorities()
  priorities_ab = { -1, -1, -1, -1, -1 }
  priorities_w = { -1, -1, -1 }

  for inv in iter.invent_iterator:new(items.inventory()) do
    local p = get_priority_w(inv)
    if p > 0 then
      if priorities_w[p] == -1 then priorities_w[p] = inv.slot
      else priorities_w[p+1] = inv.slot
      end
    end

    p = get_priority_ab(inv)
    if p > 0 then
      if priorities_ab[p] == -1 then priorities_ab[p] = inv.slot
      else priorities_ab[p+1] = inv.slot
      end
    end
  end
end

local function cleanup_w()
  local slot_w = items.letter_to_index("w")
  local inv = items.inslot(slot_w)
  if inv and inv.class(true) == "weapon" then return end

  for p=1,3 do
    if priorities_w[p] > 1 then
      items.swap_slots(priorities_w[p], slot_w)
      return
    end
  end
end

local function cleanup_ab(ab)
  local inv
  inv = items.inslot(ab)
  if inv and inv.class(true) == "weapon" then return end

  for p=1,5 do
    if priorities_ab[p] > ab then
      items.swap_slots(priorities_ab[p], ab)
      priorities_ab[p] = -1
      return
    end
  end
end

local function cleanup_weapon_slots()
  generate_priorities()
  cleanup_ab(0)
  cleanup_ab(1)
  cleanup_w()
end

------------------- Hooks -------------------
function c_assign_invletter_weapon_slots(it)
  if not is_weapon(it) and not is_staff(it) then return end

  for i=0,2 do
    local slot = if_el(i==2, items.letter_to_index("w"), i)

    local inv = items.inslot(slot)
    if not inv then return slot end
    if not is_weapon(inv) and not is_staff(inv) then
      items.swap_slots(slot, get_first_empty_slot())
      return slot
    end
  end
end

function c_message_weapon_slots(text, channel)
  do_cleanup_weapon_slots = channel == "plain" and text:find("You drop ")
end

function ready_weapon_slots()
  if do_cleanup_weapon_slots then
    cleanup_weapon_slots()
    do_cleanup_weapon_slots = false
  end
end

}
############################### End lua/weapon-slots.lua ###############################
##########################################################################################

## (Resuming init.txt) ##

### Pickup and alert ###

################################### Begin lua/pickup-alert/pa-armour.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
if loaded_pa_armour then return end
loaded_pa_armour = true

----------------------------------- Begin lua/pickup-alert/pa-util.lua -----------------------------------
--------------- https://github.com/brianfaires/crawl-rc/ ---------------
if loaded_pa_util then return end
loaded_pa_util = true

function pa_show_alert_msg(alert_text, item_name, emoji)
  tokens = { "<cyan>----<magenta>", alert_text, "</magenta><yellow>", item_name, "</yellow>----</cyan>" }
  if emoji then
    table.insert(tokens, 1, emoji .. " ")
    table.insert(tokens, " " .. emoji)
  end
  crawl.mpr(table.concat(tokens))
  you.stop_activity()
end


--- Custom def of ego/branded ---
function has_ego(it)
  if it.class(true) == "weapon" then return it.branded or it.artefact end
  if it.artefact or it.branded then return true end
  local basename = it.name("base")
  if basename:find("troll leather") then return true end
  if basename:find("dragon scales") and not basename:find("steam") then return true end
  return false
end

function get_ego(it)
  if it.artefact then return "arte" end
  local basename = it.name("base")
  if basename:find("troll leather") then return "Regen+" end
  if basename:find("dragon scales") and not basename:find("steam") then return basename end
  return it.ego()
end


--------- Armour (Shadowing crawl calcs) ---------
function get_unadjusted_armour_pen(encumb)
  -- dcss v0.33
  local pen = encumb - 2 * get_mut("sturdy frame", true)
  if pen > 0 then return pen end
  return 0
end

function get_adjusted_armour_pen(encumb, str)
  -- dcss v0.33
  local base_pen = get_unadjusted_armour_pen(encumb)
  return 2 * base_pen * base_pen * (45 - CACHE.s_armour) / 45 / (5 * (str + 3))
end

function get_adjusted_dodge_bonus(encumb, str, dex)
  -- dcss v0.33
  local size_factor = -2 * CACHE.size_penalty
  local dodge_bonus = 8*(10 + CACHE.s_dodging * dex) / (20 - size_factor) / 10
  local armour_dodge_penalty = get_unadjusted_armour_pen(encumb) - 3
  if armour_dodge_penalty <= 0 then return dodge_bonus end

  if armour_dodge_penalty >= str then
    return dodge_bonus * str / (armour_dodge_penalty * 2)
  end
  return dodge_bonus - dodge_bonus * armour_dodge_penalty / (str * 2)
end

function get_armour_ac(it)
  -- dcss v0.33
  local it_plus = it.plus or 0

  if it.artefact and it.is_identified then
    local art_ac = it.artprops["AC"]
    if art_ac then it_plus = it_plus + art_ac end
  end

  local ac = it.ac * (1 + CACHE.s_armour / 22) + it_plus
  if not is_body_armour(it) then return ac end

  local deformed = get_mut("deformed body", true) > 0
  local pseudopods = get_mut("pseudopods", true) > 0
  if pseudopods or deformed then
    return ac * 6/10
  end

  return ac
end

function get_armour_ev(it)
  -- dcss v0.33
  -- This function computes the armour-based component to standard EV (not paralysed, etc)
  -- Factors in stat changes from this armour and removing current one
  local str = CACHE.str
  local dex = CACHE.dex
  local no_art_str = str
  local no_art_dex = dex
  local art_ev = 0

  -- Adjust str/dex/EV for artefact stat changes
  local worn = items.equipped_at("armour")
  if worn and worn.artefact then
    if worn.artprops["Str"] then str = str - worn.artprops["Str"] end
    if worn.artprops["Dex"] then dex = dex - worn.artprops["Dex"] end
    if worn.artprops["EV"] then art_ev = art_ev - worn.artprops["EV"] end
  end

  if it.artefact then
    if it.artprops["Str"] then str = str + it.artprops["Str"] end
    if it.artprops["Dex"] then dex = dex + it.artprops["Dex"] end
    if it.artprops["EV"] then art_ev = art_ev + it.artprops["EV"] end
  end

  if str <= 0 then str = 1 end

  local dodge_bonus = get_adjusted_dodge_bonus(it.encumbrance, str, dex)
  local naked_dodge_bonus = get_adjusted_dodge_bonus(0, no_art_str, no_art_dex)
  return (dodge_bonus - naked_dodge_bonus) + art_ev - get_adjusted_armour_pen(it.encumbrance, str)
end

function get_shield_penalty(sh)
  -- dcss v0.33
  return 2 * sh.encumbrance * sh.encumbrance
        * (27 - CACHE.s_shields) / 27
        / (25 + 5 * CACHE.str)
end

function get_shield_sh(it)
  -- dcss v0.33
  local dex = CACHE.dex
  if it.artefact and it.is_identified then
    local art_dex = it.artprops["Dex"]
    if art_dex then dex = dex + art_dex end
  end

  local cur = items.equipped_at("shield")
  if cur and cur.artefact and cur.slot ~= it.slot then
    local art_dex = cur.artprops["Dex"]
    if art_dex then dex = dex - art_dex end
  end

  local it_plus = it.plus or 0

  local base_sh = it.ac * 2
  local shield = base_sh * (50 + CACHE.s_shields*5/2)
  shield = shield + 200 * it_plus
  shield = shield + 38 * (CACHE.s_shields + 3 + dex * (base_sh + 13) / 26)
  return shield / 200
end


--------- Weapons (Shadowing crawl calcs) ---------
function get_hands(it)
  if CACHE.race ~= "Formicid" then return it.hands end
  local st, _ = it.subtype()
  if st == "giant club" or st == "giant spiked club" then return 2 end
  return 1
end

function get_weap_delay(it, ignore_brands)
  local delay = it.delay - get_skill(it.weap_skill)/2
  local min_delay = get_weap_min_delay(it)
  if delay < min_delay then delay = min_delay end

  if not ignore_brands then
    if it.ego() == "speed" then delay = delay * 2 / 3
    elseif it.ego() == "heavy" then delay = delay * 1.5
    end
  end

  if delay < 3 then delay = 3 end

  local sh = items.equipped_at("shield")
  if sh then delay = delay + get_shield_penalty(sh) end

  if it.is_ranged then
    local body = items.equipped_at("armour")
    if body then
      local str = CACHE.str
      if it.artefact then
        if it.artprops["Str"] then str = str + it.artprops["Str"] end
      end
      local cur = items.equipped_at("weapon")
      if cur and cur ~= it and cur.artefact then
        if cur.artprops["Str"] then str = str - cur.artprops["Str"] end
      end

      delay = delay + get_adjusted_armour_pen(body.encumbrance, str)
    end
  end

  return delay / 10
end

function get_weap_min_delay(it)
  -- This is an abbreviated version of the actual calculation.
  -- Intended only to be used to prevent skill from reducing too far in get_weap_delay()
  local basename = it.name("base")

  local adj_base_delay = it.delay / 2
  if it.ego() == "heavy" then adj_base_delay = 1.5 * adj_base_delay end
  local min_delay = math.floor(adj_base_delay)

  if it.weap_skill == "Short Blades" and min_delay > 5 then min_delay = 5 end
  if min_delay > 7 then min_delay = 7 end

  if basename:find("longbow") then min_delay = 6
  elseif (basename:find("crossbow") or basename:find("arbalest")) and min_delay < 10 then min_delay = 10 end

  return min_delay
end


--------- Other damage calcs ---------
-- Count all slay bonuses from weapons/armour/jewellery
function get_slay_bonuses()
  local sum = 0

  -- Slots can go as high as 18 afaict
  for i = 0,20 do
    local it = items.equipped_at(i)
    if it then
      if is_ring(it) then
        if it.artefact then
          local name = it.name()
          local idx = name:find("Slay")
          if idx then
            local slay = tonumber(name:sub(idx+5, idx+5))
            if slay == 1 then
              local next_digit = tonumber(name:sub(idx+6, idx+6))
              if next_digit then slay = 10 + next_digit end
            end

            if name:sub(idx+4, idx+4) == "+" then sum = sum + slay
            else sum = sum - slay end
          end
        elseif it.ego(true) == "Slay" then
          sum = sum + it.plus
        end
      elseif it.artefact and (is_armour(it) or is_amulet(it)) then
          local slay = it.artprops["Slay"]
          if slay then sum = sum + slay end
      end
    end
  end

  if CACHE.race == "Demonspawn" then
    sum = sum + 3 * get_mut("augmentation", true)
    sum = sum + get_mut("sharp scales", true)
  end

  return sum
end

function get_staff_bonus_dmg(it, no_brand_dmg)
  -- dcss v0.33
  if no_brand_dmg then
    local basename = it.name("base")
    if basename ~= "staff of earth" and basename ~= "staff of conjuration" then
      return 0
    end
  end

  local school = get_staff_school(it)
  if not school then return 0 end
  local spell_skill = get_skill(school)
  local evo_skill = you.skill("Evocations")
  
  local chance = (2*evo_skill + spell_skill) / 30
  if chance > 1 then chance = 1 end
  -- 0.75 is an acceptable approximation; most commonly 63/80
  -- Varies by staff type in sometimes complex ways
  local avg_dmg = 3/4 * (evo_skill/2 + spell_skill)
  return avg_dmg*chance
end

function get_staff_school(it)
  for k,v in pairs(staff_schools) do
    if it.name("base") == "staff of "..k then return v end
	end
end


--------- get_weap_dmg() ---------
function get_weap_dmg(it, no_brand_dmg, no_weight_all_brands)
  -- Returns an adjusted weapon damage = damage * speed
  -- Includes stat/slay changes between weapon and the one currently wielded
  -- Aux attacks not included
  local it_plus = if_el(it.plus, it.plus, 0)

  -- Adjust str/dex/slay from artefacts
  local str = CACHE.str
  local dex = CACHE.dex

  -- Adjust str/dex/EV for artefact stat changes
  if not it.equipped then
    local wielded = items.equipped_at("weapon")
    if wielded and wielded.artefact then
      if wielded.artprops["Str"] then str = str - wielded.artprops["Str"] end
      if wielded.artprops["Dex"] then dex = dex - wielded.artprops["Dex"] end
      if wielded.artprops["Slay"] then it_plus = it_plus - wielded.artprops["Slay"] end
    end

    if it.artefact and it.is_identified then
      if it.artprops["Str"] then str = str + it.artprops["Str"] end
      if it.artprops["Dex"] then dex = dex + it.artprops["Dex"] end
      if it.artprops["Slay"] then it_plus = it_plus + it.artprops["Slay"] end
    end
  end

  local stat
  if it.is_ranged or it.weap_skill:find("Blades") then stat = dex
  else stat = str end

  local stat_mod = 0.75 + 0.025 * stat
  local skill_mod = (1 + get_skill(it.weap_skill)/25/2) * (1 + CACHE.s_fighting/30/2)

  it_plus = it_plus + get_slay_bonuses()
  local pre_brand_dmg_no_plus = it.damage * stat_mod * skill_mod
  local pre_brand_dmg = pre_brand_dmg_no_plus + it_plus

  if is_staff(it) then
    return (pre_brand_dmg + get_staff_bonus_dmg(it, no_brand_dmg))
  end

  local ego = it.ego()
  if not ego then return pre_brand_dmg end

  if not no_brand_dmg then
    if ego == "spectralizing" then return 2 * pre_brand_dmg end
    if ego == "heavy" then return (1.8 * pre_brand_dmg_no_plus + it_plus) end
    if ego == "flaming" or ego == "freezing" then return 1.25 * pre_brand_dmg end
    if ego == "draining" then return (1.25 * pre_brand_dmg + 2) end
    if ego == "electrocution" then return (pre_brand_dmg + 3.5) end
    -- Ballparking venom as 5 dmg since it totally breaks the paradigm
    if ego == "venom" then return (pre_brand_dmg + 5) end
    if ego == "pain" then return (pre_brand_dmg + you.skill("Necromancy")/2) end
    -- Distortion does 5.025 extra dmg, + 5% chance to banish
    if ego == "distortion" then return (pre_brand_dmg + 6) end
    -- Weighted average of all the easily computed brands was ~ 1.17*dmg + 2.13
    if ego == "chaos" then return (1.25 * pre_brand_dmg + 2) end

    if not no_weight_all_brands then
      if ego == "protection" then return 1.15 * pre_brand_dmg end
      if ego == "vampirism" then return 1.25 * pre_brand_dmg end
      if ego == "holy wrath" then return 1.15 * pre_brand_dmg end
      if ego == "antimagic" then return 1.1 * pre_brand_dmg end
    end
  end

  return pre_brand_dmg
end

function get_weap_dps(it, no_brand_dmg, no_weight_all_brands)
  return get_weap_dmg(it, no_brand_dmg, no_weight_all_brands) / get_weap_delay(it)
end


---- Stat string formatting ----
local function format_stat(abbr, val, is_worn)
  local stat_str = string.format("%.1f", val)
  if val < 0 then
    return abbr..stat_str
  elseif is_worn then
    return abbr..':'..stat_str
  else
    return abbr..'+'..stat_str
  end
end

function get_armour_info_strings(it)
  if not is_armour(it) or is_orb(it) then return "", "" end

  local cur = items.equipped_at(it.equip_type)
  local cur_ac = 0
  local cur_sh = 0
  local cur_ev = 0
  local is_worn = it.ininventory and cur and cur.slot == it.slot
  if cur and not is_worn then
    -- Only show deltas if not same item
    if is_shield(cur) then
      cur_sh = get_shield_sh(cur)
      cur_ev = -get_shield_penalty(cur)
    else
      cur_ac = get_armour_ac(cur)
      cur_ev = get_armour_ev(cur)
    end
  end

  if is_shield(it) then
    local sh_str = format_stat("SH", get_shield_sh(it) - cur_sh, is_worn)
    local ev_str = format_stat("EV", -get_shield_penalty(it) - cur_ev, is_worn)
    return sh_str, ev_str
  else
    local ac_str = format_stat("AC", get_armour_ac(it) - cur_ac, is_worn)
    if not is_body_armour(it) then return ac_str end
    local ev_str = format_stat("EV", get_armour_ev(it) - cur_ev, is_worn)
    return ac_str, ev_str
  end
end

function get_weapon_info_string(it)
  if not it.delay then return end

  local dmg = get_weap_dmg(it)
  local dmg_str = string.format("%.1f", dmg)
  if dmg < 10 then dmg_str = string.format("%.2f", dmg) end
  if dmg > 99.9 then dmg_str = ">100" end

  local delay = get_weap_delay(it)
  local delay_str = string.format("%.1f", delay)
  if delay < 1 then
    delay_str = string.format("%.2f", delay)
    delay_str = delay_str:sub(2, #delay_str)
  end

  local dps = get_weap_dps(it)
  local dps_str = string.format("%.1f", dps)
  if dps < 10 then dps_str = string.format("%.2f", dps) end
  if dps > 99.9 then dps_str = ">100" end

  local it_plus = if_el(it.plus, it.plus, 0)
  local acc = it.accuracy + it_plus
  if acc >= 0 then acc = "+"..acc end

  --This would be awesome if it didn't ruin the main UI
  --dps_str = "DPS=<white>"..dps_str.."</white> "
  --return dps_str.."(<red>"..dmg_str.."</red>/<blue>"..delay_str.."</blue>), Acc<white>"..acc.."</white>"
  dps_str = "DPS="..dps_str.." "
  return dps_str.."("..dmg_str.."/"..delay_str.."), Acc"..acc
end


---- Util ----
function get_skill(skill)
  if not skill:find(",") then
    return you.skill(skill)
  end

  local skills = crawl.split(skill, ",")
  local sum = 0
  local count = 0
  for _, s in ipairs(skills) do
    sum = sum + you.skill(s)
    count = count + 1
  end
  return sum/count
end

------------------------------- End lua/pickup-alert/pa-util.lua -------------------------------
------------------------------------------------------------------------------------------

----------------------------------- Begin lua/pickup-alert/pa-data.lua -----------------------------------
--------------- https://github.com/brianfaires/crawl-rc/ ---------------
if loaded_pa_data then return end
loaded_pa_data = true

create_persistent_data("pa_single_alert_items", CONFIG.one_time_alerts)
create_persistent_data("pa_all_level_alerts", {})
create_persistent_data("pa_items_picked", {})
create_persistent_data("pa_items_alerted", {})
create_persistent_data("alerted_first_ranged_two_handed", 0)
create_persistent_data("alerted_first_ranged_one_handed", 0)
create_persistent_data("armour_high_score", 0)
create_persistent_data("weapon_high_score", 0)
create_persistent_data("unbranded_high_score", 0)
create_persistent_data("polearm_high_score", 0)
create_persistent_data("polearm_onehand_high_score", 0)


---- Accessors into persistent data ----
function get_rare_item_index(it)
  local qualname = it.name("qual")
  for i,v in ipairs(pa_single_alert_items) do
    if v ~= "" and qualname:find(v) then return i end
  end
  return -1
end

function remove_from_pa_single_alert_items(it)
  local idx = get_rare_item_index(it)
  if idx ~= -1 then
    util.remove(pa_single_alert_items, pa_single_alert_items[idx])
    return true
  end

  return false
end

function pa_previously_picked(it)
  local name = it.name("qual")
  if not it.is_identified then name = "+0 " .. name end
  return util.contains(pa_items_picked, name)
end

function pa_previously_alerted(it)
  local name = it.name("qual")
  if not it.is_identified then name = "+0 " .. name end
  return util.contains(pa_items_alerted, name)
end

--- Multi store/remove data ---
local function add_remove_item_and_less_enchanted(table_ref, it, remove_item)
  -- Add (or remove) an item name to a table, along with all less enchanted versions
  -- e.g. "+3 flail" will add: "+3 flail", "+2 flail", "+1 flail", "+0 flail"
  local name = it.name("qual")
  if not it.is_identified then name = "+0 " .. name end
  if util.contains(table_ref, name) ~= remove_item then return end

  if remove_item then util.remove(table_ref, name)
  else table.insert(table_ref, name)
  end

  if it.artefact then return end

  -- Do less enchanted items too
  local plus = tonumber(name:sub(2,2))
  if not plus then return end

  if plus > 0 then
    if tonumber(name:sub(3,3)) then
      plus = 10 * plus + tonumber(name:sub(3,3))
    end

    for i=plus,1,-1 do
      name = name:gsub("+"..i, "+"..(i-1))
      if remove_item then util.remove(table_ref, name)
      else table.insert(table_ref, name)
      end
    end
  end
end

function insert_item_and_less_enchanted(table_ref, it)
  add_remove_item_and_less_enchanted(table_ref, it, false)
end

function remove_item_and_less_enchanted(table_ref, it)
  add_remove_item_and_less_enchanted(table_ref, it, true)
end


--- Set all single high scores ---
function update_high_scores(it)
  local ret_val = nil

  if is_armour(it) then
    local ac = get_armour_ac(it)
    if ac > armour_high_score then
      armour_high_score = ac
      if not ret_val then ret_val = "Strongest armour" end
    end
  elseif is_weapon(it) then
    local it_plus = if_el(it.plus, it.plus, 0)
    local score = get_weap_dps(it) + (it.accuracy + it_plus) / 2
    if score > weapon_high_score then
      weapon_high_score = score
      if not ret_val then ret_val = "Good weapon" end
    end

    local unbranded_score = get_weap_dps(it, false) + (it.accuracy + it_plus) / 2
    if unbranded_score > unbranded_high_score then
      unbranded_high_score = score
      if not ret_val then ret_val = "High pure damage" end
    end

    if it.weap_skill == "Polearms" and you_have_allies() then
      if score > polearm_high_score then
        polearm_high_score = score
        if not have_shield() and not ret_val then ret_val = "Good polearm" end
      end

      if get_hands(it) == 1 and score > polearm_onehand_high_score then
        polearm_onehand_high_score = score
        if not ret_val then ret_val = "Good polearm" end
      end
    end
  end

  return ret_val
end


--- Startup code ---
-- Starting items: Remove from pa_single_alert_items, and add to pa_items_picked
if you.turns() == 0 then
  for inv in iter.invent_iterator:new(items.inventory()) do
    local idx = get_rare_item_index(inv)
    if idx ~= -1 then util.remove(pa_single_alert_items, pa_single_alert_items[idx]) end
    insert_item_and_less_enchanted(pa_items_picked, inv)
  end
end

------------------------------- End lua/pickup-alert/pa-data.lua -------------------------------
------------------------------------------------------------------------------------------

----------------------------------- Begin lua/pickup-alert/pa-main.lua -----------------------------------
--------------- https://github.com/brianfaires/crawl-rc/ ---------------
if loaded_pa_main then return end
loaded_pa_main = true

-- Global var for access by autopickup function
pause_pickup_alert_sys = false
local last_ready_item_alerts_turn = 0
local last_pa_dump_turn = 0

function pa_alert_item(it, alert_type, emoji)
  local name = it.name("plain")
  local qualname = it.name("qual")
  if not (is_talisman(it) or it.is_identified) then
    name = "+0 " .. name
    qualname = "+0 " .. qualname
  end

  if not pa_previously_alerted(it) and not pa_previously_picked(it) then
    if is_weapon(it) or is_staff(it) then
      pa_show_alert_msg(
        table.concat({"Item alert, ", alert_type, ": "}),
        table.concat({name, " ", get_weapon_info_string(it)}),
        emoji or CACHE.EMOJI.WEAPON
      )
	  elseif is_body_armour(it) then
      local ac, ev = get_armour_info_strings(it)
      pa_show_alert_msg(
        table.concat({"Item alert, ", alert_type, ": "}),
        table.concat({name, " ", ac, ", ", ev}),
        emoji or CACHE.EMOJI.BODY_ARMOUR
      )
    elseif is_armour(it) then
      pa_show_alert_msg(
        table.concat({"Item alert, ", alert_type, ": "}),
        name,
        emoji or CACHE.EMOJI.ARMOUR
      )
    else
      pa_show_alert_msg(
        table.concat({"Item alert, ", alert_type, ": "}),
        name,
        emoji or CACHE.EMOJI.MISC
      )
    end

    insert_item_and_less_enchanted(pa_items_alerted, it)
    table.insert(pa_all_level_alerts, name)
  end

  -- Returns true to make other code more concise; indicates that we tried to alert this item
  return true
end
crawl.setopt("runrest_stop_message += Item alert, ")


local function dump_table(name, table)
  local summary = ""
  summary = summary .. name .. ":\n"
  for _,item in ipairs(table) do
    summary = summary .. "  " .. item .. "\n"
  end
  return summary
end


local function dump_persistent_arrays()
  local summary = "---DEBUGGING ARRAYS---\n"
  summary = summary .. dump_table("pa_items_picked", pa_items_picked)
  summary = summary .. dump_table("pa_items_alerted", pa_items_alerted)
  summary = summary .. dump_table("pa_all_level_alerts", pa_all_level_alerts)
  summary = summary .. dump_table("pa_single_alert_items", pa_single_alert_items)
  
  crawl.mpr(summary)
  crawl.take_note(summary)
  crawl.dump_char()
end


------------------- Hooks -------------------
function c_assign_invletter_item_alerts(it)
  if is_weapon(it) or is_armour(it) then
    if not pa_previously_picked(it) then
      insert_item_and_less_enchanted(pa_items_picked, it)
      update_high_scores(it)
      remove_from_pa_single_alert_items(it)
    end
  end

  remove_item_and_less_enchanted(pa_items_alerted, it)
  util.remove(pa_all_level_alerts, it.name("qual"))
end

function c_message_item_alerts(text, _)
  if text:find("You start waiting.") or text:find("You start resting.") then
    pause_pickup_alert_sys = true
  elseif text:find("Done exploring.") or text:find("Partly explored") then
    local all_alerts = ""
    for _,v in ipairs(pa_all_level_alerts) do
      if all_alerts == "" then all_alerts = v
      else all_alerts = all_alerts..", "..v
      end
    end

    pa_all_level_alerts = {}
    if all_alerts ~= "" then
      crawl.mpr("<magenta>Recent alerts: "..all_alerts.."</magenta>")
    end
  end
end

function ready_item_alerts()
  if CACHE.turn == last_ready_item_alerts_turn then return end
  last_ready_item_alerts_turn = CACHE.turn

  if CONFIG.debug_pa_array_freq > 0 and CACHE.turn - last_pa_dump_turn > CONFIG.debug_pa_array_freq then
    last_pa_dump_turn = CACHE.turn
    dump_persistent_arrays()
  end

  if not pause_pickup_alert_sys then
    generate_inv_weap_arrays()
    update_high_scores(items.equipped_at("armour"))
  else
    pause_pickup_alert_sys = false
  end
end


---- Autopickup main ----
add_autopickup_func(function (it, _)
  if pause_pickup_alert_sys then return end

  -- Check for pickup
  local retVal = false
  if loaded_pa_armour and CONFIG.pickup_armour and is_armour(it) then
    retVal = pa_pickup_armour(it)
  elseif loaded_pa_weapons and CONFIG.pickup_weapons and is_weapon(it) then
    retVal = do_pa_weapon_pickup(it)
  elseif loaded_pa_misc and CONFIG.pickup_staves and is_staff(it) then
    retVal = pa_pickup_staff(it)
  end

  if retVal == true then
    remove_from_pa_single_alert_items(it)
    return true
  end

  if CONFIG.alert_system_enabled then
    -- Not picking up this item. Check for alerts.
    -- Update inventory high scores first, in case XP gained same turn item is dropped
    ready_item_alerts()

    if loaded_pa_misc then
      if CONFIG.alert_one_time_items then pa_alert_rare_item(it) end

      if is_staff(it) and CONFIG.alert_staff_resists then pa_alert_staff(it)
      elseif is_orb(it) and CONFIG.alert_orbs then pa_alert_orb(it)
      elseif is_talisman(it) and CONFIG.alert_talismans then pa_alert_talisman(it)
      end
    end

    if is_armour(it) and loaded_pa_armour and CONFIG.alert_armour then pa_alert_armour(it)
    elseif is_weapon(it) and loaded_pa_weapons and CONFIG.alert_weapons then do_pa_weapon_alerts(it)
    end
  end
end)

------------------------------- End lua/pickup-alert/pa-main.lua -------------------------------
------------------------------------------------------------------------------------------

-- (Resuming lua/pickup-alert/pa-armour.lua) --


-- If training armour in early/mid game, alert user to any armour that is the strongest found so far
local function alert_armour_upgrades(it)
  if not is_body_armour(it) then return false end
  if CACHE.s_armour == 0 then return false end
  if CACHE.xl > 12 then return false end
  if (it.artefact or it.branded) and not it.is_identified then return false end

  if armour_high_score == 0 then
    local cur = get_body_armour()
    if not cur then return false end
    armour_high_score = get_armour_ac(cur)
  else
    local itAC = get_armour_ac(it)
    if itAC > armour_high_score then
      armour_high_score = itAC
      return pa_alert_item(it, "Strongest armour yet", CACHE.EMOJI.STRONGEST)
    end
  end

  return false
end


-- Equipment autopickup (by Medar, gammafunk, buehler, and various others)
function pa_pickup_armour(it)
  if it.is_useless then return false end

  if is_body_armour(it) then
    local cur = get_body_armour()

    -- Exclusions
    if not cur then return false end
    if it.branded and not it.is_identified then return false end
    if it.encumbrance > cur.encumbrance then return false end

    -- Pick up AC upgrades, new egos that don't lose AC, and artefacts that don't lose 5+ AC
    local ac_delta = get_armour_ac(it) - get_armour_ac(cur)

    if it.artefact and ac_delta > -5 then return true end
    if cur.artefact then return false end

    if get_ego(it) == get_ego(cur) then
      return ac_delta > 0 or ac_delta == 0 and it.encumbrance < cur.encumbrance
    elseif has_ego(it) and not has_ego(cur) then
      return ac_delta >= 0
    end
  elseif is_shield(it) then
    local cur = items.equipped_at("offhand")

    -- Exclusions
    if not it.is_identified then return false end
    if not cur or not is_shield(cur) then return false end
    if cur.name("base") ~= it.name("base") then return false end

    -- Pick up SH upgrades, artefacts, and added egos
    if it.artefact then return true end
    if cur.artefact then return false end
    if cur.branded then
      if get_ego(cur) == get_ego(it) then return it.plus > cur.plus end
      return false
    end
    if it.branded then return true end
    return it.plus > cur.plus
  else
    if is_orb(it) then return false end
    -- Aux armour: Pickup artefacts, AC upgrades, and new egos
    local st, _ = it.subtype()

    -- Skip boots/gloves/helmet if wearing Lear's hauberk
    local body_arm = get_body_armour()
    if body_arm and body_arm.name("qual"):find("Lear's hauberk") and st ~= "cloak" then return false end

    -- No autopickup if mutation interference
    if st == "gloves" then
      -- Ignore demonic touch if you're wearing a shield
      if not items.equipped_at("shield") then
        if get_mut("demonic touch", true) >= 3 then return false end
      end

      -- Ignore claws if you're wielding a weapon
      if not items.equipped_at("weapon") then
        if get_mut("claws", true) > 0 then return false end
      end
    elseif st == "boots" then
      if get_mut("hooves", true) > 0 then return false end
      if get_mut("talons", true) > 0 then return false end
    elseif it.name("base"):find("helmet") then
      if get_mut("horns", true) > 0 then return false end
      if get_mut("beak", true) > 0 then return false end
      if get_mut("antennae", true) > 0 then return false end
    end

    if it.artefact then return true end

    local cur = items.equipped_at(st)
    if not cur then return true end
    if not it.is_identified then return false end

    if it.branded then
      if get_ego(it) ~= get_ego(cur) then return true end
      if get_armour_ac(it) > get_armour_ac(cur) then return true end
    else
      if cur.branded or cur.artefact then return false end
      if get_armour_ac(it) > get_armour_ac(cur) then return true end
    end
  end

  return false
end


---- alert_armour_while_mutated() ----
-- Special cases where you have temporary or innate mutations that interfere with armour
-- Alert when an ego item is usable but interferes with mutation, or unusable due to temp mutations
local function alert_armour_while_mutated(it, type)
  local it_plus = if_el(it.plus, it.plus, 0)

  if type == "gloves" then
    local claws_lvl_innate = get_mut("claws", false)
    if claws_lvl_innate >= 3 then return end

    local touch_lvl_innate = get_mut("demonic touch", false)
    if touch_lvl_innate >= 3 then return end

    local claws_lvl = get_mut("claws", true)
    local touch_lvl = get_mut("demonic touch", true)

    if claws_lvl > 0 or touch_lvl >= 3 then
      if it.artefact or it.branded then
        pa_alert_item(it, "Branded gloves", CACHE.EMOJI.GLOVES)
      end
      local cur_gloves = items.equipped_at("gloves")
      if not cur_gloves or it_plus > cur_gloves.plus then
        pa_alert_item(it, "Enchanted gloves", CACHE.EMOJI.GLOVES)
      end
    end
  elseif type == "boots" then
    local hooves_lvl_innate = get_mut("hooves", false)
    if hooves_lvl_innate >= 3 then return end

    local talons_lvl_innate = get_mut("talons", false)
    if talons_lvl_innate >= 3 then return end

    local hooves_lvl = get_mut("hooves", true)
    local talons_lvl = get_mut("talons", true)

    if hooves_lvl + talons_lvl > 0 then
      if it.artefact or it.branded then
        pa_alert_item(it, "Branded boots", CACHE.EMOJI.BOOTS)
      end
      local cur_boots = items.equipped_at("boots")
      if not cur_boots or it_plus > cur_boots.plus then
        pa_alert_item(it, "Enchanted boots", CACHE.EMOJI.BOOTS)
      end
    end
  elseif type == "helmet" then
    local horns_lvl_innate = get_mut("horns", false)
    local antennae_lvl_innate = get_mut("antennae", false)

    if it.name("base"):find("helmet") then
      if horns_lvl_innate > 0 then return end
      if antennae_lvl_innate > 0 then return end
      if get_mut("beak", false) > 0 then return end
    else
      -- hat/crown/etc
      if horns_lvl_innate >= 3 then return end
      if antennae_lvl_innate >= 3 then return end
    end

    local horns_lvl = get_mut("horns", true)
    local antennae_lvl = get_mut("antennae", true)
    local beak_lvl = get_mut("beak", true)
    if horns_lvl + antennae_lvl + beak_lvl > 0 then
      if it.artefact or it.branded then
        pa_alert_item(it, "Branded headgear", CONFIG.EMOJI.HAT)
      end
      local cur_helmet = items.equipped_at("helmet")
      if not cur_helmet or it_plus > cur_helmet.plus then
        pa_alert_item(it, "Enchanted headgear", CACHE.EMOJI.HAT)
      end
    end
  end
end

---- alert_interesting_armour() ----
-- Alerts armour items that did trigger autopickup, but are worth consideration
-- Includes: Artefacts, added or changed egos, and
  -- body armour AC/EV/Encumbrance changes, defined by following heuristics:
    -- Lighter: EV/AC >= { 0.6, 0.8, 1.2, 2 } for ego: {gain, diff, same, lose}
      -- Or: Gain/Diff ego while losing <=4AC
    -- Heavier: AC/EV >= { 0.4, 0.7, 0.8, 2 } for ego: {gain, diff, same, lose}
      -- Penalty == 0.75*encumb_change (or 0 if irrelevant)
-- Adjusting the heuristic values up will mean fewer alerts, and down will alert more often.
-- If you want a specific alert to occur more or less often, look for the line of code below with the alert text,
-- Then modify the values in the same line of code.
local function alert_interesting_armour(it)
  if it.artefact then
    return pa_alert_item(it, "Artefact armour", CACHE.EMOJI.ARTEFACT)
  end

  if is_body_armour(it) then
    local cur = get_body_armour()
    if not cur then return false end

    if it.encumbrance == cur.encumbrance then
      if has_ego(it) then
        if not has_ego(cur) then
          return pa_alert_item(it, "Gain ego", CACHE.EMOJI.EGO)
        end
        if get_ego(it) ~= get_ego(cur) then
          return pa_alert_item(it, "Diff ego", CACHE.EMOJI.EGO)
        end
      end
      --if get_armour_ac(it) > get_armour_ac(cur) then
        --return pa_alert_item(it, "Stronger armour", CACHE.EMOJI.STRONGER)
      --end

    elseif it.encumbrance < cur.encumbrance then
      -- Lighter armour
      local ev_gain = get_armour_ev(it) - get_armour_ev(cur)
      local ac_lost = get_armour_ac(cur) - get_armour_ac(it)

      if has_ego(it) then
        if not cur.artefact and not has_ego(cur) then
          if ev_gain/ac_lost >= 0.6 or ac_lost <= 4 then
            return pa_alert_item(it, "Gain ego (Lighter armour)", CACHE.EMOJI.EGO)
          end
        elseif get_ego(it) ~= get_ego(cur) then
          if ev_gain/ac_lost >= 0.8 or ac_lost <= 4 then
            return pa_alert_item(it, "Diff ego (Lighter armour)", CACHE.EMOJI.EGO)
          end
        else
          if ev_gain/ac_lost >= 1.2 then
            return pa_alert_item(it, "Lighter armour (Same ego)", CACHE.EMOJI.LIGHTER)
          end
        end
      else
        if cur.artefact or has_ego(cur) then
          if ev_gain/ac_lost >= 2 and ev_gain >= 3 then
            return pa_alert_item(it, "Lighter armour (Lost ego)", CACHE.EMOJI.LIGHTER)
          end
        else
          -- Neither has ego
          if ev_gain/ac_lost >= 1.2 then
            return pa_alert_item(it, "Lighter armour", CACHE.EMOJI.LIGHTER)
          end
        end
      end
    else
      -- Heavier armour
      local ac_gain = get_armour_ac(it) - get_armour_ac(cur)
      local ev_lost = get_armour_ev(cur) - get_armour_ev(it)
      local encumb_penalty = 0
      if you.skill("Spellcasting") + you.skill("Ranged Weapons") > 1 then
        encumb_penalty = (it.encumbrance - cur.encumbrance)*0.75
      end
      local total_loss = ev_lost + encumb_penalty

      if has_ego(it) then
        if not cur.artefact and not has_ego(cur) then
          if ac_gain/total_loss >= 0.4 or total_loss <= 6 then
            return pa_alert_item(it, "Gain ego (Heavier armour)", CACHE.EMOJI.EGO)
          end
        elseif get_ego(it) ~= get_ego(cur) then
          if ac_gain/total_loss >= 0.7 or total_loss <= 6 then
            return pa_alert_item(it, "Diff ego (Heavier armour)", CACHE.EMOJI.EGO)
          end
        else
          if ac_gain/total_loss >= 0.8 then
            return pa_alert_item(it, "Heavier armour (Same ego)", CACHE.EMOJI.HEAVIER)
          end
        end
      else
        if cur.artefact or has_ego(cur) then
          if ac_gain/total_loss >= 2 and ac_gain >= 3 then
            return pa_alert_item(it, "Heavier armour (Lost ego)", CACHE.EMOJI.HEAVIER)
          end
        else
          -- Neither has ego
          if ac_gain/total_loss >= 0.8 then
            return pa_alert_item(it, "Heavier armour", CACHE.EMOJI.HEAVIER)
          end
        end
      end
    end
  elseif is_shield(it) then
    --if it.is_useless then return end
    local cur = items.equipped_at("shield")
    if not cur then return false end
    if it.branded and it.ego() ~= cur.ego() then
      return pa_alert_item(it, "New ego", CACHE.EMOJI.EGO)
    end
  else
    -- Aux armour
    local st, _ = it.subtype()
    local cur = items.equipped_at(st)
    if not cur then return end
    if get_armour_ac(it) > get_armour_ac(cur) then
      pa_alert_item(it, "Stronger armour", CACHE.EMOJI.STRONGER)
    else
      alert_armour_while_mutated(it, st)
    end
  end
end

function pa_alert_armour(it)
  if it.is_useless then return end
  alert_armour_upgrades(it)
  if it.is_identified or not has_ego(it) then alert_interesting_armour(it) end
end

}
############################### End lua/pickup-alert/pa-armour.lua ###############################
##########################################################################################

################################### Begin lua/pickup-alert/pa-misc.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
if loaded_pa_misc then return end
loaded_pa_misc = true


---- Alert rare items ----
function pa_alert_rare_item(it)
  local index = get_rare_item_index(it)
  if index == -1 then return end

  local do_alert = true
  -- Don't alert if already wearing a larger shield
  if pa_single_alert_items[index] == "buckler" then
    local sh = items.equipped_at("shield")
    if sh and sh.name("base") ~= "orb" then do_alert = false end
  elseif pa_single_alert_items[index] == "kite shield" then
    local sh = items.equipped_at("shield")
    if sh and sh.name("base"):find("tower shield") then do_alert = false end
  end

  if do_alert then
    pa_show_alert_msg("It's your first ", pa_single_alert_items[index].."!", CACHE.EMOJI.RARE_ITEM)
    crawl.more()
  end

  remove_from_pa_single_alert_items(it)
end

---- Alert orbs ----
function pa_alert_orb(it)
  if it.is_identified and not have_shield() then
    pa_alert_item(it, "New orb", CACHE.EMOJI.ORB)
  end
end

---- Alert talismans ----
function pa_alert_talisman(it)
  if it.is_identified then
    pa_alert_item(it, "New talisman", CACHE.EMOJI.TALISMAN)
  end
end

---- Alert for needed resists ----
function pa_alert_staff(it)
  if not it.is_identified then return false end
  local needRes = false
  local basename = it.name("base")

  if basename == "staff of fire" then needRes = you.res_fire() == 0
  elseif basename == "staff of cold" then needRes = you.res_cold() == 0
  elseif basename == "staff of air" then needRes = you.res_shock() == 0
  elseif basename == "staff of poison" then needRes = you.res_poison() == 0
  elseif basename == "staff of death" then needRes = you.res_draining() == 0
  end

  if needRes then
    pa_alert_item(it, "Staff resistance", CACHE.EMOJI.STAFF_RESISTANCE)
  end
end


---- Smart staff pickup ----
function pa_pickup_staff(it)
  if it.is_useless or not it.is_identified then return false end
  local school = get_staff_school(it)
  if get_skill(school) == 0 then return false end

  -- Check for previously picked staves
  for _,v in ipairs(pa_items_picked) do
    if v:find(it.name("base")) then return false end
  end

  return true
end

}
############################### End lua/pickup-alert/pa-misc.lua ###############################
##########################################################################################

################################### Begin lua/pickup-alert/pa-weapons.lua ###################################
############### https://github.com/brianfaires/crawl-rc/ ###############
{
if loaded_pa_weapons then return end
loaded_pa_weapons = true

---- Begin inv arrays ----
-- Use these arrays to compare potential upgrades against entire inventory
-- But only update these arrays once per turn, in ready()

local inv_weap_data = {}
local function make_weapon_struct(it)
  local weap_data = {}

  weap_data.dps = get_weap_dps(it)
  weap_data.acc = it.accuracy + it.plus
  weap_data.ego = get_ego(it)
  weap_data.branded = has_ego(it)
  weap_data.basename = it.name("base")
  weap_data.subtype = it.subtype()

  weap_data.is_ranged = it.is_ranged
  weap_data.hands = get_hands(it)
  weap_data.artefact = it.artefact
  weap_data.plus = it.plus
  weap_data.weap_skill = it.weap_skill
  weap_data.skill_lvl = get_skill(it.weap_skill)

  --weap_data.it = it
  return weap_data
end

-- High scores for melee/ranged, 1/2-handed, branded/unbranded
-- (Don't put these closing curly braces on a line by themself)
local top_school = "unarmed combat"
local egos = { }

local inv_max_dmg = {
  melee_1 = 0, melee_1b = 0, melee_2 = 0, melee_2b = 0,
  ranged_1 = 0, ranged_1b = 0, ranged_2 = 0, ranged_2b = 0, melee_only = 0
} -- inv_max_dmg (do not remove this comment)

local inv_max_dmg_acc = {
  melee_1 = 0, melee_1b = 0, melee_2 = 0, melee_2b = 0,
  ranged_1 = 0, ranged_1b = 0, ranged_2 = 0, ranged_2b = 0, melee_only = 0
} -- inv_max_dmg_acc (do not remove this comment)


local function set_top_school()
  local max = 0

  for _,v in ipairs(all_weap_schools) do
    if get_skill(v) > max then
      max = get_skill(v)
      top_school = v
    end
  end
end

local function get_weap_tag(it)
  local ret_val = if_el(it.is_ranged, "ranged_", "melee_")
  ret_val = ret_val..get_hands(it)
  if has_ego(it) then ret_val = ret_val.."b" end
  return ret_val
end

local function enforce_dmg_floor(target, floor)
  if inv_max_dmg[target] < inv_max_dmg[floor] then
    inv_max_dmg[target] = inv_max_dmg[floor]
    inv_max_dmg_acc[target] = inv_max_dmg_acc[floor]
  end
end

function generate_inv_weap_arrays()
  inv_weap_data = {}
  for k, _ in pairs(inv_max_dmg) do
    inv_max_dmg[k] = 0
    inv_max_dmg_acc[k] = 0
  end

  set_top_school()

  for inv in iter.invent_iterator:new(items.inventory()) do
    if is_weapon(inv) and not is_staff(inv) then
      update_high_scores(inv)
      inv_weap_data[#inv_weap_data + 1] = make_weapon_struct(inv)
      if has_ego(inv) then table.insert(egos, get_ego(inv)) end

      local dmg = inv_weap_data[#inv_weap_data].dps
      local weap_type = get_weap_tag(inv)
      if dmg > inv_max_dmg[weap_type] then
        inv_max_dmg[weap_type] = dmg
        local inv_plus = inv.plus
        if not inv_plus then inv_plus = 0 end
        inv_max_dmg_acc[weap_type] = inv.accuracy + inv_plus

    -- Keep a separate count for all melee weapons
    if weap_type:find("melee") then
      inv_max_dmg["melee_only"] = dmg
      inv_max_dmg_acc["melee_only"] = inv.accuracy + inv_plus
    end
      end
    end
  end

  -- Copy max_dmg from more restrictive categories to less restrictive
  enforce_dmg_floor("ranged_1", "ranged_1b")
  enforce_dmg_floor("ranged_2", "ranged_2b")
  enforce_dmg_floor("melee_1", "melee_1b")
  enforce_dmg_floor("melee_2", "melee_2b")

  enforce_dmg_floor("melee_1", "ranged_1")
  enforce_dmg_floor("melee_1b", "ranged_1b")
  enforce_dmg_floor("melee_2", "ranged_2")
  enforce_dmg_floor("melee_2b", "ranged_2b")

  enforce_dmg_floor("melee_2", "melee_1")
  enforce_dmg_floor("melee_2b", "melee_1b")
end


-- Alert strong weapons early
local function alert_early_weapons(it)
  -- Alert really good usable ranged weapons
  if CACHE.xl <= 14 then
    if it.is_identified and it.is_ranged then
      if has_ego(it) and it.plus >= 5 or it.plus >= 7 then
        if get_hands(it) == 1 or not have_shield() or you.skill("shield") <= 8 then
          return pa_alert_item(it, "Ranged weapon", CACHE.EMOJI.RANGED)
        end
      end
    end
  end

  -- Skip items when we're clearly going another route
  if get_skill(top_school) - get_skill(it.weap_skill) > 1.5*CACHE.xl+3 then return end


  if CACHE.xl < 8 then
    if has_ego(it) or it.plus and it.plus >= 4 then
      -- Make sure we don't alert a pure downgrade to something in inventory
      for _,inv in ipairs(inv_weap_data) do
        if inv.basename == it.name("base") then
          if inv.plus >= it.plus then
            if not has_ego(it) then return end
            if it.ego() == inv.ego then return end
          end
        end
      end

      return pa_alert_item(it, "Early weapon", CACHE.EMOJI.WEAPON)
    end
  end
end


local function alert_first_ranged(it)
  if not it.is_ranged then return false end

  if get_hands(it) == 2 then
    if have_shield() then return false end
    if alerted_first_ranged_two_handed == 0 then
      alerted_first_ranged_two_handed = 1
      for _,inv in ipairs(inv_weap_data) do
        if inv.is_ranged and inv.hands == 2 then return true end
      end
      return pa_alert_item(it, "Ranged weapon", CACHE.EMOJI.RANGED)
    end
  else
    if alerted_first_ranged_one_handed == 0 then
      alerted_first_ranged_one_handed = 1
      for _,inv in ipairs(inv_weap_data) do
        if inv.is_ranged then return true end
      end
      return pa_alert_item(it, "Ranged weapon", CACHE.EMOJI.RANGED)
    end
  end

  return false
end


---- pickup_weapons util ----
local function no_upgrade_possible(it, inv)
  if get_hands(it) > inv.hands then return true end
  if it.is_ranged ~= inv.is_ranged then return true end
  if inv.weap_skill == "Polearms" and it.weap_skill ~= "Polearms" then return true end
  return false
end

local function get_dmg_delta(it, cur, penalty)
  if not penalty then penalty = 1 end

  local delta
  local dmg_inv = inv_max_dmg[get_weap_tag(it)]

  if cur.dps >= dmg_inv then
    delta = get_weap_dps(it) - cur.dps
  else
    delta = get_weap_dps(it) - dmg_inv
  end

  if delta > 0 then return delta * penalty end
  return delta / penalty
end

local function need_first_weapon(it)
  if inv_max_dmg["melee_2"] ~= 0 then
    if inv_max_dmg["melee_only"] == 0 then
    -- Carrying ranged weapons only
    return get_weap_dps(it) > inv_max_dmg["melee_2"]
  end
  -- Carrying a melee weapon
  return false
  end

  if you.skill("Unarmed Combat") > 0 then return false end
  if get_mut("claws", true) > 0 then return false end
  if get_mut("demonic touch", true) > 0 then return false end

  return true
end


local function pickup_weapon(it, cur)
  if cur.subtype == it.subtype() then
    -- Exact weapon type match
    if it.artefact then return true end
    if cur.artefact then return false end
    if has_ego(it) and it.is_identified and not cur.branded then
      return get_weap_dps(it) > 0.85*cur.dps
    end
    if cur.branded and not has_ego(it) then return false end
    return it.ego() == cur.ego and get_weap_dps(it) > cur.dps + 0.001
  --elseif get_skill(it.weap_skill) >= 0.5 * get_skill(cur.weap_skill) then
  elseif it.weap_skill == cur.weap_skill or CACHE.race == "Gnoll" then
    if no_upgrade_possible(it, cur) then return false end

    if it.artefact then return true end
    if cur.artefact then return false end
    if it.branded and not it.is_identified then return false end
    --if cur.branded and not it.branded then return false end

    if it.is_ranged then return get_weap_dps(it) > cur.dps + 0.001 end

    local it_plus = if_el(it.plus, it.plus, 0)
    local it_score = get_weap_dps(it) + (it.accuracy + it_plus)/3
    local cur_score = cur.dps + cur.acc/3

    return it_score > 1.1*cur_score
  end

  return false
end


function do_pa_weapon_pickup(it)
  if it.is_useless then return false end
  for _,cur in ipairs(inv_weap_data) do
    if pickup_weapon(it, cur) then return true end
  end

  return need_first_weapon(it)
end


local function alert_interesting_weapon(it, cur)
  if it.artefact and it.is_identified then
    return pa_alert_item(it, "Artefact weapon", CACHE.EMOJI.ARTEFACT)
  end

  if cur.subtype == it.subtype() then
    -- Exact weapon type match
    if not cur.artefact and has_ego(it) and it.ego() ~= cur.ego then
      return pa_alert_item(it, "New ego", CACHE.EMOJI.EGO)
    end
    if get_weap_dps(it) > inv_max_dmg[get_weap_tag(it)] then
      return pa_alert_item(it, "Stronger weapon", CACHE.EMOJI.STRONGER)
    end
  elseif get_skill(it.weap_skill) >= 0.5 * get_skill(cur.weap_skill) then
    -- A usable weapon school
    if it.is_ranged ~= cur.is_ranged then return false end

    --local penalty = 1
    --if it.weap_skill == top_school then penalty = 0.5 end
    local penalty = (get_skill(it.weap_skill)+8) / (get_skill(top_school)+8)

    if get_hands(it) == 2 and cur.hands == 1 then
      -- Item requires an extra hand
      if has_ego(it) and not cur.branded then
        if get_weap_dps(it) > 0.8*cur.dps then
          return pa_alert_item(it, "2-handed weapon", CACHE.EMOJI.TWO_HANDED)
        end
      end

      if not have_shield() then
        if has_ego(it) and not (it.ego() == "heavy" or it.ego() == "speed") and
          not util.contains(egos, it.ego()) then
            return pa_alert_item(it, "New ego", CACHE.EMOJI.EGO)
        end
        if not cur.branded and
          get_weap_dps(it) > inv_max_dmg[get_weap_tag(it)] then
            return pa_alert_item(it, "2-handed weapon", CACHE.EMOJI.TWO_HANDED)
        end
        if cur.branded and not has_ego(it) and
          get_weap_dps(it) > inv_max_dmg[get_weap_tag(it)] then
            return pa_alert_item(it, "2-handed weapon", CACHE.EMOJI.TWO_HANDED)
        end
      elseif CACHE.s_shields <= 4 then
        -- Not really training shields; may be interested in big upgrades
        if penalty*get_weap_dps(it) >= inv_max_dmg["melee_2"] then
          return pa_alert_item(it, "2-handed weapon", CACHE.EMOJI.TWO_HANDED)
        end
      end
    else
      -- Item uses same number of hands or fewer
      if cur.artefact then return false end
      if has_ego(it) and not (it.ego() == "heavy" or it.ego() == "speed") then
        local dmg_delta = get_dmg_delta(it, cur, penalty)
        local dmg_delta_ratio = dmg_delta / get_weap_dps(it)

        if not cur.branded then
          if dmg_delta_ratio >= -0.2 then
            return pa_alert_item(it, "New ego", CACHE.EMOJI.EGO)
          end
        elseif it.ego() == cur.ego then
          if dmg_delta_ratio >= 0 then
            return pa_alert_item(it, "Stronger weapon", CACHE.EMOJI.STRONGER)
          end
        elseif not util.contains(egos, it.ego()) then
          if dmg_delta_ratio >= -0.2 then
            return pa_alert_item(it, "New ego", CACHE.EMOJI.EGO)
          end
        end
      else
        -- Not branded
        -- Allowing lower-trained skills triggers too often after picking up an untrained weapon
        -- Only use it to trigger upgrades from a low-value branded weapon to unbranded
        if cur.branded and cur.weap_skill == it.weap_skill then
          if get_weap_dps(it, true) > get_weap_dps(it, true) then
            return pa_alert_item(it, "Stronger weapon", CACHE.EMOJI.STRONGER)
          end
        else
          local dmg_delta, other_acc
          if cur.dps > inv_max_dmg[get_weap_tag(it)] then
            dmg_delta = get_weap_dps(it) - cur.dps
            other_acc = cur.acc
          else
            dmg_delta = get_weap_dps(it) - inv_max_dmg[get_weap_tag(it)]
            other_acc = inv_max_dmg_acc[get_weap_tag(it)]
          end

          if dmg_delta > 0 then
            return pa_alert_item(it, "Stronger weapon", CACHE.EMOJI.STRONGER)
          end
          local it_plus = if_el(it.plus, it.plus, 0)
          if dmg_delta == 0 and (it.accuracy+it_plus) > other_acc then
            return pa_alert_item(it, "Higher accuracy", CACHE.EMOJI.ACCURACY)
          end
        end
      end
    end
  end
end

local function alert_interesting_weapons(it)
  local ranged_weap_in_inv = false
  for _,cur in ipairs(inv_weap_data) do
    if alert_interesting_weapon(it, cur) then return true end
    if cur.is_ranged then ranged_weap_in_inv = true end
  end

  -- Alert for the first ranged weapon found (for 1 and 2 handed separately)
  if it.is_ranged and not ranged_weap_in_inv then
    if it.artefact or has_ego(it) and it.plus >= 4 then
      if get_hands(it) == 1 or not have_shield() then
        return pa_alert_item(it, "Ranged Weapon", CACHE.EMOJI.RANGED)
      end
    end
  end

  return false
end

local function alert_weap_high_scores(it)
  local category = update_high_scores(it)
  if category then pa_alert_item(it, category) end
end

function do_pa_weapon_alerts(it)
  if it.is_useless then return end
  if (it.artefact or has_ego(it)) and not it.is_identified then return end

  alert_first_ranged(it)
  alert_early_weapons(it)
  alert_interesting_weapons(it)

  -- Skip high score alerts if not using weapons
  if inv_max_dmg["melee_2"] > 0 then alert_weap_high_scores(it) end
end

}
############################### End lua/pickup-alert/pa-weapons.lua ###############################
##########################################################################################

## (Resuming init.txt) ##


############## Lua Hook Functions ##############
{
---------- c_message() -----------
function c_message(text, channel)
  if c_message_remind_identify then c_message_remind_identify(text, channel) end
  if c_message_weapon_slots then c_message_weapon_slots(text, channel) end
  if c_message_exclude_dropped then c_message_exclude_dropped(text, channel) end
  if c_message_fully_recover then c_message_fully_recover(text, channel) end
  if c_message_mute_swaps then c_message_mute_swaps(text, channel) end
  if c_message_after_shaft then c_message_after_shaft(text, channel) end
  if c_message_item_alerts then c_message_item_alerts(text, channel) end
  if c_message_runrest_features then c_message_runrest_features(text, channel) end
  if c_message_fm_pack then c_message_fm_pack(text, channel) end
  if c_message_fm_exclude then c_message_fm_exclude(text, channel) end
end


---------- c_assign_inv_letter() ----------
function c_assign_invletter(it)
  -- Calls with no return values; just triggering on new item pickup
  if c_assign_invletter_item_alerts then c_assign_invletter_item_alerts(it) end
  if c_assign_invletter_remind_identify then c_assign_invletter_remind_identify(it) end
  if c_assign_invletter_exclude_dropped then c_assign_invletter_exclude_dropped(it) end
  if c_assign_invletter_drop_inferior then c_assign_invletter_drop_inferior(it) end
  if c_assign_invletter_mute_swaps then c_assign_invletter_mute_swaps(it) end
  if c_assign_invletter_color_inscribe then c_assign_invletter_color_inscribe(it) end

  -- Calls with possible return values
  local ret_val = nil
  if c_assign_invletter_weapon_slots then ret_val = c_assign_invletter_weapon_slots(it) end
  if ret_val then return ret_val end
end


-------- ch_stop_running() --------
function ch_stop_running(kind)
  if ch_stop_running_full_recovery then ch_stop_running_full_recovery(kind) end
end


-------- Prompt auto-answers --------
function c_answer_prompt(prompt)
  if prompt:find("cheaper one?") then
    crawl.mpr("Replacing shopping list items", "plain")
    return true end
  if prompt == "Die?" then return false end  
end


--------- ready() ---------
local efficient_ready_last_turn = -1
function ready()
  ready_CACHE()
  if you.turns() ~= efficient_ready_last_turn then
    efficient_ready_last_turn = you.turns()

    if ready_force_mores then ready_force_mores() end
    if ready_fm_pack then ready_fm_pack() end
    if ready_dynamic_options then ready_dynamic_options() end
    if ready_inscribe_stats then ready_inscribe_stats() end
    if ready_weapon_slots then ready_weapon_slots() end
    if ready_safe_consumables then ready_safe_consumables() end
    if ready_mute_swaps then ready_mute_swaps() end
    if ready_runrest_features then ready_runrest_features() end
    if ready_after_shaft then ready_after_shaft() end
    if ready_fully_recover then ready_fully_recover() end
    if ready_safe_stairs then ready_safe_stairs() end
    if ready_announce_damage then ready_announce_damage() end
    if ready_item_alerts then ready_item_alerts() end
    if ready_misc_alerts then ready_misc_alerts() end
  end
end

--Startup hygeine
ready()
crawl.redraw_screen()
}
